<!DOCTYPE html>
<html lang="en">
<head>
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <script type="module" src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.6.1/dist/dotlottie-wc.js"></script>
  <?!= include('Stylesheet'); ?>
</head>
<body>

  <div id="app-layout" class="app-layout">

    <!-- Nav Drawer Scrim (mobile overlay) -->
    <div id="nav-drawer-scrim" class="nav-drawer-scrim" onclick="closeNavDrawer()"></div>

    <!-- MD3 Navigation Drawer (hidden until auth resolves) -->
    <aside id="nav-drawer" class="nav-drawer" role="navigation" aria-label="Main navigation" style="display:none">
      <div class="nav-drawer-header" onclick="showDashboard()" role="button" tabindex="0" aria-label="Go to dashboard" onkeydown="if(event.key==='Enter')showDashboard()">
        <img src="https://resources.finalsite.net/images/f_auto,q_auto/v1593114034/richfieldschoolsorg/fbdgkdnvwf9nhuugg19c/MS_Stacked_C.png" alt="Richfield Public Schools Logo" class="nav-logo nav-logo-expanded">
        <img src="https://resources.finalsite.net/images/f_auto,q_auto/v1595430487/richfieldschoolsorg/rfrcmvocatzil4spzjcp/Diamond-R_red-blackWeb_Socialfile.png" alt="Richfield R Logo" class="nav-logo nav-logo-collapsed">
      </div>
      <nav class="nav-drawer-items">
        <button class="nav-drawer-item active" id="drawer-dashboard" onclick="switchDashboardTab('dashboard')" data-tooltip="Dashboard">
          <span class="nav-drawer-active-indicator"></span>
          <svg class="nav-drawer-icon" viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>
          <span class="nav-drawer-label">Dashboard</span>
        </button>
        <div class="nav-drawer-group" id="nav-group-students">
          <div class="nav-drawer-item nav-drawer-parent" data-tooltip="Students">
            <svg class="nav-drawer-icon" viewBox="0 0 24 24"><path d="M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82zM12 3L1 9l11 6 9-4.91V17h2V9L12 3z"/></svg>
            <span class="nav-drawer-label">Students</span>
            <svg class="nav-drawer-expand-icon" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
          </div>
          <div class="nav-drawer-submenu">
            <button class="nav-drawer-item nav-drawer-child" id="drawer-caseload" onclick="switchDashboardTab('caseload')" data-tooltip="All Students">
              <span class="nav-drawer-active-indicator"></span>
              <svg class="nav-drawer-icon nav-drawer-icon-child" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
              <span class="nav-drawer-label">All Students</span>
            </button>
            <button class="nav-drawer-item nav-drawer-child" id="drawer-mycaseload" onclick="switchDashboardTab('mycaseload')" style="display:none;" data-tooltip="My Caseload">
              <span class="nav-drawer-active-indicator"></span>
              <svg class="nav-drawer-icon nav-drawer-icon-child" viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm-1 7V3.5L18.5 9H13z"/></svg>
              <span class="nav-drawer-label">My Caseload</span>
            </button>
          </div>
        </div>
        <button class="nav-drawer-item" id="drawer-dueprocess" onclick="showDueProcess()" data-tooltip="Due Process">
          <span class="nav-drawer-active-indicator"></span>
          <svg class="nav-drawer-icon" viewBox="0 0 24 24"><path d="M20 7h-4V5c0-1.1-.9-2-2-2h-4C8.9 3 8 3.9 8 5v2H4c-1.1 0-2 .9-2 2v11c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V9c0-1.1-.9-2-2-2zm-6 0h-4V5h4v2z"/></svg>
          <span class="nav-drawer-label">Due Process</span>
        </button>
        <div class="nav-drawer-divider"></div>
        <button class="nav-drawer-item" id="drawer-team" onclick="showCoTeachers()" data-tooltip="Team">
          <span class="nav-drawer-active-indicator"></span>
          <svg class="nav-drawer-icon" viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
          <span class="nav-drawer-label">Team</span>
        </button>
        <button class="nav-drawer-item" id="drawer-admin" onclick="switchDashboardTab('admin')" style="display:none;" data-tooltip="Admin">
          <span class="nav-drawer-active-indicator"></span>
          <svg class="nav-drawer-icon" viewBox="0 0 24 24"><path d="M17 11c.34 0 .67.04 1 .09V6.27L10.5 3 3 6.27v4.91c0 4.54 3.2 8.79 7.5 9.82.55-.13 1.08-.32 1.6-.55-.69-.98-1.1-2.17-1.1-3.45 0-3.31 2.69-6 6-6z"/><path d="M17 13c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 1.38c.62 0 1.12.51 1.12 1.12s-.51 1.12-1.12 1.12-1.12-.51-1.12-1.12.5-1.12 1.12-1.12zm0 5.37c-.93 0-1.74-.46-2.24-1.17.05-.72 1.51-1.08 2.24-1.08s2.19.36 2.24 1.08c-.5.71-1.31 1.17-2.24 1.17z"/></svg>
          <span class="nav-drawer-label">Admin</span>
        </button>
        <!-- SPED Lead Nav (hidden by default, shown for SPED Leads) -->
        <div class="nav-drawer-divider" id="nav-spedlead-divider" style="display:none;"></div>
        <button class="nav-drawer-item" id="drawer-spedlead-dashboard" onclick="showSpedLeadDashboard()" style="display:none;" data-tooltip="SPED Lead Dashboard">
          <span class="nav-drawer-active-indicator"></span>
          <svg class="nav-drawer-icon" viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>
          <span class="nav-drawer-label">SPED Dashboard</span>
        </button>
        <button class="nav-drawer-item" id="drawer-spedlead-students" onclick="showSpedLeadStudents()" style="display:none;" data-tooltip="All SPED Students">
          <span class="nav-drawer-active-indicator"></span>
          <svg class="nav-drawer-icon" viewBox="0 0 24 24"><path d="M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82zM12 3L1 9l11 6 9-4.91V17h2V9L12 3z"/></svg>
          <span class="nav-drawer-label">All Students</span>
        </button>
      </nav>
      <div class="nav-drawer-divider"></div>
      <nav class="nav-drawer-items nav-drawer-bottom-items">
        <button class="nav-drawer-item" onclick="toggleKeyboardHelp()" data-tooltip="Shortcuts">
          <span class="nav-drawer-active-indicator"></span>
          <svg class="nav-drawer-icon" viewBox="0 0 24 24"><path d="M20 5H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm-9 3h2v2h-2V8zm0 3h2v2h-2v-2zM8 8h2v2H8V8zm0 3h2v2H8v-2zm-1 2H5v-2h2v2zm0-3H5V8h2v2zm9 7H8v-2h8v2zm0-4h-2v-2h2v2zm0-3h-2V8h2v2zm3 3h-2v-2h2v2zm0-3h-2V8h2v2z"/></svg>
          <span class="nav-drawer-label">Shortcuts</span>
        </button>
      </nav>
      <!-- Collapse toggle (desktop only) -->
      <button id="nav-collapse-btn" class="nav-collapse-btn" onclick="toggleNavDrawerCollapse()" aria-label="Collapse navigation">
        <svg class="nav-collapse-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
      </button>
    </aside>

    <!-- App Content -->
    <div class="app-content">

      <!-- Top App Bar -->
      <header id="navbar" class="top-app-bar" style="display:none">
        <div class="top-app-bar-content">
          <button id="nav-drawer-toggle" class="nav-drawer-toggle" onclick="toggleNavDrawer()" aria-label="Open navigation menu">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
          </button>
          <div id="header-search-container" class="header-search-container">
            <svg class="header-search-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
            <input type="text" id="header-search-input" class="header-search-input" placeholder="Search students..." oninput="handleHeaderSearchInput(this.value)" onkeydown="handleHeaderSearchKeydown(event)">
            <div id="header-search-suggestion" class="header-search-suggestion" aria-hidden="true"></div>
            <button class="btn-icon btn-icon-sm header-search-close" id="header-search-close" onclick="clearHeaderSearch()" aria-label="Clear search" style="display:none">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </button>
            <div id="header-search-results" class="header-search-results"></div>
          </div>
        </div>
      </header>

      <!-- MD3 Linear Progress (indeterminate) -->
      <div id="global-progress" class="md-linear-progress" style="display:none">
        <div class="md-linear-progress-bar"></div>
      </div>

      <main id="main-content">

    <!-- Auth Loading State (shown while getUserStatus is in flight) -->
    <div id="auth-loading" class="view active">
      <div class="loading-logo-wrapper">
        <div class="loading-logo">
          <img src="https://resources.finalsite.net/images/f_auto,q_auto/v1593115004/richfieldschoolsorg/dfrlfjal7rdbrjlhbv1s/Mask_RichSpartText_C1.png" alt="Richfield Public Schools Logo">
        </div>
        <span class="loading-label">Loading&hellip;</span>
      </div>
    </div>

    <!-- Onboarding View -->
    <div id="onboarding-view" class="view">
      <div id="onboarding-container"></div>
    </div>

    <!-- Dashboard View -->
    <div id="dashboard-view" class="view">
      <div class="view-header">
        <div id="dashboard-greeting" class="dashboard-greeting"></div>
        <button class="btn-icon customize-dashboard-btn" onclick="openCustomizeDashboard()" aria-label="Customize dashboard" title="Customize dashboard" style="display:none">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17v2h6v-2H3zM3 5v2h10V5H3zm10 16v-2h8v-2h-8v-2h-2v6h2zM7 9v2H3v2h4v2h2V9H7zm14 4v-2H11v2h10zm-6-4h2V7h4V5h-4V3h-2v6z"/></svg>
        </button>
      </div>
      <!-- Dashboard Overview (quick info only) -->
      <div id="tab-panel-caseload" class="tab-panel active">
        <div id="dashboard-needs-attention" class="dashboard-section" style="display:none">
          <h2 class="dashboard-subheader">Needs Attention</h2>
          <div id="needs-attention-content"></div>
        </div>
        <div id="dashboard-at-a-glance" class="dashboard-section" style="display:none">
          <h2 class="dashboard-subheader">At a Glance</h2>
          <div id="at-a-glance-content"></div>
        </div>
        <div id="dashboard-evals-section" class="dashboard-section" style="display:none">
          <h2 class="dashboard-subheader">Evals</h2>
          <div id="evals-section-content"></div>
        </div>
        <div id="dashboard-missing-section" class="dashboard-section" style="display:none">
          <div id="missing-metric-content"></div>
        </div>
        <div id="dashboard-recent-section" class="dashboard-section" style="display:none">
          <h2 class="dashboard-subheader">Recent Students</h2>
          <div id="recent-students-content"></div>
        </div>
        <div id="dashboard-fab-container" class="fab-container" style="display:none">
          <div id="fab-menu" class="fab-menu">
            <button class="fab-menu-item" onclick="addNewWidget('sticky-note'); closeFabMenu()">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 9a2.4 2.4 0 0 0-.706-1.706l-3.588-3.588A2.4 2.4 0 0 0 15 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2z"/><path d="M15 3v5a1 1 0 0 0 1 1h5"/></svg>
              <span>Sticky Note</span>
            </button>
            <button class="fab-menu-item" onclick="addNewWidget('top3'); closeFabMenu()">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.11 0 2-.9 2-2V5c0-1.1-.89-2-2-2zm-9 14l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
              <span>To Do List</span>
            </button>
          </div>
          <button id="dashboard-add-widget-fab" class="dashboard-add-widget-fab" onclick="toggleFabMenu()" aria-label="Add widget" title="Add widget">
            <svg class="fab-icon-add" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
            <svg class="fab-icon-close" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
          </button>
        </div>
      </div>
      <!-- Student List (table + search) -->
      <div id="tab-panel-students" class="tab-panel">
        <div id="student-list-search" class="dashboard-search" style="display:none">
          <div class="dashboard-search-input-wrap">
            <svg class="dashboard-search-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
            <input type="text" id="student-list-search-input" class="dashboard-search-input" placeholder="Search students..." oninput="filterStudentListSearch(this.value)">
            <button class="btn-icon dashboard-search-clear" id="student-list-search-clear" onclick="clearStudentListSearch()" style="display:none" aria-label="Clear search">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </button>
          </div>
          <button onclick="showAddStudent()" class="btn-icon add-student-icon-btn" id="add-student-btn" aria-label="Add student" title="Add student">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
          </button>
        </div>
        <div id="dashboard-table-container"></div>
      </div>
      <div id="tab-panel-admin" class="tab-panel">
        <div id="admin-content-container"></div>
      </div>
    </div>

    <!-- Due Process View -->
    <div id="dueprocess-view" class="view">
      <div class="view-header view-title-row">
        <h1 class="view-title">Due Process</h1>
      </div>
      <div id="dueprocess-content"></div>
    </div>

    <!-- Co-Teacher Management View -->
    <div id="coteacher-view" class="view">
      <div class="view-header-stack">
        <div class="view-breadcrumb">
          <button onclick="showDashboard()" class="btn-icon" aria-label="Back to dashboard">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
          </button>
          <button class="breadcrumb-link" onclick="showDashboard()">Settings</button>
        </div>
        <h1 class="view-title">Team</h1>
      </div>
      <div id="coteacher-content-container"></div>
    </div>

    <!-- Student Profile View -->
    <div id="student-view" class="view">
      <div class="view-header-stack">
        <div class="view-breadcrumb">
          <button onclick="showDashboard()" class="btn-icon" aria-label="Back to dashboard">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
          </button>
          <button class="breadcrumb-link" id="student-view-breadcrumb" onclick="showDashboard()">Student Profile</button>
        </div>
        <div class="view-title-row">
          <h1 id="student-view-title" class="view-title">Student Profile</h1>
          <div id="student-menu-container"></div>
        </div>
      </div>
      <div id="student-form-container"></div>
    </div>

    <!-- Missing Assignments View (child page of student profile) -->
    <div id="missing-view" class="view">
      <div class="view-header-stack">
        <div class="view-breadcrumb">
          <button onclick="goBackFromMissing()" class="btn-icon" aria-label="Back">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
          </button>
          <span class="breadcrumb-label" id="missing-view-breadcrumb"><button class="breadcrumb-link" onclick="editStudent(appState.missingViewStudentId)">Student Profile</button> <svg class="breadcrumb-chevron" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg> Missing Assignments</span>
        </div>
        <h1 id="missing-view-title" class="view-title">Missing Assignments</h1>
      </div>
      <div id="missing-content-container"></div>
    </div>

    <!-- Eval Checklist View (child page of student profile) -->
    <div id="eval-checklist-view" class="view">
      <div class="view-header-stack">
        <div class="view-breadcrumb">
          <button onclick="goBackFromEvalChecklist()" class="btn-icon" aria-label="Back">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
          </button>
          <span class="breadcrumb-label" id="eval-checklist-breadcrumb">
            <button class="breadcrumb-link" onclick="goBackFromEvalChecklist()">Student Profile</button>
            <svg class="breadcrumb-chevron" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
            Eval Checklist
          </span>
        </div>
        <div class="view-title-row">
          <h1 id="eval-checklist-title" class="view-title">Eval Checklist</h1>
          <div id="eval-checklist-actions"></div>
        </div>
      </div>
      <div id="eval-checklist-content"></div>
    </div>

    <!-- Check-In Form View -->
    <div id="checkin-view" class="view">
      <div class="view-header-stack">
        <div class="view-breadcrumb">
          <button onclick="goBackFromCheckIn()" class="btn-icon" aria-label="Back">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
          </button>
          <button class="breadcrumb-link" id="checkin-view-breadcrumb" onclick="showDashboard()">Weekly Check-In</button>
        </div>
        <h1 id="checkin-view-title" class="view-title">Weekly Check-In</h1>
      </div>
      <div id="checkin-form-container"></div>
    </div>

    <!-- SPED Lead Dashboard View -->
    <div id="spedlead-view" class="view">
      <div class="view-header">
        <h2 class="view-title" id="spedlead-view-title">SPED Lead Overview</h2>
      </div>
      <div id="spedlead-content-container"></div>
    </div>

    <!-- SPED Lead Students View -->
    <div id="spedlead-students-view" class="view">
      <div class="view-header">
        <h2 class="view-title">All Students</h2>
      </div>
      <div id="spedlead-students-container"></div>
    </div>

    <!-- SPED Lead CM Profile View -->
    <div id="spedlead-cm-profile-view" class="view">
      <div class="view-header">
        <div class="breadcrumb" id="spedlead-cm-breadcrumb"></div>
      </div>
      <div id="spedlead-cm-container"></div>
    </div>

    <!-- SPED Lead Timeline Modal -->
    <div id="spedlead-timeline-modal" class="modal" style="display:none">
      <div class="modal-backdrop" onclick="closeSpedLeadTimelineModal()"></div>
      <div class="modal-content" id="spedlead-timeline-modal-content"></div>
    </div>

  </main>

    </div><!-- .app-content -->
  </div><!-- .app-layout -->

  <!-- Side Panel Overlay -->
  <div id="side-panel-overlay" class="side-panel-overlay" onclick="closeSidePanel()"></div>

  <!-- Side Panel (Quick View) -->
  <div id="side-panel" class="side-panel">
    <div class="side-panel-header">
      <h3 id="side-panel-title" aria-live="polite"></h3>
      <button onclick="closeSidePanel()" class="btn-close">&times;</button>
    </div>
    <div id="side-panel-content" class="side-panel-content"></div>
  </div>

  <!-- Toast notification -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <?!= include('JavaScript'); ?>
</body>
</html>
