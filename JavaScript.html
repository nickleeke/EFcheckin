<script>
/* ============================================================
   Caseload Dashboard — Client-Side JavaScript
   v3 — multi-user with onboarding
   ============================================================ */

// ─── Application State ───
var appState = {
  dashboardData: [],
  currentStudentId: null,
  currentCheckIns: [],
  editingCheckIn: null,
  sortField: 'name',
  sortAsc: true,
  caseloadFilter: 'all',
  caseManagerFilter: '',
  highlightedRowIndex: -1,
  missingViewStudentId: null,
  feedbackLinks: null,
  currentUserEmail: '',
  caseManagers: [],
  isSuperuser: false,
  evalChecklistStudentId: null,
  currentEvaluation: null,
  evalSummary: null,
  timelineExpandedDay: null,
  editingEvalItemId: null,
  recentStudents: [],
  searchQuery: '',
  currentProgressQuarter: null,
  progressEntries: [],
  dashboardMeetings: [],
  dueProcessData: null,
  dueProcessCalendarWeeks: 1,
  dueProcessExpandedDay: null,
  dueProcessProgressFilter: 'all',
  dueProcessQuarter: null,
  dueProcessProgressViewMode: 'grouped',
  dueProcessGoalAreaFilters: [],
  dueProcessExpandedStudents: {},
  dueProcessCompletedCollapsed: false,
  currentGoals: [],
  editingGoalId: null,
  expandedGoalIds: {},
  expandedProgressGoalIds: {},
  editingProgressGoalId: null,
  lastProgressQuarter: {},
  autoExpandProgressGoalId: null
};
var _persistTimers = {};
var _persistInFlight = 0;
var _ciAutosaveTimer = null;
var _ciAutosaveInFlight = false;
var _ciAutosaveDirty = false;
var _goalsAutosaveTimer = null;
var _goalsAutosaveInFlight = false;
var _goalsAutosaveDirty = false;
var _evalAutosaveTimer = null;
var _evalAutosaveInFlight = false;
var _evalAutosaveDirty = false;
var _evalItemFilter = 'all'; // 'all' | 'remaining' | 'overdue' | 'completed'
var _expandedEvalItemFiles = {}; // { itemId: true } — tracks expanded file lists per task
var _searchDebounceTimer = null;
var _headerSearchOpen = false;
var _headerSearchHighlight = -1;
var _evalFocusedIndex = -1;
var _progressAutosaveTimer = null;
var _progressAutosaveInFlight = false;
var _progressCompletionFiredFor = {};
var _progressAutosaveDirty = false;
var _lastDashboardFetch = 0;
var _lastEvalSummaryFetch = 0;
var _lastDueProcessFetch = 0;
var _ccmSelectedStudentId = null;
var _ccmSelectedType = null;
var _ccmActiveEvalStudentIds = {};
var _ccmSearchTimer = null;
var DATA_FRESH_MS = 30000; // 30s — frontend staleness window for navigation

var onboardingState = {
  step: 1,
  email: '',
  spreadsheetUrl: null
};

var GPA_MAP = {
  'A':4.0, 'A-':3.7, 'B+':3.3, 'B':3.0, 'B-':2.7,
  'C+':2.3, 'C':2.0, 'C-':1.7, 'D+':1.3, 'D':1.0, 'D-':0.7, 'F':0.0
};

// ─── Progress Reporting Constants ───
var PROGRESS_RATINGS = [
  { value: 'No Progress', label: 'No Progress', color: 'red' },
  { value: 'Adequate Progress', label: 'Adequate Progress', color: 'yellow' },
  { value: 'Objective Met', label: 'Objective Met', color: 'green' }
];
var PROGRESS_RATING_BADGES = {
  'No Progress': { label: 'Insufficient Progress', bg: '#FFDAD6', text: 'var(--md-on-error-container)', emoji: '' },
  'Adequate Progress': { label: 'Adequate Progress', bg: 'var(--md-surface-container-high)', text: 'var(--md-on-surface-variant)', emoji: '' },
  'Objective Met': { label: 'Objective Met', bg: '#FFDEAB', text: '#2A1800', emoji: '&#x1F3C6; ' }
};

// ─── Eval Type Definitions ───
var EVAL_TYPES = [
  { value: 'annual-iep', label: 'Annual IEP' },
  { value: '3-year-reeval', label: '3 Year Re-Eval' },
  { value: 'initial-eval', label: 'Initial Eval' }
];
var EVAL_TYPE_ALIASES = { 'eval': 'initial-eval', 'reeval': '3-year-reeval' };

function getEvalTypeLabel(type) {
  var resolved = EVAL_TYPE_ALIASES[type] || type;
  for (var i = 0; i < EVAL_TYPES.length; i++) {
    if (EVAL_TYPES[i].value === resolved) return EVAL_TYPES[i].label;
  }
  return 'Eval';
}

function setEvalMenuVisibility_(hasEval) {
  var createIds = ['menu-create-annual-iep', 'menu-create-3-year-reeval', 'menu-create-initial-eval'];
  var showCreate = !hasEval;
  createIds.forEach(function(id) { var el = document.getElementById(id); if (el) el.style.display = showCreate ? '' : 'none'; });
  var viewEl = document.getElementById('menu-view-eval');
  if (viewEl) viewEl.style.display = hasEval ? '' : 'none';
}

function updateEvalBreadcrumb_(typeLabel) {
  var el = document.getElementById('eval-checklist-breadcrumb');
  if (!el) return;
  el.innerHTML =
    '<button class="breadcrumb-link" onclick="goBackFromEvalChecklist()">Student Profile</button> ' +
    '<svg class="breadcrumb-chevron" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg> ' +
    esc(typeLabel);
}

// ─── Goal Area Definitions ───
var GOAL_AREA_OPTIONS = [
  { type: 'header', label: 'District/Coop Options' },
  { value: 'Math', label: 'Math' },
  { value: 'Reading', label: 'Reading' },
  { value: 'Writing', label: 'Writing' },
  { value: 'Motor', label: 'Motor' },
  { value: 'Emotional/Social/Behavioral', label: 'Emotional/Social/Behavioral' },
  { value: 'Functional', label: 'Functional' },
  { value: 'Communication', label: 'Communication' },
  { value: 'Sensory', label: 'Sensory' },
  { type: 'divider' },
  { value: 'Cognitive', label: 'Cognitive' },
  { value: 'Adaptive', label: 'Adaptive' },
  { value: 'Post Secondary Education and Training / Employment / Independent Living Skills', label: 'Post Secondary Education and Training / Employment / Independent Living Skills' },
  { value: 'Academics', label: 'Academics' },
  { value: 'Social/Communication', label: 'Social/Communication' }
];

function buildGoalAreaDropdown_(goalId, currentArea) {
  var label = currentArea || 'Select Goal Area';
  var html = '<div class="eval-type-picker goal-area-picker" data-goal-id="' + esc(goalId) + '">' +
    '<button class="eval-type-ghost-btn" onclick="toggleGoalAreaPicker(event)" aria-haspopup="listbox" aria-expanded="false">' +
      esc(label) +
      ' <svg class="eval-type-chevron" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>' +
    '</button>' +
    '<div class="eval-type-menu goal-area-menu" role="listbox">';
  GOAL_AREA_OPTIONS.forEach(function(opt) {
    if (opt.type === 'header') {
      html += '<div class="goal-area-menu-header">' + esc(opt.label) + '</div>';
    } else if (opt.type === 'divider') {
      html += '<div class="goal-area-menu-divider"></div>';
    } else {
      var selected = currentArea === opt.value;
      html += '<div class="eval-type-menu-item' + (selected ? ' eval-type-menu-item-selected' : '') + '" role="option" aria-selected="' + selected + '" ' +
        'onclick="selectGoalArea(\'' + esc(goalId) + '\', \'' + esc(opt.value) + '\')" ' +
        'onkeydown="if(event.key===\'Enter\')selectGoalArea(\'' + esc(goalId) + '\', \'' + esc(opt.value) + '\')" tabindex="0">' +
        esc(opt.label) + '</div>';
    }
  });
  html += '</div></div>';
  return html;
}

function toggleGoalAreaPicker(e) {
  e.stopPropagation();
  var picker = e.currentTarget.closest('.goal-area-picker');
  var menu = picker.querySelector('.goal-area-menu');
  var btn = picker.querySelector('.eval-type-ghost-btn');
  var open = menu.classList.contains('eval-type-menu-open');
  // Close any other open pickers first
  document.querySelectorAll('.eval-type-menu-open').forEach(function(m) { m.classList.remove('eval-type-menu-open'); });
  document.querySelectorAll('.eval-type-ghost-btn[aria-expanded="true"]').forEach(function(b) { b.setAttribute('aria-expanded', 'false'); });
  if (!open) {
    menu.classList.add('eval-type-menu-open');
    btn.setAttribute('aria-expanded', 'true');
    setTimeout(function() {
      document.addEventListener('click', closeGoalAreaPicker_, { once: true });
    }, 0);
  }
}

function closeGoalAreaPicker_() {
  document.querySelectorAll('.goal-area-menu.eval-type-menu-open').forEach(function(m) { m.classList.remove('eval-type-menu-open'); });
  document.querySelectorAll('.goal-area-picker .eval-type-ghost-btn[aria-expanded="true"]').forEach(function(b) { b.setAttribute('aria-expanded', 'false'); });
}

function selectGoalArea(goalId, value) {
  closeGoalAreaPicker_();
  var picker = document.querySelector('.goal-area-picker[data-goal-id="' + goalId + '"]');
  if (picker) {
    var btn = picker.querySelector('.eval-type-ghost-btn');
    btn.innerHTML = esc(value) + ' <svg class="eval-type-chevron" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>';
    picker.setAttribute('data-selected', value);
    picker.querySelectorAll('.eval-type-menu-item').forEach(function(item) {
      var isMatch = item.textContent.trim() === value;
      item.classList.toggle('eval-type-menu-item-selected', isMatch);
      item.setAttribute('aria-selected', isMatch);
    });
  }
  // Update appState directly
  for (var i = 0; i < appState.currentGoals.length; i++) {
    if (appState.currentGoals[i].id === goalId) {
      appState.currentGoals[i].goalArea = value;
      break;
    }
  }
  scheduleGoalsAutosave();
}

function buildEvalTypeDropdown_(evalId, currentType) {
  var resolved = EVAL_TYPE_ALIASES[currentType] || currentType;
  var label = getEvalTypeLabel(currentType);
  var html = '<div class="eval-type-picker">' +
    '<button class="eval-type-ghost-btn" onclick="toggleEvalTypePicker(event)" aria-haspopup="listbox" aria-expanded="false">' +
      esc(label) +
      ' <svg class="eval-type-chevron" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>' +
    '</button>' +
    '<div class="eval-type-menu" role="listbox">';
  EVAL_TYPES.forEach(function(t) {
    var selected = resolved === t.value;
    html += '<div class="eval-type-menu-item' + (selected ? ' eval-type-menu-item-selected' : '') + '" role="option" aria-selected="' + selected + '" ' +
      'onclick="selectEvalType(\'' + esc(evalId) + '\', \'' + esc(t.value) + '\')" ' +
      'onkeydown="if(event.key===\'Enter\')selectEvalType(\'' + esc(evalId) + '\', \'' + esc(t.value) + '\')" tabindex="0">' +
      esc(t.label) + '</div>';
  });
  html += '</div></div>';
  return html;
}

function toggleEvalTypePicker(e) {
  e.stopPropagation();
  var picker = e.currentTarget.closest('.eval-type-picker');
  var menu = picker.querySelector('.eval-type-menu');
  var btn = picker.querySelector('.eval-type-ghost-btn');
  var open = menu.classList.contains('eval-type-menu-open');
  // Close any other open pickers first
  document.querySelectorAll('.eval-type-menu-open').forEach(function(m) { m.classList.remove('eval-type-menu-open'); });
  document.querySelectorAll('.eval-type-ghost-btn[aria-expanded="true"]').forEach(function(b) { b.setAttribute('aria-expanded', 'false'); });
  if (!open) {
    menu.classList.add('eval-type-menu-open');
    btn.setAttribute('aria-expanded', 'true');
    // Close on outside click
    setTimeout(function() {
      document.addEventListener('click', closeEvalTypePicker_, { once: true });
    }, 0);
  }
}

function closeEvalTypePicker_() {
  document.querySelectorAll('.eval-type-menu-open').forEach(function(m) { m.classList.remove('eval-type-menu-open'); });
  document.querySelectorAll('.eval-type-ghost-btn[aria-expanded="true"]').forEach(function(b) { b.setAttribute('aria-expanded', 'false'); });
}

function selectEvalType(evalId, newType) {
  closeEvalTypePicker_();
  // Update button label
  var picker = document.querySelector('.eval-type-picker');
  if (picker) {
    var btn = picker.querySelector('.eval-type-ghost-btn');
    btn.innerHTML = esc(getEvalTypeLabel(newType)) + ' <svg class="eval-type-chevron" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>';
    // Update selected state
    picker.querySelectorAll('.eval-type-menu-item').forEach(function(item) {
      var isMatch = item.textContent.trim() === getEvalTypeLabel(newType);
      item.classList.toggle('eval-type-menu-item-selected', isMatch);
      item.setAttribute('aria-selected', isMatch);
    });
  }
  updateEvalType(evalId, newType);
}

// ─── Eval Navigation (Prev/Next Student) ───
function buildEvalNavRow_(currentStudentId) {
  var activeEvals = appState.evalSummary ? appState.evalSummary.activeEvals : [];
  if (activeEvals.length <= 1) return '';
  var currentIdx = -1;
  for (var i = 0; i < activeEvals.length; i++) {
    if (activeEvals[i].studentId === currentStudentId) { currentIdx = i; break; }
  }
  if (currentIdx === -1) return '';
  var prevEval = currentIdx > 0 ? activeEvals[currentIdx - 1] : null;
  var nextEval = currentIdx < activeEvals.length - 1 ? activeEvals[currentIdx + 1] : null;

  var html = '<div class="eval-nav-row">';
  html += '<button class="eval-nav-btn"' + (prevEval ? ' onclick="navigateToEvalStudent_(\'' + esc(prevEval.studentId) + '\')"' : ' disabled') + '>' +
    '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>' +
    (prevEval ? esc(prevEval.studentName) : 'Prev') +
  '</button>';
  html += '<span class="eval-nav-counter">' + (currentIdx + 1) + ' of ' + activeEvals.length + '</span>';
  html += '<button class="eval-nav-btn"' + (nextEval ? ' onclick="navigateToEvalStudent_(\'' + esc(nextEval.studentId) + '\')"' : ' disabled') + '>' +
    (nextEval ? esc(nextEval.studentName) : 'Next') +
    '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>' +
  '</button>';
  html += '</div>';
  return html;
}

function navigateToEvalStudent_(studentId) {
  navigateToEvalTask(studentId);
}

// ─── Eval Item Helpers ───
function isEvalItemOverdue_(item) {
  if (item.checked || !item.dueDate) return false;
  return new Date() > new Date(item.dueDate + 'T23:59:59');
}

function isEvalItemDueSoon_(item) {
  if (item.checked || !item.dueDate) return false;
  var now = new Date();
  var due = new Date(item.dueDate + 'T23:59:59');
  if (now > due) return false; // overdue, not due-soon
  var diffMs = due.getTime() - now.getTime();
  return diffMs <= 3 * 24 * 60 * 60 * 1000; // within 72 hours
}

function sortEvalItems_(items) {
  return items.slice().sort(function(a, b) {
    var aOverdue = isEvalItemOverdue_(a);
    var bOverdue = isEvalItemOverdue_(b);
    if (aOverdue !== bOverdue) return aOverdue ? -1 : 1;
    var aDueSoon = isEvalItemDueSoon_(a);
    var bDueSoon = isEvalItemDueSoon_(b);
    if (aDueSoon !== bDueSoon) return aDueSoon ? -1 : 1;
    // Items with due dates before those without
    if (a.dueDate && !b.dueDate) return -1;
    if (!a.dueDate && b.dueDate) return 1;
    if (a.dueDate && b.dueDate) return a.dueDate < b.dueDate ? -1 : a.dueDate > b.dueDate ? 1 : 0;
    return 0;
  });
}

function getEvalFilterCounts_(items) {
  var now = new Date();
  var counts = { all: items.length, remaining: 0, overdue: 0, completed: 0 };
  items.forEach(function(it) {
    if (it.checked) { counts.completed++; }
    else {
      counts.remaining++;
      if (it.dueDate && now > new Date(it.dueDate + 'T23:59:59')) counts.overdue++;
    }
  });
  return counts;
}

function applyEvalFilter_(items, filter) {
  if (filter === 'all') return items;
  var now = new Date();
  return items.filter(function(it) {
    if (filter === 'remaining') return !it.checked;
    if (filter === 'completed') return it.checked;
    if (filter === 'overdue') return !it.checked && it.dueDate && now > new Date(it.dueDate + 'T23:59:59');
    return true;
  });
}

function setEvalItemFilter(filter) {
  _evalItemFilter = filter;
  if (appState.currentEvaluation) {
    rebuildEvalItemsCard(appState.currentEvaluation.id);
  }
}

function buildEvalFilterChips_(items) {
  var counts = getEvalFilterCounts_(items);
  var filters = [
    { key: 'all', label: 'All (' + counts.all + ')' },
    { key: 'remaining', label: 'Remaining (' + counts.remaining + ')' },
    { key: 'overdue', label: 'Overdue (' + counts.overdue + ')' },
    { key: 'completed', label: 'Completed (' + counts.completed + ')' }
  ];
  var html = '<div class="eval-filter-bar">';
  filters.forEach(function(f) {
    var active = _evalItemFilter === f.key;
    html += '<button class="eval-filter-chip' + (active ? ' eval-filter-chip-active' : '') + '" ' +
      'aria-pressed="' + active + '" onclick="setEvalItemFilter(\'' + f.key + '\')">' +
      f.label + '</button>';
  });
  html += '</div>';
  return html;
}

// ─── Helpers ───
function getFirstNameFromEmail(email) {
  if (!email) return '';
  var local = email.split('@')[0];
  var firstName = local.split('.')[0];
  return firstName.charAt(0).toUpperCase() + firstName.slice(1).toLowerCase();
}

function trackRecentStudent(studentId) {
  appState.recentStudents = appState.recentStudents.filter(function(id) {
    return id !== studentId;
  });
  appState.recentStudents.unshift(studentId);
  if (appState.recentStudents.length > 5) {
    appState.recentStudents = appState.recentStudents.slice(0, 5);
  }
  renderRecentStudents();
}

// ─── Dashboard Helpers ───
function computeUrgencyScore(s) {
  var score = 0;
  if (s.daysSinceCheckIn != null && s.daysSinceCheckIn > 7) score += 2;
  if (s.avgRating != null) {
    if (s.avgRating < 3.0) score += 2;
    else if (s.avgRating < 4.0) score += 1;
  }
  if (s.totalMissing >= 4) score += 2;
  else if (s.totalMissing >= 1) score += 1;
  if (s.trend === 'down') score += 1;
  return score;
}

function formatRelativeDate(dateStr) {
  if (!dateStr) return { text: 'Never', tier: 'red' };
  var parts = dateStr.split('-');
  if (parts.length !== 3) return { text: dateStr, tier: 'gray' };
  var checkDate = new Date(parseInt(parts[0], 10), parseInt(parts[1], 10) - 1, parseInt(parts[2], 10));
  var today = new Date();
  today.setHours(0,0,0,0);
  var diffDays = Math.floor((today - checkDate) / 86400000);
  var text;
  if (diffDays < 0) text = 'Upcoming';
  else if (diffDays === 0) text = 'Today';
  else if (diffDays === 1) text = 'Yesterday';
  else if (diffDays < 7) text = diffDays + 'd ago';
  else if (diffDays < 14) text = '1 wk ago';
  else text = Math.floor(diffDays / 7) + ' wks ago';
  var tier = diffDays < 0 ? 'green' : diffDays <= 6 ? 'green' : diffDays <= 13 ? 'yellow' : 'red';
  return { text: text, tier: tier };
}

function buildSparklineSvg(efHistory) {
  if (!efHistory || efHistory.length < 2) return '';
  var w = 60, h = 24, pad = 3;
  var points = [];
  var n = efHistory.length;
  for (var i = 0; i < n; i++) {
    var x = pad + (i / (n - 1)) * (w - pad * 2);
    var y = h - pad - ((efHistory[i] - 1) / 4) * (h - pad * 2);
    points.push({ x: x, y: y });
  }
  var pathD = points.map(function(p, i) {
    return (i === 0 ? 'M' : 'L') + p.x.toFixed(1) + ',' + p.y.toFixed(1);
  }).join(' ');
  var lastVal = efHistory[n - 1];
  var dotColor = lastVal >= 4 ? '#1B5E20' : lastVal >= 3 ? '#7A5900' : '#BA1A1A';
  var lp = points[n - 1];
  return '<svg class="ef-sparkline" width="' + w + '" height="' + h + '" viewBox="0 0 ' + w + ' ' + h + '">' +
    '<path d="' + pathD + '" fill="none" stroke="var(--md-outline)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>' +
    '<circle cx="' + lp.x.toFixed(1) + '" cy="' + lp.y.toFixed(1) + '" r="3" fill="' + dotColor + '"/>' +
  '</svg>';
}

function applyFilter_(data) {
  if (appState.caseloadFilter === 'my') {
    var email = (appState.currentUserEmail || '').toLowerCase();
    return data.filter(function(s) {
      return (s.caseManagerEmail || '').toLowerCase() === email;
    });
  }
  return data;
}

function setCaseloadFilter(filter) {
  appState.caseloadFilter = filter;
  if (appState.dashboardData) {
    var filtered = applyFilter_(appState.dashboardData);
    // Re-render whichever panel is currently active
    var studentsPanel = document.getElementById('tab-panel-students');
    if (studentsPanel && studentsPanel.classList.contains('active')) {
      renderDashboard(filtered);
    }
    renderNeedsAttention(filtered);
    renderMissingAggregate(filtered);
    renderRecentStudents();
  }
}

function setCaseManagerFilter(email) {
  appState.caseManagerFilter = email;
  renderDashboard(applyFilter_(appState.dashboardData), { skipAnimation: true });
}

// ─── Preloaded Options ───
var PRELOADED_CLASSES = [
  'Academic Skills', 'Art', 'Band', 'Choir', 'ELA',
  'FACS', 'Global Studies', 'History', 'Lit Lab', 'Math',
  'Numbers Lab', 'PE', 'Photography', 'Reading Tier',
  'Science', 'STEAM', 'Woodshop'
];

// ─── Initialization ───
var _authLoadingTimer = null;

function showAuthError(message) {
  if (_authLoadingTimer) { clearTimeout(_authLoadingTimer); _authLoadingTimer = null; }
  document.getElementById('auth-loading').innerHTML =
    '<div class="empty-state">' +
      '<h3>Unable to Load</h3>' +
      '<p>' + esc(message) + '</p>' +
      '<button class="btn btn-primary" style="margin-top:16px;" onclick="location.reload()">Reload</button>' +
    '</div>';
}

document.addEventListener('DOMContentLoaded', function() {
  // Safety timeout: if auth hasn't resolved after 15s, show a retry prompt
  _authLoadingTimer = setTimeout(function() {
    var authEl = document.getElementById('auth-loading');
    if (authEl && authEl.classList.contains('active')) {
      showAuthError('The app is taking too long to load. Please check your connection and try again.');
    }
  }, 15000);

  // Check user auth status before showing anything
  google.script.run
    .withSuccessHandler(function(status) {
      if (_authLoadingTimer) { clearTimeout(_authLoadingTimer); _authLoadingTimer = null; }
      try {
        appState.currentUserEmail = status.email || '';
        appState.isSuperuser = status.isSuperuser || false;

        // Check for pending co-teacher invite
        if (status.pendingInvite) {
          if (status.isNewUser) {
            // New user with invite — show invite acceptance directly
            showInviteModal(status.pendingInvite, true);
          } else {
            // Existing user with invite — enter app, then show invite modal
            enterApp();
            showInviteModal(status.pendingInvite, false);
          }
        } else if (status.isNewUser) {
          showOnboarding(status);
        } else {
          enterApp();
        }
      } catch(e) {
        showAuthError(e.message || 'Unexpected error during startup.');
      }
    })
    .withFailureHandler(function(err) {
      showAuthError(err && err.message ? err.message : String(err));
    })
    .getUserStatus();
});

/** Enter the main app (for returning users or after onboarding). */
function enterApp() {
  var navbar = document.getElementById('navbar');
  var navDrawer = document.getElementById('nav-drawer');
  if (navbar) navbar.style.display = '';
  if (navDrawer) navDrawer.style.display = '';
  var headerSearch = document.getElementById('header-search-container');
  if (headerSearch) headerSearch.style.display = '';
  // G1: Populate desktop top bar user identity
  var firstName = getFirstNameFromEmail(appState.currentUserEmail);
  var nameEl = document.getElementById('top-bar-user-name');
  var avatarEl = document.getElementById('top-bar-avatar');
  if (nameEl) nameEl.textContent = firstName || '';
  if (avatarEl) avatarEl.textContent = firstName ? firstName.charAt(0) : '';
  // Load global case managers list
  google.script.run
    .withSuccessHandler(function(cms) {
      appState.caseManagers = cms || [];
      // Show My Caseload drawer item if current user is a case manager
      var isCM = cms.some(function(cm) {
        return cm.email === (appState.currentUserEmail || '').toLowerCase();
      });
      if (isCM) {
        var myCaseloadItem = document.getElementById('drawer-mycaseload');
        if (myCaseloadItem) myCaseloadItem.style.display = '';
        appState.caseloadFilter = 'my';
        setCaseloadFilter('my');
      }
      // Show Admin drawer item if superuser
      if (appState.isSuperuser) {
        var adminItem = document.getElementById('drawer-admin');
        if (adminItem) adminItem.style.display = '';
      }
    })
    .withFailureHandler(function() {})
    .getCaseManagers();
  // Render greeting with date context
  updateGreetingForTab('dashboard');
  showView('dashboard-view');
  showDashboardSkeleton();

  google.script.run
    .withSuccessHandler(function(result) {
      try {
        appState.feedbackLinks = (result && result.feedbackLinks) || {};
        loadDashboard();
      } catch(e) {
        document.getElementById('dashboard-table-container').innerHTML =
          renderErrorState(e.message || String(e));
      }
    })
    .withFailureHandler(function(err) {
      document.getElementById('dashboard-table-container').innerHTML =
        renderErrorState(err && err.message ? err.message : String(err));
    })
    .initializeSheets();
}

// ─── Navigation Drawer Toggle ───
var _navDrawerOpen = false;

// Mobile: toggle submenu on parent click (hover doesn't work on touch)
(function() {
  document.addEventListener('click', function(e) {
    var parent = e.target.closest('.nav-drawer-parent');
    if (!parent) return;
    if (window.innerWidth > 840) return; // desktop uses hover
    var group = parent.closest('.nav-drawer-group');
    if (group) group.classList.toggle('submenu-open');
  });
})();

function toggleNavDrawer() {
  _navDrawerOpen ? closeNavDrawer() : openNavDrawer();
}
function openNavDrawer() {
  closeSidePanel();
  var drawer = document.getElementById('nav-drawer');
  var scrim = document.getElementById('nav-drawer-scrim');
  if (drawer) drawer.classList.add('open');
  if (scrim) scrim.classList.add('open');
  _navDrawerOpen = true;
}
function closeNavDrawer() {
  var drawer = document.getElementById('nav-drawer');
  var scrim = document.getElementById('nav-drawer-scrim');
  if (drawer) drawer.classList.remove('open');
  if (scrim) scrim.classList.remove('open');
  _navDrawerOpen = false;
}
function closeNavDrawerIfMobile_() {
  if (window.innerWidth < 840) closeNavDrawer();
}

// ─── Navigation Drawer Collapse (desktop) ───
var _navDrawerCollapsed = false;
var _tooltipEl = null;
var _tooltipTimer = null;
var _flyoutEl = null;
var _flyoutHideTimer = null;

// Restore collapse state from localStorage
(function() {
  try {
    if (localStorage.getItem('navDrawerCollapsed') === 'true') {
      _navDrawerCollapsed = true;
      var drawer = document.getElementById('nav-drawer');
      if (drawer) drawer.classList.add('collapsed');
    }
  } catch(e) { /* localStorage unavailable */ }
})();

function toggleNavDrawerCollapse() {
  var drawer = document.getElementById('nav-drawer');
  if (!drawer) return;
  _navDrawerCollapsed = !_navDrawerCollapsed;
  if (_navDrawerCollapsed) {
    drawer.classList.add('collapsed');
  } else {
    drawer.classList.remove('collapsed');
  }
  hideNavTooltip_();
  hideNavFlyout_();
  var btn = document.getElementById('nav-collapse-btn');
  if (btn) btn.setAttribute('aria-label', _navDrawerCollapsed ? 'Expand navigation' : 'Collapse navigation');
  try { localStorage.setItem('navDrawerCollapsed', _navDrawerCollapsed); } catch(e) {}
}

// ─── Tooltips for collapsed nav items ───
function showNavTooltip_(target) {
  if (!_navDrawerCollapsed || window.innerWidth <= 840) return;
  var text = target.getAttribute('data-tooltip');
  if (!text) return;
  hideNavTooltip_();
  clearTimeout(_tooltipTimer);
  _tooltipTimer = setTimeout(function() {
    if (!_tooltipEl) {
      _tooltipEl = document.createElement('div');
      _tooltipEl.className = 'nav-drawer-tooltip';
      document.body.appendChild(_tooltipEl);
    }
    _tooltipEl.textContent = text;
    var rect = target.getBoundingClientRect();
    _tooltipEl.style.left = (rect.right + 8) + 'px';
    _tooltipEl.style.top = (rect.top + rect.height / 2 - 14) + 'px';
    _tooltipEl.offsetHeight; // force reflow
    _tooltipEl.classList.add('visible');
  }, 400);
}

function hideNavTooltip_() {
  clearTimeout(_tooltipTimer);
  if (_tooltipEl) _tooltipEl.classList.remove('visible');
}

// Delegated hover events for tooltips
document.addEventListener('mouseover', function(e) {
  var item = e.target.closest('.nav-drawer-item[data-tooltip]');
  if (item) showNavTooltip_(item);
});
document.addEventListener('mouseout', function(e) {
  var item = e.target.closest('.nav-drawer-item[data-tooltip]');
  if (item) hideNavTooltip_();
});

// ─── Flyout submenu for collapsed nav groups ───
function showNavFlyout_(groupEl) {
  if (!_navDrawerCollapsed || window.innerWidth <= 840) return;
  clearTimeout(_flyoutHideTimer);
  hideNavTooltip_();
  var children = groupEl.querySelectorAll('.nav-drawer-child');
  if (!children.length) return;
  if (!_flyoutEl) {
    _flyoutEl = document.createElement('div');
    _flyoutEl.className = 'nav-drawer-flyout';
    _flyoutEl.addEventListener('mouseenter', function() { clearTimeout(_flyoutHideTimer); });
    _flyoutEl.addEventListener('mouseleave', function() { scheduleFlyoutHide_(); });
    document.body.appendChild(_flyoutEl);
  }
  _flyoutEl.innerHTML = '';
  children.forEach(function(child) {
    if (child.style.display === 'none') return;
    var btn = document.createElement('button');
    btn.className = 'nav-drawer-flyout-item';
    if (child.classList.contains('active')) btn.classList.add('active');
    btn.textContent = child.getAttribute('data-tooltip') || child.querySelector('.nav-drawer-label').textContent;
    btn.onclick = function() { child.click(); hideNavFlyout_(); };
    _flyoutEl.appendChild(btn);
  });
  if (!_flyoutEl.children.length) return;
  var parentItem = groupEl.querySelector('.nav-drawer-parent');
  if (!parentItem) return;
  var rect = parentItem.getBoundingClientRect();
  _flyoutEl.style.left = (rect.right + 4) + 'px';
  _flyoutEl.style.top = rect.top + 'px';
  _flyoutEl.offsetHeight; // force reflow
  _flyoutEl.classList.add('visible');
}

function hideNavFlyout_() {
  clearTimeout(_flyoutHideTimer);
  if (_flyoutEl) _flyoutEl.classList.remove('visible');
}

function scheduleFlyoutHide_() {
  clearTimeout(_flyoutHideTimer);
  _flyoutHideTimer = setTimeout(hideNavFlyout_, 100);
}

// Delegated hover for flyout
document.addEventListener('mouseover', function(e) {
  var group = e.target.closest('.nav-drawer-group');
  if (group && _navDrawerCollapsed && window.innerWidth > 840) showNavFlyout_(group);
});
document.addEventListener('mouseout', function(e) {
  var group = e.target.closest('.nav-drawer-group');
  if (group && _navDrawerCollapsed) scheduleFlyoutHide_();
});

// Close panels on Escape key
document.addEventListener('keydown', function(e) {
  // Close keyboard help on Escape regardless of context
  var helpOverlay = document.querySelector('.keyboard-help-overlay');
  if (e.key === 'Escape' && helpOverlay) {
    helpOverlay.remove();
    return;
  }
  if (e.key === 'Escape') {
    // In eval edit mode, let it exit edit first
    if (_currentViewId === 'eval-checklist-view' && appState.editingEvalItemId) {
      exitEvalEditMode();
      return;
    }
    closeNavDrawer();
    closeSidePanel();
    hideNavTooltip_();
    hideNavFlyout_();
    var overlay = document.querySelector('.confirm-overlay');
    if (overlay) closeConfirmDialog(overlay);
    // Clear row highlight
    appState.highlightedRowIndex = -1;
    document.querySelectorAll('.row-highlighted').forEach(function(r) { r.classList.remove('row-highlighted'); });
    return;
  }
  // Skip shortcuts if user is typing in an input
  var tag = (document.activeElement && document.activeElement.tagName) || '';
  if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;
  // Only handle dashboard shortcuts when dashboard is visible
  var dashView = document.getElementById('dashboard-view');
  if (!dashView || !dashView.classList.contains('active')) return;
  var rows = document.querySelectorAll('#dashboard-table-container tbody tr');
  if (e.key === 'ArrowDown') {
    e.preventDefault();
    if (rows.length === 0) return;
    appState.highlightedRowIndex = Math.min(appState.highlightedRowIndex + 1, rows.length - 1);
    updateRowHighlight(rows);
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    if (rows.length === 0) return;
    appState.highlightedRowIndex = Math.max(appState.highlightedRowIndex - 1, 0);
    updateRowHighlight(rows);
  } else if (e.key === 'Enter' && appState.highlightedRowIndex >= 0 && rows[appState.highlightedRowIndex]) {
    e.preventDefault();
    rows[appState.highlightedRowIndex].click();
  } else if (e.key === 'n' && appState.highlightedRowIndex >= 0 && rows[appState.highlightedRowIndex]) {
    e.preventDefault();
    var sid = rows[appState.highlightedRowIndex].dataset.studentId;
    if (sid) startCheckIn(sid);
  } else if (e.key === 'p' && appState.highlightedRowIndex >= 0 && rows[appState.highlightedRowIndex]) {
    e.preventDefault();
    var sid2 = rows[appState.highlightedRowIndex].dataset.studentId;
    if (sid2) showStudentProfile(sid2);
  } else if (e.key === '?') {
    e.preventDefault();
    toggleKeyboardHelp();
  }

  // Eval checklist keyboard navigation
  if (_currentViewId !== 'eval-checklist-view') return;
  var tag = document.activeElement ? document.activeElement.tagName.toLowerCase() : '';
  if (tag === 'input' || tag === 'textarea' || tag === 'select') return;

  var evalItems = document.querySelectorAll('#eval-items-list .eval-item');
  if (!evalItems.length) return;

  if (e.key === 'j' || e.key === 'ArrowDown') {
    e.preventDefault();
    _evalFocusedIndex = Math.min(_evalFocusedIndex + 1, evalItems.length - 1);
    updateEvalFocus_(evalItems);
  } else if (e.key === 'k' || e.key === 'ArrowUp') {
    e.preventDefault();
    _evalFocusedIndex = Math.max(_evalFocusedIndex - 1, 0);
    updateEvalFocus_(evalItems);
  } else if (e.key === ' ' && _evalFocusedIndex >= 0) {
    e.preventDefault();
    var cb = evalItems[_evalFocusedIndex].querySelector('.eval-item-checkbox');
    if (cb) { cb.checked = !cb.checked; cb.dispatchEvent(new Event('change')); }
  } else if (e.key === 'e' && _evalFocusedIndex >= 0) {
    e.preventDefault();
    var itemId = evalItems[_evalFocusedIndex].getAttribute('data-item-id');
    if (itemId) enterEvalEditMode(itemId);
  }
});

function updateEvalFocus_(evalItems) {
  document.querySelectorAll('.eval-item-focused').forEach(function(el) { el.classList.remove('eval-item-focused'); });
  if (_evalFocusedIndex >= 0 && _evalFocusedIndex < evalItems.length) {
    evalItems[_evalFocusedIndex].classList.add('eval-item-focused');
    evalItems[_evalFocusedIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
}

function updateRowHighlight(rows) {
  rows.forEach(function(r) { r.classList.remove('row-highlighted'); });
  if (appState.highlightedRowIndex >= 0 && rows[appState.highlightedRowIndex]) {
    rows[appState.highlightedRowIndex].classList.add('row-highlighted');
    rows[appState.highlightedRowIndex].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
  }
}


function toggleKeyboardHelp() {
  var existing = document.querySelector('.keyboard-help-overlay');
  if (existing) { existing.remove(); return; }
  var overlay = document.createElement('div');
  overlay.className = 'keyboard-help-overlay';
  overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };
  overlay.innerHTML =
    '<div class="keyboard-help">' +
      '<h3>Keyboard Shortcuts</h3>' +
      '<div class="kb-row"><span>Navigate rows</span><span><kbd>&#x2191;</kbd> <kbd>&#x2193;</kbd></span></div>' +
      '<div class="kb-row"><span>Open side panel</span><kbd>Enter</kbd></div>' +
      '<div class="kb-row"><span>New check-in</span><kbd>n</kbd></div>' +
      '<div class="kb-row"><span>Student profile</span><kbd>p</kbd></div>' +
      '<div class="kb-row"><span>Close / deselect</span><kbd>Esc</kbd></div>' +
      '<div class="kb-row"><span>Show this help</span><kbd>?</kbd></div>' +
    '</div>';
  document.body.appendChild(overlay);
}


function closeConfirmDialog(overlayEl) {
  if (!overlayEl || overlayEl.classList.contains('dialog-closing')) return;
  overlayEl.classList.add('dialog-closing');
  var fallback = setTimeout(function() { overlayEl.remove(); }, 200);
  overlayEl.addEventListener('animationend', function() {
    clearTimeout(fallback);
    overlayEl.remove();
  });
}

// ─── View Management ───
var VIEW_ORDER = {
  'auth-loading': -1, 'onboarding-view': -1,
  'dashboard-view': 0, 'dueprocess-view': 1, 'coteacher-view': 2,
  'student-view': 3, 'missing-view': 4, 'eval-checklist-view': 4, 'checkin-view': 5
};
var _currentViewId = 'auth-loading';

function showView(viewId) {
  closeHeaderSearch();
  var oldId = _currentViewId;
  _currentViewId = viewId;

  document.querySelectorAll('.view').forEach(function(v) {
    v.classList.remove('active', 'view-enter-forward', 'view-enter-backward');
  });

  var el = document.getElementById(viewId);
  if (!el) return;
  el.classList.add('active');

  var oldOrder = VIEW_ORDER[oldId] != null ? VIEW_ORDER[oldId] : 0;
  var newOrder = VIEW_ORDER[viewId] != null ? VIEW_ORDER[viewId] : 0;

  if (oldId !== viewId && oldOrder !== -1 && newOrder !== -1) {
    var cls = newOrder >= oldOrder ? 'view-enter-forward' : 'view-enter-backward';
    el.classList.add(cls);
    el.addEventListener('animationend', function handler() {
      el.classList.remove(cls);
      el.removeEventListener('animationend', handler);
    });
  }

  window.scrollTo(0, 0);
}

// ─── Dashboard ───

function renderDashboardFromState() {
  var filtered = applyFilter_(appState.dashboardData);
  renderNeedsAttention(filtered);
  renderMissingAggregate(filtered);
  renderRecentStudents();
  if (appState.evalSummary) renderEvalSummary(appState.evalSummary);
}

function showDashboard() {
  switchDashboardTab('dashboard');
}

function loadDashboard(force) {
  // If academic-data persists are pending or in-flight, render from
  // local optimistic state to avoid overwriting unsaved changes.
  if (Object.keys(_persistTimers).length > 0 || _persistInFlight > 0) {
    renderDashboardFromState();
    return;
  }
  // Skip re-fetch if data is fresh and not forced
  if (!force && _lastDashboardFetch > 0 &&
      (Date.now() - _lastDashboardFetch) < DATA_FRESH_MS &&
      appState.dashboardData && appState.dashboardData.length > 0) {
    renderDashboardFromState();
    return;
  }
  showDashboardSkeleton();
  loadEvalSummary(force);
  google.script.run
    .withSuccessHandler(function(data) {
      try {
        appState.dashboardData = data || [];
        _lastDashboardFetch = Date.now();
        var filtered = applyFilter_(data);
        renderNeedsAttention(filtered);
        renderMissingAggregate(filtered);
        renderRecentStudents();
      } catch(e) {
        showToast('Dashboard error: ' + (e.message || String(e)));
      }
    })
    .withFailureHandler(function(err) {
      showToast('Error loading dashboard: ' + (err && err.message ? err.message : String(err)));
    })
    .getDashboardData();
}

function loadStudentList() {
  if (!appState.dashboardData || appState.dashboardData.length === 0) {
    // Data not loaded yet — load it first, then render
    showDashboardSkeleton();
    google.script.run
      .withSuccessHandler(function(data) {
        appState.dashboardData = data || [];
        var filtered = applyFilter_(data);
        renderDashboard(filtered);
      })
      .withFailureHandler(function(err) {
        var container = document.getElementById('dashboard-table-container');
        if (container) container.innerHTML = renderErrorState(err && err.message ? err.message : String(err));
      })
      .getDashboardData();
  } else {
    var filtered = applyFilter_(appState.dashboardData);
    renderDashboard(filtered);
  }
}

function updateGreetingForTab(tabName) {
  var greetingEl = document.getElementById('dashboard-greeting');
  if (!greetingEl) return;
  var today = new Date();
  var dateStr = today.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
  var titleText;
  if (tabName === 'caseload') {
    titleText = 'All Students';
  } else if (tabName === 'mycaseload') {
    titleText = 'My Caseload';
  } else {
    var firstName = getFirstNameFromEmail(appState.currentUserEmail);
    titleText = firstName ? 'Hi, ' + firstName + '!' : 'Welcome!';
  }
  greetingEl.innerHTML =
    '<div class="greeting-text">' + esc(titleText) + '</div>' +
    '<div class="greeting-date">' + esc(dateStr) + '</div>';
}

function switchDashboardTab(tabName) {
  // Ensure dashboard view is visible (handles clicks from child pages)
  showView('dashboard-view');
  closeHeaderSearch();
  updateGreetingForTab(tabName);
  // Deactivate all drawer child items, parent items, and panels
  document.querySelectorAll('.nav-drawer-child').forEach(function(t) { t.classList.remove('active'); });
  document.querySelectorAll('.nav-drawer-items > .nav-drawer-item').forEach(function(t) { t.classList.remove('active'); });
  document.querySelectorAll('.nav-drawer-parent').forEach(function(t) { t.classList.remove('active'); });
  document.querySelectorAll('.tab-panel').forEach(function(p) { p.classList.remove('active'); });
  // Map tab names to panels and drawer items
  var isAdmin = (tabName === 'admin');
  var isStudentList = (tabName === 'caseload' || tabName === 'mycaseload');
  var panelName = isStudentList ? 'students' : (tabName === 'dashboard' ? 'caseload' : tabName);
  var item = document.getElementById('drawer-' + tabName);
  var panel = document.getElementById('tab-panel-' + panelName);
  if (item) item.classList.add('active');
  if (panel) panel.classList.add('active');
  // For dashboard tab, also highlight the dashboard drawer item
  if (tabName === 'dashboard') {
    var dashItem = document.getElementById('drawer-dashboard');
    if (dashItem) dashItem.classList.add('active');
  }
  // For student list tabs, also highlight the parent Students group
  if (isStudentList) {
    var studentsParent = document.querySelector('#nav-group-students .nav-drawer-parent');
    if (studentsParent) studentsParent.classList.add('active');
  }
  // Close mobile submenu and drawer
  var openGroup = document.querySelector('.nav-drawer-group.submenu-open');
  if (openGroup) openGroup.classList.remove('submenu-open');
  closeNavDrawerIfMobile_();
  // Render tab content
  if (tabName === 'dashboard') {
    loadDashboard();
  } else if (tabName === 'caseload') {
    appState.caseloadFilter = 'all';
    appState.caseManagerFilter = '';
    loadStudentList();
  } else if (tabName === 'mycaseload') {
    appState.caseloadFilter = 'my';
    appState.caseManagerFilter = '';
    loadStudentList();
  } else if (tabName === 'admin') {
    loadAdminView();
  }
}

function toggleSort(field) {
  if (appState.sortField === field) {
    appState.sortAsc = !appState.sortAsc;
  } else {
    appState.sortField = field;
    appState.sortAsc = true;
  }
  renderDashboard(applyFilter_(appState.dashboardData));
}

// ─── Student List Search (in-table filter) ───
function filterStudentListSearch(query) {
  if (_searchDebounceTimer) clearTimeout(_searchDebounceTimer);
  var clearBtn = document.getElementById('student-list-search-clear');
  if (clearBtn) clearBtn.style.display = query ? '' : 'none';
  _searchDebounceTimer = setTimeout(function() {
    appState.searchQuery = query.trim().toLowerCase();
    renderDashboard(applyFilter_(appState.dashboardData), { skipAnimation: true });
  }, 200);
}

function clearStudentListSearch() {
  var input = document.getElementById('student-list-search-input');
  if (input) input.value = '';
  appState.searchQuery = '';
  var clearBtn = document.getElementById('student-list-search-clear');
  if (clearBtn) clearBtn.style.display = 'none';
  renderDashboard(applyFilter_(appState.dashboardData), { skipAnimation: true });
}

// ─── Header Search (expandable typeahead) ───
function toggleHeaderSearch() {
  if (_headerSearchOpen) {
    closeHeaderSearch();
  } else {
    openHeaderSearch();
  }
}

function openHeaderSearch() {
  var container = document.getElementById('header-search-container');
  var input = document.getElementById('header-search-input');
  if (!container) return;
  _headerSearchOpen = true;
  _headerSearchHighlight = -1;
  container.classList.add('header-search-open');
  if (input) { input.value = ''; input.focus(); }
}

function closeHeaderSearch() {
  var container = document.getElementById('header-search-container');
  var input = document.getElementById('header-search-input');
  var results = document.getElementById('header-search-results');
  if (!container) return;
  _headerSearchOpen = false;
  _headerSearchHighlight = -1;
  container.classList.remove('header-search-open');
  if (input) input.value = '';
  if (results) results.innerHTML = '';
  document.removeEventListener('click', _closeHeaderSearchOnOutsideClick);
}

function _closeHeaderSearchOnOutsideClick(e) {
  var container = document.getElementById('header-search-container');
  if (container && !container.contains(e.target)) {
    closeHeaderSearch();
  }
}

function handleHeaderSearchInput(query) {
  if (_searchDebounceTimer) clearTimeout(_searchDebounceTimer);
  _headerSearchHighlight = -1;
  _searchDebounceTimer = setTimeout(function() {
    renderHeaderSearchResults(query.trim().toLowerCase());
  }, 150);
}

function renderHeaderSearchResults(query) {
  var results = document.getElementById('header-search-results');
  if (!results) return;
  if (!query) { results.innerHTML = ''; return; }
  var data = appState.dashboardData || [];
  var startsWithMatches = [];
  var containsMatches = [];
  for (var i = 0; i < data.length; i++) {
    var s = data[i];
    var first = (s.firstName || '').toLowerCase();
    var last = (s.lastName || '').toLowerCase();
    var full = first + ' ' + last;
    if (first.indexOf(query) === 0 || last.indexOf(query) === 0) {
      startsWithMatches.push(s);
    } else if (full.indexOf(query) !== -1) {
      containsMatches.push(s);
    }
  }
  var matches = startsWithMatches.concat(containsMatches).slice(0, 5);
  if (matches.length === 0) {
    results.innerHTML = '<div class="header-search-empty">No matches</div>';
    return;
  }
  var html = '';
  for (var j = 0; j < matches.length; j++) {
    var m = matches[j];
    var boldedName = boldMatchedLetters(m.firstName + ' ' + m.lastName, query);
    html += '<button class="header-search-result-item" data-student-id="' + esc(m.id) + '" ' +
      'onclick="selectHeaderSearchResult(\'' + esc(m.id) + '\')" role="option">' +
      '<span class="header-search-result-name">' + boldedName + '</span>' +
      (m.grade ? '<span class="header-search-result-grade">Grade ' + esc(m.grade) + '</span>' : '') +
    '</button>';
  }
  results.innerHTML = html;
  // Start listening for outside clicks
  setTimeout(function() {
    document.addEventListener('click', _closeHeaderSearchOnOutsideClick);
  }, 0);
}

function boldMatchedLetters(name, query) {
  var escaped = esc(name);
  var lowerEscaped = escaped.toLowerCase();
  var lowerQuery = query.toLowerCase();
  var idx = lowerEscaped.indexOf(lowerQuery);
  if (idx === -1) return escaped;
  var before = escaped.substring(0, idx);
  var match = escaped.substring(idx, idx + query.length);
  var after = escaped.substring(idx + query.length);
  return before + '<strong>' + match + '</strong>' + after;
}

function selectHeaderSearchResult(studentId) {
  closeHeaderSearch();
  showStudentProfile(studentId);
}

function handleHeaderSearchKeydown(e) {
  var results = document.getElementById('header-search-results');
  if (!results) return;
  var items = results.querySelectorAll('.header-search-result-item');
  if (e.key === 'ArrowDown') {
    e.preventDefault();
    _headerSearchHighlight = Math.min(_headerSearchHighlight + 1, items.length - 1);
    updateHeaderSearchHighlight(items);
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    _headerSearchHighlight = Math.max(_headerSearchHighlight - 1, 0);
    updateHeaderSearchHighlight(items);
  } else if (e.key === 'Enter' && _headerSearchHighlight >= 0 && items[_headerSearchHighlight]) {
    e.preventDefault();
    var sid = items[_headerSearchHighlight].dataset.studentId;
    if (sid) selectHeaderSearchResult(sid);
  } else if (e.key === 'Escape') {
    e.preventDefault();
    closeHeaderSearch();
  }
}

function updateHeaderSearchHighlight(items) {
  for (var i = 0; i < items.length; i++) {
    items[i].classList.toggle('header-search-result-highlighted', i === _headerSearchHighlight);
  }
  if (_headerSearchHighlight >= 0 && items[_headerSearchHighlight]) {
    items[_headerSearchHighlight].scrollIntoView({ block: 'nearest' });
  }
}

function sortIcon(field) {
  var isActive = appState.sortField === field;
  var arrow;
  if (!isActive) {
    // Inactive: up/down unfold arrow
    arrow = '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 5.83L15.17 9l1.41-1.41L12 3 7.41 7.59 8.83 9 12 5.83zm0 12.34L8.83 15l-1.41 1.41L12 21l4.59-4.59L15.17 15 12 18.17z"/></svg>';
  } else if (appState.sortAsc) {
    arrow = '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M7 14l5-5 5 5z"/></svg>';
  } else {
    arrow = '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>';
  }
  var cls = 'btn-icon btn-sort' + (isActive ? ' btn-sort-active' : '');
  return '<button class="' + cls + '" onclick="event.stopPropagation(); toggleSort(\'' + field + '\')" aria-label="Sort by ' + field + '">' + arrow + '</button>';
}

function renderDashboard(data, opts) {
  var skipAnimation = opts && opts.skipAnimation;
  appState.highlightedRowIndex = -1;
  var container = document.getElementById('dashboard-table-container');
  var searchBar = document.getElementById('student-list-search');

  if (!data || data.length === 0) {
    if (searchBar) searchBar.style.display = 'none';
    container.innerHTML =
      '<div class="empty-state">' +
        '<div class="empty-state-icon">' +
          '<svg width="40" height="40" viewBox="0 0 24 24" fill="currentColor">' +
            '<path d="M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82zM12 3L1 9l11 6 9-4.91V17h2V9L12 3z"/>' +
          '</svg>' +
        '</div>' +
        '<h3>No Students Yet</h3>' +
        '<p>Add your first student to start tracking EF skills and academic progress.</p>' +
        '<button onclick="showAddStudent()" class="btn btn-primary">+ Add Student</button>' +
      '</div>';
    return;
  }

  // Show search bar when students exist
  if (searchBar) searchBar.style.display = '';

  // Apply search filter
  var filtered = data;
  if (appState.searchQuery) {
    var q = appState.searchQuery;
    filtered = data.filter(function(s) {
      var full = (s.firstName + ' ' + s.lastName).toLowerCase();
      return full.indexOf(q) !== -1;
    });
  }

  // Apply case manager filter
  if (appState.caseManagerFilter) {
    filtered = filtered.filter(function(s) {
      return (s.caseManagerEmail || '') === appState.caseManagerFilter;
    });
  }

  if (filtered.length === 0) {
    container.innerHTML =
      '<div class="empty-state">' +
        '<p>No students match your current filters.</p>' +
      '</div>';
    return;
  }

  // Sort data
  var sorted = filtered.slice().sort(function(a, b) {
    var cmp = 0;
    if (appState.sortField === 'priority') {
      cmp = computeUrgencyScore(b) - computeUrgencyScore(a);
      if (cmp === 0) cmp = String(a.firstName).localeCompare(String(b.firstName));
    } else if (appState.sortField === 'name') {
      cmp = String(a.firstName).localeCompare(String(b.firstName));
      if (cmp === 0) cmp = String(a.lastName).localeCompare(String(b.lastName));
    } else if (appState.sortField === 'grade') {
      var ag = a.grade || '', bg = b.grade || '';
      // Push empty grades to the bottom regardless of direction
      if (!ag && !bg) cmp = 0;
      else if (!ag) return 1;
      else if (!bg) return -1;
      else cmp = ag.localeCompare(bg);
      if (cmp === 0) cmp = String(a.firstName).localeCompare(String(b.firstName));
    } else if (appState.sortField === 'caseManager') {
      var acm = a.caseManagerEmail ? getCaseManagerName(a.caseManagerEmail) : '';
      var bcm = b.caseManagerEmail ? getCaseManagerName(b.caseManagerEmail) : '';
      if (!acm && !bcm) cmp = 0;
      else if (!acm) return 1;
      else if (!bcm) return -1;
      else cmp = acm.localeCompare(bcm);
      if (cmp === 0) cmp = String(a.firstName).localeCompare(String(b.firstName));
    }
    return appState.sortAsc ? cmp : -cmp;
  });

  // Build case manager filter dropdown
  var cmEmails = {};
  data.forEach(function(s) {
    if (s.caseManagerEmail) cmEmails[s.caseManagerEmail] = true;
  });
  var cmOptions = Object.keys(cmEmails).sort(function(a, b) {
    return getCaseManagerName(a).localeCompare(getCaseManagerName(b));
  });
  var cmFilterHtml = '';
  if (cmOptions.length > 1) {
    cmFilterHtml = '<div class="cm-filter-bar">' +
      '<label class="cm-filter-label" for="cm-filter-select">Case Manager:</label>' +
      '<select id="cm-filter-select" class="cm-filter-select" onchange="setCaseManagerFilter(this.value)">' +
      '<option value=""' + (!appState.caseManagerFilter ? ' selected' : '') + '>All</option>';
    cmOptions.forEach(function(email) {
      var sel = appState.caseManagerFilter === email ? ' selected' : '';
      cmFilterHtml += '<option value="' + esc(email) + '"' + sel + '>' + esc(getCaseManagerName(email)) + '</option>';
    });
    cmFilterHtml += '</select></div>';
  }

  var html = cmFilterHtml + '<table class="dashboard-table"><thead><tr>' +
    '<th><span class="th-sortable">' + sortIcon('name') + 'Name</span></th>' +
    '<th><span class="th-sortable">' + sortIcon('grade') + 'Grade</span></th>' +
    '<th>EF Avg</th><th>Trend</th><th>GPA</th>' +
    '<th>Missing</th><th>Last Check-In</th><th><span class="th-sortable">' + sortIcon('caseManager') + 'Case Manager</span></th><th style="text-align:left">Actions</th>' +
    '</tr></thead><tbody>';

  sorted.forEach(function(s, index) {
    var origIndex = (appState.dashboardData || data).indexOf(s);
    var rowClass = skipAnimation ? '' : ' stagger-row';
    var delayStyle = skipAnimation ? '' : ' style="animation-delay:' + Math.min(index * 50, 400) + 'ms"';
    html += '<tr class="' + rowClass + '" data-student-id="' + s.id + '" data-row-index="' + index + '"' + delayStyle + ' onclick="openSidePanel(' + origIndex + ')" title="Click for quick view">';
    html += '<td><strong>' + esc(s.firstName + ' ' + s.lastName) + '</strong>';
    if (s.online) html += ' <span class="online-badge" title="Online">Online</span>';
    html += buildBirthdayBadge_(s.birthday);
    if (s.evalType) {
      var evalLabel = getEvalTypeLabel(s.evalType);
      html += ' <span class="chip chip-clickable eval-badge" data-eval-type="' + esc(s.evalType) + '" onclick="event.stopPropagation(); openEvalFromBadge(\'' + s.id + '\')" title="View ' + evalLabel + ' checklist">' + evalLabel + '</span>';
    }
    html += '</td>';
    html += '<td>' + esc(s.grade || '-') + '</td>';

    // EF Average with sparkline
    if (s.avgRating != null) {
      var efClass = s.avgRating >= 4 ? 'chip-green' : s.avgRating >= 3 ? 'chip-yellow' : 'chip-red';
      var sparkSvg = (s.efHistory && s.efHistory.length >= 2) ? buildSparklineSvg(s.efHistory) : '';
      if (sparkSvg) {
        html += '<td><span class="ef-sparkline-cell">' + sparkSvg + '<span class="chip ' + efClass + '">' + s.avgRating.toFixed(1) + '</span></span></td>';
      } else {
        html += '<td><span class="chip ' + efClass + '">' + s.avgRating.toFixed(1) + '</span></td>';
      }
    } else {
      html += '<td><span class="chip chip-gray">--</span></td>';
    }

    // Trend
    var trendMap = { up: '&#x25B2; Up', down: '&#x25BC; Down', flat: '&#x25B6; Flat', none: '--' };
    var trendClass = s.trend === 'up' ? 'trend-up' : s.trend === 'down' ? 'trend-down' : 'trend-flat';
    html += '<td><span class="' + trendClass + '">' + (trendMap[s.trend] || '--') + '</span></td>';

    // GPA
    if (s.gpa != null) {
      var gpaClass = s.gpa >= 3.5 ? 'chip-gold' : s.gpa > 3.0 ? 'chip-green' : s.gpa >= 2.5 ? 'chip-yellow' : 'chip-red';
      var trophy = s.gpa >= 3.7 ? ' &#x1F3C6;' : '';
      html += '<td><span class="chip ' + gpaClass + '">' + s.gpa.toFixed(2) + trophy + '</span></td>';
    } else {
      html += '<td><span class="chip chip-gray">--</span></td>';
    }

    // Missing assignments (clickable badge)
    if (s.totalMissing > 0) {
      var missingClass = s.totalMissing >= 4 ? 'chip-red' : 'chip-yellow';
      html += '<td><span class="chip chip-clickable ' + missingClass + '" onclick="event.stopPropagation(); showMissingAssignments(\'' + s.id + '\')" title="View missing assignments">' + s.totalMissing + '</span></td>';
    } else {
      html += '<td><span class="chip chip-clickable chip-green" onclick="event.stopPropagation(); showMissingAssignments(\'' + s.id + '\')" title="View missing assignments">0</span></td>';
    }

    // Last check-in staleness
    if (s.latestWeek) {
      var rel = formatRelativeDate(s.latestWeek);
      var dateParts = s.latestWeek.split('-');
      var compactDate = parseInt(dateParts[1], 10) + '/' + parseInt(dateParts[2], 10);
      html += '<td><span class="staleness-chip staleness-' + rel.tier + '" title="' + esc(formatDateDisplay(s.latestWeek)) + '">' +
        '<span class="staleness-relative">' + esc(rel.text) + '</span>' +
        '<span class="staleness-compact">' + esc(compactDate) + '</span>' +
        '</span></td>';
    } else {
      html += '<td><span class="chip chip-gray">--</span></td>';
    }

    // Case Manager
    var cmName = s.caseManagerEmail ? getCaseManagerName(s.caseManagerEmail) : '';
    html += '<td>' + esc(cmName || '--') + '</td>';

    // Action buttons (icon-only)
    html += '<td><div class="action-btns">' +
      '<button class="action-btn primary" onclick="event.stopPropagation(); startCheckIn(\'' + s.id + '\')" title="Check-In">' +
        '<svg class="action-btn-icon" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>' +
      '</button>' +
      '<button class="action-btn" onclick="event.stopPropagation(); showStudentProfile(\'' + s.id + '\')" title="Student Profile">' +
        '<svg class="action-btn-icon" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>' +
      '</button>' +
      '</div></td>';

    html += '</tr>';
  });

  html += '</tbody></table>';
  html += '<p class="hint" style="margin-top:8px;">Click any row for a quick academic overview.</p>';

  container.innerHTML = html;
  if (!skipAnimation) animateContentIn(container);
}

// ─── Needs Attention Cards (Feature 1 + 10) ───

function renderNeedsAttention(data) {
  var section = document.getElementById('dashboard-needs-attention');
  var content = document.getElementById('needs-attention-content');
  if (!section || !content) return;

  if (!data || data.length === 0) {
    section.style.display = 'none';
    return;
  }

  var flagged = data.filter(function(s) {
    if (s.daysSinceCheckIn != null && s.daysSinceCheckIn >= 7) return true;
    if (s.avgRating != null && s.avgRating < 3) return true;
    if (s.trend === 'down') return true;
    if (s.totalMissing >= 4) return true;
    return false;
  });

  var birthdayStudents = data.filter(function(s) { return isBirthdayToday_(s.birthday); });

  section.style.display = '';

  if (flagged.length === 0 && birthdayStudents.length === 0) {
    content.innerHTML = '<div class="needs-attention-empty">' +
      '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>' +
      'All students on track this week</div>';
    return;
  }

  // Sort by urgency
  flagged.sort(function(a, b) {
    return computeUrgencyScore(b) - computeUrgencyScore(a);
  });

  var html = '<div class="needs-attention-cards">';
  flagged.forEach(function(s) {
    var reasons = [];
    if (s.daysSinceCheckIn != null && s.daysSinceCheckIn >= 7) {
      reasons.push(s.daysSinceCheckIn + 'd no check-in');
    }
    if (s.avgRating != null && s.avgRating < 3) {
      reasons.push('EF ' + s.avgRating.toFixed(1));
    } else if (s.trend === 'down') {
      reasons.push('EF trending down');
    }
    if (s.totalMissing >= 4) {
      reasons.push(s.totalMissing + ' missing');
    }

    var spIdx = (appState.dashboardData || []).indexOf(s);
    html += '<div class="needs-attention-card" role="button" tabindex="0" onclick="openSidePanel(' + spIdx + ')" onkeydown="if(event.key===\'Enter\')openSidePanel(' + spIdx + ')">';
    html += '<div class="needs-attention-name">' + esc(s.firstName + ' ' + s.lastName) + (s.online ? ' <span class="online-badge" title="Online">Online</span>' : '') + buildBirthdayBadge_(s.birthday) + '</div>';
    html += '<div class="needs-attention-reasons">';
    reasons.forEach(function(r) {
      html += '<span class="needs-attention-reason">' + esc(r) + '</span>';
    });
    html += '</div>';
    html += '<button class="needs-attention-action" onclick="event.stopPropagation(); startCheckIn(\'' + s.id + '\')">Check In &#x2192;</button>';
    html += '</div>';
  });

  // Birthday cards for students whose birthday is today
  data.forEach(function(s) {
    if (!isBirthdayToday_(s.birthday)) return;
    html += '<div class="needs-attention-card birthday-card" role="button" tabindex="0" onclick="editStudent(\'' + s.id + '\')" onkeydown="if(event.key===\'Enter\')editStudent(\'' + s.id + '\')">';
    html += '<div class="needs-attention-name">&#x1F382; ' + esc(s.firstName + ' ' + s.lastName) + '</div>';
    html += '<span class="chip-gold birthday-chip">Happy Birthday!</span>';
    html += '<button class="needs-attention-action" onclick="event.stopPropagation(); editStudent(\'' + s.id + '\')">View Profile &#x2192;</button>';
    html += '</div>';
  });

  html += '</div>';
  content.innerHTML = html;
}

// ─── Missing Assignments Aggregate (Feature 7) ───

function renderMissingAggregate(data) {
  var section = document.getElementById('dashboard-missing-section');
  var content = document.getElementById('missing-metric-content');
  if (!section || !content) return;

  if (!data || data.length === 0) {
    section.style.display = 'none';
    return;
  }

  var totalMissing = 0;
  var studentsWithMissing = [];
  data.forEach(function(s) {
    if (s.totalMissing > 0) {
      totalMissing += s.totalMissing;
      studentsWithMissing.push(s);
    }
  });

  if (totalMissing === 0) {
    section.style.display = 'none';
    return;
  }

  studentsWithMissing.sort(function(a, b) { return b.totalMissing - a.totalMissing; });

  section.style.display = '';
  var chipClass = totalMissing >= 10 ? 'chip-red' : totalMissing >= 4 ? 'chip-yellow' : 'chip-green';

  var html = '<div class="eval-metric-card-wrapper">' +
    '<div id="metric-card-missing-agg" class="eval-metric-card eval-metric-card-clickable" onclick="toggleMetricDropdown(\'missing-agg\')" role="button" aria-expanded="false" aria-controls="metric-dropdown-missing-agg">' +
      '<div class="eval-metric-icon">' +
        '<svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>' +
      '</div>' +
      '<div class="eval-metric-info">' +
        '<div class="eval-metric-value"><span class="chip ' + chipClass + '">' + totalMissing + '</span></div>' +
        '<div class="eval-metric-label">Total Missing Assignments</div>' +
      '</div>' +
      '<svg class="eval-metric-chevron" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>' +
    '</div>' +
    '<div id="metric-dropdown-missing-agg" class="eval-metric-dropdown">' +
      '<div class="missing-agg-students">';

  studentsWithMissing.forEach(function(s) {
    html += '<div class="missing-agg-row" role="button" tabindex="0" onclick="event.stopPropagation(); showMissingAssignments(\'' + s.id + '\')" onkeydown="if(event.key===\'Enter\'){event.stopPropagation(); showMissingAssignments(\'' + s.id + '\')}">' +
      '<span>' + esc(s.firstName + ' ' + s.lastName) + (s.online ? ' <span class="online-badge" title="Online">Online</span>' : '') + buildBirthdayBadge_(s.birthday) + '</span>' +
      '<span class="missing-agg-count">' + s.totalMissing + '</span>' +
    '</div>';
  });

  html += '</div></div></div>';
  content.innerHTML = html;
}

// ─── Eval Summary Cards + Next 7 Days Timeline ───

function loadEvalSummary(force) {
  // Skip re-fetch if eval data is fresh (changes infrequently)
  if (!force && _lastEvalSummaryFetch > 0 &&
      (Date.now() - _lastEvalSummaryFetch) < 60000 &&
      appState.evalSummary) {
    renderEvalSummary(appState.evalSummary);
    return;
  }
  google.script.run
    .withSuccessHandler(function(summary) {
      try {
        appState.evalSummary = summary;
        _lastEvalSummaryFetch = Date.now();
        renderEvalSummary(summary);
      } catch(e) {
        hideEvalSections_();
      }
    })
    .withFailureHandler(function() {
      hideEvalSections_();
    })
    .getEvalTaskSummary();

  // Also fetch meetings for timeline meeting-day highlights
  google.script.run
    .withSuccessHandler(function(meetings) {
      appState.dashboardMeetings = meetings || [];
      // Re-render timeline if eval summary already loaded
      if (appState.evalSummary) {
        var atAGlanceContent = document.getElementById('at-a-glance-content');
        if (atAGlanceContent && atAGlanceContent.innerHTML) {
          renderEvalSummary(appState.evalSummary);
        }
      }
    })
    .withFailureHandler(function() {
      appState.dashboardMeetings = [];
    })
    .getAllMeetings();
}

function hideEvalSections_() {
  var a = document.getElementById('dashboard-at-a-glance');
  var b = document.getElementById('dashboard-evals-section');
  if (a) a.style.display = 'none';
  if (b) b.style.display = 'none';
}

function buildMetricCardsHtml_(summary) {
  var html = '<div class="eval-metric-cards">';

  // Due This Week card
  var dtwClickable = summary.dueThisWeekCount > 0 ? ' eval-metric-card-clickable' : '';
  var dtwOnclick = summary.dueThisWeekCount > 0 ? ' onclick="toggleMetricDropdown(\'due-this-week\')"' : '';
  html += '<div class="eval-metric-card-wrapper">' +
    '<div class="eval-metric-card' + dtwClickable + '"' + dtwOnclick +
      ' role="button" tabindex="0" aria-expanded="false" id="metric-card-due-this-week">' +
    '<div class="eval-metric-icon">' +
      '<svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">' +
        '<path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM9 10H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2z"/>' +
      '</svg>' +
    '</div>' +
    '<div class="eval-metric-info">' +
      '<span class="eval-metric-label">Due This Week</span>' +
      '<span class="eval-metric-value">' + summary.dueThisWeekCount + '</span>' +
    '</div>' +
    (summary.dueThisWeekCount > 0 ? '<svg class="eval-metric-chevron" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>' : '') +
  '</div>' +
  '<div class="eval-metric-dropdown" id="metric-dropdown-due-this-week">' +
    buildMetricTaskList_(summary.dueThisWeekTasks || [], 'due') +
  '</div></div>';

  // Overdue card
  var overdueClass = summary.overdueCount > 0 ? ' eval-metric-card-alert' : '';
  var ovClickable = summary.overdueCount > 0 ? ' eval-metric-card-clickable' : '';
  var ovOnclick = summary.overdueCount > 0 ? ' onclick="toggleMetricDropdown(\'overdue\')"' : '';
  html += '<div class="eval-metric-card-wrapper">' +
    '<div class="eval-metric-card' + overdueClass + ovClickable + '"' + ovOnclick +
      ' role="button" tabindex="0" aria-expanded="false" id="metric-card-overdue">' +
    '<div class="eval-metric-icon' + (summary.overdueCount > 0 ? ' eval-metric-icon-alert' : '') + '">' +
      '<svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">' +
        '<path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>' +
      '</svg>' +
    '</div>' +
    '<div class="eval-metric-info">' +
      '<span class="eval-metric-label">Overdue</span>' +
      '<span class="eval-metric-value' + (summary.overdueCount > 0 ? ' eval-metric-value-alert' : '') + '">' + summary.overdueCount + '</span>' +
    '</div>' +
    (summary.overdueCount > 0 ? '<svg class="eval-metric-chevron" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>' : '') +
  '</div>' +
  '<div class="eval-metric-dropdown" id="metric-dropdown-overdue">' +
    buildMetricTaskList_(summary.overdueTasks || [], 'overdue') +
  '</div></div>';

  html += '</div>';
  return html;
}

function buildMetricTaskList_(tasks, type) {
  if (!tasks.length) return '<div class="eval-metric-dropdown-empty">No tasks</div>';
  var html = '';
  tasks.forEach(function(task) {
    var dateLabel = '';
    if (task.dueDate) {
      var parts = task.dueDate.split('-');
      dateLabel = parseInt(parts[1], 10) + '/' + parseInt(parts[2], 10);
    }
    html += '<div class="eval-metric-dropdown-item" onclick="navigateToEvalTask(\'' + esc(task.studentId) + '\')" ' +
      'role="link" tabindex="0">' +
      '<div class="eval-metric-dropdown-item-main">' +
        '<span class="eval-metric-dropdown-item-text">' + esc(task.text) + '</span>' +
        (dateLabel ? '<span class="eval-metric-dropdown-item-date' +
          (type === 'overdue' ? ' eval-metric-dropdown-item-date-overdue' : '') + '">' + dateLabel + '</span>' : '') +
      '</div>' +
      '<span class="eval-metric-dropdown-item-student">' + esc(task.studentName) + '</span>' +
    '</div>';
  });
  return html;
}

function toggleMetricDropdown(key) {
  var card = document.getElementById('metric-card-' + key);
  var dropdown = document.getElementById('metric-dropdown-' + key);
  if (!card || !dropdown) return;

  var isOpen = dropdown.classList.contains('eval-metric-dropdown-open');

  // Close all open dropdowns first
  var allDropdowns = document.querySelectorAll('.eval-metric-dropdown-open');
  var allCards = document.querySelectorAll('.eval-metric-card[aria-expanded="true"]');
  for (var i = 0; i < allDropdowns.length; i++) {
    allDropdowns[i].classList.remove('eval-metric-dropdown-open');
  }
  for (var j = 0; j < allCards.length; j++) {
    allCards[j].setAttribute('aria-expanded', 'false');
  }

  if (!isOpen) {
    dropdown.classList.add('eval-metric-dropdown-open');
    card.setAttribute('aria-expanded', 'true');
  }
}

function buildTimelineHtml_(summary) {
  var html = '<div class="eval-timeline-strip">';
  html += '<div class="eval-timeline-header">' +
    '<span class="eval-timeline-title">Next 7 Days</span>' +
  '</div>';

  html += '<div class="eval-timeline-days">';

  // Build meeting date lookup for tertiary highlights
  var meetingsByDate = {};
  (appState.dashboardMeetings || []).forEach(function(m) {
    if (m.date) {
      if (!meetingsByDate[m.date]) meetingsByDate[m.date] = [];
      meetingsByDate[m.date].push(m);
    }
  });

  summary.timeline.forEach(function(day, idx) {
    var isToday = (idx === 0);
    var isWeekend = (day.dayOfWeek === 0 || day.dayOfWeek === 6);
    var isExpanded = (appState.timelineExpandedDay === idx);
    var hasTasks = day.tasks.length > 0;
    var dayMeetings = meetingsByDate[day.date] || [];
    var hasMeeting = dayMeetings.length > 0;

    var dayClass = 'eval-timeline-day';
    if (isToday) dayClass += ' eval-timeline-today';
    if (isWeekend) dayClass += ' eval-timeline-weekend';
    if (isExpanded) dayClass += ' eval-timeline-day-expanded';
    if (hasMeeting) dayClass += ' eval-timeline-meeting';

    html += '<button class="' + dayClass + '" onclick="toggleTimelineDay(' + idx + ')">';
    html += '<span class="eval-timeline-day-abbr">' + (isToday ? 'Today' : esc(day.dayAbbr)) + '</span>';
    html += '<span class="eval-timeline-day-num">' + day.dayNum + '</span>';

    if (hasTasks) {
      html += '<div class="eval-timeline-dots">';
      var dotCount = Math.min(day.tasks.length, 3);
      for (var d = 0; d < dotCount; d++) {
        html += '<span class="eval-timeline-dot"></span>';
      }
      if (day.tasks.length > 3) {
        html += '<span class="eval-timeline-dot-more">+' + (day.tasks.length - 3) + '</span>';
      }
      html += '</div>';
    }

    if (hasMeeting) {
      html += '<span class="eval-timeline-meeting-badge" title="IEP Meeting">' + dayMeetings.length + '</span>';
    }

    html += '</button>';
  });
  html += '</div>';

  // Expanded day details
  if (appState.timelineExpandedDay !== null) {
    var expandedDay = summary.timeline[appState.timelineExpandedDay];
    if (expandedDay && expandedDay.tasks.length > 0) {
      var isExpandedToday = (appState.timelineExpandedDay === 0);
      var dayLabel = isExpandedToday ? 'Today' : (esc(expandedDay.dayAbbr) + ', ' + esc(expandedDay.monthShort) + ' ' + expandedDay.dayNum);
      html += '<div class="eval-timeline-detail">';
      html += '<div class="eval-timeline-detail-header">' +
        dayLabel +
        ' <span class="eval-timeline-detail-count">' + expandedDay.tasks.length + ' task' + (expandedDay.tasks.length !== 1 ? 's' : '') + '</span>' +
      '</div>';

      expandedDay.tasks.forEach(function(task) {
        var typeLabel = getEvalTypeLabel(task.evalType);
        html += '<div class="eval-timeline-task" role="button" tabindex="0" onclick="navigateToEvalTask(\'' + esc(task.studentId) + '\', \'' + esc(task.itemId || '') + '\')" onkeydown="if(event.key===\'Enter\')navigateToEvalTask(\'' + esc(task.studentId) + '\', \'' + esc(task.itemId || '') + '\')">' +
          '<span class="eval-timeline-task-dot"></span>' +
          '<div class="eval-timeline-task-info">' +
            '<span class="eval-timeline-task-text">' + esc(task.text) + '</span>' +
            '<span class="eval-timeline-task-student">' + esc(task.studentName) + ' &middot; ' + esc(typeLabel) + '</span>' +
          '</div>' +
        '</div>';
      });

      html += '</div>';
    } else if (expandedDay) {
      var emptyLabel = (appState.timelineExpandedDay === 0) ? 'today' : (esc(expandedDay.dayAbbr) + ', ' + esc(expandedDay.monthShort) + ' ' + expandedDay.dayNum);
      html += '<div class="eval-timeline-detail eval-timeline-detail-empty">' +
        '<span>No tasks due ' + emptyLabel + '</span>' +
      '</div>';
    }
  }

  html += '</div>';
  return html;
}

function buildEvalCarouselHtml_(activeEvals) {
  var now = new Date();
  var today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  var todayStr = today.getFullYear() + '-' +
    String(today.getMonth() + 1).padStart(2, '0') + '-' +
    String(today.getDate()).padStart(2, '0');
  var monthAbbrs = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

  var html = '<div class="eval-cards-carousel">';
  activeEvals.forEach(function(ev) {
    var pct = ev.total > 0 ? Math.round(ev.done / ev.total * 100) : 0;
    var alertClass = ev.overdueCount > 0 ? ' eval-carousel-card-alert' : '';

    // Build next due date label
    var dueLine = '';
    if (ev.nextDueDate) {
      var parts = ev.nextDueDate.split('-');
      var dueLabel = monthAbbrs[parseInt(parts[1], 10) - 1] + ' ' + parseInt(parts[2], 10);
      if (ev.nextDueDate < todayStr) {
        dueLine = '<span class="eval-carousel-card-due eval-carousel-card-due-overdue">Overdue since ' + dueLabel + '</span>';
      } else if (ev.nextDueDate === todayStr) {
        dueLine = '<span class="eval-carousel-card-due eval-carousel-card-due-today">Due today</span>';
      } else {
        dueLine = '<span class="eval-carousel-card-due">Next: ' + dueLabel + '</span>';
      }
    }

    html += '<div class="eval-carousel-card' + alertClass + '" role="button" tabindex="0" onclick="navigateToEvalTask(\'' + esc(ev.studentId) + '\')" onkeydown="if(event.key===\'Enter\')navigateToEvalTask(\'' + esc(ev.studentId) + '\')" aria-label="' + esc(ev.studentName) + ', ' + esc(getEvalTypeLabel(ev.type)) + ', ' + pct + '% complete' + (ev.overdueCount > 0 ? ', ' + ev.overdueCount + ' overdue' : '') + '">' +
      '<div class="eval-carousel-card-name">' + esc(ev.studentName) + '</div>' +
      '<div class="eval-carousel-card-type"><span class="eval-badge" data-eval-type="' + esc(ev.type) + '">' + esc(getEvalTypeLabel(ev.type)) + '</span></div>' +
      '<div class="eval-carousel-card-progress">' +
        '<div class="eval-carousel-bar"><div class="eval-carousel-bar-fill" style="width:' + pct + '%"></div></div>' +
        '<span class="eval-carousel-card-pct">' + ev.done + '/' + ev.total + '</span>' +
      '</div>' +
      dueLine +
      (ev.overdueCount > 0 ? '<span class="eval-carousel-card-overdue">' + ev.overdueCount + ' overdue</span>' : '') +
    '</div>';
  });
  html += '</div>';
  return html;
}

function renderEvalSummary(summary) {
  var activeEvals = summary.activeEvals || [];

  // ── At a Glance section: metric cards + timeline ──
  var atAGlanceEl = document.getElementById('dashboard-at-a-glance');
  var atAGlanceContent = document.getElementById('at-a-glance-content');
  var hasMetrics = summary.dueThisWeekCount > 0 || summary.overdueCount > 0 ||
    summary.timeline.some(function(d) { return d.tasks.length > 0; });

  if (atAGlanceEl && atAGlanceContent) {
    if (hasMetrics) {
      atAGlanceEl.style.display = '';
      atAGlanceContent.innerHTML = buildMetricCardsHtml_(summary) + buildTimelineHtml_(summary);
      animateContentIn(atAGlanceContent);
    } else {
      atAGlanceEl.style.display = 'none';
    }
  }

  // ── Evals section: individual eval cards carousel ──
  var evalsEl = document.getElementById('dashboard-evals-section');
  var evalsContent = document.getElementById('evals-section-content');
  if (evalsEl && evalsContent) {
    if (activeEvals.length > 0) {
      evalsEl.style.display = '';
      evalsContent.innerHTML = buildEvalCarouselHtml_(activeEvals);
      animateContentIn(evalsContent);
    } else {
      evalsEl.style.display = 'none';
    }
  }
}

// ─── Due Process View ───

function showDueProcess() {
  document.querySelectorAll('.nav-drawer-item').forEach(function(t) { t.classList.remove('active'); });
  document.querySelectorAll('.nav-drawer-child').forEach(function(t) { t.classList.remove('active'); });
  var dpItem = document.getElementById('drawer-dueprocess');
  if (dpItem) dpItem.classList.add('active');
  closeNavDrawerIfMobile_();

  appState.dueProcessExpandedDay = null;
  appState.dueProcessCalendarWeeks = 1;
  appState.dueProcessProgressFilter = 'all';
  appState.dueProcessProgressViewMode = 'grouped';
  appState.dueProcessGoalAreaFilters = [];
  appState.dueProcessExpandedStudents = {};
  appState.dueProcessCompletedCollapsed = false;
  // Keep dueProcessQuarter across visits (don't reset)

  showView('dueprocess-view');

  // Reuse cached data if fresh
  if (appState.dueProcessData && _lastDueProcessFetch > 0 &&
      (Date.now() - _lastDueProcessFetch) < DATA_FRESH_MS) {
    try { renderDueProcess(appState.dueProcessData); }
    catch(e) { showToast('Error rendering Due Process: ' + e.message); }
    return;
  }

  var container = document.getElementById('dueprocess-content');
  if (container) container.innerHTML = buildDueProcessSkeleton_();

  google.script.run
    .withSuccessHandler(function(data) {
      if (_currentViewId !== 'dueprocess-view') return;
      appState.dueProcessData = data;
      _lastDueProcessFetch = Date.now();
      try { renderDueProcess(data); }
      catch(e) { showToast('Error rendering Due Process: ' + e.message); }
    })
    .withFailureHandler(function(err) {
      var container = document.getElementById('dueprocess-content');
      if (container) container.innerHTML = renderErrorState(err && err.message ? err.message : String(err));
    })
    .getDueProcessData(appState.dueProcessQuarter);
}

function refreshDueProcess() {
  _lastDueProcessFetch = 0;
  showDueProcess();
}

function buildDueProcessSkeleton_() {
  // 1. Summary stats row — 4 metric cards
  var html = '<div class="dp-section"><div class="dp-summary-row">';
  for (var i = 0; i < 4; i++) {
    html += '<div class="eval-metric-card-wrapper">' +
      '<div class="skeleton-card" style="display:flex;align-items:center;gap:12px;padding:16px;margin-bottom:0;">' +
        '<div class="skeleton" style="width:48px;height:48px;border-radius:var(--md-shape-md);flex-shrink:0;"></div>' +
        '<div style="flex:1;">' +
          '<div class="skeleton skeleton-text w-50" style="margin-bottom:6px;"></div>' +
          '<div class="skeleton" style="width:40px;height:24px;border-radius:var(--md-shape-xs);"></div>' +
        '</div>' +
      '</div></div>';
  }
  html += '</div></div>';

  // 2. Evaluations in Progress — section title + 3 carousel cards
  html += '<div class="dp-section">' +
    '<div class="skeleton skeleton-heading" style="width:200px;"></div>' +
    '<div style="display:flex;gap:12px;overflow:hidden;">';
  for (var j = 0; j < 3; j++) {
    html += '<div class="skeleton-card" style="min-width:200px;flex-shrink:0;margin-bottom:0;">' +
      '<div class="skeleton skeleton-text w-75" style="margin-bottom:8px;"></div>' +
      '<div class="skeleton skeleton-text w-50" style="margin-bottom:8px;"></div>' +
      '<div class="skeleton" style="width:100%;height:6px;border-radius:var(--md-shape-full);"></div>' +
    '</div>';
  }
  html += '</div></div>';

  // 3. At a Glance — section title + 5 calendar day buttons
  html += '<div class="dp-section">' +
    '<div class="skeleton skeleton-heading" style="width:130px;"></div>' +
    '<div style="display:flex;gap:8px;">';
  for (var k = 0; k < 5; k++) {
    html += '<div class="skeleton" style="flex:1;height:72px;border-radius:var(--md-shape-md);"></div>';
  }
  html += '</div></div>';

  // 4. Progress Reports — header row with quarter buttons + progress bar + 2 student cards
  html += '<div class="dp-section">' +
    '<div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">' +
      '<div class="skeleton skeleton-heading" style="width:160px;margin-bottom:0;"></div>' +
      '<div style="display:flex;gap:6px;margin-left:auto;">';
  for (var q = 0; q < 4; q++) {
    html += '<div class="skeleton skeleton-btn" style="width:40px;"></div>';
  }
  html += '</div></div>' +
    '<div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">' +
      '<div class="skeleton skeleton-text w-25" style="margin-bottom:0;"></div>' +
      '<div class="skeleton" style="flex:1;height:8px;border-radius:var(--md-shape-full);"></div>' +
    '</div>' +
    '<div style="display:flex;gap:8px;margin-bottom:16px;">';
  for (var f = 0; f < 3; f++) {
    html += '<div class="skeleton skeleton-chip"></div>';
  }
  html += '</div>';
  for (var s = 0; s < 2; s++) {
    html += '<div class="skeleton-card">' +
      '<div class="skeleton skeleton-text w-40" style="margin-bottom:10px;"></div>' +
      '<div class="skeleton skeleton-text w-75"></div>' +
      '<div class="skeleton skeleton-text w-50"></div>' +
    '</div>';
  }
  html += '</div>';

  return html;
}

// ── Create Checklist Modal (FAB) ──

function openCreateChecklistModal() {
  var activeEvalStudentIds = {};
  var evalSrc = appState.dueProcessData && appState.dueProcessData.evalSummary
    ? appState.dueProcessData.evalSummary.activeEvals
    : (appState.evalSummary ? appState.evalSummary.activeEvals : []);
  (evalSrc || []).forEach(function(ev) {
    activeEvalStudentIds[ev.studentId] = getEvalTypeLabel(ev.type);
  });

  var hasStudents = appState.dashboardData && appState.dashboardData.length > 0;

  var bodyHtml;
  if (!hasStudents) {
    bodyHtml = '<div class="ccm-body"><div class="ccm-loading">Loading students&#x2026;</div></div>';
  } else {
    bodyHtml = buildCreateChecklistModalBody_(activeEvalStudentIds);
  }

  var overlay = document.createElement('div');
  overlay.className = 'confirm-overlay';
  overlay.id = 'ccm-overlay';
  overlay.innerHTML =
    '<div class="confirm-dialog" style="max-width:480px;">' +
      '<h3>Create Checklist</h3>' +
      '<div id="ccm-body-container">' + bodyHtml + '</div>' +
      '<div class="confirm-actions">' +
        '<button class="btn btn-outlined" onclick="closeConfirmDialog(this.closest(\'.confirm-overlay\'))">Cancel</button>' +
        '<button class="btn" id="ccm-create-btn" disabled onclick="handleCreateChecklistModalSubmit()">Create</button>' +
      '</div>' +
    '</div>';
  document.body.appendChild(overlay);

  if (!hasStudents) {
    google.script.run
      .withSuccessHandler(function(data) {
        appState.dashboardData = data || [];
        _lastDashboardFetch = Date.now();
        var container = document.getElementById('ccm-body-container');
        if (!container) return;
        container.innerHTML = buildCreateChecklistModalBody_(activeEvalStudentIds);
        var input = document.getElementById('ccm-search');
        if (input) input.focus();
      })
      .withFailureHandler(function() {
        var container = document.getElementById('ccm-body-container');
        if (!container) return;
        container.innerHTML = '<div class="ccm-body"><p style="color:var(--md-error);">Failed to load students.</p></div>';
      })
      .getDashboardData();
  } else {
    setTimeout(function() {
      var input = document.getElementById('ccm-search');
      if (input) input.focus();
    }, 50);
  }
}

function buildCreateChecklistModalBody_(activeEvalStudentIds) {
  _ccmSelectedStudentId = null;
  _ccmSelectedType = null;
  _ccmActiveEvalStudentIds = activeEvalStudentIds;

  var html = '<div class="ccm-body">';

  html += '<div class="ccm-search-wrap">' +
    '<svg class="ccm-search-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>' +
    '<input type="text" id="ccm-search" class="ccm-search-input" placeholder="Search for a student&#x2026;" oninput="filterCCMStudents(this.value)" autocomplete="off">' +
  '</div>';

  html += '<div id="ccm-student-list" class="ccm-student-list" role="listbox" aria-label="Students">';
  html += buildCCMStudentListHtml_('');
  html += '</div>';

  html += '<div class="ccm-type-selector">' +
    '<span class="ccm-type-label">Checklist type</span>' +
    '<div class="ccm-type-chips">';
  EVAL_TYPES.forEach(function(et) {
    html += '<button class="ccm-type-chip" data-type="' + esc(et.value) + '" ' +
      'onclick="selectCCMType(this, \'' + esc(et.value) + '\')" ' +
      'aria-pressed="false">' + esc(et.label) + '</button>';
  });
  html += '</div></div>';

  html += '<div id="ccm-summary" class="ccm-selected-summary"></div>';
  html += '</div>';
  return html;
}

function buildCCMStudentListHtml_(query) {
  var students = (appState.dashboardData || []).slice();
  students.sort(function(a, b) {
    var cmp = (a.lastName || '').localeCompare(b.lastName || '');
    return cmp !== 0 ? cmp : (a.firstName || '').localeCompare(b.firstName || '');
  });

  if (query) {
    var q = query.toLowerCase();
    students = students.filter(function(s) {
      var full = ((s.firstName || '') + ' ' + (s.lastName || '')).toLowerCase();
      return full.indexOf(q) !== -1;
    });
  }

  if (students.length === 0) {
    return '<div class="ccm-no-results">No students found</div>';
  }

  var html = '';
  students.forEach(function(s) {
    var hasEval = _ccmActiveEvalStudentIds[s.id];
    var evalClass = hasEval ? ' ccm-student-has-eval' : '';
    var selectedClass = (s.id === _ccmSelectedStudentId) ? ' ccm-student-selected' : '';
    var onclick = hasEval ? '' : ' onclick="selectCCMStudent(\'' + esc(s.id) + '\')"';
    var ariaDisabled = hasEval ? ' aria-disabled="true"' : '';

    html += '<div class="ccm-student-item' + evalClass + selectedClass + '"' +
      onclick + ariaDisabled +
      ' role="option" aria-selected="' + (s.id === _ccmSelectedStudentId ? 'true' : 'false') + '"' +
      (hasEval ? '' : ' tabindex="0" onkeydown="if(event.key===\'Enter\')selectCCMStudent(\'' + esc(s.id) + '\')"') +
      '>' +
      '<span class="ccm-student-name">' + esc(s.lastName) + ', ' + esc(s.firstName) + '</span>' +
      (s.grade ? '<span class="ccm-student-grade">Gr. ' + esc(String(s.grade)) + '</span>' : '') +
      (hasEval ? '<span class="ccm-student-eval-badge">' + esc(hasEval) + '</span>' : '') +
    '</div>';
  });
  return html;
}

function filterCCMStudents(query) {
  if (_ccmSearchTimer) clearTimeout(_ccmSearchTimer);
  _ccmSearchTimer = setTimeout(function() {
    var listEl = document.getElementById('ccm-student-list');
    if (!listEl) return;
    listEl.innerHTML = buildCCMStudentListHtml_(query.trim());
  }, 150);
}

function selectCCMStudent(studentId) {
  _ccmSelectedStudentId = studentId;
  var searchEl = document.getElementById('ccm-search');
  var query = searchEl ? searchEl.value.trim() : '';
  var listEl = document.getElementById('ccm-student-list');
  if (listEl) listEl.innerHTML = buildCCMStudentListHtml_(query);
  updateCCMSummaryAndButton_();
}

function selectCCMType(chipEl, type) {
  _ccmSelectedType = type;
  var chips = chipEl.parentElement.querySelectorAll('.ccm-type-chip');
  chips.forEach(function(c) {
    c.classList.remove('ccm-type-selected');
    c.setAttribute('aria-pressed', 'false');
  });
  chipEl.classList.add('ccm-type-selected');
  chipEl.setAttribute('aria-pressed', 'true');
  updateCCMSummaryAndButton_();
}

function updateCCMSummaryAndButton_() {
  var createBtn = document.getElementById('ccm-create-btn');
  var summaryEl = document.getElementById('ccm-summary');
  var ready = _ccmSelectedStudentId && _ccmSelectedType;

  if (createBtn) createBtn.disabled = !ready;

  if (summaryEl) {
    if (ready) {
      var student = getStudentById(_ccmSelectedStudentId);
      var name = student ? (student.firstName + ' ' + student.lastName) : 'Student';
      var typeLabel = getEvalTypeLabel(_ccmSelectedType);
      summaryEl.textContent = name + ' \u2014 ' + typeLabel;
    } else {
      summaryEl.textContent = '';
    }
  }
}

function handleCreateChecklistModalSubmit() {
  if (!_ccmSelectedStudentId || !_ccmSelectedType) return;

  var overlay = document.getElementById('ccm-overlay');
  if (overlay) closeConfirmDialog(overlay);

  doCreateEvalChecklist(_ccmSelectedStudentId, _ccmSelectedType);
}

function renderDueProcess(data) {
  var container = document.getElementById('dueprocess-content');
  if (!container) return;
  var html = '';
  html += buildDPSummarySection_(data);
  html += buildDPEvalsSection_(data.evalSummary);
  html += buildDPCalendarSection_(data);
  html += buildDPProgressSection_(data);
  container.innerHTML = html;
  animateContentIn(container);
}

// ── Summary Stats Row ──

function buildDPSummarySection_(data) {
  var evalSummary = data.evalSummary || {};
  var overdueCount = evalSummary.overdueCount || 0;
  var dueThisWeekCount = evalSummary.dueThisWeekCount || 0;
  var meetingsThisWeek = data.meetingsThisWeek || [];
  var completionMap = data.completionMap || {};
  var assignments = data.progressAssignments || [];

  // Compute progress totals
  var progressStudents = {};
  assignments.forEach(function(a) { progressStudents[a.studentId] = true; });
  var studentIds = Object.keys(progressStudents);
  var totalStudents = studentIds.length;
  var doneStudents = 0;
  studentIds.forEach(function(sid) {
    var comp = completionMap[sid];
    if (comp && comp.allDone) doneStudents++;
  });

  var html = '<div class="dp-section"><div class="dp-summary-row">';

  // 1. Overdue Tasks
  var ovClickable = overdueCount > 0 ? ' eval-metric-card-clickable' : '';
  var ovAlert = overdueCount > 0 ? ' eval-metric-card-alert' : '';
  var ovOnclick = overdueCount > 0 ? ' onclick="toggleMetricDropdown(\'dp-overdue\')"' : '';
  html += '<div class="eval-metric-card-wrapper">' +
    '<div class="eval-metric-card' + ovAlert + ovClickable + '"' + ovOnclick +
      ' role="button" tabindex="0" aria-expanded="false" id="metric-card-dp-overdue">' +
    '<div class="eval-metric-icon' + (overdueCount > 0 ? ' eval-metric-icon-alert' : '') + '">' +
      '<svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">' +
        '<path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>' +
      '</svg>' +
    '</div>' +
    '<div class="eval-metric-info">' +
      '<span class="eval-metric-label">Overdue</span>' +
      '<span class="eval-metric-value' + (overdueCount > 0 ? ' eval-metric-value-alert' : '') + '">' + overdueCount + '</span>' +
    '</div>' +
    (overdueCount > 0 ? '<svg class="eval-metric-chevron" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>' : '') +
  '</div>' +
  '<div class="eval-metric-dropdown" id="metric-dropdown-dp-overdue">' +
    buildMetricTaskList_(evalSummary.overdueTasks || [], 'overdue') +
  '</div></div>';

  // 2. Due This Week
  var dtwClickable = dueThisWeekCount > 0 ? ' eval-metric-card-clickable' : '';
  var dtwOnclick = dueThisWeekCount > 0 ? ' onclick="toggleMetricDropdown(\'dp-due-week\')"' : '';
  html += '<div class="eval-metric-card-wrapper">' +
    '<div class="eval-metric-card' + dtwClickable + '"' + dtwOnclick +
      ' role="button" tabindex="0" aria-expanded="false" id="metric-card-dp-due-week">' +
    '<div class="eval-metric-icon">' +
      '<svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">' +
        '<path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM9 10H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2z"/>' +
      '</svg>' +
    '</div>' +
    '<div class="eval-metric-info">' +
      '<span class="eval-metric-label">Due This Week</span>' +
      '<span class="eval-metric-value">' + dueThisWeekCount + '</span>' +
    '</div>' +
    (dueThisWeekCount > 0 ? '<svg class="eval-metric-chevron" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>' : '') +
  '</div>' +
  '<div class="eval-metric-dropdown" id="metric-dropdown-dp-due-week">' +
    buildMetricTaskList_(evalSummary.dueThisWeekTasks || [], 'due') +
  '</div></div>';

  // 3. Meetings This Week
  var mtgCount = meetingsThisWeek.length;
  var mtgClickable = mtgCount > 0 ? ' eval-metric-card-clickable' : '';
  var mtgOnclick = mtgCount > 0 ? ' onclick="toggleMetricDropdown(\'dp-meetings\')"' : '';
  html += '<div class="eval-metric-card-wrapper">' +
    '<div class="eval-metric-card' + mtgClickable + '"' + mtgOnclick +
      ' role="button" tabindex="0" aria-expanded="false" id="metric-card-dp-meetings">' +
    '<div class="eval-metric-icon dp-metric-icon-meetings">' +
      '<svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">' +
        '<path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>' +
      '</svg>' +
    '</div>' +
    '<div class="eval-metric-info">' +
      '<span class="eval-metric-label">Meetings This Week</span>' +
      '<span class="eval-metric-value">' + mtgCount + '</span>' +
    '</div>' +
    (mtgCount > 0 ? '<svg class="eval-metric-chevron" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>' : '') +
  '</div>' +
  '<div class="eval-metric-dropdown" id="metric-dropdown-dp-meetings">' +
    buildDPMeetingsDropdownList_(meetingsThisWeek) +
  '</div></div>';

  // 4. Progress Reports
  var pctDone = totalStudents > 0 ? Math.round(doneStudents / totalStudents * 100) : 0;
  html += '<div class="eval-metric-card-wrapper">' +
    '<div class="eval-metric-card" role="group" id="metric-card-dp-progress">' +
    '<div class="eval-metric-icon dp-metric-icon-progress">' +
      '<svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">' +
        '<path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>' +
      '</svg>' +
    '</div>' +
    '<div class="eval-metric-info">' +
      '<span class="eval-metric-label">Progress Reports</span>' +
      '<span class="eval-metric-value">' + doneStudents + '/' + totalStudents + '</span>' +
    '</div>' +
  '</div>' +
  '</div></div>';

  html += '</div></div>';
  return html;
}

function buildDPMeetingsDropdownList_(meetings) {
  if (!meetings.length) return '<div class="eval-metric-dropdown-empty">No meetings this week</div>';
  var html = '';
  meetings.forEach(function(m) {
    var dateLabel = '';
    if (m.date) {
      var parts = m.date.split('-');
      dateLabel = parseInt(parts[1], 10) + '/' + parseInt(parts[2], 10);
    }
    html += '<div class="eval-metric-dropdown-item" onclick="showStudentProfile(\'' + esc(m.studentId) + '\')" ' +
      'role="link" tabindex="0">' +
      '<div class="eval-metric-dropdown-item-main">' +
        '<span class="eval-metric-dropdown-item-text">' + esc(m.meetingType) + '</span>' +
        '<span class="eval-metric-dropdown-item-date">' + dateLabel + '</span>' +
      '</div>' +
      '<span class="eval-metric-dropdown-item-student">' + esc(m.studentName) +
      (m.notes ? ' &#x00B7; ' + esc(m.notes) : '') + '</span>' +
    '</div>';
  });
  return html;
}

// ── Section 1: Evaluations in Progress ──

function buildDPEvalsSection_(evalSummary) {
  var activeEvals = (evalSummary && evalSummary.activeEvals) || [];

  var html = '<div class="dp-section">';
  html += '<h2 class="dp-section-header">Evaluations in Progress</h2>';

  if (activeEvals.length === 0) {
    html += '<p class="dp-empty-state">No active evaluations.</p>';
    html += '</div>';
    return html;
  }

  html += buildEvalCarouselHtml_(activeEvals);
  html += '</div>';
  return html;
}

// ── Section 2: Calendar (Week / Month at a Glance) ──

function buildDPCalendarDays_(data) {
  var meetings = data.meetings || [];
  var evalSummary = data.evalSummary || {};
  var timeline = evalSummary.timeline || [];
  var numWeeks = 4; // Always generate 4 weeks; CSS controls visibility

  var now = new Date();
  var today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  var todayStr = today.getFullYear() + '-' +
    String(today.getMonth() + 1).padStart(2, '0') + '-' +
    String(today.getDate()).padStart(2, '0');
  var dayAbbrs = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  var monthAbbrs = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

  // Find Monday of the current week
  var dow = today.getDay();
  var mondayOffset = (dow === 0) ? -6 : 1 - dow;
  var monday = new Date(today.getTime() + mondayOffset * 86400000);

  // Build M-F day objects for numWeeks weeks
  var days = [];
  for (var w = 0; w < numWeeks; w++) {
    for (var d = 0; d < 5; d++) {
      var dayDate = new Date(monday.getTime() + (w * 7 + d) * 86400000);
      var dateStr = dayDate.getFullYear() + '-' +
        String(dayDate.getMonth() + 1).padStart(2, '0') + '-' +
        String(dayDate.getDate()).padStart(2, '0');
      days.push({
        date: dateStr,
        dayOfWeek: dayDate.getDay(),
        dayAbbr: dayAbbrs[dayDate.getDay()],
        dayNum: dayDate.getDate(),
        monthShort: monthAbbrs[dayDate.getMonth()],
        isToday: dateStr === todayStr,
        tasks: [],
        meetings: []
      });
    }
  }

  // Map timeline tasks and meetings to days
  var dateMap = {};
  days.forEach(function(day, idx) { dateMap[day.date] = idx; });

  timeline.forEach(function(tDay) {
    var idx = dateMap[tDay.date];
    if (idx !== undefined) days[idx].tasks = tDay.tasks || [];
  });

  meetings.forEach(function(m) {
    var idx = dateMap[m.date];
    if (idx !== undefined) days[idx].meetings.push(m);
  });

  return { days: days, dateMap: dateMap, monthAbbrs: monthAbbrs };
}

function buildDPCalendarSection_(data) {
  var expanded = appState.dueProcessCalendarWeeks > 1;
  var result = buildDPCalendarDays_(data);
  var days = result.days;
  var dateMap = result.dateMap;

  var html = '<div class="dp-section" id="dp-calendar-section">';
  html += '<div class="dp-calendar-header">';
  html += '<h2 class="dp-section-header">At a Glance</h2>';
  html += '<button class="btn btn-sm" id="dp-cal-toggle-btn" onclick="toggleDPCalendarRange()">' +
    (expanded ? 'This Week' : 'Show 4 Weeks') + '</button>';
  html += '</div>';

  // Always render all 4 weeks; weeks 2-4 in a collapsible wrapper
  var stripClass = 'dp-calendar-strip dp-calendar-30';
  html += '<div class="' + stripClass + '">';

  // Week 1 (always visible)
  var week1 = days.slice(0, 5);
  html += '<div class="dp-calendar-days' + (expanded ? ' dp-calendar-days-sm' : '') + '" id="dp-cal-week1">';
  html += buildDPCalendarDaysHtml_(week1);
  html += '</div>';

  // Weeks 2-4 (collapsible)
  html += '<div class="dp-calendar-extra' + (expanded ? ' dp-calendar-extra-open' : '') + '" id="dp-cal-extra">';
  for (var w = 1; w < 4; w++) {
    var weekDays = days.slice(w * 5, (w + 1) * 5);
    if (weekDays.length === 0) break;
    if (weekDays[0].dayNum <= 7) {
      html += '<div class="dp-calendar-month-label">' + esc(weekDays[0].monthShort) + '</div>';
    }
    html += '<div class="dp-calendar-days dp-calendar-days-sm">';
    html += buildDPCalendarDaysHtml_(weekDays);
    html += '</div>';
  }
  html += '</div>';
  html += '</div>';

  // Expanded day details
  if (appState.dueProcessExpandedDay !== null) {
    var expandedIdx = dateMap[appState.dueProcessExpandedDay];
    if (expandedIdx !== undefined) {
      html += buildDPExpandedDayHtml_(days[expandedIdx]);
    }
  }

  // Upcoming meetings list (all meetings within the calendar range)
  html += buildDPUpcomingMeetingsList_(data.meetings || [], days);

  html += '</div>';
  return html;
}

function buildDPCalendarDaysHtml_(days) {
  var html = '';
  days.forEach(function(day) {
    var hasMeeting = day.meetings.length > 0;
    var hasTasks = day.tasks.length > 0;
    var isExpanded = (appState.dueProcessExpandedDay === day.date);

    var dayClass = 'dp-cal-day';
    if (day.isToday) dayClass += ' dp-cal-today';
    if (hasMeeting) dayClass += ' dp-cal-meeting';
    if (isExpanded) dayClass += ' dp-cal-expanded';

    html += '<button class="' + dayClass + '" onclick="toggleDPDay(\'' + day.date + '\')" ' +
      'aria-label="' + esc(day.dayAbbr) + ' ' + day.dayNum + (hasMeeting ? ', IEP meeting' : '') +
      (hasTasks ? ', ' + day.tasks.length + ' task' + (day.tasks.length !== 1 ? 's' : '') : '') + '">';
    html += '<span class="dp-cal-day-abbr">' + (day.isToday ? 'Today' : esc(day.dayAbbr)) + '</span>';
    html += '<span class="dp-cal-day-num">' + day.dayNum + '</span>';

    if (hasTasks) {
      html += '<div class="dp-cal-dots">';
      var dotCount = Math.min(day.tasks.length, 3);
      for (var i = 0; i < dotCount; i++) {
        html += '<span class="eval-timeline-dot"></span>';
      }
      if (day.tasks.length > 3) {
        html += '<span class="eval-timeline-dot-more">+' + (day.tasks.length - 3) + '</span>';
      }
      html += '</div>';
    }

    if (hasMeeting) {
      html += '<span class="dp-cal-meeting-badge" title="IEP Meeting">' + day.meetings.length + '</span>';
    }

    html += '</button>';
  });
  return html;
}

function buildDPExpandedDayHtml_(day) {
  if (!day) return '';
  var hasTasks = day.tasks.length > 0;
  var hasMeetings = day.meetings.length > 0;

  if (!hasTasks && !hasMeetings) {
    var emptyLabel = day.isToday ? 'today' : (esc(day.dayAbbr) + ', ' + esc(day.monthShort) + ' ' + day.dayNum);
    return '<div class="dp-expanded-day dp-expanded-day-empty"><span>Nothing scheduled ' + emptyLabel + '</span></div>';
  }

  var dayLabel = day.isToday ? 'Today' : (esc(day.dayAbbr) + ', ' + esc(day.monthShort) + ' ' + day.dayNum);
  var html = '<div class="dp-expanded-day">';
  html += '<div class="dp-expanded-day-header">' + dayLabel + '</div>';

  // Meetings first
  if (hasMeetings) {
    day.meetings.forEach(function(m) {
      html += '<div class="dp-expanded-meeting">' +
        '<span class="dp-expanded-meeting-badge">IEP</span>' +
        '<div class="dp-expanded-meeting-info">' +
          '<span class="dp-expanded-meeting-type">' + esc(m.meetingType) + '</span>' +
          '<span class="dp-expanded-meeting-student">' + esc(m.studentName) +
          (m.notes ? ' &middot; ' + esc(m.notes) : '') + '</span>' +
        '</div>' +
      '</div>';
    });
  }

  // Tasks
  if (hasTasks) {
    day.tasks.forEach(function(task) {
      var typeLabel = getEvalTypeLabel(task.evalType);
      html += '<div class="dp-expanded-task" role="button" tabindex="0" ' +
        'onclick="navigateToEvalTask(\'' + esc(task.studentId) + '\', \'' + esc(task.itemId || '') + '\')" ' +
        'onkeydown="if(event.key===\'Enter\')navigateToEvalTask(\'' + esc(task.studentId) + '\', \'' + esc(task.itemId || '') + '\')">' +
        '<span class="eval-timeline-task-dot"></span>' +
        '<div class="dp-expanded-task-info">' +
          '<span class="dp-expanded-task-text">' + esc(task.text) + '</span>' +
          '<span class="dp-expanded-task-student">' + esc(task.studentName) + ' &middot; ' + esc(typeLabel) + '</span>' +
        '</div>' +
      '</div>';
    });
  }

  html += '</div>';
  return html;
}

function renderDPCalendarOnly_() {
  var section = document.getElementById('dp-calendar-section');
  if (!section || !appState.dueProcessData) return;
  var tmp = document.createElement('div');
  tmp.innerHTML = buildDPCalendarSection_(appState.dueProcessData);
  var newSection = tmp.firstChild;
  section.parentNode.replaceChild(newSection, section);
}

function toggleDPCalendarRange() {
  var expanding = appState.dueProcessCalendarWeeks === 1;
  appState.dueProcessCalendarWeeks = expanding ? 4 : 1;
  appState.dueProcessExpandedDay = null;

  var extra = document.getElementById('dp-cal-extra');
  var week1 = document.getElementById('dp-cal-week1');
  var btn = document.getElementById('dp-cal-toggle-btn');

  if (extra) {
    if (expanding) {
      extra.classList.add('dp-calendar-extra-open');
      if (week1) week1.classList.add('dp-calendar-days-sm');
    } else {
      extra.classList.remove('dp-calendar-extra-open');
      if (week1) week1.classList.remove('dp-calendar-days-sm');
    }
  }
  if (btn) btn.textContent = expanding ? 'This Week' : 'Show 4 Weeks';

  // Clear expanded day detail (needs DOM update)
  var dayDetail = document.querySelector('.dp-expanded-day');
  if (dayDetail) dayDetail.remove();
}

function toggleDPDay(dateStr) {
  appState.dueProcessExpandedDay = (appState.dueProcessExpandedDay === dateStr) ? null : dateStr;
  renderDPCalendarOnly_();
}

function buildDPUpcomingMeetingsList_(meetings, days) {
  if (!meetings || meetings.length === 0) return '';

  // Filter meetings to those within the calendar date range and from today onward
  var now = new Date();
  var today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  var todayStr = today.getFullYear() + '-' +
    String(today.getMonth() + 1).padStart(2, '0') + '-' +
    String(today.getDate()).padStart(2, '0');
  var lastDate = days.length > 0 ? days[days.length - 1].date : todayStr;

  var upcoming = meetings.filter(function(m) {
    return m.date >= todayStr && m.date <= lastDate;
  }).sort(function(a, b) {
    return a.date < b.date ? -1 : a.date > b.date ? 1 : 0;
  });

  if (upcoming.length === 0) return '';

  var monthAbbrs = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  var dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

  var html = '<div class="dp-upcoming-meetings">';
  html += '<div class="dp-upcoming-header">Upcoming Meetings</div>';

  upcoming.forEach(function(m) {
    var parts = m.date.split('-');
    var meetDate = new Date(parseInt(parts[0], 10), parseInt(parts[1], 10) - 1, parseInt(parts[2], 10));
    var dateLabel = dayNames[meetDate.getDay()] + ', ' + monthAbbrs[meetDate.getMonth()] + ' ' + meetDate.getDate();
    var isToday = m.date === todayStr;

    html += '<div class="dp-upcoming-row" role="button" tabindex="0" ' +
      'onclick="showStudentProfile(\'' + esc(m.studentId) + '\')" ' +
      'onkeydown="if(event.key===\'Enter\')showStudentProfile(\'' + esc(m.studentId) + '\')">' +
      '<span class="dp-upcoming-date' + (isToday ? ' dp-upcoming-today' : '') + '">' +
        (isToday ? 'Today' : esc(dateLabel)) + '</span>' +
      '<div class="dp-upcoming-info">' +
        '<span class="dp-upcoming-type">' + esc(m.meetingType) + '</span>' +
        '<span class="dp-upcoming-student">' + esc(m.studentName) +
        (m.notes ? ' &#x00B7; ' + esc(m.notes) : '') + '</span>' +
      '</div>' +
      '<span class="dp-upcoming-badge">IEP</span>' +
    '</div>';
  });

  html += '</div>';
  return html;
}

// ── Section 3: Progress Reports ──

function buildDPProgressSection_(data) {
  var assignments = data.progressAssignments || [];
  var completionMap = data.completionMap || {};
  var completionFlags = data.completionFlags || {};
  var quarter = data.currentQuarter || '';
  var filter = appState.dueProcessProgressFilter || 'all';
  var viewMode = appState.dueProcessProgressViewMode || 'grouped';
  var areaFilters = appState.dueProcessGoalAreaFilters || [];

  var html = '<div class="dp-section" id="dp-progress-section">';

  // Header row with quarter selector
  html += '<div class="dp-section-header-row">';
  html += '<h2 class="dp-section-header">Progress Reports</h2>';
  html += '<div class="dp-progress-quarter-selector">';
  ['Q1','Q2','Q3','Q4'].forEach(function(q) {
    var active = q === quarter ? ' progress-quarter-btn-active' : '';
    html += '<button class="btn btn-sm progress-quarter-btn' + active + '" ' +
      'onclick="switchDPProgressQuarter(\'' + q + '\')">' + q + '</button>';
  });
  html += '</div></div>';

  if (assignments.length === 0) {
    html += '<p class="dp-empty-state">No goals assigned to you. Mark yourself as responsible in student profiles.</p>';
    html += '</div>';
    return html;
  }

  // Collect unique goal areas for filter chips
  var areaSet = {};
  assignments.forEach(function(a) { areaSet[a.goalArea] = true; });
  var areaList = Object.keys(areaSet).sort();

  // Group by studentId
  var studentGoals = {};
  var studentOrder = [];
  assignments.forEach(function(a) {
    if (!studentGoals[a.studentId]) {
      studentGoals[a.studentId] = { name: a.studentName, caseManager: a.caseManagerEmail, online: a.online, birthday: a.birthday, goals: [] };
      studentOrder.push(a.studentId);
    }
    studentGoals[a.studentId].goals.push(a);
  });

  // Compute aggregate completion (considering both flags and progress data)
  var totalStudents = studentOrder.length;
  var doneStudents = 0;
  studentOrder.forEach(function(sid) {
    var allGoalsDone = isStudentFullyComplete_(sid, studentGoals[sid].goals, completionMap, completionFlags, quarter);
    if (allGoalsDone) doneStudents++;
  });
  var pctDone = totalStudents > 0 ? Math.round(doneStudents / totalStudents * 100) : 0;

  // Aggregate progress bar
  html += '<div class="dp-progress-summary-row">';
  html += '<span class="dp-progress-summary-text">' + doneStudents + ' of ' + totalStudents + ' complete</span>';
  html += '<div class="dp-progress-bar"><div class="dp-progress-bar-fill" style="width:' + pctDone + '%"></div></div>';
  html += '</div>';

  // Status filter chips
  html += '<div class="dp-progress-filters">';
  var filters = [
    { key: 'all', label: 'All' },
    { key: 'incomplete', label: 'Incomplete' },
    { key: 'complete', label: 'Complete' }
  ];
  filters.forEach(function(f) {
    var isActive = filter === f.key;
    html += '<button class="eval-filter-chip' + (isActive ? ' eval-filter-chip-active' : '') + '" ' +
      'aria-pressed="' + isActive + '" onclick="setDPProgressFilter(\'' + f.key + '\')">' +
      f.label + '</button>';
  });

  // View mode toggle
  html += '<span style="border-left:1px solid var(--md-outline-variant);height:20px;margin:0 4px;"></span>';
  var groupedActive = viewMode === 'grouped' ? ' eval-filter-chip-active' : '';
  var flatActive = viewMode === 'flat' ? ' eval-filter-chip-active' : '';
  html += '<button class="eval-filter-chip' + groupedActive + '" aria-pressed="' + (viewMode === 'grouped') + '" ' +
    'onclick="setDPProgressViewMode(\'grouped\')">Group by Student</button>';
  html += '<button class="eval-filter-chip' + flatActive + '" aria-pressed="' + (viewMode === 'flat') + '" ' +
    'onclick="setDPProgressViewMode(\'flat\')">Show All</button>';
  html += '</div>';

  // Goal area filter chips (only if >1 area)
  if (areaList.length > 1) {
    html += '<div class="dp-progress-area-filters">';
    areaList.forEach(function(area) {
      var isActive = areaFilters.indexOf(area) !== -1;
      html += '<button class="eval-filter-chip' + (isActive ? ' eval-filter-chip-active' : '') + '" ' +
        'aria-pressed="' + isActive + '" onclick="toggleDPGoalAreaFilter(\'' + esc(area) + '\')">' +
        esc(area) + '</button>';
    });
    if (areaFilters.length > 0) {
      html += '<button class="btn-ghost" style="font-size:12px;padding:4px 8px;" onclick="clearDPGoalAreaFilters()">Clear</button>';
    }
    html += '</div>';
  }

  // Render the appropriate view
  if (viewMode === 'grouped') {
    html += buildDPProgressGroupedView_(studentGoals, studentOrder, completionMap, completionFlags, quarter, filter, areaFilters);
  } else {
    html += buildDPProgressFlatView_(assignments, completionMap, completionFlags, quarter, filter, areaFilters);
  }

  html += '</div>';
  return html;
}

/** Check if a single goal is flagged complete (either via flag or progress data). */
function isGoalComplete_(studentId, goalId, completionMap, completionFlags, quarter) {
  var flagKey = studentId + '|' + goalId + '|' + quarter;
  if (completionFlags[flagKey]) return true;
  var comp = completionMap[studentId];
  if (comp && comp.goals && comp.goals[goalId]) {
    return comp.goals[goalId].completed;
  }
  return false;
}

/** Check if ALL goals for a student are complete. */
function isStudentFullyComplete_(studentId, goals, completionMap, completionFlags, quarter) {
  for (var i = 0; i < goals.length; i++) {
    if (!isGoalComplete_(studentId, goals[i].goalId, completionMap, completionFlags, quarter)) return false;
  }
  return goals.length > 0;
}

/** Count completed goals for a student. */
function countCompletedGoals_(studentId, goals, completionMap, completionFlags, quarter) {
  var count = 0;
  goals.forEach(function(g) {
    if (isGoalComplete_(studentId, g.goalId, completionMap, completionFlags, quarter)) count++;
  });
  return count;
}

/** Filter goals by active goal area filters (OR logic). Returns all if no filters active. */
function filterGoalsByArea_(goals, areaFilters) {
  if (areaFilters.length === 0) return goals;
  return goals.filter(function(g) {
    return areaFilters.indexOf(g.goalArea) !== -1;
  });
}

// ── Grouped View ──

function buildGroupedStudentRow_(sid, info, filteredGoals, completionMap, completionFlags, quarter) {
  var doneCount = countCompletedGoals_(sid, filteredGoals, completionMap, completionFlags, quarter);
  var totalGoals = filteredGoals.length;
  var isExpanded = !!appState.dueProcessExpandedStudents[sid];

  var html = '<div class="dp-progress-student-row" data-student-id="' + esc(sid) + '">';

  // Header — no checkbox, neutral count chip + chevron
  html += '<div class="dp-progress-student-header" role="button" tabindex="0" ' +
    'onclick="toggleDPProgressStudent(\'' + esc(sid) + '\')" ' +
    'onkeydown="if(event.key===\'Enter\')toggleDPProgressStudent(\'' + esc(sid) + '\')">';
  html += '<span class="dp-progress-student-name">' + esc(info.name) +
    (info.online ? ' <span class="online-badge" title="Online">Online</span>' : '') +
    buildBirthdayBadge_(info.birthday) + '</span>';
  html += '<div class="dp-progress-student-right">';
  html += '<span class="dp-progress-count-chip">' + doneCount + '/' + totalGoals + '</span>';
  html += '<svg class="dp-progress-chevron' + (isExpanded ? ' dp-progress-chevron-open' : '') + '" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
    '<polyline points="6 9 12 15 18 9"></polyline></svg>';
  html += '</div></div>';

  // Body (collapsible goal rows)
  html += '<div class="dp-progress-student-body' + (isExpanded ? ' dp-progress-student-body-open' : '') + '">';
  filteredGoals.forEach(function(g) {
    var goalDone = isGoalComplete_(sid, g.goalId, completionMap, completionFlags, quarter);

    html += '<div class="dp-progress-checkbox-row' + (goalDone ? ' dp-progress-checkbox-done' : '') + '" ' +
      'onclick="toggleDPReportItem(\'' + esc(sid) + '\',\'' + esc(g.goalId) + '\',\'' + esc(quarter) + '\',' + !goalDone + ')" ' +
      'role="button" tabindex="0" onkeydown="if(event.key===\'Enter\')toggleDPReportItem(\'' + esc(sid) + '\',\'' + esc(g.goalId) + '\',\'' + esc(quarter) + '\',' + !goalDone + ')">';
    html += '<input type="checkbox" class="eval-item-checkbox" ' + (goalDone ? 'checked' : '') +
      ' onchange="event.stopPropagation();toggleDPReportItem(\'' + esc(sid) + '\',\'' + esc(g.goalId) + '\',\'' + esc(quarter) + '\',this.checked)" ' +
      'onclick="event.stopPropagation()" tabindex="-1">';
    html += '<div style="flex:1;min-width:0;">';
    html += '<span class="dp-progress-goal-chip" style="margin-right:6px;">' + esc(g.goalArea) + '</span>';
    html += '<span class="dp-progress-checkbox-text">' + esc(g.goalText) + '</span>';
    html += '</div>';
    html += '<svg class="dp-progress-goto-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" ' +
      'onclick="event.stopPropagation();navigateToProgressGoal(\'' + esc(sid) + '\',\'' + esc(g.goalId) + '\',\'' + esc(quarter) + '\')" title="Go to profile">' +
      '<polyline points="9 18 15 12 9 6"></polyline></svg>';
    html += '</div>';

    // Objectives (indented)
    if (g.objectives && g.objectives.length > 0) {
      g.objectives.forEach(function(obj) {
        var objComp = completionMap[sid] && completionMap[sid].goals && completionMap[sid].goals[g.goalId] &&
          completionMap[sid].goals[g.goalId].objectives ? completionMap[sid].goals[g.goalId].objectives[obj.id] : false;
        html += '<div class="dp-progress-checkbox-row dp-progress-checkbox-objective' + (objComp ? ' dp-progress-checkbox-done' : '') + '" ' +
          'onclick="navigateToProgressGoal(\'' + esc(sid) + '\',\'' + esc(g.goalId) + '\',\'' + esc(quarter) + '\')" ' +
          'role="button" tabindex="0" onkeydown="if(event.key===\'Enter\')navigateToProgressGoal(\'' + esc(sid) + '\',\'' + esc(g.goalId) + '\',\'' + esc(quarter) + '\')">';
        html += '<span class="dp-progress-obj-indicator' + (objComp ? ' dp-progress-obj-done' : '') + '">' +
          (objComp ? '&#x25CF;' : '&#x25CB;') + '</span>';
        html += '<span class="dp-progress-checkbox-text">' + esc(obj.text) + '</span>';
        html += '<svg class="dp-progress-goto-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
          '<polyline points="9 18 15 12 9 6"></polyline></svg>';
        html += '</div>';
      });
    }
  });
  html += '</div>'; // end body
  html += '</div>'; // end student row
  return html;
}

function buildDPProgressGroupedView_(studentGoals, studentOrder, completionMap, completionFlags, quarter, filter, areaFilters) {
  // Split students into incomplete and complete arrays
  var incompleteStudents = [];
  var completeStudents = [];

  studentOrder.forEach(function(sid) {
    var info = studentGoals[sid];
    var filteredGoals = filterGoalsByArea_(info.goals, areaFilters);
    if (filteredGoals.length === 0) return;

    var allDone = isStudentFullyComplete_(sid, filteredGoals, completionMap, completionFlags, quarter);

    // Apply status filter
    if (filter === 'incomplete' && allDone) return;
    if (filter === 'complete' && !allDone) return;

    var entry = { sid: sid, info: info, filteredGoals: filteredGoals, allDone: allDone };
    if (allDone) {
      completeStudents.push(entry);
    } else {
      incompleteStudents.push(entry);
    }
  });

  // Sort each group alphabetically
  var nameSorter = function(a, b) { return a.info.name.localeCompare(b.info.name); };
  incompleteStudents.sort(nameSorter);
  completeStudents.sort(nameSorter);

  var visibleCount = incompleteStudents.length + completeStudents.length;
  if (visibleCount === 0) {
    return '<p class="dp-empty-state">No matching progress reports.</p>';
  }

  // Single container (matches eval-items-card)
  var html = '<div class="eval-items-card">';

  // Render incomplete students
  incompleteStudents.forEach(function(entry) {
    html += buildGroupedStudentRow_(entry.sid, entry.info, entry.filteredGoals, completionMap, completionFlags, quarter);
  });

  // Completed section divider + collapsible container
  if (completeStudents.length > 0 && incompleteStudents.length > 0) {
    var isCollapsed = !!appState.dueProcessCompletedCollapsed;
    html += '<div class="eval-completed-divider" role="button" tabindex="0" ' +
      'onclick="toggleDPProgressCompletedSection()" ' +
      'onkeydown="if(event.key===\'Enter\')toggleDPProgressCompletedSection()" ' +
      'aria-expanded="' + (!isCollapsed) + '" aria-controls="dp-progress-completed-items" ' +
      'id="dp-progress-completed-divider">' +
      '<svg class="eval-completed-divider-icon' + (isCollapsed ? ' collapsed' : '') + '" ' +
        'id="dp-progress-completed-chevron" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">' +
        '<path d="M7 10l5 5 5-5z"/></svg>' +
      '<span class="eval-completed-divider-text">' + completeStudents.length + ' completed</span>' +
    '</div>';
    html += '<div class="eval-completed-items' + (isCollapsed ? ' collapsed' : '') + '" ' +
      'id="dp-progress-completed-items">';
  }

  completeStudents.forEach(function(entry) {
    html += buildGroupedStudentRow_(entry.sid, entry.info, entry.filteredGoals, completionMap, completionFlags, quarter);

    // Fire confetti for newly-complete students
    if (!_progressCompletionFiredFor[entry.sid + quarter]) {
      _progressCompletionFiredFor[entry.sid + quarter] = true;
      var capturedSid = entry.sid;
      setTimeout(function() {
        var header = document.querySelector('[data-student-id="' + capturedSid + '"] .dp-progress-student-header');
        if (header) launchConfetti(header);
      }, 400);
    }
  });

  if (completeStudents.length > 0 && incompleteStudents.length > 0) {
    html += '</div>'; // end .eval-completed-items
  }

  html += '</div>'; // end .eval-items-card
  return html;
}

// ── Flat View ──

function buildFlatGoalRow_(a, completionMap, completionFlags, quarter, goalDone) {
  var cardClass = 'dp-progress-flat-card' + (goalDone ? ' dp-progress-flat-done' : '');

  var html = '<div class="' + cardClass + '" role="button" tabindex="0" ' +
    'onclick="toggleDPReportItem(\'' + esc(a.studentId) + '\',\'' + esc(a.goalId) + '\',\'' + esc(quarter) + '\',' + !goalDone + ')" ' +
    'onkeydown="if(event.key===\'Enter\')toggleDPReportItem(\'' + esc(a.studentId) + '\',\'' + esc(a.goalId) + '\',\'' + esc(quarter) + '\',' + !goalDone + ')">';
  html += '<input type="checkbox" class="eval-item-checkbox" ' + (goalDone ? 'checked' : '') +
    ' onchange="event.stopPropagation();toggleDPReportItem(\'' + esc(a.studentId) + '\',\'' + esc(a.goalId) + '\',\'' + esc(quarter) + '\',this.checked)" ' +
    'onclick="event.stopPropagation()" tabindex="-1">';
  html += '<span class="dp-progress-flat-name">' + esc(a.studentName) + '</span>';
  html += '<span class="dp-progress-goal-chip">' + esc(a.goalArea) + '</span>';
  html += '<span class="dp-progress-checkbox-text" style="flex:1;min-width:0;">' + esc(a.goalText) + '</span>';
  html += '<svg class="dp-progress-goto-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" ' +
    'onclick="event.stopPropagation();navigateToProgressGoal(\'' + esc(a.studentId) + '\',\'' + esc(a.goalId) + '\',\'' + esc(quarter) + '\')" title="Go to profile">' +
    '<polyline points="9 18 15 12 9 6"></polyline></svg>';
  html += '</div>';
  return html;
}

function buildDPProgressFlatView_(assignments, completionMap, completionFlags, quarter, filter, areaFilters) {
  var filtered = filterGoalsByArea_(assignments, areaFilters);

  // Split into incomplete and complete arrays
  var incompleteGoals = [];
  var completeGoals = [];

  filtered.forEach(function(a) {
    var goalDone = isGoalComplete_(a.studentId, a.goalId, completionMap, completionFlags, quarter);

    // Apply status filter
    if (filter === 'incomplete' && goalDone) return;
    if (filter === 'complete' && !goalDone) return;

    if (goalDone) {
      completeGoals.push(a);
    } else {
      incompleteGoals.push(a);
    }
  });

  // Sort each group by student name
  var nameSorter = function(a, b) { return a.studentName.localeCompare(b.studentName); };
  incompleteGoals.sort(nameSorter);
  completeGoals.sort(nameSorter);

  var visibleCount = incompleteGoals.length + completeGoals.length;
  if (visibleCount === 0) {
    return '<p class="dp-empty-state">No matching progress reports.</p>';
  }

  // Single container (matches eval-items-card)
  var html = '<div class="eval-items-card">';

  // Render incomplete goals
  incompleteGoals.forEach(function(a) {
    html += buildFlatGoalRow_(a, completionMap, completionFlags, quarter, false);
  });

  // Completed section divider + collapsible container
  if (completeGoals.length > 0 && incompleteGoals.length > 0) {
    var isCollapsed = !!appState.dueProcessCompletedCollapsed;
    html += '<div class="eval-completed-divider" role="button" tabindex="0" ' +
      'onclick="toggleDPProgressCompletedSection()" ' +
      'onkeydown="if(event.key===\'Enter\')toggleDPProgressCompletedSection()" ' +
      'aria-expanded="' + (!isCollapsed) + '" aria-controls="dp-progress-completed-items" ' +
      'id="dp-progress-completed-divider">' +
      '<svg class="eval-completed-divider-icon' + (isCollapsed ? ' collapsed' : '') + '" ' +
        'id="dp-progress-completed-chevron" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">' +
        '<path d="M7 10l5 5 5-5z"/></svg>' +
      '<span class="eval-completed-divider-text">' + completeGoals.length + ' completed</span>' +
    '</div>';
    html += '<div class="eval-completed-items' + (isCollapsed ? ' collapsed' : '') + '" ' +
      'id="dp-progress-completed-items">';
  }

  completeGoals.forEach(function(a) {
    html += buildFlatGoalRow_(a, completionMap, completionFlags, quarter, true);
  });

  if (completeGoals.length > 0 && incompleteGoals.length > 0) {
    html += '</div>'; // end .eval-completed-items
  }

  html += '</div>'; // end .eval-items-card
  return html;
}

// ── Progress Section Handlers ──

function setDPProgressFilter(filter) {
  appState.dueProcessProgressFilter = filter;
  renderDPProgressOnly_();
}

function setDPProgressViewMode(mode) {
  appState.dueProcessProgressViewMode = mode;
  renderDPProgressOnly_();
}

function toggleDPGoalAreaFilter(area) {
  var idx = appState.dueProcessGoalAreaFilters.indexOf(area);
  if (idx === -1) {
    appState.dueProcessGoalAreaFilters.push(area);
  } else {
    appState.dueProcessGoalAreaFilters.splice(idx, 1);
  }
  renderDPProgressOnly_();
}

function clearDPGoalAreaFilters() {
  appState.dueProcessGoalAreaFilters = [];
  renderDPProgressOnly_();
}

function toggleDPProgressStudent(studentId) {
  if (appState.dueProcessExpandedStudents[studentId]) {
    delete appState.dueProcessExpandedStudents[studentId];
  } else {
    appState.dueProcessExpandedStudents[studentId] = true;
  }
  renderDPProgressOnly_();
}

function toggleDPProgressCompletedSection() {
  appState.dueProcessCompletedCollapsed = !appState.dueProcessCompletedCollapsed;
  var items = document.getElementById('dp-progress-completed-items');
  var chevron = document.getElementById('dp-progress-completed-chevron');
  var divider = document.getElementById('dp-progress-completed-divider');
  if (items) items.classList.toggle('collapsed');
  if (chevron) chevron.classList.toggle('collapsed');
  if (divider) divider.setAttribute('aria-expanded', String(!appState.dueProcessCompletedCollapsed));
}

function switchDPProgressQuarter(quarter) {
  appState.dueProcessQuarter = quarter;
  // Show skeleton in progress section only
  var section = document.getElementById('dp-progress-section');
  if (section) {
    var skelHtml = '<div class="dp-section" id="dp-progress-section">';
    skelHtml += '<div class="dp-section-header-row">';
    skelHtml += '<h2 class="dp-section-header">Progress Reports</h2>';
    skelHtml += '<div class="dp-progress-quarter-selector">';
    ['Q1','Q2','Q3','Q4'].forEach(function(q) {
      var active = q === quarter ? ' progress-quarter-btn-active' : '';
      skelHtml += '<button class="btn btn-sm progress-quarter-btn' + active + '" disabled>' + q + '</button>';
    });
    skelHtml += '</div></div>';
    skelHtml += '<div class="skeleton" style="width:100%;height:120px;border-radius:12px;margin-top:12px;"></div>';
    skelHtml += '</div>';
    var tmp = document.createElement('div');
    tmp.innerHTML = skelHtml;
    section.parentNode.replaceChild(tmp.firstChild, section);
  }
  google.script.run
    .withSuccessHandler(function(data) {
      if (_currentViewId !== 'dueprocess-view') return;
      appState.dueProcessData.progressAssignments = data.progressAssignments;
      appState.dueProcessData.completionMap = data.completionMap;
      appState.dueProcessData.completionFlags = data.completionFlags;
      appState.dueProcessData.currentQuarter = data.currentQuarter;
      renderDPProgressOnly_();
    })
    .withFailureHandler(function(err) {
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
      renderDPProgressOnly_();
    })
    .getDueProcessData(quarter);
}

function toggleDPReportItem(studentId, goalId, quarter, checked) {
  var flags = appState.dueProcessData.completionFlags || {};
  var key = studentId + '|' + goalId + '|' + quarter;

  // Optimistic update
  if (checked) {
    flags[key] = true;
  } else {
    delete flags[key];
  }
  appState.dueProcessData.completionFlags = flags;
  renderDPProgressOnly_();

  // Save to backend
  google.script.run
    .withSuccessHandler(function() { _lastDueProcessFetch = 0; })
    .withFailureHandler(function(err) {
      // Revert optimistic update
      if (checked) { delete flags[key]; } else { flags[key] = true; }
      appState.dueProcessData.completionFlags = flags;
      renderDPProgressOnly_();
      showToast('Error saving: ' + (err && err.message ? err.message : String(err)));
    })
    .toggleDPReportComplete(studentId, goalId, quarter, checked);
}

function navigateToProgressGoal(studentId, goalId, quarter) {
  appState.autoExpandProgressGoalId = goalId;
  showStudentProfile(studentId);
}

function renderDPProgressOnly_() {
  var section = document.getElementById('dp-progress-section');
  if (!section || !appState.dueProcessData) return;
  var tmp = document.createElement('div');
  tmp.innerHTML = buildDPProgressSection_(appState.dueProcessData);
  var newSection = tmp.firstChild;
  section.parentNode.replaceChild(newSection, section);
}

// ─── Recent Students ───
function renderRecentStudents() {
  var sectionEl = document.getElementById('dashboard-recent-section');
  var container = document.getElementById('recent-students-content');
  if (!sectionEl || !container) return;

  var recentIds = appState.recentStudents || [];
  if (recentIds.length === 0) {
    sectionEl.style.display = 'none';
    return;
  }

  // Resolve student data from dashboardData
  var students = [];
  recentIds.forEach(function(id) {
    var s = getStudentById(id);
    if (s) students.push(s);
  });

  if (students.length === 0) {
    sectionEl.style.display = 'none';
    return;
  }

  sectionEl.style.display = '';

  var html = '<table class="dashboard-table recent-students-table"><thead><tr>' +
    '<th>Name</th>' +
    '<th>Case Manager</th>' +
    '<th>Grade</th>' +
    '<th>Actions</th>' +
    '</tr></thead><tbody>';

  students.forEach(function(s) {
    var cmEmail = s.caseManagerEmail || '';
    var cmName = cmEmail ? getCaseManagerName(cmEmail) : '--';

    html += '<tr>';
    html += '<td><strong>' + esc(s.firstName + ' ' + s.lastName) + '</strong>' + (s.online ? ' <span class="online-badge" title="Online">Online</span>' : '') + buildBirthdayBadge_(s.birthday) + '</td>';
    html += '<td>' + esc(cmName) + '</td>';
    html += '<td>' + esc(s.grade || '--') + '</td>';
    html += '<td><div class="action-btns">';

    // Check-In button (black)
    html += '<button class="action-btn" onclick="event.stopPropagation(); startCheckIn(\'' + s.id + '\')" title="Check-In">' +
      '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>' +
    '</button>';

    // Student Profile button (black)
    html += '<button class="action-btn" onclick="event.stopPropagation(); showStudentProfile(\'' + s.id + '\')" title="Student Profile">' +
      '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>' +
    '</button>';

    // Contact Card button (black) - navigates to contacts section
    html += '<button class="action-btn" onclick="event.stopPropagation(); navigateToContacts(\'' + s.id + '\')" title="View Contacts">' +
      '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M20 0H4v2h16V0zM4 24h16v-2H4v2zM20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-8 2.75c1.24 0 2.25 1.01 2.25 2.25s-1.01 2.25-2.25 2.25S9.75 10.24 9.75 9s1.01-2.25 2.25-2.25zM17 17H7v-1.5c0-1.67 3.33-2.5 5-2.5s5 .83 5 2.5V17z"/></svg>' +
    '</button>';

    html += '</div></td>';
    html += '</tr>';
  });

  html += '</tbody></table>';
  container.innerHTML = html;
}

function navigateToContacts(studentId) {
  showStudentProfile(studentId);
  // Poll for the contacts card to appear (async data load)
  var attempts = 0;
  var scrollInterval = setInterval(function() {
    var contactsCard = document.getElementById('profile-contacts-card');
    attempts++;
    if (contactsCard) {
      clearInterval(scrollInterval);
      setTimeout(function() {
        contactsCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
        contactsCard.classList.add('contacts-highlight');
        setTimeout(function() {
          contactsCard.classList.remove('contacts-highlight');
        }, 2000);
      }, 100);
    } else if (attempts > 30) {
      clearInterval(scrollInterval);
    }
  }, 100);
}

function toggleTimelineDay(dayIndex) {
  if (appState.timelineExpandedDay === dayIndex) {
    appState.timelineExpandedDay = null;
  } else {
    appState.timelineExpandedDay = dayIndex;
  }
  if (!appState.evalSummary) return;

  // Surgically update only the timeline strip — leave metric cards untouched
  var stripEl = document.querySelector('.eval-timeline-strip');
  if (stripEl) {
    stripEl.outerHTML = buildTimelineHtml_(appState.evalSummary);
  } else {
    renderEvalSummary(appState.evalSummary);
  }
}

function navigateToEvalTask(studentId, scrollToItemId) {
  // Optimistic UI: show eval checklist view with skeleton immediately
  var student = getStudentById(studentId);
  var studentName = student ? (student.firstName + ' ' + student.lastName) : 'Student';

  updateEvalBreadcrumb_('Eval');
  var titleEl = document.getElementById('eval-checklist-title');
  if (titleEl) titleEl.textContent = studentName;
  var actionsEl = document.getElementById('eval-checklist-actions');
  if (actionsEl) actionsEl.innerHTML = '';
  var contentEl = document.getElementById('eval-checklist-content');
  if (contentEl) contentEl.innerHTML = buildEvalChecklistSkeleton_();

  showView('eval-checklist-view');


  google.script.run
    .withSuccessHandler(function(evaluation) {
      if (evaluation) {
        showEvalChecklistView(studentId, evaluation, scrollToItemId);
      } else {
        showToast('No active evaluation found for this student.');
        goBackFromEvalChecklist();
      }
    })
    .withFailureHandler(function(err) {
      showToast('Error loading evaluation: ' + (err && err.message ? err.message : String(err)));
      goBackFromEvalChecklist();
    })
    .getEvaluation(studentId);
}

function buildEvalChecklistSkeleton_() {
  var html = '<div class="skeleton-fade-in"><div class="eval-checklist-layout"><div class="eval-checklist-main">';

  // Summary card skeleton
  html += '<div class="eval-summary-card">' +
    '<div class="eval-summary-top">' +
      '<div class="eval-summary-left">' +
        '<div class="skeleton" style="width:140px;height:20px;border-radius:6px;margin-bottom:8px;"></div>' +
        '<div class="skeleton" style="width:200px;height:14px;border-radius:4px;"></div>' +
      '</div>' +
      '<div class="eval-summary-right">' +
        '<div class="skeleton" style="width:48px;height:36px;border-radius:8px;"></div>' +
      '</div>' +
    '</div>' +
    '<div class="eval-progress-bar"><div class="skeleton" style="width:100%;height:100%;border-radius:inherit;"></div></div>' +
  '</div>';

  // Column header skeleton
  html += '<div class="eval-items-card"><div class="eval-items-header">' +
    '<span>Task</span><span>Due Date</span><span>Completed</span><span>Actions</span>' +
  '</div>';

  // Item row skeletons
  for (var i = 0; i < 6; i++) {
    var w = (i % 3 === 0) ? '70%' : (i % 3 === 1) ? '55%' : '85%';
    html += '<div class="eval-item" style="pointer-events:none;">' +
      '<div class="eval-item-task"><label class="eval-item-label">' +
        '<div class="skeleton" style="width:16px;height:16px;border-radius:3px;flex-shrink:0;"></div>' +
        '<div class="skeleton" style="width:' + w + ';height:16px;border-radius:4px;margin-left:10px;"></div>' +
      '</label></div>' +
      '<div class="eval-item-due"><div class="skeleton" style="width:80px;height:16px;border-radius:4px;"></div></div>' +
      '<div class="eval-item-completed"><div class="skeleton" style="width:60px;height:16px;border-radius:4px;"></div></div>' +
      '<div class="eval-item-actions"><div class="skeleton" style="width:24px;height:24px;border-radius:4px;"></div></div>' +
    '</div>';
  }

  html += '</div></div>';

  // Files sidebar skeleton
  html += '<div class="eval-checklist-sidebar">' +
    '<div class="eval-files-card">' +
      '<div class="skeleton" style="width:80px;height:18px;border-radius:4px;margin-bottom:12px;"></div>' +
      '<div class="skeleton" style="width:100%;height:36px;border-radius:8px;margin-bottom:8px;"></div>' +
      '<div class="skeleton" style="width:100%;height:36px;border-radius:8px;"></div>' +
    '</div>' +
  '</div>';

  html += '</div></div>';
  return html;
}

// ─── Side Panel (Quick View on Double-Click) ───
function openSidePanel(index) {
  var s = appState.dashboardData[index];
  if (!s) return;
  trackRecentStudent(s.id);

  var sidePanelTitle = document.getElementById('side-panel-title');
  sidePanelTitle.innerHTML = esc(s.firstName + ' ' + s.lastName) + (s.online ? ' <span class="online-badge" title="Online">Online</span>' : '') + buildBirthdayBadge_(s.birthday);

  var content = '';

  // Student info subtitle
  if (s.grade) {
    content += '<div class="sp-subtitle" style="margin-bottom:16px;">Grade ' + esc(s.grade) + '</div>';
  }

  // Case manager
  var cmEmail = s.caseManagerEmail || '';
  if (cmEmail) {
    var cmName = getCaseManagerName(cmEmail);
    content += '<div class="sp-case-manager">' +
      '<span class="sp-case-manager-name">Case Manager: ' + esc(cmName) + '</span>' +
      '<a href="mailto:' + esc(cmEmail) + '" class="btn-icon" title="Email case manager" onclick="event.stopPropagation();">' +
        '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>' +
      '</a>' +
    '</div>';
  }

  // GPA
  content += '<div class="sp-section">';
  content += '<div class="sp-section-title">Current GPA</div>';
  if (s.gpa != null) {
    var gpaClass = s.gpa >= 3.5 ? 'high' : s.gpa > 3.0 ? 'mid' : s.gpa >= 2.5 ? 'caution' : 'low';
    content += '<div class="sp-gpa ' + gpaClass + '">' + s.gpa.toFixed(2) + '</div>';
  } else {
    content += '<div class="sp-gpa none">No GPA data</div>';
  }
  content += '</div>';

  // Focus Goal (from student profile / onboarding)
  if (s.focusGoal) {
    content += '<div class="sp-section">';
    content += '<div class="sp-section-title">Focus Goal</div>';
    content += '<div class="sp-goal-text">' + esc(s.focusGoal) + '</div>';
    content += '</div>';
  }

  // Current Micro Goal (from latest check-in)
  content += '<div class="sp-section">';
  content += '<div class="sp-section-title">Current Micro Goal</div>';
  if (s.latestMicroGoal) {
    content += '<div class="sp-goal-text">' + esc(s.latestMicroGoal) + '</div>';
  } else {
    content += '<div class="sp-goal-none">No goal set</div>';
  }
  content += '</div>';

  // IEP Goal
  if (s.iepGoal) {
    content += '<div class="sp-section">';
    content += '<div class="sp-section-title">IEP Goal</div>';
    content += '<div class="sp-goal-text">' + esc(s.iepGoal) + '</div>';
    content += '</div>';
  }

  // Classes & Grades (with inline grade selects)
  content += '<div class="sp-section">';
  content += '<div class="sp-section-title">Classes &amp; Grades</div>';
  if (s.academicData && s.academicData.length > 0) {
    content += '<ul class="sp-class-list">';
    s.academicData.forEach(function(c, classIdx) {
      var missingNum = Number(c.missing) || 0;
      var classLabel = c.className || 'Unknown';
      var matchedClass = (s.classes || []).find(function(cl) { return cl.name === c.className; });
      if (matchedClass && matchedClass.period) classLabel += ' (P' + matchedClass.period + ')';
      // Grade select dropdown
      var gradeOpts = ['--', 'A', 'A-', 'B+', 'B', 'B-', 'C+', 'C', 'C-', 'D+', 'D', 'D-', 'F'];
      var gradeSelect = '<select class="sp-grade-select" onchange="sidePanelChangeGrade(\'' + s.id + '\', ' + classIdx + ', this.value)" title="Change grade">';
      gradeOpts.forEach(function(g) {
        var sel = (c.grade || '--') === g ? ' selected' : '';
        gradeSelect += '<option value="' + g + '"' + sel + '>' + g + '</option>';
      });
      gradeSelect += '</select>';
      // Missing items with mark-done buttons
      var missingHtml = '';
      if (missingNum > 0 && c.missingAssignments && c.missingAssignments.length > 0) {
        missingHtml += '<div class="sp-missing-detail">';
        c.missingAssignments.forEach(function(a, aIdx) {
          missingHtml += '<div class="sp-missing-item">' +
            '<span>' + esc(a.name || 'Assignment ' + (aIdx + 1)) + '</span>' +
            '<button class="sp-missing-done-btn" onclick="event.stopPropagation(); spMarkDone(\'' + s.id + '\', ' + classIdx + ', ' + aIdx + ', this)" title="Mark done">' +
              '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>' +
            '</button>' +
          '</div>';
        });
        missingHtml += '</div>';
      }
      var missingBadgeClass = missingNum > 0 ? '' : ' none';
      content += '<li class="sp-class-item">' +
        '<span class="sp-class-name">' + esc(classLabel) + '</span>' +
        '<span class="sp-class-meta">' +
          gradeSelect +
          '<span class="sp-missing-badge clickable' + missingBadgeClass + '" onclick="event.stopPropagation(); closeSidePanel(); showMissingAssignments(\'' + s.id + '\')" title="View missing assignments">' + missingNum + ' missing</span>' +
        '</span>' +
        missingHtml +
      '</li>';
    });
    content += '</ul>';
  } else {
    content += '<div class="sp-goal-none">No academic data from latest check-in</div>';
  }
  content += '</div>';

  // Total missing (clickable to open detail view)
  content += '<div class="sp-section">';
  var totalMissing = s.totalMissing || 0;
  if (totalMissing === 0) {
    content += '<div class="sp-total-missing ok sp-no-missing" onclick="closeSidePanel(); showMissingAssignments(\'' + s.id + '\')" style="cursor:pointer;" title="View missing assignments detail">No Missing Assignments! <span class="sp-no-missing-emoji">&#x1F4AF;</span></div>';
  } else {
    content += '<div class="sp-total-missing alert" onclick="closeSidePanel(); showMissingAssignments(\'' + s.id + '\')" style="cursor:pointer;" title="View missing assignments detail">Total Missing Assignments: ' + totalMissing + '</div>';
  }
  content += '</div>';

  // Quick note
  content += '<div class="sp-section">';
  content += '<div class="sp-section-title">Quick Note</div>';
  content += '<div class="sp-quick-note-form">' +
    '<textarea id="sp-note-input" class="sp-quick-note-input" placeholder="Add a quick note..." rows="2"></textarea>' +
    '<button class="btn btn-secondary btn-sm" onclick="saveQuickNote(\'' + s.id + '\')">Save Note</button>' +
  '</div>';
  content += '</div>';

  // Action buttons
  content += '<div class="sp-actions">' +
    '<button class="btn btn-primary" onclick="closeSidePanel(); startCheckIn(\'' + s.id + '\')">New Check-In</button>' +
    '<button class="btn btn-secondary" onclick="closeSidePanel(); editStudent(\'' + s.id + '\')">View Profile</button>' +
  '</div>';

  document.getElementById('side-panel-content').innerHTML = content;
  document.getElementById('side-panel').classList.add('open');
  document.getElementById('side-panel-overlay').classList.add('open');
}

function closeSidePanel() {
  document.getElementById('side-panel').classList.remove('open');
  document.getElementById('side-panel-overlay').classList.remove('open');
}

function sidePanelChangeGrade(studentId, classIdx, newGrade) {
  var student = getStudentById(studentId);
  if (!student || !student.academicData || !student.academicData[classIdx]) return;
  student.academicData[classIdx].grade = newGrade === '--' ? '' : newGrade;
  // Recalculate GPA using global GPA_MAP
  var validGrades = [];
  student.academicData.forEach(function(c) {
    if (c.grade && GPA_MAP[c.grade] !== undefined) validGrades.push(GPA_MAP[c.grade]);
  });
  student.gpa = validGrades.length > 0 ? validGrades.reduce(function(a, b) { return a + b; }, 0) / validGrades.length : null;
  // Update GPA display in panel
  var gpaSection = document.querySelector('.sp-gpa');
  if (gpaSection) {
    if (student.gpa != null) {
      var gpaClass = student.gpa >= 3.5 ? 'high' : student.gpa > 3.0 ? 'mid' : student.gpa >= 2.5 ? 'caution' : 'low';
      gpaSection.className = 'sp-gpa ' + gpaClass;
      gpaSection.textContent = student.gpa.toFixed(2);
    } else {
      gpaSection.className = 'sp-gpa none';
      gpaSection.textContent = 'No GPA data';
    }
  }
  persistAcademicData_(student);
  showToast('Grade updated');
}

function spMarkDone(studentId, classIdx, assignmentIdx, btnEl) {
  modifyMissingAssignment(studentId, classIdx, assignmentIdx, { action: 'done' });
  // Optimistic: remove the item from DOM
  var item = btnEl.closest('.sp-missing-item');
  if (item) {
    item.style.transition = 'opacity 0.2s, height 0.2s';
    item.style.opacity = '0';
    item.style.height = '0';
    item.style.overflow = 'hidden';
    setTimeout(function() { item.remove(); }, 200);
  }
  // Update missing badge count in side panel
  var student = getStudentById(studentId);
  if (student) {
    var classData = student.academicData && student.academicData[classIdx];
    if (classData) {
      var badges = document.querySelectorAll('.sp-missing-badge');
      if (badges[classIdx]) {
        var newCount = Number(classData.missing) || 0;
        badges[classIdx].textContent = newCount + ' missing';
        badges[classIdx].classList.toggle('none', newCount === 0);
      }
    }
    // Update total missing display
    var totalEl = document.querySelector('.sp-total-missing');
    if (totalEl) {
      var tm = student.totalMissing || 0;
      if (tm === 0) {
        totalEl.className = 'sp-total-missing ok sp-no-missing';
        totalEl.innerHTML = 'No Missing Assignments! <span class="sp-no-missing-emoji">&#x1F4AF;</span>';
      } else {
        totalEl.className = 'sp-total-missing alert';
        totalEl.textContent = 'Total Missing Assignments: ' + tm;
      }
    }
  }
}

function saveQuickNote(studentId) {
  var input = document.getElementById('sp-note-input');
  if (!input) return;
  var text = input.value.trim();
  if (!text) { showToast('Enter a note first'); return; }
  input.disabled = true;
  google.script.run
    .withSuccessHandler(function(result) {
      input.disabled = false;
      if (result && result.success) {
        input.value = '';
        showToast('Note saved');
        // Update local state
        var student = getStudentById(studentId);
        if (student && result.notes) student.notes = result.notes;
      } else {
        showToast('Failed to save note');
      }
    })
    .withFailureHandler(function(err) {
      input.disabled = false;
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
    })
    .appendStudentNote(studentId, text);
}

// ─── Check-In Form ───
function startCheckIn(studentId, existingCheckIn) {
  appState.currentStudentId = studentId;
  appState.editingCheckIn = existingCheckIn || null;
  document.getElementById('checkin-view-title').innerHTML = '<span class="skeleton skeleton-title-inline"></span>';
  showCheckInSkeleton();
  showView('checkin-view');

  google.script.run
    .withSuccessHandler(function(students) {
      var student = (students || []).find(function(s) { return s.id === studentId; });
      if (!student) { showToast('Student not found'); return; }

      google.script.run
        .withSuccessHandler(function(checkIns) {
          try {
            appState.currentCheckIns = checkIns || [];
            renderCheckInForm(student, checkIns, existingCheckIn);
          } catch(e) { showToast('Render error: ' + e.message); }
        })
        .withFailureHandler(function(err) { showToast('Error: ' + (err && err.message ? err.message : String(err))); })
        .getCheckIns(studentId);
    })
    .withFailureHandler(function(err) { showToast('Error: ' + (err && err.message ? err.message : String(err))); })
    .getStudents();
}

function renderCheckInForm(student, checkIns, existingCheckIn) {
  document.getElementById('checkin-view-breadcrumb').textContent = 'Weekly Check-In';
  document.getElementById('checkin-view-title').innerHTML = esc(student.firstName + ' ' + student.lastName) + (student.online ? ' <span class="online-badge" title="Online">Online</span>' : '') + buildBirthdayBadge_(student.birthday);

  var container = document.getElementById('checkin-form-container');
  var html = '';

  // ── Previous Goal Banner (top of form) ──
  var lastCheckIn = null;
  if (existingCheckIn) {
    // When editing, show the goal from the check-in before this one
    var others = checkIns.filter(function(ci) { return ci.id !== existingCheckIn.id; });
    lastCheckIn = others.length > 0 ? others[0] : null;
  } else {
    // For new check-in, show the goal from the most recent check-in
    lastCheckIn = checkIns.length > 0 ? checkIns[0] : null;
  }

  if (lastCheckIn && lastCheckIn.microGoal) {
    html += '<div class="prev-goal-banner">' +
      '<div class="banner-label">Previous Goal</div>' +
      '<div class="banner-goal">' + esc(lastCheckIn.microGoal) + '</div>' +
      '<div class="banner-date">Set on check-in: ' + esc(lastCheckIn.weekOf || 'Unknown date') + '</div>' +
    '</div>';
    // Goal met tracking
    var prefillGoalMet = (existingCheckIn && existingCheckIn.goalMet) || '';
    html += '<div class="goal-met-section">' +
      '<label>Did the student meet this goal?</label>' +
      '<div class="goal-met-options">' +
        '<button class="goal-met-btn' + (prefillGoalMet === 'yes' ? ' selected' : '') + '" data-goal-met="yes" onclick="selectGoalMet(this, \'yes\')">Yes</button>' +
        '<button class="goal-met-btn' + (prefillGoalMet === 'partially' ? ' selected' : '') + '" data-goal-met="partially" onclick="selectGoalMet(this, \'partially\')">Partially</button>' +
        '<button class="goal-met-btn' + (prefillGoalMet === 'no' ? ' selected' : '') + '" data-goal-met="no" onclick="selectGoalMet(this, \'no\')">No</button>' +
      '</div>' +
    '</div>';
  } else {
    html += '<div class="prev-goal-banner no-goal">' +
      '<div class="banner-label">Previous Goal</div>' +
      '<div class="banner-goal">No previous goal set</div>' +
    '</div>';
  }

  // Pre-fill values from existing check-in (if editing)
  var ci = existingCheckIn || {};
  var today = new Date().toISOString().slice(0, 10);

  html += '<div class="form-card">';

  // Week Of
  html += '<div class="form-section">' +
    '<div class="form-group">' +
      '<label>Week Of</label>' +
      '<input type="date" id="ci-weekOf" value="' + esc(ci.weekOf || today) + '">' +
    '</div>' +
  '</div>';

  // EF Ratings
  html += '<div class="form-section">' +
    '<div class="form-section-title">Executive Function Ratings</div>';

  var efDimensions = [
    { key: 'planningRating', label: 'Planning' },
    { key: 'followThroughRating', label: 'Follow-Through' },
    { key: 'regulationRating', label: 'Regulation' },
    { key: 'focusGoalRating', label: 'Focus Goal' },
    { key: 'effortRating', label: 'Effort' }
  ];

  efDimensions.forEach(function(dim) {
    var currentVal = Number(ci[dim.key]) || 0;
    html += '<div class="form-group">' +
      '<label>' + dim.label + '</label>' +
      '<div class="rating-group" data-field="' + dim.key + '">';
    for (var r = 1; r <= 5; r++) {
      var sel = (r === currentVal) ? ' selected' : '';
      html += '<button type="button" class="rating-btn' + sel + '" data-value="' + r + '" onclick="selectRating(this)">' + r + '</button>';
    }
    html += '</div></div>';
  });

  html += '</div>';

  // Reflection
  html += '<div class="form-section">' +
    '<div class="form-section-title">Reflection</div>' +
    '<div class="form-group"><label>What went well?</label>' +
      '<textarea id="ci-whatWentWell">' + esc(ci.whatWentWell || '') + '</textarea></div>' +
    '<div class="form-group"><label>Barrier / Challenge</label>' +
      '<textarea id="ci-barrier">' + esc(ci.barrier || '') + '</textarea></div>' +
  '</div>';

  // Micro Goal
  html += '<div class="form-section">' +
    '<div class="form-section-title">Micro Goal</div>' +
    '<div class="form-group"><label>Goal for next week</label>' +
      '<input type="text" id="ci-microGoal" value="' + esc(ci.microGoal || '') + '"></div>' +
    '<div class="form-group"><label>Category</label>' +
      '<select id="ci-microGoalCategory">';

  var categories = [
    '', 'Planning & Prioritization', 'Organization', 'Time Management',
    'Task Initiation', 'Sustained Attention', 'Flexibility',
    'Metacognition', 'Working Memory', 'Emotional Regulation', 'Other'
  ];
  categories.forEach(function(cat) {
    var sel = ((ci.microGoalCategory || '') === cat) ? ' selected' : '';
    html += '<option value="' + esc(cat) + '"' + sel + '>' + (cat || '-- Select --') + '</option>';
  });

  html += '</select></div></div>';

  // Academic Snapshot
  html += '<div class="form-section">' +
    '<div class="form-section-title">Academic Snapshot</div>';

  var classes = student.classes || [];

  // Build lookup maps for pre-filling grades
  var prevAcademic = {};
  if (lastCheckIn && lastCheckIn.academicData) {
    lastCheckIn.academicData.forEach(function(ad) { prevAcademic[ad.className] = ad; });
  }
  var editAcademic = {};
  if (existingCheckIn && existingCheckIn.academicData) {
    existingCheckIn.academicData.forEach(function(ad) { editAcademic[ad.className] = ad; });
  }

  if (classes.length > 0) {
    var grades = ['', 'A', 'A-', 'B+', 'B', 'B-', 'C+', 'C', 'C-', 'D+', 'D', 'D-', 'F'];

    html += '<table class="academic-table" id="academic-table">' +
      '<thead><tr><th>Class</th><th>Grade</th><th>Missing</th></tr></thead><tbody>';

    classes.forEach(function(cls, clsIdx) {
      var className = cls.name || cls;
      var classPeriod = cls.period || '';
      var displayName = classPeriod ? className + ' (P' + classPeriod + ')' : className;
      var existing = editAcademic[className] || prevAcademic[className] || {};
      var assignments = existing.missingAssignments || [];
      var missingCount = assignments.length || (Number(existing.missing) || 0);
      var badgeClass = missingCount === 0 ? 'chip-green' : missingCount <= 3 ? 'chip-yellow' : 'chip-red';

      html += '<tr class="acad-row">' +
        '<td class="class-name-col">' + esc(displayName) +
          '<input type="hidden" class="acad-class-name" value="' + esc(className) + '">' +
        '</td>' +
        '<td><select class="acad-grade">';

      grades.forEach(function(g) {
        var sel = ((existing.grade || '') === g) ? ' selected' : '';
        html += '<option value="' + g + '"' + sel + '>' + (g || '--') + '</option>';
      });

      html += '</select></td>' +
        '<td>' +
          '<button type="button" class="missing-toggle chip ' + badgeClass + '" onclick="toggleCheckInMissing(' + clsIdx + ')">' +
            '<span id="ci-missing-count-' + clsIdx + '">' + missingCount + '</span>' +
            ' <svg class="expand-chevron" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>' +
          '</button>' +
        '</td>' +
      '</tr>';

      // Expandable missing assignments detail row
      html += '<tr class="acad-missing-row" id="acad-missing-row-' + clsIdx + '" style="display:none;">' +
        '<td colspan="3">' +
          '<div class="ci-missing-container">' +
            '<div class="ci-missing-list" id="ci-missing-list-' + clsIdx + '">';

      // Render existing individual assignments
      assignments.forEach(function(a) {
        html += renderCheckInMissingItem(clsIdx, a.name || '', a.type || '');
      });

      html += '</div>' +
            '<button type="button" class="btn-ghost btn-sm" onclick="addCheckInMissing(' + clsIdx + ')">+ Add Missing Assignment</button>' +
          '</div>' +
        '</td>' +
      '</tr>';
    });

    html += '</tbody></table>';
  } else {
    html += '<p class="hint">No classes configured for this student.</p>' +
      '<button class="btn-ghost btn-sm" onclick="goBackFromCheckIn(); editStudent(\'' + student.id + '\')">Add Classes</button>';
  }

  html += '</div>';

  // Teacher Notes
  html += '<div class="form-section">' +
    '<div class="form-section-title">Teacher Notes</div>' +
    '<div class="form-group"><label>Notes</label>' +
      '<textarea id="ci-teacherNotes">' + esc(ci.teacherNotes || '') + '</textarea></div>' +
  '</div>';

  // Buttons + autosave indicator
  html += '<div class="checkin-form-footer">' +
    '<div id="ci-autosave-status" class="autosave-status"></div>' +
    '<div style="display:flex;gap:8px;">' +
      '<button class="btn btn-secondary" onclick="goBackFromCheckIn()">Back</button>' +
      '<button class="btn btn-primary" onclick="saveCheckIn()">Save Check-In</button>' +
    '</div>' +
  '</div>';

  html += '</div>'; // form-card

  container.innerHTML = html;
  animateContentIn(container);
  setupCheckInAutosave();
}

function selectRating(btn) {
  var group = btn.parentElement;
  group.querySelectorAll('.rating-btn').forEach(function(b) { b.classList.remove('selected'); });
  btn.classList.add('selected');
  scheduleCheckInAutosave();
}

function getSelectedRating(field) {
  var group = document.querySelector('.rating-group[data-field="' + field + '"]');
  if (!group) return '';
  var selected = group.querySelector('.rating-btn.selected');
  return selected ? selected.getAttribute('data-value') : '';
}

// ─── Check-In Inline Missing Assignment Helpers ───
function renderCheckInMissingItem(clsIdx, name, type) {
  return '<div class="ci-missing-item" data-class-idx="' + clsIdx + '">' +
    '<input type="text" class="ci-ma-name" value="' + esc(name) + '" placeholder="Assignment name">' +
    '<select class="ci-ma-type">' +
      '<option value=""' + (!type ? ' selected' : '') + '>-- Type --</option>' +
      '<option value="Formative"' + (type === 'Formative' ? ' selected' : '') + '>Formative</option>' +
      '<option value="Summative"' + (type === 'Summative' ? ' selected' : '') + '>Summative</option>' +
    '</select>' +
    '<button type="button" class="btn-remove-class" onclick="removeCheckInMissing(this, ' + clsIdx + ')">&times;</button>' +
  '</div>';
}

function toggleCheckInMissing(clsIdx) {
  var row = document.getElementById('acad-missing-row-' + clsIdx);
  if (!row) return;
  if (row.style.display === 'none') {
    row.style.display = '';
  } else {
    row.style.display = 'none';
  }
}

function addCheckInMissing(clsIdx) {
  var list = document.getElementById('ci-missing-list-' + clsIdx);
  var div = document.createElement('div');
  div.innerHTML = renderCheckInMissingItem(clsIdx, '', '');
  list.appendChild(div.firstChild);
  updateCheckInMissingCount(clsIdx);
  scheduleCheckInAutosave();
  // Focus the new name input
  var items = list.querySelectorAll('.ci-missing-item');
  var last = items[items.length - 1];
  if (last) last.querySelector('.ci-ma-name').focus();
}

function removeCheckInMissing(btn, clsIdx) {
  btn.parentElement.remove();
  updateCheckInMissingCount(clsIdx);
  scheduleCheckInAutosave();
}

function updateCheckInMissingCount(clsIdx) {
  var list = document.getElementById('ci-missing-list-' + clsIdx);
  var count = list.querySelectorAll('.ci-missing-item').length;
  var countEl = document.getElementById('ci-missing-count-' + clsIdx);
  countEl.textContent = count;
  // Update badge color
  var btn = countEl.closest('.missing-toggle');
  btn.className = 'missing-toggle chip ' +
    (count === 0 ? 'chip-green' : count <= 3 ? 'chip-yellow' : 'chip-red');
}

function getAcademicData() {
  var table = document.getElementById('academic-table');
  if (!table) return [];
  var rows = table.querySelectorAll('tbody tr.acad-row');
  var result = [];
  rows.forEach(function(row, idx) {
    var missingItems = [];
    var list = document.getElementById('ci-missing-list-' + idx);
    if (list) {
      list.querySelectorAll('.ci-missing-item').forEach(function(item) {
        var name = item.querySelector('.ci-ma-name').value.trim();
        var type = item.querySelector('.ci-ma-type').value;
        if (name) {
          missingItems.push({ name: name, type: type });
        }
      });
    }
    result.push({
      className: row.querySelector('.acad-class-name').value,
      grade: row.querySelector('.acad-grade').value,
      missing: missingItems.length,
      missingAssignments: missingItems
    });
  });
  return result;
}

function selectGoalMet(btn, value) {
  var btns = btn.parentElement.querySelectorAll('.goal-met-btn');
  btns.forEach(function(b) { b.classList.remove('selected'); });
  btn.classList.add('selected');
  btn.dataset.goalMet = value;
}

function getSelectedGoalMet() {
  var selected = document.querySelector('.goal-met-btn.selected');
  return selected ? (selected.dataset.goalMet || '') : '';
}

function collectCheckInData() {
  var weekOfEl = document.getElementById('ci-weekOf');
  if (!weekOfEl) return null;
  return {
    studentId: appState.currentStudentId,
    weekOf: weekOfEl.value,
    planningRating: getSelectedRating('planningRating'),
    followThroughRating: getSelectedRating('followThroughRating'),
    regulationRating: getSelectedRating('regulationRating'),
    focusGoalRating: getSelectedRating('focusGoalRating'),
    effortRating: getSelectedRating('effortRating'),
    whatWentWell: document.getElementById('ci-whatWentWell').value,
    barrier: document.getElementById('ci-barrier').value,
    microGoal: document.getElementById('ci-microGoal').value,
    microGoalCategory: document.getElementById('ci-microGoalCategory').value,
    teacherNotes: document.getElementById('ci-teacherNotes').value,
    academicData: getAcademicData(),
    goalMet: getSelectedGoalMet()
  };
}

function saveCheckIn() {
  // Cancel any pending autosave
  if (_ciAutosaveTimer) {
    clearTimeout(_ciAutosaveTimer);
    _ciAutosaveTimer = null;
  }

  var data = collectCheckInData();
  if (!data) return;

  if (appState.editingCheckIn && appState.editingCheckIn.id) {
    data.id = appState.editingCheckIn.id;
  }

  // Reset autosave state
  _ciAutosaveDirty = false;

  // Optimistic UI: navigate immediately
  showView('dashboard-view');
  renderDashboard(applyFilter_(appState.dashboardData));
  showToast('Saving check-in\u2026');

  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showToast('Check-in saved');
        renderDashboardFromState();
        _lastDashboardFetch = 0;
      } else {
        showToast('Error saving check-in');
      }
    })
    .withFailureHandler(function(err) { showToast('Error: ' + (err && err.message ? err.message : String(err))); })
    .saveCheckIn(data);
}

function goBackFromCheckIn() {
  // Cancel any pending autosave timer
  if (_ciAutosaveTimer) {
    clearTimeout(_ciAutosaveTimer);
    _ciAutosaveTimer = null;
  }
  // If there are unsaved changes, do a final save before leaving
  if (_ciAutosaveDirty && !_ciAutosaveInFlight && appState.editingCheckIn && appState.editingCheckIn.id) {
    var data = collectCheckInData();
    if (data) {
      data.id = appState.editingCheckIn.id;
      _ciAutosaveDirty = false;
      google.script.run
        .withSuccessHandler(function() { renderDashboardFromState(); _lastDashboardFetch = 0; })
        .withFailureHandler(function() {})
        .saveCheckIn(data);
    }
  }
  showDashboard();
}

// ─── Check-In Autosave ───

function setupCheckInAutosave() {
  var container = document.getElementById('checkin-form-container');
  if (!container) return;

  // Listen for input/change events on all form fields
  container.addEventListener('input', function() { scheduleCheckInAutosave(); });
  container.addEventListener('change', function() { scheduleCheckInAutosave(); });

  // Reset autosave state
  _ciAutosaveDirty = false;
  _ciAutosaveInFlight = false;
  if (_ciAutosaveTimer) { clearTimeout(_ciAutosaveTimer); _ciAutosaveTimer = null; }
  updateAutosaveIndicator('idle');
}

function scheduleCheckInAutosave() {
  _ciAutosaveDirty = true;
  updateAutosaveIndicator('unsaved');
  if (_ciAutosaveTimer) clearTimeout(_ciAutosaveTimer);
  _ciAutosaveTimer = setTimeout(function() {
    _ciAutosaveTimer = null;
    performCheckInAutosave();
  }, 2000);
}

function performCheckInAutosave() {
  if (_ciAutosaveInFlight) {
    // Already saving — re-schedule to pick up latest changes
    scheduleCheckInAutosave();
    return;
  }

  var data = collectCheckInData();
  if (!data) return;

  if (appState.editingCheckIn && appState.editingCheckIn.id) {
    data.id = appState.editingCheckIn.id;
  }

  _ciAutosaveInFlight = true;
  _ciAutosaveDirty = false;
  updateAutosaveIndicator('saving');

  google.script.run
    .withSuccessHandler(function(result) {
      _ciAutosaveInFlight = false;
      if (result && result.success) {
        // Store the ID so future saves update the same record
        if (!appState.editingCheckIn) {
          appState.editingCheckIn = {};
        }
        appState.editingCheckIn.id = result.id;

        if (_ciAutosaveDirty) {
          scheduleCheckInAutosave();
        } else {
          updateAutosaveIndicator('saved');
        }
      } else {
        updateAutosaveIndicator('error');
      }
    })
    .withFailureHandler(function() {
      _ciAutosaveInFlight = false;
      updateAutosaveIndicator('error');
    })
    .saveCheckIn(data);
}

function updateAutosaveIndicator(state, elementId) {
  var el = document.getElementById(elementId || 'ci-autosave-status');
  if (!el) return;
  var html = '';
  switch(state) {
    case 'saving':
      html = '<span class="autosave-saving"><span class="autosave-spinner"></span> Saving\u2026</span>';
      break;
    case 'saved':
      html = '<span class="autosave-saved"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg> All changes saved</span>';
      break;
    case 'unsaved':
      html = '<span class="autosave-unsaved">Unsaved changes</span>';
      break;
    case 'error':
      html = '<span class="autosave-error">Error saving — try again</span>';
      break;
    default:
      html = '';
  }
  el.innerHTML = html;
}

// ─── Goals Autosave ───

function setupGoalsAutosave() {
  var container = document.getElementById('goals-autosave-container');
  if (!container) return;

  container.addEventListener('input', function() { scheduleGoalsAutosave(); });
  container.addEventListener('change', function() { scheduleGoalsAutosave(); });
  container.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && appState.editingGoalId) {
      e.stopPropagation();
      exitGoalEditMode();
    }
  });

  _goalsAutosaveDirty = false;
  _goalsAutosaveInFlight = false;
  if (_goalsAutosaveTimer) { clearTimeout(_goalsAutosaveTimer); _goalsAutosaveTimer = null; }
  updateGoalsAutosaveIndicator('idle');
}

function scheduleGoalsAutosave() {
  _goalsAutosaveDirty = true;
  updateGoalsAutosaveIndicator('unsaved');
  if (_goalsAutosaveTimer) clearTimeout(_goalsAutosaveTimer);
  _goalsAutosaveTimer = setTimeout(function() {
    _goalsAutosaveTimer = null;
    performGoalsAutosave();
  }, 2000);
}

function performGoalsAutosave() {
  if (_goalsAutosaveInFlight) {
    scheduleGoalsAutosave();
    return;
  }

  var goalsData = collectGoalsData();
  var goalsJson = JSON.stringify(goalsData);
  var studentId = appState.currentStudentId;
  if (!studentId) return;

  _goalsAutosaveInFlight = true;
  _goalsAutosaveDirty = false;
  updateGoalsAutosaveIndicator('saving');

  google.script.run
    .withSuccessHandler(function(result) {
      _goalsAutosaveInFlight = false;
      if (result && result.success) {
        // Update local state
        var s = appState.dashboardData.find(function(st) { return st.id === studentId; });
        if (s) {
          s.goalsJson = goalsJson;
          s.goals = goalsData;
        }
        if (appState.currentStudent) {
          appState.currentStudent.goalsJson = goalsJson;
          appState.currentStudent.goals = goalsData;
        }
        // Sync in-memory goals from saved data (if still on same student and not editing)
        if (studentId === appState.currentStudentId && !appState.editingGoalId) {
          appState.currentGoals = goalsData;
        }

        if (_goalsAutosaveDirty) {
          scheduleGoalsAutosave();
        } else {
          updateGoalsAutosaveIndicator('saved');
        }
      } else {
        updateGoalsAutosaveIndicator('error');
      }
    })
    .withFailureHandler(function() {
      _goalsAutosaveInFlight = false;
      updateGoalsAutosaveIndicator('error');
    })
    .saveStudentGoals(studentId, goalsJson);
}

function collectGoalsData() {
  // Hybrid: read from appState.currentGoals, but for the editing goal read from DOM
  saveEditingGoalToState_();
  return appState.currentGoals.map(function(g) {
    return { id: g.id, text: g.text, goalArea: g.goalArea || '', responsibleEmail: g.responsibleEmail || '', objectives: (g.objectives || []).map(function(o) { return { id: o.id, text: o.text }; }) };
  });
}

function saveEditingGoalToState_() {
  var editId = appState.editingGoalId;
  if (!editId) return;
  var container = document.getElementById('goals-autosave-container');
  if (!container) return;
  var goalEl = container.querySelector('.goal-card[data-goal-id="' + editId + '"]');
  if (!goalEl) return;

  var goalText = goalEl.querySelector('[data-field="goal-text"]');
  var goalAreaPicker = goalEl.querySelector('.goal-area-picker');
  var responsibleSelect = goalEl.querySelector('[data-field="goal-responsible"]');

  for (var i = 0; i < appState.currentGoals.length; i++) {
    if (appState.currentGoals[i].id === editId) {
      if (goalText) appState.currentGoals[i].text = goalText.value;
      if (goalAreaPicker) {
        var selected = goalAreaPicker.getAttribute('data-selected');
        if (selected !== null) appState.currentGoals[i].goalArea = selected;
      }
      if (responsibleSelect) appState.currentGoals[i].responsibleEmail = responsibleSelect.value;

      // Read objectives from DOM
      var objItems = goalEl.querySelectorAll('.profile-objective-item');
      var objectives = [];
      objItems.forEach(function(objEl) {
        var objId = objEl.getAttribute('data-obj-id') || '';
        var objText = objEl.querySelector('[data-field="obj-text"]');
        objectives.push({ id: objId, text: objText ? objText.value : '' });
      });
      appState.currentGoals[i].objectives = objectives;
      break;
    }
  }
}

function updateGoalsAutosaveIndicator(state) {
  updateAutosaveIndicator(state, 'goals-autosave-status');
}

// ─── Goal Mode Toggle Functions ───

function enterGoalEditMode(goalId) {
  // Save + exit previous editing goal
  if (appState.editingGoalId && appState.editingGoalId !== goalId) {
    saveEditingGoalToState_();
    var prevId = appState.editingGoalId;
    appState.editingGoalId = null;
    rerenderGoalCard(prevId);
  }
  appState.editingGoalId = goalId;
  appState.expandedGoalIds[goalId] = true;
  rerenderGoalCard(goalId);
  // Focus goal text
  var container = document.getElementById('goals-autosave-container');
  if (container) {
    var textarea = container.querySelector('.goal-card[data-goal-id="' + goalId + '"] [data-field="goal-text"]');
    if (textarea) textarea.focus();
  }
}

function exitGoalEditMode() {
  var goalId = appState.editingGoalId;
  if (!goalId) return;
  saveEditingGoalToState_();
  appState.editingGoalId = null;
  rerenderGoalCard(goalId);
  scheduleGoalsAutosave();
  showToast('Goal saved');
}

function toggleGoalExpand(goalId) {
  // Don't collapse if currently editing this goal
  if (appState.editingGoalId === goalId) return;
  if (appState.expandedGoalIds[goalId]) {
    delete appState.expandedGoalIds[goalId];
  } else {
    appState.expandedGoalIds[goalId] = true;
  }
  rerenderGoalCard(goalId);
}

function rerenderGoalCard(goalId) {
  var container = document.getElementById('goals-autosave-container');
  if (!container) return;
  var el = container.querySelector('.goal-card[data-goal-id="' + goalId + '"]');
  if (!el) return;
  var goal = null;
  for (var i = 0; i < appState.currentGoals.length; i++) {
    if (appState.currentGoals[i].id === goalId) { goal = appState.currentGoals[i]; break; }
  }
  if (!goal) { el.remove(); return; }
  el.outerHTML = renderGoalCard(goal);
}

function addGoal() {
  var container = document.getElementById('goals-autosave-container');
  if (!container) return;

  // Exit any currently editing goal first
  if (appState.editingGoalId) {
    saveEditingGoalToState_();
    var prevId = appState.editingGoalId;
    appState.editingGoalId = null;
    rerenderGoalCard(prevId);
  }

  var goalId = 'goal-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5);
  var goal = { id: goalId, text: '', goalArea: '', responsibleEmail: '', objectives: [] };
  appState.currentGoals.push(goal);

  // Remove empty state if present
  var emptyState = container.querySelector('.goal-card-empty-state');
  if (emptyState) emptyState.remove();

  // Set editing and expanded
  appState.editingGoalId = goalId;
  appState.expandedGoalIds[goalId] = true;

  var div = document.createElement('div');
  div.innerHTML = renderGoalCard(goal);
  var goalEl = div.firstChild;
  container.appendChild(goalEl);

  // Focus goal text input
  var textInput = goalEl.querySelector('[data-field="goal-text"]');
  if (textInput) textInput.focus();
  scheduleGoalsAutosave();
}

function removeGoal(goalId) {
  showConfirmDialog({
    title: 'Delete Goal',
    body: 'Are you sure you want to delete this goal and all its objectives? This cannot be undone.',
    confirmLabel: 'Delete',
    onConfirm: 'confirmRemoveGoal(\'' + esc(goalId) + '\')'
  });
}

function confirmRemoveGoal(goalId) {
  appState.currentGoals = appState.currentGoals.filter(function(g) { return g.id !== goalId; });
  if (appState.editingGoalId === goalId) appState.editingGoalId = null;
  delete appState.expandedGoalIds[goalId];

  var container = document.getElementById('goals-autosave-container');
  if (container) {
    var el = container.querySelector('.goal-card[data-goal-id="' + goalId + '"]');
    if (el) el.remove();
    if (appState.currentGoals.length === 0) {
      container.innerHTML = '<div class="goal-card-empty-state">No goals added yet</div>';
    }
  }
  scheduleGoalsAutosave();
}

function addObjective(goalId) {
  var container = document.getElementById('goals-autosave-container');
  if (!container) return;
  var goalEl = container.querySelector('.goal-card[data-goal-id="' + goalId + '"]');
  if (!goalEl) return;
  var objList = goalEl.querySelector('.profile-objectives-list');
  if (!objList) return;

  var objId = 'obj-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5);
  var objHtml = '<div class="profile-objective-item" data-obj-id="' + objId + '">' +
    '<textarea data-field="obj-text" placeholder="Enter objective..."></textarea>' +
    '<button class="goal-remove-btn" onclick="removeObjective(\'' + esc(goalId) + '\', \'' + objId + '\')" title="Remove objective">' +
      '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>' +
    '</button>' +
  '</div>';

  // Insert before the "Add Objective" button
  var addBtn = objList.querySelector('.btn-ghost');
  var div = document.createElement('div');
  div.innerHTML = objHtml;
  var objEl = div.firstChild;
  objList.insertBefore(objEl, addBtn);

  var textarea = objEl.querySelector('[data-field="obj-text"]');
  if (textarea) textarea.focus();
  scheduleGoalsAutosave();
}

function removeObjective(goalId, objId) {
  var container = document.getElementById('goals-autosave-container');
  if (!container) return;
  var goalEl = container.querySelector('.goal-card[data-goal-id="' + goalId + '"]');
  if (!goalEl) return;
  var objEl = goalEl.querySelector('[data-obj-id="' + objId + '"]');
  if (objEl) objEl.remove();
  saveEditingGoalToState_();
  scheduleGoalsAutosave();
}

// ─── Missing Assignments View (child page) ───
function showMissingAssignments(studentId) {
  var student = getStudentById(studentId);
  if (!student) { showToast('Student not found'); return; }

  appState.missingViewStudentId = studentId;

  document.getElementById('missing-view-breadcrumb').innerHTML =
    '<button class="breadcrumb-link" onclick="editStudent(appState.missingViewStudentId)">Student Profile</button> <svg class="breadcrumb-chevron" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg> Missing Assignments';
  document.getElementById('missing-view-title').innerHTML =
    esc(student.firstName + ' ' + student.lastName) + (student.online ? ' <span class="online-badge" title="Online">Online</span>' : '') + buildBirthdayBadge_(student.birthday);

  renderMissingView(student);
  showView('missing-view');
}

function renderMissingView(student) {
  var container = document.getElementById('missing-content-container');
  var academicData = student.academicData || [];
  var totalMissing = student.totalMissing || 0;
  var html = '';

  // Summary card
  if (totalMissing === 0) {
    html += '<div class="missing-summary ok">' +
      '<div class="missing-summary-label" style="font-size:22px;font-weight:600;">No Missing Assignments! &#x1F4AF;</div>' +
    '</div>';
  } else {
    html += '<div class="missing-summary alert">' +
      '<div class="missing-summary-count">' + totalMissing + '</div>' +
      '<div class="missing-summary-label">Total Missing Assignments</div>' +
    '</div>';
  }

  if (academicData.length === 0) {
    html += '<div class="empty-state" style="padding:40px 20px;">' +
      '<p>No academic data from the latest check-in.</p>' +
    '</div>';
  } else {
    html += '<div class="missing-class-cards">';

    academicData.forEach(function(c, idx) {
      var missingNum = Number(c.missing) || 0;
      var assignments = c.missingAssignments || [];
      var badgeClass = missingNum === 0 ? 'badge-green' : missingNum <= 3 ? 'badge-yellow' : 'badge-red';
      var classLabel = c.className || 'Unknown';

      // Find period from student's class list
      var matchedClass = (student.classes || []).find(function(cl) {
        return cl.name === c.className;
      });
      if (matchedClass && matchedClass.period) classLabel += ' (P' + matchedClass.period + ')';

      html += '<div class="missing-class-card" id="missing-card-' + idx + '">' +
        '<div class="missing-class-header" onclick="toggleMissingClass(' + idx + ')">' +
          '<div class="missing-class-info">' +
            '<span class="missing-class-name">' + esc(classLabel) + '</span>' +
            '<span class="missing-class-grade">' + esc(c.grade || '--') + '</span>' +
          '</div>' +
          '<div class="missing-class-right">' +
            '<div class="missing-class-badge ' + badgeClass + '">' + missingNum + '</div>' +
            '<svg class="expand-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>' +
          '</div>' +
        '</div>' +
        '<div class="missing-class-detail" id="missing-class-detail-' + idx + '">';

      if (missingNum === 0) {
        html += '<div class="missing-none-msg">No missing assignments</div>';
      } else if (assignments.length > 0) {
        // Sort by name then type, tracking original indices
        var sorted = assignments.map(function(a, i) {
          return { name: a.name, type: a.type, _origIdx: i };
        }).sort(function(a, b) {
          var nameComp = (a.name || '').localeCompare(b.name || '');
          if (nameComp !== 0) return nameComp;
          return (a.type || '').localeCompare(b.type || '');
        });

        html += '<table class="missing-detail-table">' +
          '<thead><tr><th>Assignment Name</th><th>Type</th><th>Actions</th></tr></thead><tbody>';
        sorted.forEach(function(a) {
          var typeClass = a.type === 'Summative' ? 'type-summative' :
                          a.type === 'Formative' ? 'type-formative' : '';
          html += '<tr>' +
            '<td>' + esc(a.name || 'Untitled') + '</td>' +
            '<td><span class="assignment-type ' + typeClass + '">' +
              esc(a.type || 'Unknown') + '</span></td>' +
            '<td class="missing-actions-cell">' +
              '<button class="missing-action-btn btn-check" onclick="event.stopPropagation(); markMissingDone(\'' + student.id + '\', ' + idx + ', ' + a._origIdx + ')" title="Mark as complete">' +
                '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>' +
              '</button>' +
              '<button class="missing-action-btn btn-delete" onclick="event.stopPropagation(); removeMissingAssignment(\'' + student.id + '\', ' + idx + ', ' + a._origIdx + ')" title="Remove assignment">' +
                '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>' +
              '</button>' +
            '</td>' +
          '</tr>';
        });
        html += '</tbody></table>';
      } else {
        html += '<div class="missing-count-only">' + missingNum +
          ' missing assignment' + (missingNum !== 1 ? 's' : '') +
          ' recorded (no details available)</div>';
      }

      // Add Missing Assignment inline form
      html += '<div class="mv-add-section">' +
        '<button type="button" class="btn-ghost btn-sm mv-add-btn" id="mv-add-btn-' + idx + '" onclick="event.stopPropagation(); showAddMissingForm(\'' + student.id + '\', ' + idx + ')">+ Add Missing Assignment</button>' +
        '<div class="mv-add-form" id="mv-add-form-' + idx + '" style="display:none;">' +
          '<div class="mv-add-form-row">' +
            '<input type="text" class="mv-add-name" id="mv-add-name-' + idx + '" placeholder="Assignment name" onkeydown="if(event.key===\'Enter\'){event.preventDefault();confirmAddMissing(\'' + student.id + '\',' + idx + ');}">' +
            '<select class="mv-add-type" id="mv-add-type-' + idx + '">' +
              '<option value="">-- Type --</option>' +
              '<option value="Formative">Formative</option>' +
              '<option value="Summative">Summative</option>' +
            '</select>' +
            '<button type="button" class="mv-confirm-btn" id="mv-confirm-btn-' + idx + '" onclick="event.stopPropagation(); confirmAddMissing(\'' + student.id + '\', ' + idx + ')" title="Add assignment">' +
              '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>' +
            '</button>' +
          '</div>' +
        '</div>' +
      '</div>';

      html += '</div></div>';
    });

    html += '</div>';
  }

  // Action buttons
  html += '<div class="missing-actions">' +
    '<button class="btn btn-primary" onclick="goBackFromMissing(); startCheckIn(\'' + student.id + '\')">New Check-In</button>' +
    '<button class="btn btn-secondary" onclick="goBackFromMissing()">Back</button>' +
  '</div>';

  container.innerHTML = html;
  animateContentIn(container);
}

function toggleMissingClass(idx) {
  document.getElementById('missing-card-' + idx).classList.toggle('expanded');
}

function launchConfetti(originEl) {
  var rect = originEl ? originEl.getBoundingClientRect() : { left: window.innerWidth / 2, top: window.innerHeight / 2 };
  var colors = ['#4CAF50', '#FFC107', '#2196F3', '#E91E63', '#9C27B0', '#FF5722', '#00BCD4'];
  var shapes = ['circle', 'square'];
  var count = 40;

  for (var i = 0; i < count; i++) {
    (function(index) {
      var piece = document.createElement('div');
      var size = Math.random() * 8 + 5;
      var color = colors[Math.floor(Math.random() * colors.length)];
      var shape = shapes[Math.floor(Math.random() * shapes.length)];
      var angle = (Math.random() * 360) * (Math.PI / 180);
      var velocity = Math.random() * 200 + 100;
      var dx = Math.cos(angle) * velocity;
      var dy = Math.sin(angle) * velocity - 150;
      var rotation = Math.random() * 360;

      piece.style.cssText =
        'position:fixed;z-index:10000;pointer-events:none;' +
        'width:' + size + 'px;height:' + size + 'px;' +
        'background:' + color + ';' +
        'border-radius:' + (shape === 'circle' ? '50%' : '2px') + ';' +
        'left:' + rect.left + 'px;top:' + rect.top + 'px;' +
        'opacity:1;transform:rotate(' + rotation + 'deg);';

      document.body.appendChild(piece);

      var startTime = performance.now();
      var duration = 900 + Math.random() * 400;

      function animate(now) {
        var elapsed = now - startTime;
        var progress = Math.min(elapsed / duration, 1);
        var ease = 1 - Math.pow(1 - progress, 3);

        var x = rect.left + dx * ease;
        var y = rect.top + dy * ease + 300 * progress * progress;
        var opacity = progress < 0.7 ? 1 : 1 - ((progress - 0.7) / 0.3);
        var rot = rotation + 360 * ease;

        piece.style.left = x + 'px';
        piece.style.top = y + 'px';
        piece.style.opacity = opacity;
        piece.style.transform = 'rotate(' + rot + 'deg)';

        if (progress < 1) {
          requestAnimationFrame(animate);
        } else {
          piece.remove();
        }
      }

      requestAnimationFrame(animate);
    })(i);
  }
}

/** Shared logic for removing a missing assignment from a student's academic data. */
function modifyMissingAssignment(studentId, classIdx, assignmentIdx, opts) {
  var student = getStudentById(studentId);
  if (!student) return;
  var classData = student.academicData[classIdx];
  if (!classData || !classData.missingAssignments) return;

  if (opts && opts.confetti) {
    var btn = event && event.currentTarget ? event.currentTarget : null;
    launchConfetti(btn);
  }

  classData.missingAssignments.splice(assignmentIdx, 1);
  classData.missing = classData.missingAssignments.length;
  recalcTotalMissing(student);

  if (opts && opts.renderFn) {
    opts.renderFn(student);
  }
  persistAcademicData_(student);
  showToast(opts && opts.message || 'Assignment updated');
}

function markMissingDone(studentId, classIdx, assignmentIdx) {
  modifyMissingAssignment(studentId, classIdx, assignmentIdx, {
    confetti: true,
    renderFn: renderMissingView,
    message: 'Assignment marked as complete'
  });
}

function removeMissingAssignment(studentId, classIdx, assignmentIdx) {
  modifyMissingAssignment(studentId, classIdx, assignmentIdx, {
    renderFn: renderMissingView,
    message: 'Assignment removed'
  });
}

function persistAcademicData_(student) {
  if (!student.latestCheckInId) {
    showToast('Change not saved — no check-in data found.');
    return;
  }
  // Debounce: if user marks several assignments rapidly, only the last call persists
  if (_persistTimers[student.id]) clearTimeout(_persistTimers[student.id]);
  var checkInId = student.latestCheckInId;
  var dataSnapshot = JSON.parse(JSON.stringify(student.academicData));
  _persistTimers[student.id] = setTimeout(function() {
    delete _persistTimers[student.id];
    _persistInFlight++;
    google.script.run
      .withSuccessHandler(function() {
        _persistInFlight--;
        // Once all persists complete, sync dashboard from backend if visible
        if (_persistInFlight === 0 && Object.keys(_persistTimers).length === 0 &&
            document.getElementById('dashboard-view').classList.contains('active')) {
          renderDashboardFromState();
          _lastDashboardFetch = 0;
        }
      })
      .withFailureHandler(function(err) {
        _persistInFlight--;
        showToast('Could not save change: ' + (err && err.message ? err.message : String(err)));
      })
      .updateCheckInAcademicData(checkInId, dataSnapshot);
  }, 600);
}

// ─── Profile Dashboard — Missing Assignment Operations ───

function profileMarkDone(studentId, classIdx, assignmentIdx, btnEl) {
  // For profile view, confetti originates from the passed button element
  var student = getStudentById(studentId);
  if (!student) return;
  launchConfetti(btnEl);
  modifyMissingAssignment(studentId, classIdx, assignmentIdx, {
    renderFn: reRenderProfileAcademics,
    message: 'Assignment marked as complete'
  });
}

function profileRemoveAssignment(studentId, classIdx, assignmentIdx) {
  modifyMissingAssignment(studentId, classIdx, assignmentIdx, {
    renderFn: reRenderProfileAcademics,
    message: 'Assignment removed'
  });
}

function showProfileAddMissing(studentId, classIdx) {
  showAddMissingForm(studentId, classIdx, 'pv');
}

function profileChangeGrade(studentId, classIdx, newGrade) {
  var student = getStudentById(studentId);
  if (!student || !student.academicData || !student.academicData[classIdx]) return;

  student.academicData[classIdx].grade = newGrade;

  // Recalculate GPA locally (uses global GPA_MAP)
  var gpaValues = [];
  student.academicData.forEach(function(c) {
    if (c.grade && GPA_MAP.hasOwnProperty(c.grade)) gpaValues.push(GPA_MAP[c.grade]);
  });
  student.gpa = gpaValues.length > 0
    ? gpaValues.reduce(function(a, b) { return a + b; }, 0) / gpaValues.length
    : null;

  // Update the GPA stat card without full re-render
  var gpaCard = document.getElementById('profile-gpa-card');
  var gpaNumber = document.getElementById('profile-gpa-number');
  var gpaTrophy = document.getElementById('profile-gpa-trophy');
  if (gpaCard) {
    gpaCard.classList.remove('gpa-honor-roll', 'gpa-good-standing', 'gpa-caution', 'gpa-at-risk');
    if (student.gpa != null) {
      gpaCard.classList.add(student.gpa >= 3.5 ? 'gpa-honor-roll' : student.gpa > 3.0 ? 'gpa-good-standing' : student.gpa >= 2.5 ? 'gpa-caution' : 'gpa-at-risk');
    }
  }
  if (gpaNumber) {
    if (student.gpa != null) {
      gpaNumber.textContent = student.gpa.toFixed(2);
    } else {
      gpaNumber.textContent = '--';
    }
  }
  if (gpaTrophy) {
    if (student.gpa != null && student.gpa >= 3.7) {
      gpaTrophy.classList.add('visible');
    } else {
      gpaTrophy.classList.remove('visible');
    }
  }

  persistAcademicData_(student);
  showToast('Grade updated');
}

/** Shared logic for adding a missing assignment from an inline form. */
function addMissingFromForm_(studentId, classIdx, prefix, renderFn, opts) {
  var nameInput = document.getElementById(prefix + '-add-name-' + classIdx);
  var typeSelect = document.getElementById(prefix + '-add-type-' + classIdx);
  var name = nameInput.value.trim();
  var type = typeSelect.value;

  if (!name) {
    showToast('Please enter an assignment name');
    nameInput.focus();
    return;
  }

  var student = getStudentById(studentId);
  if (!student) return;
  var classData = student.academicData[classIdx];
  if (!classData) return;

  if (!classData.missingAssignments) classData.missingAssignments = [];
  classData.missingAssignments.push({ name: name, type: type });
  classData.missing = classData.missingAssignments.length;
  recalcTotalMissing(student);

  if (opts && opts.confirmBtn) {
    var confirmBtn = document.getElementById(prefix + '-confirm-btn-' + classIdx);
    if (confirmBtn) confirmBtn.classList.add('saved');
  }

  // Track expanded cards
  var expandedCards = [];
  var cardSelector = opts && opts.cardSelector || '.missing-class-card.expanded';
  document.querySelectorAll(cardSelector).forEach(function(card) {
    expandedCards.push(card.id);
  });

  function reExpandCards_() {
    expandedCards.forEach(function(cardId) {
      var card = document.getElementById(cardId);
      if (card) {
        card.classList.add('expanded');
        // For table-row detail, also expand the main row
        if (cardId.indexOf('profile-row-detail-') === 0) {
          var mainRow = document.getElementById(cardId.replace('profile-row-detail-', 'profile-row-'));
          if (mainRow) mainRow.classList.add('expanded');
        }
      }
    });
  }

  if (opts && opts.delay) {
    setTimeout(function() {
      renderFn(student);
      reExpandCards_();
      showToast('Assignment added');
    }, opts.delay);
  } else {
    renderFn(student);
    reExpandCards_();
    showToast('Assignment added');
  }

  persistAcademicData_(student);
}

function profileConfirmAddMissing(studentId, classIdx) {
  addMissingFromForm_(studentId, classIdx, 'pv', reRenderProfileAcademics, {
    cardSelector: '.profile-row-detail.expanded'
  });
}

function reRenderProfileAcademics(student) {
  // Track which profile rows are expanded
  var expandedRows = [];
  document.querySelectorAll('.profile-row-detail.expanded').forEach(function(row) {
    expandedRows.push(row.id);
  });

  // Save current goals from DOM before re-render so unsaved changes aren't lost
  var goalsData = collectGoalsData();
  if (goalsData.length > 0) {
    student.goalsJson = JSON.stringify(goalsData);
  }

  renderStudentProfileDashboard(student);

  // Re-expand previously expanded rows
  expandedRows.forEach(function(rowId) {
    var detailRow = document.getElementById(rowId);
    if (detailRow) {
      detailRow.classList.add('expanded');
      var mainRowId = rowId.replace('profile-row-detail-', 'profile-row-');
      var mainRow = document.getElementById(mainRowId);
      if (mainRow) mainRow.classList.add('expanded');
    }
  });
}

function goBackFromMissing() {
  renderDashboard(applyFilter_(appState.dashboardData));
  showView('dashboard-view');
}

// ─── Add Missing Assignment (from Missing View) ───

function showAddMissingForm(studentId, classIdx, prefix) {
  prefix = prefix || 'mv';
  var btn = document.getElementById(prefix + '-add-btn-' + classIdx);
  var form = document.getElementById(prefix + '-add-form-' + classIdx);
  if (btn) btn.style.display = 'none';
  if (form) form.style.display = '';
  var nameInput = document.getElementById(prefix + '-add-name-' + classIdx);
  if (nameInput) nameInput.focus();
}

function confirmAddMissing(studentId, classIdx) {
  addMissingFromForm_(studentId, classIdx, 'mv', renderMissingView, {
    confirmBtn: true,
    delay: 400,
    cardSelector: '.missing-class-card.expanded'
  });
}

// ─── Student Profile ───
function showAddStudent() {
  appState.currentStudentId = null;
  renderStudentForm({});
  document.getElementById('student-view-breadcrumb').textContent = 'Students';
  document.getElementById('student-view-title').textContent = 'New Student';
  renderStudentMenu(null);
  showView('student-view');
}

function editStudent(studentId) {
  showStudentProfile(studentId);
}

function showStudentProfile(studentId) {
  // Clean up any in-progress autosave from a previous student
  if (_progressAutosaveTimer) { clearTimeout(_progressAutosaveTimer); _progressAutosaveTimer = null; }
  _progressAutosaveInFlight = false;
  _progressAutosaveDirty = false;
  if (_goalsAutosaveTimer) { clearTimeout(_goalsAutosaveTimer); _goalsAutosaveTimer = null; }
  _goalsAutosaveInFlight = false;
  _goalsAutosaveDirty = false;

  // Clean up goal edit state
  appState.editingGoalId = null;
  appState.expandedGoalIds = {};
  appState.currentGoals = [];

  // Clean up progress edit state
  appState.expandedProgressGoalIds = {};
  appState.editingProgressGoalId = null;

  appState.currentStudentId = studentId;
  trackRecentStudent(studentId);
  document.getElementById('student-view-breadcrumb').textContent = 'Student Profile';
  document.getElementById('student-view-title').innerHTML = '<span class="skeleton skeleton-title-inline"></span>';
  showStudentProfileSkeleton();
  renderStudentMenu(studentId);
  showView('student-view');

  google.script.run
    .withSuccessHandler(function(students) {
      var student = (students || []).find(function(s) { return s.id === studentId; });
      if (!student) { showToast('Student not found'); return; }

      // Store student reference for edit access
      appState.currentStudent = student;

      try {
        document.getElementById('student-view-title').innerHTML =
          esc(student.firstName + ' ' + student.lastName) + (student.online ? ' <span class="online-badge" title="Online">Online</span>' : '') + buildBirthdayBadge_(student.birthday);
        renderStudentProfileDashboard(student);
        renderStudentMenu(studentId);
      } catch(e) { showToast('Render error: ' + e.message); return; }

      // Also load check-in history
      google.script.run
        .withSuccessHandler(function(checkIns) {
          try { renderCheckInHistory(checkIns, student); } catch(e) { showToast('History error: ' + e.message); }
        })
        .withFailureHandler(function() {})
        .getCheckIns(studentId);
    })
    .withFailureHandler(function(err) { showToast('Error: ' + (err && err.message ? err.message : String(err))); })
    .getDashboardData();
}

function buildMergedScheduleRows_(student) {
  var classes = (student.classes || []).slice();
  var academicData = student.academicData || [];
  var academicMap = {};
  academicData.forEach(function(c, idx) {
    academicMap[c.className] = { data: c, idx: idx };
  });

  var rows = [];
  var usedClassNames = {};

  classes.forEach(function(cl) {
    var entry = { period: cl.period || null, className: cl.name || 'Unknown', academicIdx: null, grade: null, missingNum: 0, assignments: [] };
    var match = academicMap[cl.name];
    if (match) {
      entry.academicIdx = match.idx;
      entry.grade = match.data.grade || '';
      entry.missingNum = Number(match.data.missing) || 0;
      entry.assignments = match.data.missingAssignments || [];
      usedClassNames[cl.name] = true;
    }
    rows.push(entry);
  });

  academicData.forEach(function(c, idx) {
    if (!usedClassNames[c.className]) {
      rows.push({ period: null, className: c.className || 'Unknown', academicIdx: idx, grade: c.grade || '', missingNum: Number(c.missing) || 0, assignments: c.missingAssignments || [] });
    }
  });

  rows.sort(function(a, b) { return (parseInt(a.period) || 999) - (parseInt(b.period) || 999); });
  return rows;
}

function renderStudentProfileDashboard(student) {
  var container = document.getElementById('student-form-container');
  var html = '';

  // ─── Section 0: Eval Checklist Card (collapsible, above academics) ───
  html += '<div class="profile-eval-section" id="profile-eval-section" style="display:none">';
  html += '<div class="profile-eval-section-header" onclick="toggleEvalSectionCollapse()">';
  html += '<div class="profile-eval-section-left">';
  html += '<span class="profile-eval-section-title" id="profile-eval-section-title">Eval Checklist</span>';
  html += '<span class="profile-eval-section-progress" id="profile-eval-section-progress"></span>';
  html += '<span class="profile-eval-overdue-badge" id="profile-eval-overdue-badge" style="display:none"></span>';
  html += '</div>';
  html += '<div class="profile-eval-section-right">';
  html += '<span class="profile-eval-meeting-date" id="profile-eval-meeting-date" onclick="event.stopPropagation(); handleEvalMeetingDateClick()"></span>';
  html += '<input type="date" class="profile-eval-meeting-input" id="profile-eval-meeting-input" style="display:none" onclick="event.stopPropagation()" onchange="saveEvalMeetingDate(this.value)">';
  html += '<button class="btn-icon btn-sm eval-collapse-btn" id="eval-collapse-btn" onclick="event.stopPropagation(); toggleEvalSectionCollapse()" aria-label="Toggle eval section">' +
    '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/></svg>' +
  '</button>';
  html += '</div>';
  html += '</div>';
  html += '<div class="profile-eval-section-body" id="profile-eval-section-body">';
  html += '<ul class="eval-card-tasks" id="profile-eval-tasks"></ul>';
  html += '<div class="eval-card-action" id="profile-eval-action" onclick="handleEvalCardClick(\'' + esc(student.id) + '\')">View all &#x2192;</div>';
  html += '</div>';
  html += '</div>';

  // ─── Section 1: Merged Academics Overview ───
  var mergedRows = buildMergedScheduleRows_(student);
  var totalMissing = student.totalMissing || 0;

  html += '<div class="profile-section-card">';
  html += '<div class="profile-section-header">' +
    '<span class="profile-section-title">Academics</span>' +
    '<button class="btn btn-sm btn-primary" onclick="startCheckIn(\'' + student.id + '\')">New Check-In</button>' +
  '</div>';

  html += '<div class="profile-academics-layout">';

  // ── Left column: merged schedule + academics table ──
  html += '<div class="profile-academics-left">';
  if (mergedRows.length === 0) {
    html += '<div class="profile-empty-state"><p>No schedule or academic data available.</p></div>';
  } else {
    html += '<table class="profile-schedule-table" id="profile-schedule-table">';
    html += '<thead><tr><th class="pst-col-period">Period</th><th class="pst-col-class">Class</th><th class="pst-col-grade">Grade</th><th class="pst-col-missing">Missing</th></tr></thead><tbody>';

    mergedRows.forEach(function(row, idx) {
      var expandable = row.academicIdx !== null && row.missingNum > 0;

      html += '<tr class="profile-schedule-row" id="profile-row-' + idx + '" data-expandable="' + expandable + '"' +
        (expandable ? ' onclick="toggleProfileRow(' + idx + ')"' : '') + '>';
      html += '<td class="pst-period">' + esc(row.period ? String(row.period) : '--') + '</td>';
      html += '<td class="pst-class">' + esc(row.className) + '</td>';

      // Grade column
      if (row.academicIdx !== null) {
        var gradeOptions = ['', 'A', 'A-', 'B+', 'B', 'B-', 'C+', 'C', 'C-', 'D+', 'D', 'D-', 'F'];
        html += '<td class="pst-grade"><select class="profile-grade-select" onclick="event.stopPropagation()" onchange="profileChangeGrade(\'' + student.id + '\', ' + row.academicIdx + ', this.value)">';
        gradeOptions.forEach(function(g) {
          var selected = (row.grade || '') === g ? ' selected' : '';
          html += '<option value="' + esc(g) + '"' + selected + '>' + esc(g || '--') + '</option>';
        });
        html += '</select></td>';
      } else {
        html += '<td class="pst-grade"><span style="color:var(--md-on-surface-variant);font-size:13px;">--</span></td>';
      }

      // Missing badge (only if > 0)
      html += '<td class="pst-missing">';
      if (row.missingNum > 0) {
        var pillClass = row.missingNum <= 3 ? 'badge-yellow' : 'badge-red';
        html += '<span class="profile-missing-pill ' + pillClass + '">' + row.missingNum + '</span>';
      }
      html += '</td></tr>';

      // Expansion detail row (only if expandable)
      if (expandable) {
        html += '<tr class="profile-row-detail" id="profile-row-detail-' + idx + '">';
        html += '<td colspan="4" class="profile-row-detail-cell">';

        var assignments = row.assignments || [];
        if (assignments.length > 0) {
          var sorted = assignments.map(function(a, i) {
            return { name: a.name, type: a.type, _origIdx: i };
          }).sort(function(a, b) {
            var nameComp = (a.name || '').localeCompare(b.name || '');
            if (nameComp !== 0) return nameComp;
            return (a.type || '').localeCompare(b.type || '');
          });

          html += '<table class="missing-detail-table">' +
            '<thead><tr><th>Assignment Name</th><th>Type</th><th>Actions</th></tr></thead><tbody>';
          sorted.forEach(function(a) {
            var typeClass = a.type === 'Summative' ? 'type-summative' :
                            a.type === 'Formative' ? 'type-formative' : '';
            html += '<tr>' +
              '<td>' + esc(a.name || 'Untitled') + '</td>' +
              '<td><span class="assignment-type ' + typeClass + '">' + esc(a.type || 'Unknown') + '</span></td>' +
              '<td class="missing-actions-cell">' +
                '<button class="missing-action-btn btn-check" onclick="event.stopPropagation(); profileMarkDone(\'' + student.id + '\', ' + row.academicIdx + ', ' + a._origIdx + ', this)" title="Mark as complete">' +
                  '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>' +
                '</button>' +
                '<button class="missing-action-btn btn-delete" onclick="event.stopPropagation(); profileRemoveAssignment(\'' + student.id + '\', ' + row.academicIdx + ', ' + a._origIdx + ')" title="Remove assignment">' +
                  '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>' +
                '</button>' +
              '</td>' +
            '</tr>';
          });
          html += '</tbody></table>';
        } else {
          html += '<div class="missing-count-only" style="padding:12px 16px;">' + row.missingNum +
            ' missing assignment' + (row.missingNum !== 1 ? 's' : '') +
            ' recorded (no details available)</div>';
        }

        // Add Missing Assignment inline form
        html += '<div class="mv-add-section">' +
          '<button type="button" class="btn-ghost btn-sm mv-add-btn" id="pv-add-btn-' + row.academicIdx + '" onclick="event.stopPropagation(); showProfileAddMissing(\'' + student.id + '\', ' + row.academicIdx + ')">+ Add Missing Assignment</button>' +
          '<div class="mv-add-form" id="pv-add-form-' + row.academicIdx + '" style="display:none;">' +
            '<div class="mv-add-form-row">' +
              '<input type="text" class="mv-add-name" id="pv-add-name-' + row.academicIdx + '" placeholder="Assignment name" onkeydown="if(event.key===\'Enter\'){event.preventDefault();profileConfirmAddMissing(\'' + student.id + '\',' + row.academicIdx + ');}">' +
              '<select class="mv-add-type" id="pv-add-type-' + row.academicIdx + '">' +
                '<option value="">-- Type --</option>' +
                '<option value="Formative">Formative</option>' +
                '<option value="Summative">Summative</option>' +
              '</select>' +
              '<button type="button" class="mv-confirm-btn" onclick="event.stopPropagation(); profileConfirmAddMissing(\'' + student.id + '\', ' + row.academicIdx + ')" title="Add assignment">' +
                '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>' +
              '</button>' +
            '</div>' +
          '</div>' +
        '</div>';

        html += '</td></tr>';
      }
    });

    html += '</tbody></table>';
  }
  html += '</div>'; // end .profile-academics-left

  // ── Right column: stat cards ──
  html += '<div class="profile-academics-right">';

  // GPA Card
  var gpaCardClass = 'profile-stat-card';
  if (student.gpa != null) {
    gpaCardClass += student.gpa >= 3.5 ? ' gpa-honor-roll' : student.gpa > 3.0 ? ' gpa-good-standing' : student.gpa >= 2.5 ? ' gpa-caution' : ' gpa-at-risk';
  }
  html += '<div class="' + gpaCardClass + '" id="profile-gpa-card">';
  html += '<div class="profile-stat-label">Current GPA</div>';
  html += '<div class="profile-stat-value">';
  if (student.gpa != null) {
    html += '<span class="profile-stat-number" id="profile-gpa-number">' + student.gpa.toFixed(2) + '</span>';
    html += '<span class="profile-trophy' + (student.gpa >= 3.7 ? ' visible' : '') + '" id="profile-gpa-trophy">&#x1F3C6;</span>';
  } else {
    html += '<span class="profile-stat-number" id="profile-gpa-number">--</span>';
    html += '<span class="profile-trophy" id="profile-gpa-trophy">&#x1F3C6;</span>';
  }
  html += '</div></div>';

  // Missing Assignments Card (clickable)
  html += '<div class="profile-stat-card profile-stat-clickable" id="profile-missing-card" onclick="showMissingAssignments(\'' + student.id + '\')">';
  html += '<div class="profile-stat-label">Missing Assignments</div>';
  html += '<div class="profile-stat-value">';
  var missingClass = totalMissing === 0 ? 'missing-zero' : 'missing-alert';
  html += '<span class="profile-stat-number ' + missingClass + '" id="profile-missing-number">' + totalMissing + '</span>';
  html += '</div>';
  html += '<div class="profile-stat-action">View all &rarr;</div>';
  html += '</div>';

  html += '</div>'; // end .profile-academics-right
  html += '</div>'; // end .profile-academics-layout
  html += '</div>'; // end .profile-section-card (Academics)

  // Contacts Card (full-width, below academics section)
  var contacts = student.contacts || [];
  if (!contacts.length && student.contactsJson) {
    try { contacts = JSON.parse(student.contactsJson); } catch(e) { contacts = []; }
  }
  html += '<div class="profile-contacts-card" id="profile-contacts-card">';
  html += '<div class="profile-contacts-header">';
  html += '<span class="profile-section-title">Contacts</span>';
  html += '<button class="btn-icon btn-sm" onclick="addProfileContact(\'' + esc(student.id) + '\')" title="Add contact">' +
    '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>' +
  '</button>';
  html += '</div>';
  html += '<div class="profile-contacts-list" id="profile-contacts-list">';
  if (contacts.length === 0) {
    html += '<div class="profile-contacts-empty">No contacts added</div>';
  } else {
    contacts.forEach(function(c, idx) {
      html += renderProfileContactItem(student.id, c, idx);
    });
  }
  html += '</div></div>';

  // ─── Section 2: Goals & Objectives ───
  html += '<div class="profile-section-card">';
  html += '<div class="profile-section-header">' +
    '<span class="profile-section-title">Goals &amp; Objectives</span>' +
    '<span class="goals-autosave-status" id="goals-autosave-status"></span>' +
  '</div>';
  html += '<div id="goals-autosave-container">';

  // Parse goals — backward compat with old iepGoal field
  var goals = [];
  if (student.goalsJson) {
    try { goals = JSON.parse(student.goalsJson); } catch(e) { goals = []; }
  } else if (student.goals && student.goals.length > 0) {
    goals = student.goals;
  }
  if (goals.length === 0 && student.iepGoal) {
    goals = [{ id: 'migrated-' + Date.now(), text: student.iepGoal, objectives: [] }];
  }

  // Store in appState and reset edit state
  appState.currentGoals = goals;
  appState.editingGoalId = null;
  appState.expandedGoalIds = {};

  if (goals.length > 0) {
    goals.forEach(function(goal) {
      html += renderGoalCard(goal);
    });
  } else {
    html += '<div class="goal-card-empty-state">No goals added yet</div>';
  }

  html += '</div>';
  html += '<button type="button" class="btn btn-sm btn-secondary profile-add-goal-btn" onclick="addGoal()">+ Add Goal</button>';
  html += '</div>';

  // ─── Section 3: Quarterly Progress ───
  html += '<div class="profile-section-card">';
  html += '<div class="profile-section-header">' +
    '<span class="profile-section-title">Quarterly Progress</span>' +
    '<div class="progress-header-right">' +
      '<span class="progress-autosave-status" id="progress-autosave-status"></span>' +
      '<button class="btn-icon btn-icon-sm" id="progress-generate-report-btn" style="display:none" onclick="generateReport(\'' + esc(student.id) + '\')" title="Generate Report">' +
        '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/></svg>' +
      '</button>' +
    '</div>' +
  '</div>';
  html += '<div id="progress-section-container">';
  html += '<div class="progress-loading-placeholder" style="color:var(--md-on-surface-variant);font-size:14px;padding:12px 0;">Loading progress data\u2026</div>';
  html += '</div>';
  html += '</div>';

  // ─── Section 4: Check-In History placeholder ───
  html += '<div id="checkin-history-section"></div>';

  container.innerHTML = html;
  animateContentIn(container);

  // Setup goals autosave listeners
  setupGoalsAutosave();

  // Load quarterly progress section
  loadProgressSection(student.id, goals);

  // Async-load eval checklist card state
  loadEvalCardState(student.id);
}

function renderGoalCard(goal) {
  var isEditing = appState.editingGoalId === goal.id;
  var isExpanded = !!appState.expandedGoalIds[goal.id];
  var objectives = goal.objectives || [];
  var goalArea = goal.goalArea || '';
  var goalText = goal.text || '';

  // Truncate preview text
  var previewText = goalText.length > 80 ? goalText.substring(0, 80) + '\u2026' : goalText;
  if (!previewText) previewText = 'No goal text';

  var html = '<div class="goal-card' + (isEditing ? ' goal-card-editing' : '') + '" data-goal-id="' + esc(goal.id) + '">';

  // ── Card Header (always visible) ──
  html += '<div class="goal-card-header" role="button" tabindex="0" onclick="toggleGoalExpand(\'' + esc(goal.id) + '\')" onkeydown="if(event.key===\'Enter\')toggleGoalExpand(\'' + esc(goal.id) + '\')">';
  html += '<div class="goal-card-header-left">';
  if (goalArea) {
    html += '<span class="goal-card-area-chip">' + esc(goalArea) + '</span>';
  }
  if (!isExpanded && !isEditing) {
    html += '<span class="goal-card-text-preview">' + esc(previewText) + '</span>';
  }
  html += '</div>';
  html += '<div class="goal-card-header-right">';
  if (objectives.length > 0) {
    html += '<span class="goal-card-obj-badge">' + objectives.length + ' obj.</span>';
  }
  html += '<svg class="goal-card-chevron' + (isExpanded || isEditing ? ' rotated' : '') + '" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>';
  // Edit button (stop propagation so it doesn't toggle expand)
  if (!isEditing) {
    html += '<button class="btn-icon btn-icon-sm" onclick="event.stopPropagation();enterGoalEditMode(\'' + esc(goal.id) + '\')" title="Edit goal">' +
      '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>' +
    '</button>';
  } else {
    html += '<button class="btn-icon btn-icon-sm" onclick="event.stopPropagation();exitGoalEditMode()" title="Done editing">' +
      '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>' +
    '</button>';
  }
  // Delete button
  html += '<button class="btn-icon btn-icon-sm" onclick="event.stopPropagation();removeGoal(\'' + esc(goal.id) + '\')" title="Delete goal">' +
    '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>' +
  '</button>';
  html += '</div>';
  html += '</div>';

  // ── Card Body (collapsible) ──
  html += '<div class="goal-card-body' + (isExpanded || isEditing ? ' goal-card-body-open' : '') + '">';
  if (isEditing) {
    html += renderGoalEditMode_(goal);
  } else {
    html += renderGoalDisplayMode_(goal);
  }
  html += '</div>';

  html += '</div>';
  return html;
}

function renderGoalDisplayMode_(goal) {
  var html = '';
  var objectives = goal.objectives || [];
  var goalArea = goal.goalArea || '';
  var goalText = goal.text || '';
  var respEmail = goal.responsibleEmail || '';

  if (goalArea) {
    html += '<div class="goal-card-field"><span class="goal-card-field-label">Goal Area</span><span class="goal-card-field-value">' + esc(goalArea) + '</span></div>';
  }
  if (respEmail) {
    var displayName = respEmail;
    if (respEmail.toLowerCase() === (appState.currentUserEmail || '').toLowerCase()) {
      displayName = 'Me';
    }
    html += '<div class="goal-card-field"><span class="goal-card-field-label">Progress Reporter</span><span class="goal-card-field-value">' + esc(displayName) + '</span></div>';
  }
  html += '<div class="goal-card-goal-text">' + (goalText ? esc(goalText) : '<span style="color:var(--md-on-surface-variant);font-style:italic;">No goal text</span>') + '</div>';

  if (objectives.length > 0) {
    html += '<div class="goal-card-field-label" style="margin-top:12px;">Objectives</div>';
    html += '<ol class="goal-card-objectives-list">';
    objectives.forEach(function(obj) {
      html += '<li class="goal-card-objectives-item">' + (obj.text ? esc(obj.text) : '<span style="color:var(--md-on-surface-variant);font-style:italic;">No text</span>') + '</li>';
    });
    html += '</ol>';
  }
  return html;
}

function renderGoalEditMode_(goal) {
  var html = '';
  var objectives = goal.objectives || [];
  var goalArea = goal.goalArea || '';
  var goalText = goal.text || '';
  var respEmail = (goal.responsibleEmail || '').toLowerCase();
  var currentEmail = (appState.currentUserEmail || '').toLowerCase();

  // Goal area dropdown
  html += '<div class="profile-goal-area-row">';
  html += '<label class="profile-goal-area-label">Goal Area:</label>';
  html += buildGoalAreaDropdown_(goal.id, goalArea);
  html += '</div>';

  // Responsibility selector
  html += '<div class="profile-goal-responsible-row">';
  html += '<label class="profile-goal-responsible-label">Progress Reporter:</label>';
  html += '<select class="profile-goal-responsible-select" data-field="goal-responsible">';
  html += '<option value="">Not assigned</option>';
  html += '<option value="' + esc(appState.currentUserEmail) + '"' +
    (respEmail === currentEmail && respEmail ? ' selected' : '') + '>Me</option>';
  (appState.caseManagers || []).forEach(function(cm) {
    var cmEmail = (cm.email || '').toLowerCase();
    if (cmEmail && cmEmail !== currentEmail) {
      html += '<option value="' + esc(cm.email) + '"' +
        (respEmail === cmEmail ? ' selected' : '') + '>' + esc(cm.email) + '</option>';
    }
  });
  html += '</select>';
  html += '</div>';

  // Goal text
  html += '<textarea class="profile-goal-textarea" data-field="goal-text" placeholder="Enter IEP goal...">' + esc(goalText) + '</textarea>';

  // Objectives
  html += '<div class="profile-objectives-list">';
  objectives.forEach(function(obj) {
    html += '<div class="profile-objective-item" data-obj-id="' + esc(obj.id) + '">' +
      '<textarea data-field="obj-text" placeholder="Enter objective...">' + esc(obj.text || '') + '</textarea>' +
      '<button class="goal-remove-btn" onclick="removeObjective(\'' + esc(goal.id) + '\', \'' + esc(obj.id) + '\')" title="Remove objective">' +
        '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>' +
      '</button>' +
    '</div>';
  });
  html += '<button type="button" class="btn-ghost btn-sm profile-add-objective-btn" onclick="addObjective(\'' + esc(goal.id) + '\')">+ Add Objective</button>';
  html += '</div>';

  return html;
}

function toggleProfileRow(idx) {
  var mainRow = document.getElementById('profile-row-' + idx);
  var detailRow = document.getElementById('profile-row-detail-' + idx);
  if (!mainRow || !detailRow) return;
  mainRow.classList.toggle('expanded');
  detailRow.classList.toggle('expanded');
}

// ─── Quarterly Progress Section ───

function loadProgressSection(studentId, goals) {
  appState.currentProgressQuarter = null;
  appState.progressEntries = [];

  // Use remembered quarter if available, otherwise get from backend
  var remembered = appState.lastProgressQuarter[studentId];

  function loadEntries(quarter) {
    appState.currentProgressQuarter = quarter;
    appState.lastProgressQuarter[studentId] = quarter;
    google.script.run
      .withSuccessHandler(function(entries) {
        appState.progressEntries = entries || [];
        renderProgressSection(studentId, goals, quarter, entries || []);
      })
      .withFailureHandler(function() {
        appState.progressEntries = [];
        renderProgressSection(studentId, goals, quarter, []);
      })
      .getAllProgressForStudent(studentId);
  }

  if (remembered) {
    loadEntries(remembered);
  } else {
    google.script.run
      .withSuccessHandler(function(quarter) {
        loadEntries(quarter);
      })
      .withFailureHandler(function() {
        var month = new Date().getMonth();
        var q = month >= 8 && month <= 10 ? 'Q1' : (month === 11 || month <= 1) ? 'Q2' : month <= 4 ? 'Q3' : 'Q4';
        loadEntries(q);
      })
      .getCurrentQuarter();
  }
}

function renderProgressSection(studentId, goals, quarter, allEntries) {
  var container = document.getElementById('progress-section-container');
  if (!container) return;

  // Build entry lookup: goalId|objectiveId|quarter → entry
  var entryMap = {};
  (allEntries || []).forEach(function(e) {
    var key = e.goalId + '|' + e.objectiveId + '|' + e.quarter;
    entryMap[key] = e;
  });

  var html = '';

  // Quarter selector
  html += '<div class="progress-quarter-selector">';
  html += '<label class="progress-quarter-label">Quarter:</label>';
  ['Q1', 'Q2', 'Q3', 'Q4'].forEach(function(q) {
    var active = q === quarter ? ' progress-quarter-btn-active' : '';
    html += '<button type="button" class="btn btn-sm progress-quarter-btn' + active + '" ' +
      'onclick="switchProgressQuarter(\'' + esc(studentId) + '\', \'' + q + '\')">' + q + '</button>';
  });
  html += '</div>';

  if (!goals || goals.length === 0) {
    html += '<p style="color:var(--md-on-surface-variant);font-size:14px;padding:8px 0;">Add IEP goals above to begin tracking quarterly progress.</p>';
    container.innerHTML = html;
    return;
  }

  // Determine prior quarters for timeline
  var qOrder = ['Q1', 'Q2', 'Q3', 'Q4'];
  var currentIdx = qOrder.indexOf(quarter);
  var priorQuarters = currentIdx > 0 ? qOrder.slice(0, currentIdx) : [];

  // Auto-expand goal navigated from due process dashboard
  if (appState.autoExpandProgressGoalId) {
    appState.expandedProgressGoalIds[appState.autoExpandProgressGoalId] = true;
    appState.autoExpandProgressGoalId = null;
  }

  // Render each goal as an expandable card
  goals.forEach(function(goal) {
    html += renderProgressCard(goal, studentId, quarter, entryMap, priorQuarters);
  });

  // Overall teacher summary for report
  html += '<div class="progress-summary-section">';
  html += '<label class="progress-summary-label">Overall Teacher Summary <span style="color:var(--md-on-surface-variant);font-weight:400;">(optional, appears in printed report)</span></label>';
  html += '<textarea class="progress-summary-input" id="progress-overall-summary" ' +
    'placeholder="Brief summary of overall student progress this quarter..." ' +
    'oninput="scheduleProgressAutosave(\'' + esc(studentId) + '\')"></textarea>';
  html += '</div>';

  container.innerHTML = html;

  // Show the report icon button now that data is loaded
  var reportBtn = document.getElementById('progress-generate-report-btn');
  if (reportBtn) reportBtn.style.display = '';

  // Escape key exits progress edit mode
  container.onkeydown = function(e) {
    if (e.key === 'Escape' && appState.editingProgressGoalId) {
      e.stopPropagation();
      exitProgressEditMode(studentId);
    }
  };
}

// ─── Progress Card Rendering (Expandable) ───

function buildProgressRatingBadge(rating) {
  var badge = PROGRESS_RATING_BADGES[rating];
  if (!badge) return '';
  return '<span class="progress-rating-badge" style="background:' + badge.bg + ';color:' + badge.text + ';">' +
    badge.emoji + esc(badge.label) + '</span>';
}

function renderProgressCard(goal, studentId, quarter, entryMap, priorQuarters) {
  var isEditing = appState.editingProgressGoalId === goal.id;
  var isExpanded = !!appState.expandedProgressGoalIds[goal.id];
  var objectives = goal.objectives || [];
  var goalArea = goal.goalArea || '';
  var goalText = goal.text || '';

  // Count rated objectives for summary badge
  var ratedCount = 0;
  objectives.forEach(function(obj) {
    var key = goal.id + '|' + obj.id + '|' + quarter;
    if (entryMap[key] && entryMap[key].progressRating) ratedCount++;
  });
  var totalObj = objectives.length;

  // Truncate preview text
  var previewText = goalText.length > 80 ? goalText.substring(0, 80) + '\u2026' : goalText;
  if (!previewText) previewText = 'No goal text';

  var html = '<div class="progress-card' + (isEditing ? ' progress-card-editing' : '') + '" data-goal-id="' + esc(goal.id) + '">';

  // ── Card Header (always visible) ──
  html += '<div class="progress-card-header" role="button" tabindex="0" ' +
    'onclick="toggleProgressExpand(\'' + esc(goal.id) + '\')" ' +
    'onkeydown="if(event.key===\'Enter\')toggleProgressExpand(\'' + esc(goal.id) + '\')">';

  html += '<div class="progress-card-header-left">';
  if (goalArea) {
    html += '<span class="goal-card-area-chip">' + esc(goalArea) + '</span>';
  }
  if (!isExpanded && !isEditing) {
    html += '<span class="goal-card-text-preview">' + esc(previewText) + '</span>';
  }
  html += '</div>';

  html += '<div class="progress-card-header-right">';
  if (totalObj > 0) {
    var badgeClass = ratedCount === totalObj ? 'progress-count-badge-complete' : 'progress-count-badge';
    html += '<span class="' + badgeClass + '">' + ratedCount + '/' + totalObj + ' rated</span>';
  }
  html += '<svg class="goal-card-chevron' + (isExpanded || isEditing ? ' rotated' : '') + '" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>';
  if (!isEditing) {
    html += '<button class="btn-icon btn-icon-sm" onclick="event.stopPropagation();enterProgressEditMode(\'' + esc(goal.id) + '\', \'' + esc(studentId) + '\')" title="Edit progress">' +
      '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>' +
    '</button>';
  } else {
    html += '<button class="btn-icon btn-icon-sm" onclick="event.stopPropagation();exitProgressEditMode(\'' + esc(studentId) + '\')" title="Done editing">' +
      '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>' +
    '</button>';
  }
  html += '</div>';
  html += '</div>';

  // ── Card Body (collapsible) ──
  html += '<div class="progress-card-body' + (isExpanded || isEditing ? ' progress-card-body-open' : '') + '">';

  // Full goal text
  if (goalText) {
    html += '<div class="progress-card-goal-text">' + esc(goalText) + '</div>';
  }

  // Each objective
  objectives.forEach(function(obj) {
    var entryKey = goal.id + '|' + obj.id + '|' + quarter;
    var entry = entryMap[entryKey] || null;
    var currentRating = entry ? entry.progressRating : '';
    var currentNotes = entry ? entry.anecdotalNotes : '';

    html += '<div class="progress-objective-row" data-goal-id="' + esc(goal.id) + '" data-obj-id="' + esc(obj.id) + '">';

    // Objective subheading + rating badge
    html += '<div class="progress-obj-heading">';
    html += '<p class="progress-obj-text">' + esc(obj.text || '') + '</p>';
    if (currentRating) {
      html += buildProgressRatingBadge(currentRating);
    }
    html += '</div>';

    // Prior quarter timeline chips (always visible)
    if (priorQuarters.length > 0) {
      html += '<div class="progress-timeline-row">';
      priorQuarters.forEach(function(pq) {
        var pKey = goal.id + '|' + obj.id + '|' + pq;
        var pEntry = entryMap[pKey];
        if (pEntry) {
          var chipClass = pEntry.progressRating === 'Objective Met' ? 'progress-chip-met' :
                          pEntry.progressRating === 'Adequate Progress' ? 'progress-chip-adequate' : 'progress-chip-none';
          html += '<span class="progress-timeline-chip ' + chipClass + '">' + pq + ': ' + esc(pEntry.progressRating) + '</span>';
        } else {
          html += '<span class="progress-timeline-chip progress-chip-empty">' + pq + ': \u2014</span>';
        }
      });
      html += '</div>';
    }

    // Edit mode: rating buttons + notes textarea
    if (isEditing) {
      html += '<div class="progress-rating-group">';
      PROGRESS_RATINGS.forEach(function(r) {
        var selected = currentRating === r.value ? ' progress-rating-selected progress-rating-' + r.color : '';
        html += '<button type="button" class="btn btn-sm progress-rating-btn' + selected + '" ' +
          'data-rating="' + esc(r.value) + '" ' +
          'onclick="selectProgressRating(this, \'' + esc(studentId) + '\', \'' + esc(goal.id) + '\', \'' + esc(obj.id) + '\')">' +
          esc(r.label) + '</button>';
      });
      html += '</div>';

      html += '<textarea class="progress-notes-input" ' +
        'data-goal-id="' + esc(goal.id) + '" data-obj-id="' + esc(obj.id) + '" ' +
        'placeholder="Anecdotal notes (required, minimum 10 characters)..." ' +
        'oninput="scheduleProgressAutosave(\'' + esc(studentId) + '\')">' +
        esc(currentNotes) + '</textarea>';
    }

    html += '</div>'; // objective-row
  });

  if (objectives.length === 0) {
    html += '<p style="color:var(--md-on-surface-variant);font-size:13px;font-style:italic;">No objectives defined for this goal.</p>';
  }

  html += '</div>'; // card body
  html += '</div>'; // card
  return html;
}

// ─── Progress Card Interaction ───

function toggleProgressExpand(goalId) {
  if (appState.editingProgressGoalId === goalId) return;
  if (appState.expandedProgressGoalIds[goalId]) {
    delete appState.expandedProgressGoalIds[goalId];
  } else {
    appState.expandedProgressGoalIds[goalId] = true;
  }
  rerenderProgressCard(goalId);
}

function enterProgressEditMode(goalId, studentId) {
  if (appState.editingProgressGoalId && appState.editingProgressGoalId !== goalId) {
    exitProgressEditMode(studentId);
  }
  appState.editingProgressGoalId = goalId;
  appState.expandedProgressGoalIds[goalId] = true;
  rerenderProgressCard(goalId);
}

function exitProgressEditMode(studentId) {
  var goalId = appState.editingProgressGoalId;
  if (!goalId) return;

  // Collect data while DOM still has rating buttons + notes
  if (_progressAutosaveTimer) { clearTimeout(_progressAutosaveTimer); _progressAutosaveTimer = null; }
  var entries = collectProgressData(studentId);

  appState.editingProgressGoalId = null;
  rerenderProgressCard(goalId);

  // Save immediately with collected entries
  if (entries.length > 0) {
    _progressAutosaveInFlight = true;
    _progressAutosaveDirty = false;
    updateAutosaveIndicator('saving', 'progress-autosave-status');
    var saved = 0, total = entries.length, errors = [];
    entries.forEach(function(entry) {
      google.script.run
        .withSuccessHandler(function(result) {
          saved++;
          if (!result.success) errors.push(result.error);
          if (saved === total) {
            _progressAutosaveInFlight = false;
            updateAutosaveIndicator(errors.length ? 'error' : 'idle', 'progress-autosave-status');
            if (studentId === appState.currentStudentId) {
              google.script.run
                .withSuccessHandler(function(fresh) {
                  appState.progressEntries = fresh || [];
                  rerenderProgressCard(goalId);
                  checkProgressCompletion_(studentId);
                })
                .getAllProgressForStudent(studentId);
            }
          }
        })
        .withFailureHandler(function() {
          saved++;
          errors.push('Save failed');
          if (saved === total) {
            _progressAutosaveInFlight = false;
            updateAutosaveIndicator('error', 'progress-autosave-status');
          }
        })
        .saveProgressEntry(entry);
    });
  }
}

function rerenderProgressCard(goalId) {
  var container = document.getElementById('progress-section-container');
  if (!container) return;
  var el = container.querySelector('.progress-card[data-goal-id="' + goalId + '"]');
  if (!el) return;

  var studentId = appState.currentStudentId;
  var quarter = appState.currentProgressQuarter;
  var allEntries = appState.progressEntries || [];
  var entryMap = {};
  allEntries.forEach(function(e) {
    var key = e.goalId + '|' + e.objectiveId + '|' + e.quarter;
    entryMap[key] = e;
  });
  var qOrder = ['Q1', 'Q2', 'Q3', 'Q4'];
  var currentIdx = qOrder.indexOf(quarter);
  var priorQuarters = currentIdx > 0 ? qOrder.slice(0, currentIdx) : [];

  var goal = null;
  var goals = appState.currentGoals || [];
  for (var i = 0; i < goals.length; i++) {
    if (goals[i].id === goalId) { goal = goals[i]; break; }
  }
  if (!goal) return;

  el.outerHTML = renderProgressCard(goal, studentId, quarter, entryMap, priorQuarters);
}

function switchProgressQuarter(studentId, quarter) {
  // Cancel any pending autosave from the previous quarter
  if (_progressAutosaveTimer) { clearTimeout(_progressAutosaveTimer); _progressAutosaveTimer = null; }
  _progressAutosaveDirty = false;
  appState.editingProgressGoalId = null;

  // Determine slide direction based on quarter order
  var qOrder = ['Q1', 'Q2', 'Q3', 'Q4'];
  var oldIdx = qOrder.indexOf(appState.currentProgressQuarter);
  var newIdx = qOrder.indexOf(quarter);
  var slideClass = newIdx > oldIdx ? 'progress-slide-forward' : 'progress-slide-backward';

  appState.currentProgressQuarter = quarter;
  appState.lastProgressQuarter[studentId] = quarter;

  var goals = [];
  var student = getStudentById(studentId);
  if (student && student.goalsJson) {
    try { goals = JSON.parse(student.goalsJson); } catch(e) { goals = []; }
  } else if (student && student.goals) {
    goals = student.goals;
  }
  renderProgressSection(studentId, goals, quarter, appState.progressEntries);

  // Apply slide animation
  var container = document.getElementById('progress-section-container');
  if (container && oldIdx !== newIdx) {
    container.classList.remove('progress-slide-forward', 'progress-slide-backward');
    void container.offsetWidth; // force reflow
    container.classList.add(slideClass);
    container.addEventListener('animationend', function handler() {
      container.classList.remove(slideClass);
      container.removeEventListener('animationend', handler);
    });
  }
}

function selectProgressRating(btn, studentId, goalId, objId) {
  // Deselect siblings
  var group = btn.parentElement;
  if (!group) return;
  var siblings = group.querySelectorAll('.progress-rating-btn');
  siblings.forEach(function(s) {
    s.classList.remove('progress-rating-selected', 'progress-rating-red', 'progress-rating-yellow', 'progress-rating-green');
  });
  // Select this one
  var rating = btn.getAttribute('data-rating');
  var colorClass = rating === 'Objective Met' ? 'progress-rating-green' :
                   rating === 'Adequate Progress' ? 'progress-rating-yellow' : 'progress-rating-red';
  btn.classList.add('progress-rating-selected', colorClass);

  scheduleProgressAutosave(studentId);
}

function collectProgressData(studentId) {
  var quarter = appState.currentProgressQuarter;
  if (!quarter) return [];
  var entries = [];
  var rows = document.querySelectorAll('.progress-objective-row');

  rows.forEach(function(row) {
    var goalId = row.getAttribute('data-goal-id');
    var objId = row.getAttribute('data-obj-id');

    // Get selected rating
    var selectedBtn = row.querySelector('.progress-rating-btn.progress-rating-selected');
    var rating = selectedBtn ? selectedBtn.getAttribute('data-rating') : '';

    // Get anecdotal notes
    var notesEl = row.querySelector('.progress-notes-input');
    var notes = notesEl ? notesEl.value : '';

    if (rating && notes.trim().length >= 10) {
      entries.push({
        studentId: studentId,
        goalId: goalId,
        objectiveId: objId,
        quarter: quarter,
        progressRating: rating,
        anecdotalNotes: notes.trim()
      });
    }
  });

  return entries;
}

function scheduleProgressAutosave(studentId) {
  _progressAutosaveDirty = true;
  updateAutosaveIndicator('unsaved', 'progress-autosave-status');
  if (_progressAutosaveTimer) clearTimeout(_progressAutosaveTimer);
  _progressAutosaveTimer = setTimeout(function() {
    performProgressAutosave(studentId);
  }, 2000);
}

function performProgressAutosave(studentId) {
  if (_progressAutosaveInFlight) {
    scheduleProgressAutosave(studentId);
    return;
  }

  var entries = collectProgressData(studentId);
  if (entries.length === 0) {
    _progressAutosaveDirty = false;
    updateAutosaveIndicator('idle', 'progress-autosave-status');
    return;
  }

  _progressAutosaveInFlight = true;
  _progressAutosaveDirty = false;
  updateAutosaveIndicator('saving', 'progress-autosave-status');

  var saved = 0;
  var total = entries.length;
  var errors = [];

  entries.forEach(function(entry) {
    google.script.run
      .withSuccessHandler(function(result) {
        saved++;
        if (!result.success) errors.push(result.error);
        if (saved === total) {
          _progressAutosaveInFlight = false;
          if (errors.length > 0) {
            updateAutosaveIndicator('error', 'progress-autosave-status');
          } else {
            updateAutosaveIndicator('idle', 'progress-autosave-status');
          }
          // Only refresh cache and reschedule if still viewing the same student
          if (studentId === appState.currentStudentId) {
            google.script.run
              .withSuccessHandler(function(fresh) {
                appState.progressEntries = fresh || [];
                checkProgressCompletion_(studentId);
              })
              .getAllProgressForStudent(studentId);

            if (_progressAutosaveDirty) {
              scheduleProgressAutosave(studentId);
            }
          }
        }
      })
      .withFailureHandler(function() {
        saved++;
        errors.push('Save failed');
        if (saved === total) {
          _progressAutosaveInFlight = false;
          updateAutosaveIndicator('error', 'progress-autosave-status');
          if (_progressAutosaveDirty && studentId === appState.currentStudentId) {
            scheduleProgressAutosave(studentId);
          }
        }
      })
      .saveProgressEntry(entry);
  });
}

function checkProgressCompletion_(studentId) {
  var student = getStudentById(studentId);
  if (!student) return;
  var goals = [];
  try { goals = JSON.parse(student.goalsJson || '[]'); } catch(e) { return; }

  var email = (appState.currentUserEmail || '').toLowerCase();
  var myGoals = goals.filter(function(g) {
    return (g.responsibleEmail || '').toLowerCase() === email;
  });
  if (myGoals.length === 0) return;

  var quarter = appState.currentProgressQuarter;
  var entries = appState.progressEntries || [];
  var allComplete = true;
  var totalObjectives = 0;

  myGoals.forEach(function(goal) {
    var objectives = goal.objectives || [];
    if (objectives.length === 0) {
      totalObjectives++;
      var hasEntry = entries.some(function(e) {
        return e.goalId === goal.id && !e.objectiveId && e.quarter === quarter && e.progressRating;
      });
      if (!hasEntry) allComplete = false;
    } else {
      objectives.forEach(function(obj) {
        totalObjectives++;
        var hasEntry = entries.some(function(e) {
          return e.goalId === goal.id && e.objectiveId === obj.id && e.quarter === quarter && e.progressRating;
        });
        if (!hasEntry) allComplete = false;
      });
    }
  });

  if (allComplete && totalObjectives > 0 && !_progressCompletionFiredFor[studentId + quarter]) {
    _progressCompletionFiredFor[studentId + quarter] = true;
    var originEl = document.getElementById('progress-section-container') ||
                   document.getElementById('student-form-container');
    launchConfetti(originEl);
    showToast('All progress reports complete for ' + esc(student.firstName) + '!');
  }
}

function generateReport(studentId) {
  var quarter = appState.currentProgressQuarter || 'Q1';
  var summaryEl = document.getElementById('progress-overall-summary');
  var overallSummary = summaryEl ? summaryEl.value : '';

  showToast('Generating report\u2026');

  google.script.run
    .withSuccessHandler(function(result) {
      if (!result.success) {
        showToast('Error: ' + result.error);
        return;
      }
      // Open report in new window
      var win = window.open('', '_blank');
      if (win) {
        win.document.write(result.html);
        win.document.close();
      } else {
        showToast('Pop-up blocked. Please allow pop-ups for this site.');
      }
    })
    .withFailureHandler(function(err) {
      showToast('Error generating report: ' + (err.message || err));
    })
    .generateProgressReport(studentId, quarter, overallSummary);
}

function generateBatchReports() {
  var quarter = appState.currentProgressQuarter || 'Q1';
  showToast('Generating reports for all students\u2026');

  google.script.run
    .withSuccessHandler(function(result) {
      if (!result.success) {
        showToast('Error: ' + result.error);
        return;
      }
      var reports = result.reports || [];
      if (reports.length === 0) {
        showToast('No students found.');
        return;
      }

      // Extract styles from first report, then combine body content with page breaks
      var reportStyles = '';
      var firstStyleMatch = reports[0].html.match(/<style[^>]*>([\s\S]*?)<\/style>/i);
      if (firstStyleMatch) reportStyles = firstStyleMatch[1];

      var combinedHtml = '<!DOCTYPE html><html><head><meta charset="utf-8"><title>Batch Progress Reports</title>';
      combinedHtml += '<style>' + reportStyles;
      combinedHtml += ' @media print { .page-break { page-break-before: always; } }';
      combinedHtml += '</style></head><body>';

      reports.forEach(function(r, idx) {
        if (idx > 0) combinedHtml += '<div class="page-break"></div>';
        // Extract body content from each report's HTML
        var bodyMatch = r.html.match(/<body[^>]*>([\s\S]*)<\/body>/i);
        var bodyContent = bodyMatch ? bodyMatch[1] : r.html.replace(/<\/?(?:html|head|style|meta|title)[^>]*>/gi, '');
        combinedHtml += '<div class="student-report">' + bodyContent + '</div>';
      });

      combinedHtml += '</body></html>';

      var win = window.open('', '_blank');
      if (win) {
        win.document.write(combinedHtml);
        win.document.close();
        showToast(reports.length + ' report' + (reports.length > 1 ? 's' : '') + ' generated.');
      } else {
        showToast('Pop-up blocked. Please allow pop-ups for this site.');
      }
    })
    .withFailureHandler(function(err) {
      showToast('Error generating batch reports: ' + (err.message || err));
    })
    .generateBatchReports(quarter, {});
}

function cancelStudentEdit() {
  if (appState.currentStudentId) {
    showStudentProfile(appState.currentStudentId);
  } else {
    showDashboard();
  }
}

function renderStudentForm(student) {
  var container = document.getElementById('student-form-container');
  var html = '<div class="form-card">';

  // Basic Info
  var gradeOptions = ['', '6', '7', '8'];
  var gradeHtml = '<select id="st-grade">';
  gradeOptions.forEach(function(g) {
    var sel = (String(student.grade || '') === g) ? ' selected' : '';
    gradeHtml += '<option value="' + g + '"' + sel + '>' + (g || '-- Select Grade --') + '</option>';
  });
  gradeHtml += '</select>';

  html += '<div class="form-section">' +
    '<div class="form-section-title">Basic Information</div>' +
    '<div class="form-row">' +
      '<div class="form-group"><label>First Name</label>' +
        '<input type="text" id="st-firstName" value="' + esc(student.firstName || '') + '" placeholder="First name"></div>' +
      '<div class="form-group"><label>Last Name</label>' +
        '<input type="text" id="st-lastName" value="' + esc(student.lastName || '') + '" placeholder="Last name"></div>' +
    '</div>' +
    '<div class="form-row">' +
      '<div class="form-group"><label>Grade Level</label>' + gradeHtml + '</div>' +
      '<div class="form-group"><label>Birthday</label>' +
        '<input type="date" id="st-birthday" value="' + esc(student.birthday || '') + '">' +
      '</div>' +
    '</div>';

  // Case Manager dropdown
  var cmOptions = '<select id="st-caseManager">';
  cmOptions += '<option value="">-- No Case Manager --</option>';
  (appState.caseManagers || []).forEach(function(cm) {
    var sel = (String(student.caseManagerEmail || '') === cm.email) ? ' selected' : '';
    cmOptions += '<option value="' + esc(cm.email) + '"' + sel + '>' + esc(cm.name) + '</option>';
  });
  cmOptions += '</select>';

  var cmDisplayHtml = '';
  if (student.id && student.caseManagerEmail) {
    var cmName = getCaseManagerName(student.caseManagerEmail);
    cmDisplayHtml = '<div class="case-manager-display" style="margin-top:4px;">' +
      '<span style="font-size:12px;color:var(--md-on-surface-variant);">Assigned: ' + esc(cmName) + '</span>' +
      '<a href="mailto:' + esc(student.caseManagerEmail) + '" class="btn-icon" title="Email case manager">' +
        '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>' +
      '</a>' +
    '</div>';
  }

  html += '<div class="form-group"><label>Case Manager</label>' + cmOptions + cmDisplayHtml + '</div>' +
  '</div>';

  // Focus & Support
  html += '<div class="form-section">' +
    '<div class="form-section-title">Focus &amp; Support</div>' +
    '<div class="form-group"><label>Focus Goal</label>' +
      '<input type="text" id="st-focusGoal" value="' + esc(student.focusGoal || '') + '" placeholder="Executive function focus area"></div>' +
    '<div class="form-group"><label>Accommodations</label>' +
      '<textarea id="st-accommodations" placeholder="IEP accommodations, 504 plan details, etc.">' + esc(student.accommodations || '') + '</textarea></div>' +
    '<div class="form-group"><label>Notes</label>' +
      '<textarea id="st-notes" placeholder="Additional notes">' + esc(student.notes || '') + '</textarea></div>' +
  '</div>';

  // IEP Goal
  html += '<div class="form-section">' +
    '<div class="form-section-title">IEP Goal</div>' +
    '<div class="form-group"><label>Current IEP Goal</label>' +
      '<textarea id="st-iepGoal" placeholder="Enter the student\'s current IEP goal">' + esc(student.iepGoal || '') + '</textarea></div>' +
  '</div>';

  // Online status
  html += '<div class="form-section">' +
    '<div class="form-section-title">Online Status</div>' +
    '<div class="form-group"><label class="contact-primary-check">' +
      '<input type="checkbox" id="st-online"' + (student.online ? ' checked' : '') + '> ' +
      'Student attends online' +
    '</label></div>' +
  '</div>';

  // Classes
  html += '<div class="form-section">' +
    '<div class="form-section-title">Classes</div>' +
    '<div id="class-list-container">';

  var classes = student.classes || [];
  classes.forEach(function(cls, idx) {
    html += renderClassRow(cls, idx);
  });

  html += '</div>' +
    '<button type="button" class="btn btn-sm btn-secondary" onclick="addClass()" style="margin-top:8px;">+ Add Class</button>' +
  '</div>';

  // Contacts
  var contacts = student.contacts || [];
  if (!contacts.length && student.contactsJson) {
    try { contacts = JSON.parse(student.contactsJson); } catch(e) { contacts = []; }
  }
  html += '<div class="form-section">' +
    '<div class="form-section-title">Contacts</div>' +
    '<div id="contact-list-container">';
  contacts.forEach(function(c, idx) {
    html += renderContactFormRow(c, idx);
  });
  html += '</div>' +
    '<button type="button" class="btn btn-sm btn-secondary" onclick="addFormContact()" style="margin-top:8px;">+ Add Contact</button>' +
  '</div>';

  // Action buttons
  html += '<div style="display:flex;gap:8px;justify-content:space-between;margin-top:24px;">' +
    '<div>';
  if (student.id) {
    html += '<button class="btn btn-danger" onclick="confirmDeleteStudent(\'' + student.id + '\')">Delete Student</button>';
  }
  html += '</div>' +
    '<div style="display:flex;gap:8px;">' +
      '<button class="btn btn-secondary" onclick="cancelStudentEdit()">Cancel</button>' +
      '<button class="btn btn-primary" onclick="saveStudentForm()">Save Student</button>' +
    '</div>' +
  '</div>';

  html += '</div>'; // form-card

  // Placeholder for check-in history (filled later)
  if (student.id) {
    html += '<div id="checkin-history-section"></div>';
  }

  container.innerHTML = html;
}

function renderClassRow(cls, idx) {
  var name = '';
  var period = '';
  if (typeof cls === 'string') {
    name = cls;
  } else if (cls) {
    name = cls.name || '';
    period = cls.period || '';
  }

  var isOther = name !== '' && PRELOADED_CLASSES.indexOf(name) === -1;

  var html = '<div class="class-list-item" data-class-idx="' + idx + '">';

  // Class name select
  html += '<select class="class-select" onchange="handleClassSelect(this)">';
  html += '<option value="">-- Select Class --</option>';
  PRELOADED_CLASSES.forEach(function(c) {
    var sel = (name === c) ? ' selected' : '';
    html += '<option value="' + esc(c) + '"' + sel + '>' + esc(c) + '</option>';
  });
  html += '<option value="__other__"' + (isOther ? ' selected' : '') + '>+ Add Other</option>';
  html += '</select>';

  // Other text input (hidden unless "Other" selected)
  html += '<input type="text" class="class-other-input"' +
    (isOther ? '' : ' style="display:none"') +
    ' value="' + esc(isOther ? name : '') + '" placeholder="Enter class name">';

  // Period select
  html += '<select class="class-period-select">';
  html += '<option value="">Period</option>';
  for (var p = 1; p <= 7; p++) {
    var pSel = (String(period) === String(p)) ? ' selected' : '';
    html += '<option value="' + p + '"' + pSel + '>' + p + '</option>';
  }
  html += '</select>';

  // Remove button
  html += '<button type="button" class="btn-remove-class" onclick="removeClass(this)">&times;</button>';
  html += '</div>';
  return html;
}

function handleClassSelect(select) {
  var otherInput = select.parentElement.querySelector('.class-other-input');
  if (select.value === '__other__') {
    otherInput.style.display = '';
    otherInput.focus();
  } else {
    otherInput.style.display = 'none';
    otherInput.value = '';
  }
}

function addClass() {
  var container = document.getElementById('class-list-container');
  var idx = container.querySelectorAll('.class-list-item').length;
  var div = document.createElement('div');
  div.innerHTML = renderClassRow({ name: '', period: '' }, idx);
  container.appendChild(div.firstChild);
}

function removeClass(btn) {
  btn.parentElement.remove();
}

// ─── Contact Validation ───

var CONTACT_EMAIL_RE = /^[^\s@]+@[^\s@]+\.[a-zA-Z]{2,}$/;

function isValidContactEmail(val) {
  return val === '' || CONTACT_EMAIL_RE.test(val);
}

function extractDigits(val) {
  return (val || '').replace(/\D/g, '');
}

function isValidContactPhone(val) {
  if (val === '') return true;
  return extractDigits(val).length === 10;
}

function validateContactField(input, validatorFn, errorMsg) {
  var val = input.value.trim();
  var wrapper = input.closest('.form-group') || input.parentElement;
  var existing = wrapper.querySelector('.contact-field-error');
  if (!validatorFn(val)) {
    input.classList.add('contact-input-error');
    if (!existing) {
      var errEl = document.createElement('div');
      errEl.className = 'contact-field-error';
      errEl.textContent = errorMsg;
      wrapper.appendChild(errEl);
    }
    return false;
  } else {
    input.classList.remove('contact-input-error');
    if (existing) existing.remove();
    return true;
  }
}

function hasContactValidationErrors(container) {
  return container.querySelectorAll('.contact-input-error').length > 0;
}

// ─── Student Contacts ───

function renderProfileContactItem(studentId, contact, idx) {
  var html = '<div class="profile-contact-item" data-contact-idx="' + idx + '">';
  html += '<div class="profile-contact-info">';
  html += '<div class="profile-contact-name">';
  if (contact.primary) {
    html += '<span class="contact-primary-badge" title="Primary contact">' +
      '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>' +
      'Primary</span> ';
  }
  html += esc(contact.name || 'Unnamed') +
    (contact.relationship ? ' <span class="profile-contact-rel">(' + esc(contact.relationship) + ')</span>' : '') +
  '</div>';
  if (contact.email) {
    html += '<a href="mailto:' + esc(contact.email) + '" class="profile-contact-detail" onclick="event.stopPropagation()">' +
      '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg> ' +
      esc(contact.email) + '</a>';
  }
  if (contact.phone) {
    html += '<a href="tel:' + esc(contact.phone) + '" class="profile-contact-detail" onclick="event.stopPropagation()">' +
      '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg> ' +
      esc(contact.phone) + '</a>';
  }
  html += '</div>';
  html += '<div class="profile-contact-actions">';
  html += '<button class="btn-icon btn-sm" onclick="event.stopPropagation(); editProfileContact(\'' + esc(studentId) + '\', ' + idx + ')" title="Edit contact">' +
    '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>' +
  '</button>';
  html += '<button class="btn-icon btn-sm" onclick="event.stopPropagation(); removeProfileContact(\'' + esc(studentId) + '\', ' + idx + ')" title="Remove contact">' +
    '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>' +
  '</button>';
  html += '</div></div>';
  return html;
}

function getStudentContacts_(studentId) {
  var student = getStudentById(studentId);
  if (!student) return [];
  var contacts = student.contacts || [];
  if (!contacts.length && student.contactsJson) {
    try { contacts = JSON.parse(student.contactsJson); } catch(e) { contacts = []; }
  }
  return contacts;
}

function saveContactsToServer_(studentId, contacts) {
  var contactsJson = JSON.stringify(contacts);
  var student = getStudentById(studentId);
  if (student) {
    student.contacts = contacts;
    student.contactsJson = contactsJson;
  }
  google.script.run
    .withSuccessHandler(function() { showToast('Contacts saved'); })
    .withFailureHandler(function() { showToast('Failed to save contacts'); })
    .saveStudentContacts(studentId, contactsJson);
}

function refreshContactsList_(studentId) {
  var listEl = document.getElementById('profile-contacts-list');
  if (!listEl) return;
  var contacts = getStudentContacts_(studentId);
  if (contacts.length === 0) {
    listEl.innerHTML = '<div class="profile-contacts-empty">No contacts added</div>';
  } else {
    var html = '';
    contacts.forEach(function(c, idx) {
      html += renderProfileContactItem(studentId, c, idx);
    });
    listEl.innerHTML = html;
  }
}

function showContactFormDialog(studentId, contact, idx) {
  var isEdit = (typeof idx === 'number');
  contact = contact || {};
  var primaryChecked = contact.primary ? ' checked' : '';
  var overlay = document.createElement('div');
  overlay.className = 'confirm-overlay';
  overlay.innerHTML =
    '<div class="confirm-dialog contact-form-dialog">' +
      '<div class="confirm-title">' + (isEdit ? 'Edit' : 'Add') + ' Contact</div>' +
      '<div class="contact-form-fields">' +
        '<div class="form-group"><label>Name</label>' +
          '<input type="text" id="cf-name" value="' + esc(contact.name || '') + '" placeholder="Contact name"></div>' +
        '<div class="form-group"><label>Relationship</label>' +
          '<input type="text" id="cf-relationship" value="' + esc(contact.relationship || '') + '" placeholder="e.g. Parent, Guardian, Tutor"></div>' +
        '<div class="form-group"><label>Email</label>' +
          '<input type="email" id="cf-email" value="' + esc(contact.email || '') + '" placeholder="email@example.com"></div>' +
        '<div class="form-group"><label>Phone</label>' +
          '<input type="tel" id="cf-phone" value="' + esc(contact.phone || '') + '" placeholder="(555) 123-4567"></div>' +
        '<label class="contact-primary-check"><input type="checkbox" id="cf-primary"' + primaryChecked + '> Primary contact</label>' +
      '</div>' +
      '<div class="confirm-actions">' +
        '<button class="btn btn-secondary" id="cf-cancel">Cancel</button>' +
        '<button class="btn btn-primary" id="cf-save">' + (isEdit ? 'Update' : 'Add') + '</button>' +
      '</div>' +
    '</div>';

  document.body.appendChild(overlay);
  requestAnimationFrame(function() { overlay.classList.add('visible'); });

  var nameInput = overlay.querySelector('#cf-name');
  nameInput.focus();

  // Blur validation for email and phone
  var emailInput = overlay.querySelector('#cf-email');
  var phoneInput = overlay.querySelector('#cf-phone');
  emailInput.addEventListener('blur', function() {
    validateContactField(emailInput, isValidContactEmail, 'Please enter a valid email address');
  });
  phoneInput.addEventListener('blur', function() {
    validateContactField(phoneInput, isValidContactPhone, 'Phone number must have 10 digits');
  });

  overlay.querySelector('#cf-cancel').onclick = function() { closeConfirmDialog(overlay); };
  overlay.querySelector('#cf-save').onclick = function() {
    var name = overlay.querySelector('#cf-name').value.trim();
    if (!name) { showToast('Contact name is required'); return; }

    // Run validation on email and phone before saving
    var emailOk = validateContactField(emailInput, isValidContactEmail, 'Please enter a valid email address');
    var phoneOk = validateContactField(phoneInput, isValidContactPhone, 'Phone number must have 10 digits');
    if (!emailOk || !phoneOk) { showToast('Please fix validation errors'); return; }

    var isPrimary = overlay.querySelector('#cf-primary').checked;
    var newContact = {
      name: name,
      relationship: overlay.querySelector('#cf-relationship').value.trim(),
      email: emailInput.value.trim(),
      phone: phoneInput.value.trim(),
      primary: isPrimary
    };
    var contacts = getStudentContacts_(studentId);
    // If marking as primary, unmark others
    if (isPrimary) {
      contacts.forEach(function(c) { c.primary = false; });
    }
    if (isEdit) {
      contacts[idx] = newContact;
    } else {
      contacts.push(newContact);
    }
    saveContactsToServer_(studentId, contacts);
    refreshContactsList_(studentId);
    closeConfirmDialog(overlay);
  };

  // Close on overlay click
  overlay.addEventListener('click', function(e) {
    if (e.target === overlay) closeConfirmDialog(overlay);
  });
}

function addProfileContact(studentId) {
  showContactFormDialog(studentId);
}

function editProfileContact(studentId, idx) {
  var contacts = getStudentContacts_(studentId);
  showContactFormDialog(studentId, contacts[idx], idx);
}

function removeProfileContact(studentId, idx) {
  showConfirmDialog({
    title: 'Remove Contact',
    body: 'Are you sure you want to remove this contact?',
    confirmLabel: 'Remove',
    onConfirm: "confirmRemoveContact('" + esc(studentId) + "', " + idx + ")"
  });
}

function confirmRemoveContact(studentId, idx) {
  var contacts = getStudentContacts_(studentId);
  contacts.splice(idx, 1);
  saveContactsToServer_(studentId, contacts);
  refreshContactsList_(studentId);
}

// ─── Contacts in Student Edit Form ───

function renderContactFormRow(contact, idx) {
  contact = contact || {};
  var primaryChecked = contact.primary ? ' checked' : '';
  var html = '<div class="contact-list-item" data-contact-idx="' + idx + '">';
  html += '<div class="contact-fields-grid">';
  html += '<input type="text" class="contact-name" value="' + esc(contact.name || '') + '" placeholder="Name">';
  html += '<input type="text" class="contact-relationship" value="' + esc(contact.relationship || '') + '" placeholder="Relationship">';
  html += '<div class="form-group" style="margin:0;"><input type="email" class="contact-email" value="' + esc(contact.email || '') + '" placeholder="Email" onblur="validateContactField(this, isValidContactEmail, \'Please enter a valid email address\')"></div>';
  html += '<div class="form-group" style="margin:0;"><input type="tel" class="contact-phone" value="' + esc(contact.phone || '') + '" placeholder="Phone" onblur="validateContactField(this, isValidContactPhone, \'Phone number must have 10 digits\')"></div>';
  html += '</div>';
  html += '<label class="contact-primary-check contact-primary-inline"><input type="checkbox" class="contact-primary-cb"' + primaryChecked + ' onchange="handleFormPrimaryToggle(this)"> Primary</label>';
  html += '<button type="button" class="btn-remove-class" onclick="removeFormContact(this)">&times;</button>';
  html += '</div>';
  return html;
}

function addFormContact() {
  var container = document.getElementById('contact-list-container');
  var idx = container.querySelectorAll('.contact-list-item').length;
  var div = document.createElement('div');
  div.innerHTML = renderContactFormRow({}, idx);
  container.appendChild(div.firstChild);
}

function removeFormContact(btn) {
  btn.parentElement.remove();
}

function handleFormPrimaryToggle(cb) {
  if (cb.checked) {
    // Uncheck all other primary checkboxes in the form
    var container = document.getElementById('contact-list-container');
    if (container) {
      container.querySelectorAll('.contact-primary-cb').forEach(function(other) {
        if (other !== cb) other.checked = false;
      });
    }
  }
}

function validateFormContacts_() {
  var container = document.getElementById('contact-list-container');
  if (!container) return true;
  var valid = true;
  container.querySelectorAll('.contact-list-item').forEach(function(item) {
    var nameInput = item.querySelector('.contact-name');
    var emailInput = item.querySelector('.contact-email');
    var phoneInput = item.querySelector('.contact-phone');
    // Require name if any other field is filled
    if (nameInput) {
      var hasOtherData = (emailInput && emailInput.value.trim()) || (phoneInput && phoneInput.value.trim());
      if (hasOtherData && !nameInput.value.trim()) {
        if (!validateContactField(nameInput, function() { return false; }, 'Contact name is required')) valid = false;
      } else {
        validateContactField(nameInput, function() { return true; }, '');
      }
    }
    if (emailInput && !validateContactField(emailInput, isValidContactEmail, 'Please enter a valid email address')) valid = false;
    if (phoneInput && !validateContactField(phoneInput, isValidContactPhone, 'Phone number must have 10 digits')) valid = false;
  });
  return valid;
}

function collectFormContacts() {
  var contactItems = document.querySelectorAll('#contact-list-container .contact-list-item');
  var contacts = [];
  contactItems.forEach(function(item) {
    var name = item.querySelector('.contact-name').value.trim();
    var relationship = item.querySelector('.contact-relationship').value.trim();
    var email = item.querySelector('.contact-email').value.trim();
    var phone = item.querySelector('.contact-phone').value.trim();
    var primaryCb = item.querySelector('.contact-primary-cb');
    var primary = primaryCb ? primaryCb.checked : false;
    if (name) contacts.push({ name: name, relationship: relationship, email: email, phone: phone, primary: primary });
  });
  return contacts;
}

function saveStudentForm() {
  var classItems = document.querySelectorAll('#class-list-container .class-list-item');
  var classes = [];
  classItems.forEach(function(item) {
    var select = item.querySelector('.class-select');
    var otherInput = item.querySelector('.class-other-input');
    var periodSelect = item.querySelector('.class-period-select');

    var name = select.value === '__other__' ? otherInput.value.trim() : select.value;
    var period = periodSelect.value;

    if (name) classes.push({ name: name, period: period });
  });

  // Preserve goalsJson from existing student data so save doesn't erase it
  var existingStudent = appState.currentStudentId ? getStudentById(appState.currentStudentId) : null;

  var profile = {
    id: appState.currentStudentId || null,
    firstName: document.getElementById('st-firstName').value.trim(),
    lastName: document.getElementById('st-lastName').value.trim(),
    grade: document.getElementById('st-grade').value,
    period: '',
    focusGoal: document.getElementById('st-focusGoal').value.trim(),
    accommodations: document.getElementById('st-accommodations').value.trim(),
    iepGoal: document.getElementById('st-iepGoal').value.trim(),
    notes: document.getElementById('st-notes').value.trim(),
    caseManagerEmail: document.getElementById('st-caseManager').value,
    online: document.getElementById('st-online').checked,
    birthday: document.getElementById('st-birthday').value,
    goalsJson: existingStudent ? (existingStudent.goalsJson || '') : '',
    classes: classes,
    contacts: collectFormContacts()
  };

  if (!profile.firstName || !profile.lastName) {
    showToast('First and last name are required');
    return;
  }

  if (!validateFormContacts_()) {
    showToast('Please fix contact validation errors before saving');
    return;
  }

  // Optimistic UI: update local state and navigate immediately
  if (profile.id) {
    appState.dashboardData.forEach(function(s) {
      if (s.id === profile.id) {
        s.firstName = profile.firstName;
        s.lastName = profile.lastName;
        s.grade = profile.grade;
        s.focusGoal = profile.focusGoal;
        s.iepGoal = profile.iepGoal;
        s.classes = profile.classes;
        s.caseManagerEmail = profile.caseManagerEmail;
        s.online = profile.online;
        s.birthday = profile.birthday;
        s.contacts = profile.contacts;
        s.contactsJson = JSON.stringify(profile.contacts);
      }
    });
  } else {
    appState.dashboardData.push({
      id: '__pending_' + Date.now(),
      firstName: profile.firstName, lastName: profile.lastName,
      grade: profile.grade, period: '',
      focusGoal: profile.focusGoal, iepGoal: profile.iepGoal,
      classes: profile.classes,
      caseManagerEmail: profile.caseManagerEmail,
      online: profile.online,
      birthday: profile.birthday,
      contacts: profile.contacts,
      contactsJson: JSON.stringify(profile.contacts),
      totalCheckIns: 0, latestWeek: null, latestMicroGoal: null,
      avgRating: null, trend: 'none', gpa: null,
      totalMissing: 0, academicData: []
    });
  }

  if (appState.currentStudentId) {
    showStudentProfile(appState.currentStudentId);
  } else {
    renderDashboard(applyFilter_(appState.dashboardData));
    showView('dashboard-view');
  }
  showToast('Saving\u2026');
  showGlobalProgress();

  google.script.run
    .withSuccessHandler(function(result) {
      hideGlobalProgress();
      if (result.success) {
        showToast('Student saved');
        renderDashboardFromState();
        _lastDashboardFetch = 0;
      }
    })
    .withFailureHandler(function(err) {
      hideGlobalProgress();
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
      loadDashboard(true);
    })
    .saveStudent(profile);
}

function confirmDeleteStudent(studentId) {
  showConfirmDialog({
    title: 'Delete Student?',
    body: 'This will permanently delete this student and all their check-in records.',
    confirmLabel: 'Delete',
    onConfirm: "doDeleteStudent('" + esc(studentId) + "')"
  });
}

function doDeleteStudent(studentId) {
  // Optimistic UI: remove from local state immediately
  appState.dashboardData = appState.dashboardData.filter(function(s) { return s.id !== studentId; });
  renderDashboard(applyFilter_(appState.dashboardData));
  showView('dashboard-view');
  showToast('Deleting\u2026');
  showGlobalProgress();

  google.script.run
    .withSuccessHandler(function() {
      hideGlobalProgress();
      showToast('Student deleted');
      loadDashboard(true);
    })
    .withFailureHandler(function(err) {
      hideGlobalProgress();
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
      loadDashboard(true);
    })
    .deleteStudent(studentId);
}

// ─── Check-In History (inside student profile) ───
function renderCheckInHistory(checkIns, student) {
  var section = document.getElementById('checkin-history-section');
  if (!section) return;

  var html = '<div class="profile-section-card">' +
    '<div class="profile-section-header">' +
      '<span class="profile-section-title">Check-In History (' + checkIns.length + ')</span>' +
      '<button class="btn btn-sm btn-primary" onclick="startCheckIn(\'' + student.id + '\')">New Check-In</button>' +
    '</div>';

  if (checkIns.length === 0) {
    html += '<div class="profile-empty-state"><p>No check-ins recorded yet.</p></div>';
  } else {
    checkIns.forEach(function(ci) {
      var ratings = [
        Number(ci.planningRating), Number(ci.followThroughRating),
        Number(ci.regulationRating), Number(ci.focusGoalRating),
        Number(ci.effortRating)
      ].filter(function(r) { return !isNaN(r) && r > 0; });

      var avg = ratings.length > 0
        ? (ratings.reduce(function(a,b){ return a+b; }, 0) / ratings.length).toFixed(1)
        : '--';
      var avgClass = avg !== '--'
        ? (avg >= 4 ? 'chip-green' : avg >= 3 ? 'chip-yellow' : 'chip-red')
        : 'chip-gray';

      html += '<div class="history-card" onclick="editCheckIn(\'' + ci.id + '\', \'' + student.id + '\')">' +
        '<div class="history-card-header">' +
          '<span class="history-card-date">' + esc(formatDateDisplay(ci.weekOf) || 'No date') + '</span>' +
          '<span class="chip ' + avgClass + '">Avg: ' + avg + '</span>' +
        '</div>' +
        '<div class="history-ratings">' +
          '<span class="history-rating-item">Plan: <span>' + (ci.planningRating || '-') + '</span></span>' +
          '<span class="history-rating-item">Follow: <span>' + (ci.followThroughRating || '-') + '</span></span>' +
          '<span class="history-rating-item">Reg: <span>' + (ci.regulationRating || '-') + '</span></span>' +
          '<span class="history-rating-item">Focus: <span>' + (ci.focusGoalRating || '-') + '</span></span>' +
          '<span class="history-rating-item">Effort: <span>' + (ci.effortRating || '-') + '</span></span>' +
        '</div>';

      if (ci.microGoal) {
        html += '<div class="history-goal">Goal: ' + esc(ci.microGoal) + '</div>';
      }

      html += '<div class="history-card-actions">' +
        '<button class="btn-icon btn-sm" onclick="event.stopPropagation(); confirmDeleteCheckIn(\'' + ci.id + '\', \'' + student.id + '\')" title="Delete check-in">' +
          '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>' +
        '</button>' +
      '</div>';

      html += '</div>';
    });
  }

  html += '</div>';
  section.innerHTML = html;
}

function editCheckIn(checkInId, studentId) {
  showCheckInSkeleton();
  showView('checkin-view');
  google.script.run
    .withSuccessHandler(function(checkIns) {
      var ci = checkIns.find(function(c) { return c.id === checkInId; });
      if (ci) {
        startCheckIn(studentId, ci);
      } else {
        showToast('Check-in not found');
      }
    })
    .withFailureHandler(function(err) { showToast('Error: ' + (err && err.message ? err.message : String(err))); })
    .getCheckIns(studentId);
}

function confirmDeleteCheckIn(checkInId, studentId) {
  showConfirmDialog({
    title: 'Delete Check-In?',
    body: 'This check-in record will be permanently deleted.',
    confirmLabel: 'Delete',
    onConfirm: "doDeleteCheckIn('" + esc(checkInId) + "', '" + esc(studentId) + "')"
  });
}

function doDeleteCheckIn(checkInId, studentId) {
  // Optimistic UI: hide the card immediately
  var cards = document.querySelectorAll('.history-card');
  cards.forEach(function(card) {
    if (card.getAttribute('onclick') && card.getAttribute('onclick').indexOf(checkInId) !== -1) {
      card.style.opacity = '0.4';
      card.style.pointerEvents = 'none';
    }
  });
  showToast('Deleting check-in\u2026');

  google.script.run
    .withSuccessHandler(function() {
      showToast('Check-in deleted');
      editStudent(studentId);
    })
    .withFailureHandler(function(err) {
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
      cards.forEach(function(card) {
        card.style.opacity = '';
        card.style.pointerEvents = '';
      });
    })
    .deleteCheckIn(checkInId);
}

// ─── Teacher Feedback Menu ───

function renderStudentMenu(studentId) {
  var container = document.getElementById('student-menu-container');
  if (!container) return;
  if (!studentId) { container.innerHTML = ''; return; }

  var links = appState.feedbackLinks || {};
  var hasSheet = links.sheetUrl ? true : false;

  var items =
    '<button class="dropdown-item" onclick="editStudentInfo()">Edit Student</button>' +
    '<button class="dropdown-item" onclick="printStudentReport()">Print Missing Work &amp; Grades</button>' +
    '<button class="dropdown-item" onclick="handleFeedbackClick()">Request Teacher Feedback</button>';
  if (hasSheet) {
    items += '<button class="dropdown-item" onclick="handleViewFeedbackClick()">View Teacher Feedback</button>';
  }

  // Eval checklist items (visibility toggled async by loadEvalCardState)
  items += '<button class="dropdown-item" id="menu-create-annual-iep" style="display:none" onclick="handleCreateEvalChecklist(\'annual-iep\')">Create Annual IEP Checklist</button>';
  items += '<button class="dropdown-item" id="menu-create-3-year-reeval" style="display:none" onclick="handleCreateEvalChecklist(\'3-year-reeval\')">Create 3 Year Re-Eval Checklist</button>';
  items += '<button class="dropdown-item" id="menu-create-initial-eval" style="display:none" onclick="handleCreateEvalChecklist(\'initial-eval\')">Create Initial Eval Checklist</button>';
  items += '<button class="dropdown-item" id="menu-view-eval" style="display:none" onclick="handleViewEvalChecklist()">View Checklist</button>';

  container.innerHTML =
    '<div class="menu-anchor">' +
      '<button class="btn-icon" onclick="toggleStudentMenu(event)" aria-label="More options">' +
        '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>' +
      '</button>' +
      '<div class="dropdown-menu" id="student-dropdown">' +
        items +
      '</div>' +
    '</div>';
}

function editStudentInfo() {
  closeStudentMenu();
  var studentId = appState.currentStudentId;
  if (!studentId) return;

  var student = appState.currentStudent;
  if (student) {
    document.getElementById('student-view-breadcrumb').innerHTML =
      '<button class="breadcrumb-link" onclick="showStudentProfile(appState.currentStudentId)">Student Profile</button> ' +
      '<svg class="breadcrumb-chevron" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg> Edit';
    renderStudentForm(student);
    renderStudentMenu(studentId);
    return;
  }

  // Fallback: fetch student data if not cached
  google.script.run
    .withSuccessHandler(function(students) {
      var s = (students || []).find(function(st) { return st.id === studentId; });
      if (!s) { showToast('Student not found'); return; }
      appState.currentStudent = s;
      document.getElementById('student-view-breadcrumb').innerHTML =
        '<button class="breadcrumb-link" onclick="showStudentProfile(appState.currentStudentId)">Student Profile</button> ' +
        '<svg class="breadcrumb-chevron" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg> Edit';
      renderStudentForm(s);
      renderStudentMenu(studentId);
    })
    .withFailureHandler(function(err) { showToast('Error: ' + (err && err.message ? err.message : String(err))); })
    .getStudents();
}

function toggleStudentMenu(e) {
  e.stopPropagation();
  var menu = document.getElementById('student-dropdown');
  if (!menu) return;
  var isOpen = menu.classList.contains('dropdown-open');
  if (isOpen) {
    menu.classList.remove('dropdown-open');
    document.removeEventListener('click', closeStudentMenu);
  } else {
    menu.classList.add('dropdown-open');
    setTimeout(function() {
      document.addEventListener('click', closeStudentMenu);
    }, 0);
  }
}

function closeStudentMenu() {
  var menu = document.getElementById('student-dropdown');
  if (menu) menu.classList.remove('dropdown-open');
  document.removeEventListener('click', closeStudentMenu);
}

function printStudentReport() {
  closeStudentMenu();
  var student = appState.currentStudent;
  if (!student) {
    student = appState.dashboardData.find(function(s) { return s.id === appState.currentStudentId; });
  }
  if (!student) { showToast('Student data not available'); return; }

  var name = (student.firstName || '') + ' ' + (student.lastName || '');
  var grade = student.grade || '--';
  var academicData = student.academicData || [];
  var classes = student.classes || [];

  // Build sorted schedule
  var sortedClasses = classes.slice().sort(function(a, b) {
    return (parseInt(a.period) || 999) - (parseInt(b.period) || 999);
  });

  var html = '<!DOCTYPE html><html><head><title>Report - ' + esc(name) + '</title>' +
    '<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">' +
    '<style>' +
    'body { font-family: "Roboto", sans-serif; color: #1C1B1F; margin: 0; padding: 24px 32px; font-size: 13px; -webkit-font-smoothing: antialiased; }' +
    '.report-logo { text-align: center; margin-bottom: 16px; }' +
    '.report-logo img { height: 48px; }' +
    'h1 { font-size: 20px; margin: 0 0 4px; }' +
    '.subtitle { color: #49454F; font-size: 13px; margin-bottom: 20px; }' +
    'h2 { font-size: 15px; font-weight: 500; margin: 20px 0 8px; padding-bottom: 4px; border-bottom: 2px solid #C41E3A; }' +
    'table { width: 100%; border-collapse: collapse; margin-bottom: 16px; }' +
    'th, td { padding: 6px 10px; text-align: left; border-bottom: 1px solid #C8C8C8; }' +
    'th { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #49454F; background: #EEEEEE; font-weight: 500; }' +
    '.period-col { width: 60px; text-align: center; }' +
    '.grade-col { width: 60px; text-align: center; }' +
    '.missing-col { width: 80px; text-align: center; }' +
    '.grade-good { color: #1B5E20; font-weight: 500; }' +
    '.grade-mid { color: #7A5900; font-weight: 500; }' +
    '.grade-low { color: #BA1A1A; font-weight: 500; }' +
    '.badge { display: inline-block; min-width: 22px; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; text-align: center; }' +
    '.badge-green { background: #D6F5D6; color: #1B5E20; }' +
    '.badge-yellow { background: #FFF3CD; color: #7A5900; }' +
    '.badge-red { background: #FFDAD6; color: #410006; }' +
    '.missing-section { margin-left: 16px; margin-bottom: 12px; }' +
    '.missing-section h3 { font-size: 13px; font-weight: 500; margin: 8px 0 4px; }' +
    '.type-tag { font-size: 11px; padding: 1px 6px; border-radius: 4px; }' +
    '.type-formative { background: #E3F2FD; color: #0D47A1; }' +
    '.type-summative { background: #FCE4EC; color: #880E4F; }' +
    '.gpa-bar { padding: 8px 12px; background: #EEEEEE; border-radius: 8px; margin-bottom: 12px; display: flex; gap: 16px; align-items: center; }' +
    '.gpa-bar .label { font-size: 12px; color: #49454F; }' +
    '.gpa-bar .value { font-size: 16px; font-weight: 600; }' +
    '.footer { margin-top: 24px; font-size: 11px; color: #757575; text-align: center; }' +
    '@media print { body { padding: 12px 16px; } }' +
    '</style></head><body>';

  // Logo + Header
  html += '<div class="report-logo"><img src="https://resources.finalsite.net/images/f_auto,q_auto/v1593114034/richfieldschoolsorg/nevtdqxgci8pdkldabzj/MS_Horiz_C.png" alt="Richfield Middle School"></div>';
  html += '<h1>' + esc(name) + '</h1>';
  var subtitleParts = ['Grade ' + esc(grade)];
  var cmEmail = student.caseManagerEmail || '';
  if (cmEmail) {
    var cmName = getCaseManagerName(cmEmail);
    subtitleParts.push('Case Manager: ' + esc(cmName) + ' (' + esc(cmEmail) + ')');
  }
  subtitleParts.push('Printed ' + new Date().toLocaleDateString());
  html += '<div class="subtitle">' + subtitleParts.join(' &bull; ') + '</div>';

  // Schedule section
  if (sortedClasses.length > 0) {
    html += '<h2>Schedule</h2>';
    html += '<table><thead><tr><th class="period-col">Period</th><th>Class</th></tr></thead><tbody>';
    sortedClasses.forEach(function(cl) {
      html += '<tr><td class="period-col">' + esc(cl.period ? String(cl.period) : '--') + '</td>' +
        '<td>' + esc(cl.name || 'Unknown') + '</td></tr>';
    });
    html += '</tbody></table>';
  }

  // Classes with Grades section
  if (academicData.length > 0) {
    var totalMissing = 0;
    academicData.forEach(function(c) { totalMissing += (Number(c.missing) || 0); });

    // GPA bar
    html += '<h2>Classes &amp; Grades</h2>';
    html += '<div class="gpa-bar">';
    if (student.gpa != null) {
      var gpaClass = student.gpa >= 3.5 ? 'grade-good' : student.gpa >= 2.5 ? 'grade-mid' : 'grade-low';
      html += '<span class="label">GPA</span><span class="value ' + gpaClass + '">' + student.gpa.toFixed(2) + '</span>';
    }
    html += '<span class="label" style="margin-left:auto;">Total Missing</span><span class="value ' + (totalMissing === 0 ? 'grade-good' : 'grade-low') + '">' + totalMissing + '</span>';
    html += '</div>';

    // Grades table
    html += '<table><thead><tr><th>Class</th><th class="grade-col">Grade</th><th class="missing-col">Missing</th></tr></thead><tbody>';
    academicData.forEach(function(c) {
      var missingNum = Number(c.missing) || 0;
      var badgeClass = missingNum === 0 ? 'badge-green' : missingNum <= 3 ? 'badge-yellow' : 'badge-red';
      var classLabel = c.className || 'Unknown';
      var matchedClass = (student.classes || []).find(function(cl) { return cl.name === c.className; });
      if (matchedClass && matchedClass.period) classLabel += ' (P' + matchedClass.period + ')';

      var gradeVal = GPA_MAP[c.grade];
      var gradeClass = gradeVal != null ? (gradeVal >= 3.0 ? 'grade-good' : gradeVal >= 2.0 ? 'grade-mid' : 'grade-low') : '';

      html += '<tr><td>' + esc(classLabel) + '</td>' +
        '<td class="grade-col ' + gradeClass + '">' + esc(c.grade || '--') + '</td>' +
        '<td class="missing-col"><span class="badge ' + badgeClass + '">' + missingNum + '</span></td></tr>';
    });
    html += '</tbody></table>';

    // Missing work detail
    var hasMissing = academicData.some(function(c) { return (c.missingAssignments || []).length > 0; });
    if (hasMissing) {
      html += '<h2>Missing Work Detail</h2>';
      academicData.forEach(function(c) {
        var assignments = c.missingAssignments || [];
        if (assignments.length === 0) return;
        var classLabel = c.className || 'Unknown';
        var matchedClass = (student.classes || []).find(function(cl) { return cl.name === c.className; });
        if (matchedClass && matchedClass.period) classLabel += ' (P' + matchedClass.period + ')';

        html += '<div class="missing-section"><h3>' + esc(classLabel) + ' (' + assignments.length + ')</h3>';
        html += '<table><thead><tr><th>Assignment</th><th>Type</th></tr></thead><tbody>';
        assignments.slice().sort(function(a, b) {
          return (a.name || '').localeCompare(b.name || '');
        }).forEach(function(a) {
          var typeClass = a.type === 'Summative' ? 'type-summative' : a.type === 'Formative' ? 'type-formative' : '';
          html += '<tr><td>' + esc(a.name || 'Untitled') + '</td>' +
            '<td><span class="type-tag ' + typeClass + '">' + esc(a.type || 'Unknown') + '</span></td></tr>';
        });
        html += '</tbody></table></div>';
      });
    }
  } else {
    html += '<h2>Classes &amp; Grades</h2>';
    html += '<p style="color:#49454F;">No academic data from the latest check-in.</p>';
  }

  html += '<div class="footer">Richfield Public Schools</div>';
  html += '</body></html>';

  var printWindow = window.open('', '_blank');
  if (printWindow) {
    printWindow.document.write(html);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
  } else {
    showToast('Please allow pop-ups to print the report');
  }
}

function handleFeedbackClick() {
  closeStudentMenu();
  var links = appState.feedbackLinks || {};
  if (links.formUrl) {
    window.open(links.formUrl, '_blank');
  } else {
    showFeedbackSetupModal();
  }
}

function handleViewFeedbackClick() {
  closeStudentMenu();
  var links = appState.feedbackLinks || {};
  if (links.sheetUrl) {
    window.open(links.sheetUrl, '_blank');
  }
}

function showFeedbackSetupModal() {
  var existing = appState.feedbackLinks || {};
  var overlay = document.createElement('div');
  overlay.className = 'confirm-overlay';
  overlay.id = 'feedback-modal-overlay';
  overlay.innerHTML =
    '<div class="confirm-dialog" style="max-width:480px;">' +
      '<h3>Teacher Feedback Setup</h3>' +
      '<p>Enter the links for teacher feedback collection.</p>' +
      '<div class="form-group" style="margin-bottom:16px;">' +
        '<label>Teacher Feedback Google Form</label>' +
        '<input type="url" id="fb-form-url" value="' + esc(existing.formUrl || '') + '" placeholder="https://docs.google.com/forms/...">' +
      '</div>' +
      '<div class="form-group" style="margin-bottom:24px;">' +
        '<label>Teacher Feedback Google Sheet</label>' +
        '<input type="url" id="fb-sheet-url" value="' + esc(existing.sheetUrl || '') + '" placeholder="https://docs.google.com/spreadsheets/...">' +
      '</div>' +
      '<div class="confirm-actions">' +
        '<button class="btn btn-secondary" onclick="document.getElementById(\'feedback-modal-overlay\').remove()">Cancel</button>' +
        '<button class="btn btn-primary" onclick="saveFeedbackSetup()">Save &amp; Open Form</button>' +
      '</div>' +
    '</div>';
  document.body.appendChild(overlay);
}

function saveFeedbackSetup() {
  var formUrl = document.getElementById('fb-form-url').value.trim();
  var sheetUrl = document.getElementById('fb-sheet-url').value.trim();

  if (!formUrl) {
    showToast('Please enter a Google Form URL');
    return;
  }

  var links = { formUrl: formUrl, sheetUrl: sheetUrl };

  // Optimistic: update local state
  appState.feedbackLinks = links;
  document.getElementById('feedback-modal-overlay').remove();

  // Re-render menu to show "View Teacher Feedback" if sheet URL was provided
  renderStudentMenu(appState.currentStudentId);

  // Open form immediately
  window.open(formUrl, '_blank');
  showToast('Saving feedback links\u2026');

  google.script.run
    .withSuccessHandler(function() { showToast('Feedback links saved'); })
    .withFailureHandler(function(err) {
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
    })
    .saveFeedbackLinks(links);
}

// ─── Co-Teacher Invite Modal ───

function showInviteModal(invite, isNewUser) {
  var navbar = document.getElementById('navbar');
  var navDrawer = document.getElementById('nav-drawer');
  if (navbar) navbar.style.display = '';
  if (navDrawer) navDrawer.style.display = '';
  showView('auth-loading'); // keep loading state visible behind the modal
  if (!isNewUser) showView('dashboard-view');

  var overlay = document.createElement('div');
  overlay.className = 'confirm-overlay';
  overlay.id = 'invite-modal-overlay';
  overlay.innerHTML =
    '<div class="confirm-dialog" style="max-width:440px;">' +
      '<h3>Team Invitation</h3>' +
      '<p><strong>' + esc(invite.inviterEmail) + '</strong> has invited you to collaborate on their caseload. You will share the same students and check-in data.</p>' +
      (isNewUser
        ? '<p class="hint">Accepting will set up your account with their shared caseload. You can also decline and create your own.</p>'
        : '<p class="hint">Accepting will switch you to their shared caseload. Your own data will be preserved and can be restored if you leave the team later.</p>') +
      '<div class="confirm-actions">' +
        '<button class="btn btn-secondary" onclick="declineInvite(' + (isNewUser ? 'true' : 'false') + ')">Decline</button>' +
        '<button class="btn btn-primary" onclick="acceptInvite(' + (isNewUser ? 'true' : 'false') + ')">Accept &amp; Join</button>' +
      '</div>' +
    '</div>';
  document.body.appendChild(overlay);
}

function acceptInvite(isNewUser) {
  var modal = document.getElementById('invite-modal-overlay');
  if (modal) modal.innerHTML =
    '<div class="confirm-dialog" style="max-width:440px;text-align:center;">' +
      '<div class="provision-spinner"></div>' +
      '<p>Joining team\u2026</p>' +
    '</div>';

  google.script.run
    .withSuccessHandler(function(result) {
      if (modal) modal.remove();
      if (result.success) {
        showToast('Joined team successfully!');
        enterApp();
      } else {
        showToast(result.error || 'Error joining team');
        if (isNewUser) location.reload();
      }
    })
    .withFailureHandler(function(err) {
      if (modal) modal.remove();
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
      if (isNewUser) location.reload();
    })
    .acceptCoTeacherInvite();
}

function declineInvite(isNewUser) {
  var modal = document.getElementById('invite-modal-overlay');
  if (modal) modal.remove();

  google.script.run
    .withSuccessHandler(function() {
      if (isNewUser) {
        // Show onboarding since they don't have their own spreadsheet yet
        google.script.run
          .withSuccessHandler(function(status) { showOnboarding(status); })
          .withFailureHandler(function() { location.reload(); })
          .getUserStatus();
      }
    })
    .withFailureHandler(function() {})
    .declineCoTeacherInvite();
}

// ─── Co-Teacher Management View ───

function showCoTeachers() {
  document.querySelectorAll('.nav-drawer-item').forEach(function(t) { t.classList.remove('active'); });
  var teamItem = document.getElementById('drawer-team');
  if (teamItem) teamItem.classList.add('active');
  closeNavDrawerIfMobile_();
  showView('coteacher-view');
  document.getElementById('coteacher-content-container').innerHTML =
    '<div class="skeleton-fade-in"><div class="form-card">' +
      '<div class="skeleton skeleton-section-title" style="width:30%;"></div>' +
      '<div class="skeleton skeleton-input" style="margin-bottom:12px;"></div>' +
      '<div class="skeleton skeleton-input" style="margin-bottom:12px;"></div>' +
    '</div></div>';

  google.script.run
    .withSuccessHandler(function(teamInfo) {
      try { renderCoTeacherView(teamInfo); }
      catch(e) { showToast('Render error: ' + e.message); }
    })
    .withFailureHandler(function(err) {
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
    })
    .getTeamInfo();
}

function getRoleDisplayName(role) {
  switch(String(role).toLowerCase()) {
    case 'caseload-manager':
    case 'owner': return 'Caseload Manager';
    case 'service-provider': return 'Service Provider';
    case 'para': return 'Para';
    case 'co-teacher': return 'Co-Teacher';
    default: return role;
  }
}

function renderCoTeacherView(teamInfo) {
  var container = document.getElementById('coteacher-content-container');
  var isCaseloadManager = teamInfo.currentUserRole === 'caseload-manager';
  var html = '';

  // Role banner
  html += '<div class="ct-role-banner ' + (isCaseloadManager ? 'ct-role-caseload-manager' : 'ct-role-coteacher') + '">' +
    '<span class="ct-role-label">Your role:</span> ' +
    '<span class="ct-role-value">' + getRoleDisplayName(teamInfo.currentUserRole) + '</span>' +
  '</div>';

  // Team members
  html += '<div class="form-card">' +
    '<div class="form-section-title">Team Members</div>';

  teamInfo.members.forEach(function(m) {
    var emailStr = String(m.email || '');
    var roleStr = getRoleDisplayName(m.role);
    var isSelf = emailStr.toLowerCase() === (appState.currentUserEmail || '').toLowerCase();

    html += '<div class="ct-member-row">' +
      '<div class="ct-member-info">' +
        '<span class="ct-member-email">' + esc(emailStr) + '</span>' +
        '<span class="ct-member-role">' + roleStr + (isSelf ? ' (you)' : '') + '</span>' +
      '</div>';

    if (isCaseloadManager && m.role !== 'caseload-manager') {
      html += '<button class="btn btn-sm btn-danger" onclick="confirmRemoveTeamMember(\'' + esc(emailStr) + '\')">Remove</button>';
    }

    html += '</div>';
  });

  html += '</div>';

  // Add team member form (caseload manager only)
  if (isCaseloadManager) {
    html += '<div class="form-card">' +
      '<div class="form-section-title">Add Team Member</div>' +
      '<p class="hint">Enter the email address and role of the person you want to invite. They will receive the invite the next time they open the app. All roles have full access to caseload data.</p>' +
      '<div class="ct-add-form">' +
        '<input type="email" id="ct-add-email" placeholder="colleague@school.edu" class="ct-email-input">' +
        '<select id="ct-add-role" class="ct-role-select">' +
          '<option value="service-provider">Service Provider</option>' +
          '<option value="para">Para</option>' +
          '<option value="co-teacher">Co-Teacher</option>' +
        '</select>' +
        '<button class="btn btn-primary" onclick="addTeamMemberFromForm()">Send Invite</button>' +
      '</div>' +
    '</div>';
  }

  // Leave team (non-caseload-manager only)
  if (!isCaseloadManager) {
    html += '<div class="form-card">' +
      '<div class="form-section-title">Leave Team</div>' +
      '<p class="hint">Leaving will disconnect you from this shared caseload. If you previously had your own data, it will be restored.</p>' +
      '<button class="btn btn-danger" style="margin-top:4px;" onclick="confirmLeaveTeam()">Leave Team</button>' +
    '</div>';
  }

  container.innerHTML = html;
  animateContentIn(container);
}

function addTeamMemberFromForm() {
  var input = document.getElementById('ct-add-email');
  var roleSelect = document.getElementById('ct-add-role');
  var email = (input.value || '').trim();
  var role = roleSelect.value;
  if (!email) { showToast('Please enter an email address'); return; }
  if (!role) { showToast('Please select a role'); return; }

  showToast('Sending invite\u2026');

  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showToast('Invite sent to ' + email);
        showCoTeachers(); // refresh
      } else {
        showToast(result.error || 'Error sending invite');
      }
    })
    .withFailureHandler(function(err) {
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
    })
    .addTeamMember(email, role);
}

function confirmRemoveTeamMember(email) {
  showConfirmDialog({
    title: 'Remove Team Member?',
    body: 'This will revoke <strong>' + esc(email) + '</strong>\u2019s access to the shared caseload.',
    confirmLabel: 'Remove',
    onConfirm: "doRemoveTeamMember('" + esc(email) + "')"
  });
}

function doRemoveTeamMember(email) {
  showToast('Removing team member\u2026');
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showToast('Team member removed');
        showCoTeachers();
      } else {
        showToast(result.error || 'Error removing team member');
      }
    })
    .withFailureHandler(function(err) {
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
    })
    .removeTeamMember(email);
}

function confirmLeaveTeam() {
  showConfirmDialog({
    title: 'Leave Team?',
    body: 'You will be disconnected from this shared caseload. If you had your own data before joining, it will be restored.',
    confirmLabel: 'Leave',
    onConfirm: 'doLeaveTeam()'
  });
}

function doLeaveTeam() {
  showToast('Leaving team\u2026');
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showToast('You have left the team');
        location.reload();
      }
    })
    .withFailureHandler(function(err) {
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
    })
    .leaveCoTeacherTeam();
}

// ─── Skeleton Loading Functions ───
function showDashboardSkeleton() {
  // At a Glance skeleton
  var atAGlanceEl = document.getElementById('dashboard-at-a-glance');
  var atAGlanceContent = document.getElementById('at-a-glance-content');
  if (atAGlanceEl && atAGlanceContent) {
    atAGlanceEl.style.display = '';
    var skelHtml = '<div class="skeleton-fade-in">' +
      '<div class="eval-metric-cards">' +
        '<div class="eval-metric-card"><div class="skeleton" style="width:120px;height:40px;border-radius:8px;"></div></div>' +
        '<div class="eval-metric-card"><div class="skeleton" style="width:120px;height:40px;border-radius:8px;"></div></div>' +
      '</div>' +
      '<div class="eval-timeline-strip" style="padding:16px;">' +
        '<div style="display:flex;gap:8px;justify-content:space-between;">';
    for (var s = 0; s < 7; s++) {
      skelHtml += '<div class="skeleton" style="width:48px;height:64px;border-radius:12px;flex:1;"></div>';
    }
    skelHtml += '</div></div></div>';
    atAGlanceContent.innerHTML = skelHtml;
  }

  // Evals carousel skeleton
  var evalsEl = document.getElementById('dashboard-evals-section');
  var evalsContent = document.getElementById('evals-section-content');
  if (evalsEl && evalsContent) {
    evalsEl.style.display = '';
    var evalsSkelHtml = '<div class="skeleton-fade-in"><div class="eval-cards-carousel">';
    for (var c = 0; c < 4; c++) {
      evalsSkelHtml += '<div class="eval-carousel-card" style="pointer-events:none;">' +
        '<div class="skeleton" style="width:75%;height:16px;border-radius:4px;margin-bottom:6px;"></div>' +
        '<div class="skeleton" style="width:50%;height:12px;border-radius:4px;margin-bottom:12px;"></div>' +
        '<div style="display:flex;align-items:center;gap:8px;">' +
          '<div class="skeleton" style="flex:1;height:4px;border-radius:4px;"></div>' +
          '<div class="skeleton" style="width:32px;height:12px;border-radius:4px;"></div>' +
        '</div>' +
      '</div>';
    }
    evalsSkelHtml += '</div></div>';
    evalsContent.innerHTML = evalsSkelHtml;
  }

  // Dashboard table skeleton
  var container = document.getElementById('dashboard-table-container');
  var html = '<div class="skeleton-fade-in"><table class="skeleton-table"><thead><tr>' +
    '<th><div class="skeleton skeleton-text w-50" style="margin:0;"></div></th>' +
    '<th><div class="skeleton skeleton-text w-40" style="margin:0;"></div></th>' +
    '<th><div class="skeleton skeleton-text w-30" style="margin:0;"></div></th>' +
    '<th><div class="skeleton skeleton-text w-30" style="margin:0;"></div></th>' +
    '<th><div class="skeleton skeleton-text w-25" style="margin:0;"></div></th>' +
    '<th><div class="skeleton skeleton-text w-30" style="margin:0;"></div></th>' +
    '<th><div class="skeleton skeleton-text w-40" style="margin:0;"></div></th>' +
    '<th><div class="skeleton skeleton-text w-30" style="margin:0;"></div></th>' +
  '</tr></thead><tbody>';
  for (var i = 0; i < 6; i++) {
    html += '<tr>' +
      '<td><div class="skeleton skeleton-text w-75" style="margin:0;"></div></td>' +
      '<td><div class="skeleton skeleton-text w-25" style="margin:0;"></div></td>' +
      '<td><div class="skeleton skeleton-chip"></div></td>' +
      '<td><div class="skeleton skeleton-text w-40" style="margin:0;"></div></td>' +
      '<td><div class="skeleton skeleton-chip"></div></td>' +
      '<td><div class="skeleton skeleton-chip"></div></td>' +
      '<td><div class="skeleton skeleton-text w-50" style="margin:0;"></div></td>' +
      '<td><div style="display:flex;gap:8px;"><div class="skeleton skeleton-btn"></div><div class="skeleton skeleton-btn" style="width:56px;"></div></div></td>' +
    '</tr>';
  }
  html += '</tbody></table></div>';
  container.innerHTML = html;
}

function showStudentProfileSkeleton() {
  var container = document.getElementById('student-form-container');
  var html = '<div class="skeleton-fade-in">';
  // Academics card
  html += '<div class="profile-section-card">' +
    '<div class="skeleton skeleton-section-title" style="width:20%;margin-bottom:16px;"></div>' +
    '<div style="display:flex;gap:16px;padding:12px 16px;background:var(--md-surface-container-low);border-radius:var(--md-shape-sm);margin-bottom:12px;">' +
      '<div class="skeleton skeleton-text w-20" style="margin:0;"></div>' +
      '<div class="skeleton skeleton-chip" style="width:64px;height:32px;"></div>' +
      '<div class="skeleton skeleton-text w-20" style="margin:0;margin-left:auto;"></div>' +
      '<div class="skeleton skeleton-chip" style="width:40px;height:32px;"></div>' +
    '</div>';
  for (var i = 0; i < 4; i++) {
    html += '<div style="border:1px solid var(--md-outline-variant);border-radius:var(--md-shape-md);padding:12px 16px;margin-bottom:4px;display:flex;justify-content:space-between;align-items:center;">' +
      '<div style="display:flex;gap:12px;align-items:center;">' +
        '<div class="skeleton skeleton-text w-30" style="margin:0;"></div>' +
        '<div class="skeleton skeleton-text" style="width:24px;margin:0;"></div>' +
      '</div>' +
      '<div class="skeleton skeleton-chip"></div>' +
    '</div>';
  }
  html += '</div>';
  // Goals card
  html += '<div class="profile-section-card">' +
    '<div class="skeleton skeleton-section-title" style="width:30%;margin-bottom:16px;"></div>' +
    '<div class="skeleton skeleton-input" style="height:80px;margin-bottom:16px;"></div>' +
    '<div class="skeleton skeleton-input" style="height:60px;margin-left:20px;"></div>' +
  '</div>';
  // Check-in history
  html += '<div class="profile-section-card">' +
    '<div class="skeleton skeleton-section-title" style="width:25%;margin-bottom:16px;"></div>';
  for (var j = 0; j < 2; j++) {
    html += '<div class="skeleton-card">' +
      '<div style="display:flex;justify-content:space-between;margin-bottom:12px;">' +
        '<div class="skeleton skeleton-text w-25" style="margin:0;"></div>' +
        '<div class="skeleton skeleton-chip"></div>' +
      '</div>' +
      '<div style="display:flex;gap:12px;flex-wrap:wrap;">' +
        '<div class="skeleton skeleton-text w-20" style="margin:0;"></div>' +
        '<div class="skeleton skeleton-text w-20" style="margin:0;"></div>' +
        '<div class="skeleton skeleton-text w-20" style="margin:0;"></div>' +
      '</div>' +
    '</div>';
  }
  html += '</div></div>';
  container.innerHTML = html;
}

function showCheckInSkeleton() {
  var container = document.getElementById('checkin-form-container');
  var html = '<div class="skeleton-fade-in">';
  // Previous goal banner skeleton
  html += '<div style="background:var(--md-surface-container);border-radius:var(--md-shape-md);padding:16px 20px;margin-bottom:24px;border:1px solid var(--md-outline-variant);">' +
    '<div class="skeleton skeleton-text w-20"></div>' +
    '<div class="skeleton skeleton-text w-50"></div>' +
    '<div class="skeleton skeleton-text w-30" style="height:10px;"></div>' +
  '</div>';
  html += '<div class="form-card">';
  // Week Of
  html += '<div class="skeleton-section">' +
    '<div class="skeleton skeleton-input" style="width:200px;"></div>' +
  '</div>';
  // EF Ratings section
  html += '<div class="skeleton-section">' +
    '<div class="skeleton skeleton-section-title" style="width:40%;"></div>';
  for (var i = 0; i < 5; i++) {
    html += '<div style="margin-bottom:16px;">' +
      '<div class="skeleton skeleton-text w-20" style="height:12px;"></div>' +
      '<div style="display:flex;gap:0;">' +
        '<div class="skeleton" style="width:48px;height:40px;border-radius:9999px 0 0 9999px;"></div>' +
        '<div class="skeleton" style="width:48px;height:40px;border-radius:0;"></div>' +
        '<div class="skeleton" style="width:48px;height:40px;border-radius:0;"></div>' +
        '<div class="skeleton" style="width:48px;height:40px;border-radius:0;"></div>' +
        '<div class="skeleton" style="width:48px;height:40px;border-radius:0 9999px 9999px 0;"></div>' +
      '</div>' +
    '</div>';
  }
  html += '</div>';
  // Reflection section
  html += '<div class="skeleton-section">' +
    '<div class="skeleton skeleton-section-title" style="width:20%;"></div>' +
    '<div class="skeleton skeleton-input" style="height:80px;"></div>' +
    '<div class="skeleton skeleton-input" style="height:80px;"></div>' +
  '</div>';
  // Micro Goal section
  html += '<div class="skeleton-section">' +
    '<div class="skeleton skeleton-section-title" style="width:20%;"></div>' +
    '<div class="skeleton skeleton-input"></div>' +
    '<div class="skeleton skeleton-input"></div>' +
  '</div>';
  // Buttons
  html += '<div style="display:flex;gap:8px;justify-content:flex-end;">' +
    '<div class="skeleton skeleton-btn" style="width:72px;height:40px;"></div>' +
    '<div class="skeleton skeleton-btn" style="width:110px;height:40px;"></div>' +
  '</div>';
  html += '</div></div>';
  container.innerHTML = html;
}

function showEvalChecklistSkeleton() {
  var container = document.getElementById('eval-checklist-content');
  var html = '<div class="skeleton-fade-in">';
  // Two-column layout matching eval checklist
  html += '<div class="eval-checklist-layout">';
  // Left column: main checklist
  html += '<div class="eval-checklist-main">';
  // Summary card skeleton
  html += '<div class="eval-summary-card">' +
    '<div class="eval-summary-top">' +
      '<div class="eval-summary-left" style="flex:1;">' +
        '<div class="skeleton skeleton-text w-30" style="height:20px;margin-bottom:8px;"></div>' +
        '<div class="skeleton skeleton-text w-50" style="height:14px;"></div>' +
      '</div>' +
      '<div class="eval-summary-right">' +
        '<div class="skeleton" style="width:48px;height:32px;border-radius:var(--md-shape-sm);"></div>' +
        '<div class="skeleton skeleton-text" style="width:48px;height:10px;"></div>' +
      '</div>' +
    '</div>' +
    '<div class="skeleton" style="width:100%;height:8px;border-radius:var(--md-shape-full);"></div>' +
  '</div>';
  // Items card skeleton
  html += '<div class="eval-items-card">';
  html += '<div class="eval-items-header">' +
    '<span>Task</span>' +
    '<span>Due Date</span>' +
    '<span>Completed</span>' +
    '<span>Actions</span>' +
  '</div>';
  for (var i = 0; i < 6; i++) {
    var w = i % 3 === 0 ? 'w-75' : (i % 3 === 1 ? 'w-50' : 'w-40');
    html += '<div class="eval-item" style="border-left:none;">' +
      '<div class="eval-item-task" style="gap:12px;">' +
        '<div class="skeleton" style="width:20px;height:20px;border-radius:var(--md-shape-xs);flex-shrink:0;"></div>' +
        '<div class="skeleton skeleton-text ' + w + '" style="margin:0;"></div>' +
      '</div>' +
      '<div class="eval-item-due"><div class="skeleton" style="width:80px;height:14px;border-radius:var(--md-shape-xs);"></div></div>' +
      '<div class="eval-item-completed"><div class="skeleton skeleton-text" style="width:60px;height:12px;margin:0;"></div></div>' +
      '<div class="eval-item-actions"><div class="skeleton" style="width:56px;height:24px;border-radius:var(--md-shape-xs);"></div></div>' +
    '</div>';
  }
  html += '</div>';
  html += '</div>'; // end .eval-checklist-main
  // Right column: files sidebar skeleton
  html += '<div class="eval-checklist-sidebar">' +
    '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">' +
      '<div class="skeleton skeleton-text w-30" style="margin:0;height:16px;"></div>' +
      '<div class="skeleton" style="width:28px;height:28px;border-radius:var(--md-shape-sm);"></div>' +
    '</div>' +
    '<div class="skeleton skeleton-text w-75" style="height:12px;"></div>' +
    '<div class="skeleton skeleton-text w-50" style="height:12px;"></div>' +
  '</div>';
  html += '</div>'; // end .eval-checklist-layout
  html += '</div>'; // end .skeleton-fade-in
  container.innerHTML = html;
}

var _toastTimer = null;
function showToast(message, actionLabel, actionFn) {
  var toast = document.getElementById('toast');
  if (_toastTimer) clearTimeout(_toastTimer);
  if (actionLabel && actionFn) {
    toast.innerHTML = '<span class="toast-with-action"><span>' + esc(message) + '</span>' +
      '<button class="toast-action-btn" onclick="event.stopPropagation();">' + esc(actionLabel) + '</button></span>';
    var btn = toast.querySelector('.toast-action-btn');
    if (btn) btn.addEventListener('click', function() { actionFn(); hideToast(); });
  } else {
    toast.textContent = message;
  }
  toast.classList.remove('toast-hiding');
  toast.classList.add('show');
  _toastTimer = setTimeout(function() { hideToast(); }, actionLabel ? 5000 : 3000);
}
function hideToast() {
  var toast = document.getElementById('toast');
  if (_toastTimer) { clearTimeout(_toastTimer); _toastTimer = null; }
  toast.classList.add('toast-hiding');
  toast.classList.remove('show');
}

function showGlobalProgress() {
  var el = document.getElementById('global-progress');
  if (el) el.style.display = '';
}
function hideGlobalProgress() {
  var el = document.getElementById('global-progress');
  if (el) el.style.display = 'none';
}

function animateContentIn(container) {
  container.classList.add('content-fade-in');
  container.addEventListener('animationend', function handler() {
    container.classList.remove('content-fade-in');
    container.removeEventListener('animationend', handler);
  });
}

function esc(str) {
  if (str === null || str === undefined) return '';
  var div = document.createElement('div');
  div.textContent = String(str);
  return div.innerHTML;
}

function renderErrorState(message) {
  return '<div class="empty-state">' +
    '<h3>Unable to Load</h3>' +
    '<p>' + esc(message) + '</p>' +
    '<button class="btn btn-primary" style="margin-top:16px;" onclick="location.reload()">Reload</button>' +
  '</div>';
}

function showConfirmDialog(opts) {
  var overlay = document.createElement('div');
  overlay.className = 'confirm-overlay';
  if (opts.id) overlay.id = opts.id;
  overlay.innerHTML =
    '<div class="confirm-dialog"' + (opts.style ? ' style="' + opts.style + '"' : '') + '>' +
      '<h3>' + (opts.title || 'Confirm') + '</h3>' +
      '<p>' + (opts.body || '') + '</p>' +
      (opts.hint ? '<p class="hint">' + opts.hint + '</p>' : '') +
      '<div class="confirm-actions">' +
        '<button class="btn btn-outlined" onclick="closeConfirmDialog(this.closest(\'.confirm-overlay\'))">' + (opts.cancelLabel || 'Cancel') + '</button>' +
        '<button class="btn ' + (opts.confirmClass || 'btn-danger') + '" onclick="' + opts.onConfirm + '; closeConfirmDialog(this.closest(\'.confirm-overlay\'))">' + (opts.confirmLabel || 'Confirm') + '</button>' +
      '</div>' +
    '</div>';
  document.body.appendChild(overlay);
  return overlay;
}

function getStudentById(studentId) {
  return appState.dashboardData.find(function(s) { return s.id === studentId; });
}

function isBirthdayNear_(birthday) {
  if (!birthday) return false;
  var today = new Date();
  today.setHours(0, 0, 0, 0);
  var parts = birthday.split('-');
  var bd = new Date(today.getFullYear(), parseInt(parts[1], 10) - 1, parseInt(parts[2], 10));
  if (bd < today) bd.setFullYear(bd.getFullYear() + 1);
  var diff = Math.round((bd - today) / 86400000);
  return diff <= 7;
}

function isBirthdayToday_(birthday) {
  if (!birthday) return false;
  var today = new Date();
  var parts = birthday.split('-');
  return (today.getMonth() + 1) === parseInt(parts[1], 10) &&
         today.getDate() === parseInt(parts[2], 10);
}

function buildBirthdayBadge_(birthday) {
  if (!isBirthdayNear_(birthday)) return '';
  return ' <span class="birthday-badge" title="Birthday ' +
    (isBirthdayToday_(birthday) ? 'today!' : 'coming up!') +
    '">&#x1F382;</span>';
}

function recalcTotalMissing(student) {
  student.totalMissing = (student.academicData || []).reduce(function(sum, c) {
    return sum + (Number(c.missing) || 0);
  }, 0);
}

/** Format a YYYY-MM-DD date string as "Mon. DD, YYYY" (e.g. "Feb. 24, 2026") */
function formatDateDisplay(dateStr) {
  if (!dateStr) return 'Never';
  var parts = dateStr.split('-');
  if (parts.length !== 3) return dateStr;
  var months = ['Jan.', 'Feb.', 'Mar.', 'Apr.', 'May', 'Jun.',
                'Jul.', 'Aug.', 'Sep.', 'Oct.', 'Nov.', 'Dec.'];
  var m = parseInt(parts[1], 10);
  var d = parseInt(parts[2], 10);
  if (isNaN(m) || isNaN(d)) return dateStr;
  return months[m - 1] + ' ' + d + ', ' + parts[0];
}

// ─── Onboarding Wizard ───

function showOnboarding(status) {
  onboardingState.email = status.email || '';
  onboardingState.step = 1;
  showView('onboarding-view');
  renderOnboardingStep();
}

function onboardingNext() {
  onboardingState.step++;
  renderOnboardingStep();
}

function renderOnboardingStep() {
  var container = document.getElementById('onboarding-container');
  var html = '';

  // Progress indicator
  html += '<div class="onboarding-progress">';
  for (var i = 1; i <= 3; i++) {
    var stepClass = i === onboardingState.step ? 'active' :
                    i < onboardingState.step ? 'completed' : '';
    html += '<div class="onboarding-step-dot ' + stepClass + '">' + i + '</div>';
    if (i < 3) html += '<div class="onboarding-step-line ' + (i < onboardingState.step ? 'completed' : '') + '"></div>';
  }
  html += '</div>';

  if (onboardingState.step === 1) {
    html += renderOnboardingWelcome();
  } else if (onboardingState.step === 2) {
    html += renderOnboardingProvision();
  } else if (onboardingState.step === 3) {
    html += renderOnboardingFirstStudent();
  }

  container.innerHTML = html;

  // Auto-trigger provisioning when step 2 renders
  if (onboardingState.step === 2) {
    triggerProvisioning();
  }
}

// ── Step 1: Welcome & Feature Highlights ──
function renderOnboardingWelcome() {
  var iconSvgs = {
    dashboard: '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>',
    check_circle: '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>',
    trending_up: '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/></svg>',
    school: '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82zM12 3L1 9l11 6 9-4.91V17h2V9L12 3z"/></svg>',
    insights: '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M21 8c-1.45 0-2.26 1.44-1.93 2.51l-3.55 3.56c-.3-.09-.74-.09-1.04 0l-2.55-2.55C12.27 10.45 11.46 9 10 9c-1.45 0-2.27 1.44-1.93 2.52l-4.56 4.55C2.44 15.74 1 16.55 1 18c0 1.1.9 2 2 2 1.45 0 2.26-1.44 1.93-2.51l4.55-4.56c.3.09.74.09 1.04 0l2.55 2.55C12.73 16.55 13.54 18 15 18c1.45 0 2.27-1.44 1.93-2.52l3.56-3.55C21.56 12.26 23 11.45 23 10c0-1.1-.9-2-2-2z"/></svg>'
  };

  var features = [
    { icon: 'dashboard', title: 'Caseload Dashboard', desc: 'See all your students at a glance with EF ratings, GPA, trends, and missing assignments.' },
    { icon: 'check_circle', title: 'Weekly Check-Ins', desc: 'Rate executive function skills across five dimensions, reflect on progress, and set micro-goals.' },
    { icon: 'trending_up', title: 'EF Tracking', desc: 'Track Planning, Follow-Through, Regulation, Focus Goal, and Effort over time.' },
    { icon: 'school', title: 'Academic Snapshots', desc: 'Log grades and missing assignments per class during each check-in.' },
    { icon: 'insights', title: 'Trends & History', desc: 'Spot trends across check-ins and review a student\u2019s full history.' }
  ];

  var html = '<div class="onboarding-card">' +
    '<h2 class="onboarding-title">Welcome to Caseload Dashboard</h2>' +
    '<p class="onboarding-subtitle">A caseload dashboard for tracking executive function skills and academic progress for your students.</p>';

  html += '<div class="onboarding-features">';
  features.forEach(function(f) {
    html += '<div class="onboarding-feature">' +
      '<div class="onboarding-feature-icon">' + iconSvgs[f.icon] + '</div>' +
      '<div class="onboarding-feature-text">' +
        '<div class="onboarding-feature-title">' + f.title + '</div>' +
        '<div class="onboarding-feature-desc">' + f.desc + '</div>' +
      '</div>' +
    '</div>';
  });
  html += '</div>';

  html += '<div class="onboarding-actions">' +
    '<button class="btn btn-primary" onclick="onboardingNext()">Get Started</button>' +
  '</div>';

  html += '</div>';
  return html;
}

// ── Step 2: Spreadsheet Provisioning ──
function renderOnboardingProvision() {
  var html = '<div class="onboarding-card">' +
    '<h2 class="onboarding-title">Setting Up Your Data</h2>' +
    '<p class="onboarding-subtitle">Creating a private Google Sheet in your Drive to store student data securely.</p>' +
    '<div id="provision-status" class="onboarding-provision-status">' +
      '<div class="provision-spinner"></div>' +
      '<p>Creating your spreadsheet\u2026</p>' +
    '</div>' +
    '<div id="provision-actions" class="onboarding-actions" style="display:none;">' +
      '<button class="btn btn-primary" onclick="onboardingNext()">Continue</button>' +
    '</div>' +
  '</div>';
  return html;
}

function triggerProvisioning() {
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        onboardingState.spreadsheetUrl = result.spreadsheetUrl;
        var statusEl = document.getElementById('provision-status');
        statusEl.innerHTML =
          '<div class="provision-success">' +
            '<svg width="48" height="48" viewBox="0 0 24 24" fill="var(--md-primary)"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>' +
            '<p class="provision-success-text">Your spreadsheet has been created!</p>' +
            '<p class="provision-success-hint">It\u2019s stored in your Google Drive and only accessible to you.</p>' +
          '</div>';
        document.getElementById('provision-actions').style.display = '';
      } else {
        showProvisionError('Unexpected error during setup.');
      }
    })
    .withFailureHandler(function(err) {
      showProvisionError(err && err.message ? err.message : String(err));
    })
    .provisionUserSpreadsheet();
}

function showProvisionError(message) {
  var statusEl = document.getElementById('provision-status');
  statusEl.innerHTML =
    '<div class="provision-error">' +
      '<p>Something went wrong: ' + esc(message) + '</p>' +
      '<button class="btn btn-primary" onclick="renderOnboardingStep()" style="margin-top:12px;">Retry</button>' +
    '</div>';
}

// ── Step 3: First Student Profile ──
function renderOnboardingFirstStudent() {
  var gradeOptions = [
    { value: '', label: '-- Select Grade --' },
    { value: '6', label: '6' },
    { value: '7', label: '7' },
    { value: '8', label: '8' }
  ];

  var gradeHtml = '';
  gradeOptions.forEach(function(g) {
    gradeHtml += '<option value="' + g.value + '">' + g.label + '</option>';
  });

  var html = '<div class="onboarding-card">' +
    '<h2 class="onboarding-title">Add Your First Student</h2>' +
    '<p class="onboarding-subtitle">Set up a student profile to get started. You can always add more students later from the caseload dashboard.</p>' +
    '<div class="form-card" style="box-shadow:none;padding:0;">' +
      '<div class="form-section">' +
        '<div class="form-section-title">Basic Information</div>' +
        '<div class="form-row">' +
          '<div class="form-group"><label>First Name *</label>' +
            '<input type="text" id="ob-firstName" placeholder="First name"></div>' +
          '<div class="form-group"><label>Last Name *</label>' +
            '<input type="text" id="ob-lastName" placeholder="Last name"></div>' +
        '</div>' +
        '<div class="form-group"><label>Grade Level</label>' +
          '<select id="ob-grade">' + gradeHtml + '</select>' +
        '</div>' +
      '</div>' +
      '<div class="form-section">' +
        '<div class="form-section-title">Focus &amp; Support</div>' +
        '<div class="form-group"><label>Focus Goal</label>' +
          '<input type="text" id="ob-focusGoal" placeholder="Executive function focus area"></div>' +
        '<div class="form-group"><label>IEP Goal</label>' +
          '<textarea id="ob-iepGoal" placeholder="Enter the student\u2019s current IEP goal (optional)"></textarea></div>' +
      '</div>' +
    '</div>' +
    '<div class="onboarding-actions">' +
      '<button class="btn btn-secondary" onclick="skipFirstStudent()">Skip for Now</button>' +
      '<button class="btn btn-primary" onclick="saveOnboardingStudent()">Save &amp; Finish</button>' +
    '</div>' +
  '</div>';

  return html;
}

function saveOnboardingStudent() {
  var firstName = document.getElementById('ob-firstName').value.trim();
  var lastName = document.getElementById('ob-lastName').value.trim();

  if (!firstName || !lastName) {
    showToast('First and last name are required');
    return;
  }

  var profile = {
    firstName: firstName,
    lastName: lastName,
    grade: document.getElementById('ob-grade').value,
    focusGoal: document.getElementById('ob-focusGoal').value.trim(),
    iepGoal: document.getElementById('ob-iepGoal').value.trim(),
    period: '',
    accommodations: '',
    notes: '',
    classes: []
  };

  showToast('Saving student\u2026');

  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showToast('Welcome to Caseload Dashboard!');
        completeOnboarding();
      } else {
        showToast('Error saving student');
      }
    })
    .withFailureHandler(function(err) {
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
    })
    .saveStudent(profile);
}

function skipFirstStudent() {
  completeOnboarding();
}

function completeOnboarding() {
  enterApp();
}

// ─── Case Manager Helpers ───

function getCaseManagerName(email) {
  if (!email) return '';
  var match = appState.caseManagers.find(function(cm) {
    return cm.email === email;
  });
  return match ? match.name : email;
}

// ─── My Caseload View ───

function renderMyCaseload() {
  var container = document.getElementById('mycaseload-container');
  if (!container) return;
  var currentEmail = (appState.currentUserEmail || '').toLowerCase();

  var myStudents = appState.dashboardData.filter(function(s) {
    return (s.caseManagerEmail || '').toLowerCase() === currentEmail;
  });

  var html = '';

  // Action buttons row
  html += '<div class="mycaseload-spedforms-btn">' +
    '<a href="https://15.spedforms.org/students2020.php?login=1" target="_blank" class="btn btn-secondary">Open SpEdForms</a>' +
    '<button type="button" class="btn btn-secondary" onclick="generateBatchReports()">Generate All Progress Reports</button>' +
  '</div>';

  if (myStudents.length === 0) {
    html += '<div class="empty-state">' +
      '<h3>No Students Assigned</h3>' +
      '<p>You have no students assigned to you as case manager.</p>' +
    '</div>';
    container.innerHTML = html;
    return;
  }

  myStudents.sort(function(a, b) {
    var cmp = String(a.firstName).localeCompare(String(b.firstName));
    return cmp !== 0 ? cmp : String(a.lastName).localeCompare(String(b.lastName));
  });

  html += '<table class="dashboard-table"><thead><tr>' +
    '<th>Name</th>' +
    '<th>Grade</th>' +
    '<th>GPA</th>' +
    '<th>Missing</th>' +
    '<th>Last Check-In</th>' +
    '<th>Actions</th>' +
  '</tr></thead><tbody>';

  myStudents.forEach(function(s) {
    var origIndex = appState.dashboardData.indexOf(s);
    html += '<tr onclick="openSidePanel(' + origIndex + ')" title="Click for quick view">';
    html += '<td><strong>' + esc(s.firstName + ' ' + s.lastName) + '</strong>';
    if (s.online) html += ' <span class="online-badge" title="Online">Online</span>';
    html += buildBirthdayBadge_(s.birthday);
    if (s.evalType) {
      var evalLabel = getEvalTypeLabel(s.evalType);
      html += ' <span class="chip chip-clickable eval-badge" data-eval-type="' + esc(s.evalType) + '" onclick="event.stopPropagation(); openEvalFromBadge(\'' + s.id + '\')" title="View ' + evalLabel + ' checklist">' + evalLabel + '</span>';
    }
    html += '</td>';
    html += '<td>' + esc(s.grade || '-') + '</td>';

    if (s.gpa != null) {
      var gpaClass = s.gpa >= 3.5 ? 'chip-gold' : s.gpa > 3.0 ? 'chip-green' : s.gpa >= 2.5 ? 'chip-yellow' : 'chip-red';
      var trophy = s.gpa >= 3.7 ? ' &#x1F3C6;' : '';
      html += '<td><span class="chip ' + gpaClass + '">' + s.gpa.toFixed(2) + trophy + '</span></td>';
    } else {
      html += '<td><span class="chip chip-gray">--</span></td>';
    }

    if (s.totalMissing > 0) {
      var missingClass = s.totalMissing >= 4 ? 'chip-red' : 'chip-yellow';
      html += '<td><span class="chip chip-clickable ' + missingClass + '" onclick="event.stopPropagation(); showMissingAssignments(\'' + s.id + '\')" title="View missing assignments">' + s.totalMissing + '</span></td>';
    } else {
      html += '<td><span class="chip chip-clickable chip-green" onclick="event.stopPropagation(); showMissingAssignments(\'' + s.id + '\')" title="View missing assignments">0</span></td>';
    }

    html += '<td>' + esc(formatDateDisplay(s.latestWeek)) + '</td>';

    html += '<td><div class="action-btns">' +
      '<button class="action-btn" onclick="event.stopPropagation(); editStudent(\'' + s.id + '\')" title="Profile">' +
        '<svg class="action-btn-icon" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>' +
        '<span class="action-btn-label">Profile</span>' +
      '</button>' +
    '</div></td>';

    html += '</tr>';
  });

  html += '</tbody></table>';
  container.innerHTML = html;
  animateContentIn(container);
}

// ─── Admin View (Superuser Only) ───

function loadAdminView() {
  if (!appState.isSuperuser) {
    showToast('Unauthorized');
    return;
  }
  var container = document.getElementById('admin-content-container');
  if (!container) return;
  container.innerHTML =
    '<div class="skeleton-fade-in"><div class="form-card">' +
      '<div class="skeleton skeleton-section-title" style="width:30%;"></div>' +
      '<div class="skeleton skeleton-input" style="margin-bottom:12px;"></div>' +
      '<div class="skeleton skeleton-input" style="margin-bottom:12px;"></div>' +
    '</div></div>';

  var loadedCMs = null;
  var loadedStudents = null;

  function tryRender() {
    if (loadedCMs !== null && loadedStudents !== null) {
      renderAdminView(loadedCMs, loadedStudents);
    }
  }

  google.script.run
    .withSuccessHandler(function(cms) {
      appState.caseManagers = cms || [];
      loadedCMs = cms || [];
      tryRender();
    })
    .withFailureHandler(function() { loadedCMs = []; tryRender(); })
    .getCaseManagers();

  google.script.run
    .withSuccessHandler(function(students) { loadedStudents = students || []; tryRender(); })
    .withFailureHandler(function() { loadedStudents = []; tryRender(); })
    .getAllStudentsForAdmin();
}

function renderAdminView(caseManagers, students) {
  var container = document.getElementById('admin-content-container');
  var html = '';

  // Section 1: Manage Case Managers
  html += '<div class="form-card">' +
    '<div class="form-section-title">Case Managers</div>';

  if (caseManagers.length === 0) {
    html += '<p class="hint">No case managers configured yet.</p>';
  } else {
    caseManagers.forEach(function(cm) {
      html += '<div class="admin-cm-row">' +
        '<div class="admin-cm-info">' +
          '<span class="admin-cm-name">' + esc(cm.name) + '</span>' +
          '<span class="admin-cm-email">' + esc(cm.email) + '</span>' +
        '</div>' +
        '<button class="btn-icon btn-icon-danger" onclick="confirmRemoveCaseManager(\'' + esc(cm.email) + '\')" title="Remove" aria-label="Remove"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>' +
      '</div>';
    });
  }

  html += '<div style="margin-top:16px;">' +
    '<div class="admin-add-form">' +
      '<input type="email" id="admin-cm-email" placeholder="email@school.edu">' +
      '<input type="text" id="admin-cm-name" placeholder="Display Name">' +
      '<button class="btn btn-primary" onclick="addCaseManagerFromForm()">Add</button>' +
    '</div>' +
  '</div></div>';

  // Section 2: Assign Students to Case Managers
  html += '<div class="form-card">' +
    '<div class="form-section-title">Student Case Manager Assignments</div>';

  if (students.length === 0) {
    html += '<p class="hint">No students found.</p>';
  } else {
    html += '<table class="admin-assign-table"><thead><tr>' +
      '<th>Student</th><th>Grade</th><th>Case Manager</th>' +
    '</tr></thead><tbody>';

    students.sort(function(a, b) {
      var cmp = String(a.lastName).localeCompare(String(b.lastName));
      return cmp !== 0 ? cmp : String(a.firstName).localeCompare(String(b.firstName));
    });

    students.forEach(function(s) {
      html += '<tr>';
      html += '<td>' + esc(s.lastName + ', ' + s.firstName) + '</td>';
      html += '<td>' + esc(s.grade || '-') + '</td>';
      html += '<td><select onchange="adminAssignCaseManager(\'' + s.id + '\', this.value)">';
      html += '<option value="">-- None --</option>';
      caseManagers.forEach(function(cm) {
        var sel = (s.caseManagerEmail === cm.email) ? ' selected' : '';
        html += '<option value="' + esc(cm.email) + '"' + sel + '>' + esc(cm.name) + '</option>';
      });
      html += '</select></td></tr>';
    });

    html += '</tbody></table>';
  }

  html += '</div>';
  container.innerHTML = html;
  animateContentIn(container);
}

function addCaseManagerFromForm() {
  var emailInput = document.getElementById('admin-cm-email');
  var nameInput = document.getElementById('admin-cm-name');
  var email = (emailInput.value || '').trim();
  var name = (nameInput.value || '').trim();

  if (!email) { showToast('Please enter an email address'); return; }
  if (!name) { showToast('Please enter a display name'); return; }

  showToast('Adding case manager\u2026');

  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showToast('Case manager added');
        loadAdminView();
      } else {
        showToast(result.error || 'Error adding case manager');
      }
    })
    .withFailureHandler(function(err) {
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
    })
    .addCaseManager(email, name);
}

function confirmRemoveCaseManager(email) {
  showConfirmDialog({
    title: 'Remove Case Manager?',
    body: 'This will remove <strong>' + esc(email) + '</strong> from the case managers list. Students already assigned will keep their assignment.',
    confirmLabel: 'Remove',
    onConfirm: "doRemoveCaseManager('" + esc(email) + "')"
  });
}

function doRemoveCaseManager(email) {
  showToast('Removing case manager\u2026');
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showToast('Case manager removed');
        loadAdminView();
      } else {
        showToast(result.error || 'Error removing case manager');
      }
    })
    .withFailureHandler(function(err) {
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
    })
    .removeCaseManager(email);
}

function adminAssignCaseManager(studentId, caseManagerEmail) {
  showToast('Assigning case manager\u2026');
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showToast('Case manager assigned');
        appState.dashboardData.forEach(function(s) {
          if (s.id === studentId) {
            s.caseManagerEmail = caseManagerEmail;
          }
        });
      } else {
        showToast(result.error || 'Error assigning case manager');
      }
    })
    .withFailureHandler(function(err) {
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
    })
    .assignCaseManager(studentId, caseManagerEmail);
}

// ─── Evaluation Checklist ───

function loadEvalCardState(studentId) {
  google.script.run
    .withSuccessHandler(function(evaluation) {
      var sectionEl = document.getElementById('profile-eval-section');

      if (evaluation) {
        appState.currentEvaluation = evaluation;

        // Show eval section in profile
        if (sectionEl) {
          sectionEl.style.display = '';

          var items = evaluation.items || [];
          var remaining = items.filter(function(it) { return !it.checked; });
          var done = items.length - remaining.length;
          var typeLabel = getEvalTypeLabel(evaluation.type);

          // Compute overdue count
          var now = new Date();
          var overdueCount = items.filter(function(it) {
            if (it.checked || !it.dueDate) return false;
            return now > new Date(it.dueDate + 'T23:59:59');
          }).length;

          // Toggle overdue border
          if (overdueCount > 0) {
            sectionEl.classList.add('profile-eval-overdue');
          } else {
            sectionEl.classList.remove('profile-eval-overdue');
          }

          // Update section header
          var titleEl = document.getElementById('profile-eval-section-title');
          if (titleEl) titleEl.textContent = typeLabel;

          var progressEl = document.getElementById('profile-eval-section-progress');
          if (progressEl) progressEl.textContent = done + '/' + items.length + ' tasks complete';

          var overdueEl = document.getElementById('profile-eval-overdue-badge');
          if (overdueEl) {
            if (overdueCount > 0) {
              overdueEl.textContent = overdueCount + ' overdue';
              overdueEl.style.display = '';
            } else {
              overdueEl.style.display = 'none';
            }
          }

          // Meeting date label
          var meetingDateEl = document.getElementById('profile-eval-meeting-date');
          if (meetingDateEl) {
            if (evaluation.meetingDate) {
              meetingDateEl.textContent = 'Meeting: ' + formatDateDisplay(evaluation.meetingDate);
              meetingDateEl.style.display = '';
            } else {
              meetingDateEl.textContent = 'Set meeting date';
              meetingDateEl.style.display = '';
            }
          }

          // Populate task list directly
          var tasksEl = document.getElementById('profile-eval-tasks');
          if (tasksEl) {
            var taskHtml = '';
            var show = remaining.slice(0, 6);
            show.forEach(function(item) {
              var isOverdue = item.dueDate && !item.checked && now > new Date(item.dueDate + 'T23:59:59');
              taskHtml += '<li class="eval-card-task' + (isOverdue ? ' eval-card-task-overdue' : '') + '">';
              taskHtml += '<span class="eval-card-task-text">' + esc(item.text) + '</span>';
              if (isOverdue) {
                taskHtml += '<span class="eval-card-task-overdue-badge">Overdue</span>';
              }
              taskHtml += '</li>';
            });
            if (remaining.length > 6) {
              taskHtml += '<li class="eval-card-task eval-card-task-more">+' + (remaining.length - 6) + ' more</li>';
            }
            if (remaining.length === 0) {
              taskHtml += '<li class="eval-card-task eval-card-task-complete">All tasks complete!</li>';
            }
            tasksEl.innerHTML = taskHtml;
          }
        }

        setEvalMenuVisibility_(true);
      } else {
        appState.currentEvaluation = null;
        if (sectionEl) sectionEl.style.display = 'none';
        setEvalMenuVisibility_(false);
      }
    })
    .withFailureHandler(function() {
      setEvalMenuVisibility_(false);
    })
    .getEvaluation(studentId);
}

function handleEvalCardClick(studentId) {
  if (appState.currentEvaluation) {
    showEvalChecklistView(studentId, appState.currentEvaluation);
  }
}

function handleEvalMeetingDateClick() {
  var labelEl = document.getElementById('profile-eval-meeting-date');
  var inputEl = document.getElementById('profile-eval-meeting-input');
  if (!labelEl || !inputEl) return;

  if (inputEl.style.display === 'none') {
    inputEl.value = (appState.currentEvaluation && appState.currentEvaluation.meetingDate) || '';
    inputEl.style.display = '';
    labelEl.style.display = 'none';
    inputEl.focus();
    inputEl.onblur = function() {
      inputEl.style.display = 'none';
      labelEl.style.display = '';
      inputEl.onblur = null;
    };
  } else {
    inputEl.style.display = 'none';
    labelEl.style.display = '';
  }
}

function saveEvalMeetingDate(dateValue) {
  var eval_ = appState.currentEvaluation;
  if (!eval_) return;

  var labelEl = document.getElementById('profile-eval-meeting-date');
  var inputEl = document.getElementById('profile-eval-meeting-input');

  // Optimistic UI
  if (eval_) eval_.meetingDate = dateValue || '';
  if (labelEl) {
    if (dateValue) {
      labelEl.textContent = 'Meeting: ' + formatDateDisplay(dateValue);
    } else {
      labelEl.textContent = 'Set meeting date';
    }
    labelEl.style.display = '';
  }
  if (inputEl) inputEl.style.display = 'none';

  // Also update eval checklist view if present
  var checklistInput = document.getElementById('eval-meeting-date-input');
  if (checklistInput) checklistInput.value = dateValue || '';

  google.script.run
    .withSuccessHandler(function() {
      showToast('Meeting date saved');
    })
    .withFailureHandler(function() {
      showToast('Failed to save meeting date');
    })
    .updateEvalMeetingDate(eval_.id, dateValue || '');
}

function openEvalFromBadge(studentId) {
  // Optimistic UI: navigate immediately and show skeleton
  appState.currentStudentId = studentId;
  var student = getStudentById(studentId);
  var studentName = student ? (student.firstName + ' ' + student.lastName) : 'Student';
  document.getElementById('eval-checklist-title').innerHTML = '<span class="skeleton skeleton-title-inline"></span>';
  updateEvalBreadcrumb_('Eval Checklist');
  document.getElementById('eval-checklist-actions').innerHTML = '';
  showEvalChecklistSkeleton();
  showView('eval-checklist-view');

  google.script.run
    .withSuccessHandler(function(evaluation) {
      if (evaluation) {
        appState.currentEvaluation = evaluation;
        appState.evalChecklistStudentId = studentId;
        var typeLabel = getEvalTypeLabel(evaluation.type);
        updateEvalBreadcrumb_(typeLabel);
        document.getElementById('eval-checklist-title').textContent = studentName;
        document.getElementById('eval-checklist-actions').innerHTML =
          '<a href="https://15.spedforms.org/students2020.php?login=1" target="_blank" class="btn btn-secondary">Open SpEdForms</a>';
        renderEvalChecklist(evaluation);
      } else {
        showToast('No active evaluation found');
        goBackFromEvalChecklist();
      }
    })
    .withFailureHandler(function(err) {
      showToast('Error loading evaluation');
      goBackFromEvalChecklist();
    })
    .getEvaluation(studentId);
}

function handleCreateEvalChecklist(type) {
  closeStudentMenu();
  var studentId = appState.currentStudentId;
  if (!studentId) return;

  var typeLabel = getEvalTypeLabel(type);
  showConfirmDialog({
    title: 'Create ' + typeLabel + ' Checklist?',
    body: 'This will create a new <strong>' + typeLabel + ' Checklist</strong> for this student. Only one checklist can be active at a time.',
    confirmLabel: 'Create',
    confirmClass: 'btn-primary',
    onConfirm: "doCreateEvalChecklist('" + esc(studentId) + "', '" + esc(type) + "')"
  });
}

function doCreateEvalChecklist(studentId, type) {
  showToast('Creating checklist\u2026');
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showToast('Checklist created');
        var evaluation = {
          id: result.id,
          studentId: result.studentId,
          type: result.type,
          items: result.items,
          files: result.files || []
        };
        appState.currentEvaluation = evaluation;
        showEvalChecklistView(studentId, evaluation);
      } else {
        showToast(result.error || 'Error creating checklist');
      }
    })
    .withFailureHandler(function(err) {
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
    })
    .createEvaluation(studentId, type);
}

function handleViewEvalChecklist() {
  closeStudentMenu();
  var studentId = appState.currentStudentId;
  if (!studentId || !appState.currentEvaluation) return;
  showEvalChecklistView(studentId, appState.currentEvaluation);
}

function showEvalChecklistView(studentId, evaluation, scrollToItemId) {
  resetEvalAutosave();
  appState.editingEvalItemId = null;
  _evalFocusedIndex = -1;
  _expandedEvalItemFiles = {};
  appState.evalChecklistStudentId = studentId;
  appState.currentEvaluation = evaluation;

  var student = getStudentById(studentId);
  var studentName = student ? (student.firstName + ' ' + student.lastName) : 'Student';
  var typeLabel = getEvalTypeLabel(evaluation.type);

  updateEvalBreadcrumb_(typeLabel);

  document.getElementById('eval-checklist-title').textContent = studentName;

  // Build prev/next navigation
  var navHtml = buildEvalNavRow_(studentId);
  document.getElementById('eval-checklist-actions').innerHTML =
    '<a href="https://15.spedforms.org/students2020.php?login=1" target="_blank" class="btn btn-secondary">Open SpEdForms</a>';

  renderEvalChecklist(evaluation);

  // Insert prev/next nav before the layout
  var contentEl = document.getElementById('eval-checklist-content');
  if (contentEl && navHtml) contentEl.insertAdjacentHTML('afterbegin', navHtml);

  showView('eval-checklist-view');

  // Auto-scroll to specific item if provided
  if (scrollToItemId) {
    setTimeout(function() {
      var targetEl = document.querySelector('.eval-item[data-item-id="' + scrollToItemId + '"]');
      if (targetEl) {
        targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        targetEl.classList.add('eval-item-highlight');
        setTimeout(function() { targetEl.classList.remove('eval-item-highlight'); }, 2500);
      }
    }, 300);
  }
}

function buildEvalItemRow(evalId, item) {
  var isEditing = appState.editingEvalItemId === item.id;
  var checkedClass = item.checked ? ' eval-item-checked' : '';
  var completedDate = '';
  if (item.checked && item.completedAt) {
    var d = new Date(item.completedAt);
    completedDate = (d.getMonth() + 1) + '/' + d.getDate() + '/' + d.getFullYear();
  }
  var isOverdue = isEvalItemOverdue_(item);
  var isDueSoon = isEvalItemDueSoon_(item);
  var itemFiles = item.files || [];
  var isFilesExpanded = !!_expandedEvalItemFiles[item.id];

  var classes = 'eval-item' + checkedClass + (isOverdue ? ' eval-item-overdue' : '') + (isDueSoon ? ' eval-item-due-soon' : '') + (isEditing ? ' eval-item-editing' : '');

  var html = '<div class="' + classes + '" data-item-id="' + esc(item.id) + '">';

  // Task column
  html += '<div class="eval-item-task">';
  if (isOverdue) {
    html += '<span class="eval-overdue-icon" title="Overdue">' +
      '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>' +
    '</span>';
  } else if (isDueSoon) {
    html += '<span class="eval-due-soon-icon" title="Due soon">' +
      '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>' +
    '</span>';
  }
  html += '<label class="eval-item-label">' +
    '<input type="checkbox" class="eval-item-checkbox"' + (item.checked ? ' checked' : '') +
      ' onchange="toggleEvalItem(\'' + esc(evalId) + '\', \'' + esc(item.id) + '\', this.checked)">';
  if (isEditing) {
    html += '<input type="text" class="eval-item-edit-input" id="eval-edit-text-' + esc(item.id) + '" value="' + esc(item.text) + '" ' +
      'onkeydown="if(event.key===\'Enter\'){event.preventDefault();exitEvalEditMode();} if(event.key===\'Escape\'){cancelEvalEditMode(\'' + esc(item.id) + '\');}">';
  } else {
    html += '<span class="eval-item-text">' + esc(item.text) + '</span>';
  }
  html += '</label>';
  // File indicator (non-edit mode, when item has files)
  if (itemFiles.length > 0 && !isEditing) {
    html += '<span class="eval-item-file-indicator" role="button" tabindex="0" ' +
      'onclick="event.stopPropagation();toggleEvalItemFiles(\'' + esc(item.id) + '\')" ' +
      'onkeydown="if(event.key===\'Enter\'){event.stopPropagation();toggleEvalItemFiles(\'' + esc(item.id) + '\');}" ' +
      'title="' + itemFiles.length + ' file' + (itemFiles.length !== 1 ? 's' : '') + ' attached">' +
      '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/></svg>' +
      (itemFiles.length > 1 ? '<span class="eval-item-file-count">' + itemFiles.length + '</span>' : '') +
    '</span>';
  }
  html += '</div>';

  // Due Date column
  html += '<div class="eval-item-due">';
  html += '<span class="eval-item-mobile-label">Due Date</span>';
  if (isEditing) {
    html += '<input type="date" class="eval-item-due-date" id="eval-edit-due-' + esc(item.id) + '" value="' + esc(item.dueDate || '') + '">';
  } else if (item.dueDate) {
    var dueTextClass = isOverdue ? ' eval-due-text-overdue' : (isDueSoon ? ' eval-due-text-soon' : '');
    html += '<span class="eval-due-text' + dueTextClass + '">' + esc(formatDateDisplay(item.dueDate)) + '</span>';
  }
  html += '</div>';

  // Completed column
  html += '<div class="eval-item-completed">' +
    '<span class="eval-item-mobile-label">Completed</span>' +
    (completedDate ? '<span class="eval-item-date">' + esc(completedDate) + '</span>' : '') +
  '</div>';

  // Actions column
  html += '<div class="eval-item-actions">';
  if (isEditing) {
    html += '<button class="btn-icon btn-sm eval-edit-done-btn" onclick="exitEvalEditMode()" title="Save changes">' +
      '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>' +
    '</button>';
  } else {
    html += '<button class="btn-icon btn-sm" onclick="enterEvalEditMode(\'' + esc(item.id) + '\')" title="Edit task">' +
      '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>' +
    '</button>';
  }
  html += '<button class="btn-icon btn-sm eval-item-delete-btn" onclick="deleteEvalItemHandler(\'' + esc(evalId) + '\', \'' + esc(item.id) + '\')" title="Delete task">' +
    '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>' +
  '</button>';
  html += '</div>';

  // Expanded file list (spans all grid columns)
  if (itemFiles.length > 0 && (isFilesExpanded || isEditing)) {
    html += '<div class="eval-item-files-panel">';
    itemFiles.forEach(function(file) {
      html += '<div class="eval-item-file-row">' +
        '<a href="' + esc(file.url) + '" target="_blank" rel="noopener" class="eval-item-file-link" title="Open ' + esc(file.name) + '">' +
          '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" class="eval-item-file-link-icon"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg>' +
          '<span class="eval-item-file-name">' + esc(file.name) + '</span>' +
        '</a>';
      if (isEditing) {
        html += '<button class="btn-icon btn-sm eval-item-file-remove" onclick="event.stopPropagation();removeEvalItemFile(\'' + esc(evalId) + '\',\'' + esc(item.id) + '\',\'' + esc(file.id) + '\')" title="Remove file">' +
          '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>' +
        '</button>';
      }
      html += '</div>';
    });
    html += '</div>';
  }

  // Add files section (edit mode only, spans all grid columns)
  if (isEditing) {
    html += '<div class="eval-item-add-file-section">' +
      '<button type="button" class="btn-ghost btn-sm eval-item-add-file-btn" id="eval-item-add-file-btn-' + esc(item.id) + '" ' +
        'onclick="event.stopPropagation();showEvalItemAddFileForm(\'' + esc(item.id) + '\')">' +
        '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="margin-right:4px"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/></svg>' +
        '+ Add File' +
      '</button>' +
      '<div class="eval-item-add-file-form" id="eval-item-add-file-form-' + esc(item.id) + '" style="display:none;">' +
        '<div class="eval-item-add-file-row">' +
          '<input type="text" class="eval-item-add-file-name" id="eval-item-add-file-name-' + esc(item.id) + '" placeholder="File name...">' +
          '<input type="text" class="eval-item-add-file-url" id="eval-item-add-file-url-' + esc(item.id) + '" placeholder="Paste URL..." ' +
            'onkeydown="if(event.key===\'Enter\'){event.preventDefault();confirmAddEvalItemFile(\'' + esc(evalId) + '\',\'' + esc(item.id) + '\');}">' +
          '<button type="button" class="mv-confirm-btn" onclick="event.stopPropagation();confirmAddEvalItemFile(\'' + esc(evalId) + '\',\'' + esc(item.id) + '\')" title="Add file">' +
            '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>' +
          '</button>' +
        '</div>' +
      '</div>' +
    '</div>';
  }

  html += '</div>';
  return html;
}

function buildProgressRingSvg_(pct) {
  var r = 24, cx = 28, cy = 28, stroke = 4;
  var circumference = 2 * Math.PI * r;
  var offset = circumference - (pct / 100) * circumference;
  var fillColor = pct >= 100 ? '#1B5E20' : 'var(--md-primary)';
  return '<svg class="eval-progress-ring" width="56" height="56" viewBox="0 0 56 56">' +
    '<circle cx="' + cx + '" cy="' + cy + '" r="' + r + '" fill="none" stroke="var(--md-surface-container-high)" stroke-width="' + stroke + '"/>' +
    '<circle class="eval-progress-ring-fill" cx="' + cx + '" cy="' + cy + '" r="' + r + '" fill="none" stroke="' + fillColor + '" stroke-width="' + stroke + '" ' +
      'stroke-linecap="round" stroke-dasharray="' + circumference.toFixed(2) + '" stroke-dashoffset="' + offset.toFixed(2) + '" ' +
      'transform="rotate(-90 ' + cx + ' ' + cy + ')" style="transition: stroke-dashoffset var(--md-duration-medium2) var(--md-easing-emphasized-decelerate), stroke var(--md-duration-medium1) var(--md-easing-standard)"/>' +
    '<text x="' + cx + '" y="' + cy + '" text-anchor="middle" dominant-baseline="central" class="eval-progress-ring-text">' + pct + '%</text>' +
  '</svg>';
}

function renderEvalChecklist(evaluation) {
  _evalItemFilter = 'all'; // reset filter on full render
  var container = document.getElementById('eval-checklist-content');
  var items = evaluation.items || [];
  var done = items.filter(function(it) { return it.checked; }).length;
  var total = items.length;
  var pct = total > 0 ? Math.round(done / total * 100) : 0;

  var overdueCount = items.filter(function(it) {
    return isEvalItemOverdue_(it);
  }).length;

  var html = '';

  // Two-column layout: checklist (3/4) + files (1/4)
  html += '<div class="eval-checklist-layout">';
  html += '<div class="eval-checklist-main">';

  // Summary card with circular progress ring
  html += '<div class="eval-summary-card">';
  html += '<div class="eval-summary-top">';
  html += '<div class="eval-summary-left">' +
    '<div class="eval-summary-type">' + buildEvalTypeDropdown_(evaluation.id, evaluation.type) + '</div>' +
    '<div class="eval-summary-progress" id="eval-summary-progress">' + done + ' of ' + total + ' tasks completed' +
      (overdueCount > 0 ? ' <span class="eval-overdue-count" id="eval-overdue-count">' + overdueCount + ' overdue</span>' : '<span class="eval-overdue-count" id="eval-overdue-count" style="display:none"></span>') +
    '</div>' +
  '</div>';
  html += '<div class="eval-summary-right" id="eval-summary-right">' +
    buildProgressRingSvg_(pct) +
  '</div>';
  html += '</div>'; // end .eval-summary-top
  html += '<div class="eval-progress-bar" role="progressbar" aria-valuenow="' + pct + '" aria-valuemin="0" aria-valuemax="100" aria-label="Evaluation progress"><div class="eval-progress-fill" id="eval-progress-fill" style="width:' + pct + '%"></div></div>';
  var meetingVal = evaluation.meetingDate || '';
  html += '<div class="eval-summary-footer">' +
    '<span id="eval-autosave-status"></span>' +
    '<div class="eval-meeting-date-row">' +
      '<label class="eval-meeting-date-label" for="eval-meeting-date-input">Meeting date:</label>' +
      '<input type="date" id="eval-meeting-date-input" class="eval-meeting-date-input" value="' + esc(meetingVal) + '" onchange="saveEvalMeetingDate(this.value)">' +
    '</div>' +
  '</div>';
  html += '</div>'; // end .eval-summary-card

  // Filter chips
  html += buildEvalFilterChips_(items);

  // Column headers + items (split incomplete/completed, sorted)
  var incompleteItems = sortEvalItems_(items.filter(function(it) { return !it.checked; }));
  var completedItems = items.filter(function(it) { return it.checked; });

  html += '<div class="eval-items-card">';
  html += '<div id="eval-items-list">';
  html += '<div class="eval-items-header">' +
    '<span>Task</span>' +
    '<span>Due Date</span>' +
    '<span>Completed</span>' +
    '<span>Actions</span>' +
  '</div>';

  if (incompleteItems.length === 0 && completedItems.length > 0) {
    html += '<div class="eval-all-complete">' +
      '<div class="eval-all-complete-icon">&#x2705;</div>' +
      '<div class="eval-all-complete-text">All tasks completed!</div>' +
    '</div>';
  }

  incompleteItems.forEach(function(item) {
    html += buildEvalItemRow(evaluation.id, item);
  });

  if (completedItems.length > 0 && incompleteItems.length > 0) {
    var defaultCollapsed = (completedItems.length / total) > 0.5;
    html += '<div class="eval-completed-divider" role="button" tabindex="0" onclick="toggleCompletedSection()" onkeydown="if(event.key===\'Enter\')toggleCompletedSection()" aria-expanded="' + (!defaultCollapsed) + '" aria-controls="eval-completed-items" id="eval-completed-divider">' +
      '<svg class="eval-completed-divider-icon' + (defaultCollapsed ? ' collapsed' : '') + '" id="eval-completed-chevron" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>' +
      '<span class="eval-completed-divider-text">' + completedItems.length + ' completed</span>' +
    '</div>';
    html += '<div class="eval-completed-items' + (defaultCollapsed ? ' collapsed' : '') + '" id="eval-completed-items">';
  }

  completedItems.forEach(function(item) {
    html += buildEvalItemRow(evaluation.id, item);
  });

  if (completedItems.length > 0 && incompleteItems.length > 0) {
    html += '</div>'; // end .eval-completed-items
  }
  html += '</div>'; // end #eval-items-list

  // Add Task (inside the items card)
  html += '<div class="eval-add-task-row" id="eval-add-task-row">' +
    '<button class="btn btn-ghost btn-sm" onclick="showAddEvalTaskForm(\'' + esc(evaluation.id) + '\')">' +
      '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right:4px"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>' +
      'Add Task' +
    '</button>' +
  '</div>';
  html += '<div class="eval-add-task-form" id="eval-add-task-form" style="display:none;">' +
    '<input type="text" class="eval-add-task-input" id="eval-add-task-input" placeholder="Task description..." onkeydown="if(event.key===\'Enter\'){event.preventDefault();confirmAddEvalTask(\'' + esc(evaluation.id) + '\');}">' +
    '<input type="date" class="eval-add-task-due" id="eval-add-task-due" title="Due date (optional)">' +
    '<button class="btn btn-primary btn-sm" onclick="confirmAddEvalTask(\'' + esc(evaluation.id) + '\')">Add</button>' +
    '<button class="btn btn-ghost btn-sm" onclick="hideAddEvalTaskForm()">Cancel</button>' +
  '</div>';

  html += '</div>'; // end .eval-items-card

  html += '</div>'; // end .eval-checklist-main

  // Right column: files sidebar
  html += '<div class="eval-checklist-sidebar" id="eval-files-card"></div>';
  html += '</div>'; // end .eval-checklist-layout

  container.innerHTML = html;
  renderEvalFilesCard(evaluation);
  animateContentIn(container);
}

function toggleEvalItem(evalId, itemId, checked) {
  // Update local state
  if (appState.currentEvaluation && appState.currentEvaluation.items) {
    appState.currentEvaluation.items.forEach(function(it) {
      if (it.id === itemId) {
        it.checked = checked;
        it.completedAt = checked ? new Date().toISOString() : null;
      }
    });
  }

  // Update progress ring and counts immediately
  updateEvalProgress();
  scheduleEvalAutosave();

  if (checked) {
    // Animated completion: highlight → collapse → rebuild
    var row = document.querySelector('.eval-item[data-item-id="' + itemId + '"]');
    if (row) {
      // Phase 1: green highlight + strikethrough
      row.style.maxHeight = row.offsetHeight + 'px';
      row.classList.add('eval-item-completing');

      setTimeout(function() {
        // Phase 2: collapse the row
        row.classList.add('eval-item-collapsing');
        var rebuilt = false;
        var doRebuild = function() {
          if (rebuilt) return;
          rebuilt = true;
          rebuildEvalItemsCard(evalId);
        };
        row.addEventListener('transitionend', doRebuild, { once: true });
        setTimeout(doRebuild, 350); // fallback
      }, 500);
    } else {
      rebuildEvalItemsCard(evalId);
    }

    // Show undo toast
    var capturedEvalId = evalId;
    var capturedItemId = itemId;
    showToast('Task marked complete', 'Undo', function() {
      toggleEvalItem(capturedEvalId, capturedItemId, false);
    });
  } else {
    // Unchecking (undo) — instant rebuild
    rebuildEvalItemsCard(evalId);
  }
}

function updateEvalProgress() {
  var items = appState.currentEvaluation ? appState.currentEvaluation.items : [];
  var done = items.filter(function(it) { return it.checked; }).length;
  var total = items.length;
  var pct = total > 0 ? Math.round(done / total * 100) : 0;

  var progressEl = document.getElementById('eval-summary-progress');
  if (progressEl) {
    var text = done + ' of ' + total + ' tasks completed';
    var overdueEl = document.getElementById('eval-overdue-count');
    if (overdueEl) {
      progressEl.textContent = text + ' ';
      progressEl.appendChild(overdueEl);
    } else {
      progressEl.textContent = text;
    }
  }

  var fillEl = document.getElementById('eval-progress-fill');
  if (fillEl) fillEl.style.width = pct + '%';

  // Update progress ring
  var ringRight = document.getElementById('eval-summary-right');
  if (ringRight) ringRight.innerHTML = buildProgressRingSvg_(pct);

  // Update progress bar ARIA
  var barEl = document.querySelector('.eval-progress-bar');
  if (barEl) barEl.setAttribute('aria-valuenow', pct);

  // Update overdue count
  var overdueCount = items.filter(function(it) {
    return isEvalItemOverdue_(it);
  }).length;

  var overdueCountEl = document.getElementById('eval-overdue-count');
  if (overdueCountEl) {
    if (overdueCount > 0) {
      overdueCountEl.textContent = overdueCount + ' overdue';
      overdueCountEl.style.display = '';
    } else {
      overdueCountEl.style.display = 'none';
    }
  }
}

function confirmDeleteEvaluation(evalId) {
  showConfirmDialog({
    title: 'Delete Checklist?',
    body: 'This will permanently delete this evaluation checklist and all its progress.',
    confirmLabel: 'Delete',
    onConfirm: "doDeleteEvaluation('" + esc(evalId) + "')"
  });
}

function doDeleteEvaluation(evalId) {
  resetEvalAutosave();
  showToast('Deleting checklist\u2026');
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showToast('Checklist deleted');
        appState.currentEvaluation = null;
        showStudentProfile(appState.evalChecklistStudentId);
      } else {
        showToast('Error deleting checklist');
      }
    })
    .withFailureHandler(function(err) {
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
    })
    .deleteEvaluation(evalId);
}

function goBackFromEvalChecklist() {
  if (appState.editingEvalItemId) exitEvalEditMode();
  resetEvalAutosave();
  showStudentProfile(appState.evalChecklistStudentId);
}

function updateEvalType(evalId, newType) {
  if (!appState.currentEvaluation) return;
  appState.currentEvaluation.type = newType;
  updateEvalBreadcrumb_(getEvalTypeLabel(newType));
  google.script.run
    .withSuccessHandler(function(result) {
      if (!result.success) showToast(result.error || 'Error updating type');
    })
    .withFailureHandler(function(err) {
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
    })
    .updateEvaluationType(evalId, newType);
}

// ─── Collapsible Eval Section (profile) ───

function toggleEvalSectionCollapse() {
  var body = document.getElementById('profile-eval-section-body');
  var btn = document.getElementById('eval-collapse-btn');
  if (!body) return;
  var isCollapsed = body.classList.toggle('collapsed');
  if (btn) btn.classList.toggle('rotated', isCollapsed);
}

// ─── Completed Items Section ───

function toggleCompletedSection() {
  var items = document.getElementById('eval-completed-items');
  var chevron = document.getElementById('eval-completed-chevron');
  var divider = document.getElementById('eval-completed-divider');
  if (!items) return;
  var isCollapsed = items.classList.toggle('collapsed');
  if (chevron) chevron.classList.toggle('collapsed');
  if (divider) divider.setAttribute('aria-expanded', String(!isCollapsed));
}

function rebuildEvalItemsCard(evalId) {
  var eval_ = appState.currentEvaluation;
  if (!eval_ || !eval_.items) return;
  var listEl = document.getElementById('eval-items-list');
  if (!listEl) return;

  var allItems = eval_.items;
  var filtered = applyEvalFilter_(allItems, _evalItemFilter);
  var incompleteItems = sortEvalItems_(filtered.filter(function(it) { return !it.checked; }));
  var completedItems = filtered.filter(function(it) { return it.checked; });

  // Update filter chips
  var filterBar = document.querySelector('.eval-filter-bar');
  if (filterBar) filterBar.outerHTML = buildEvalFilterChips_(allItems);

  var html = '<div class="eval-items-header">' +
    '<span>Task</span><span>Due Date</span><span>Completed</span><span>Actions</span>' +
  '</div>';

  // In filtered modes, show all items inline (no incomplete/completed split)
  if (_evalItemFilter !== 'all') {
    var displayItems = sortEvalItems_(filtered);
    if (displayItems.length === 0) {
      html += '<div class="eval-all-complete">' +
        '<div class="eval-all-complete-text" style="padding:24px">No ' + _evalItemFilter + ' tasks</div>' +
      '</div>';
    }
    displayItems.forEach(function(item) {
      html += buildEvalItemRow(evalId, item);
    });
    listEl.innerHTML = html;
    return;
  }

  if (incompleteItems.length === 0 && completedItems.length > 0) {
    html += '<div class="eval-all-complete">' +
      '<div class="eval-all-complete-icon">&#x2705;</div>' +
      '<div class="eval-all-complete-text">All tasks completed!</div>' +
    '</div>';
  }

  incompleteItems.forEach(function(item) {
    html += buildEvalItemRow(evalId, item);
  });

  if (completedItems.length > 0 && incompleteItems.length > 0) {
    var wasCollapsed = false;
    var prevEl = document.getElementById('eval-completed-items');
    if (prevEl) wasCollapsed = prevEl.classList.contains('collapsed');

    html += '<div class="eval-completed-divider" role="button" tabindex="0" onclick="toggleCompletedSection()" onkeydown="if(event.key===\'Enter\')toggleCompletedSection()" aria-expanded="' + (!wasCollapsed) + '" aria-controls="eval-completed-items" id="eval-completed-divider">' +
      '<svg class="eval-completed-divider-icon' + (wasCollapsed ? ' collapsed' : '') + '" id="eval-completed-chevron" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>' +
      '<span class="eval-completed-divider-text">' + completedItems.length + ' completed</span>' +
    '</div>';
    html += '<div class="eval-completed-items' + (wasCollapsed ? ' collapsed' : '') + '" id="eval-completed-items">';
  }

  completedItems.forEach(function(item) {
    html += buildEvalItemRow(evalId, item);
  });

  if (completedItems.length > 0 && incompleteItems.length > 0) {
    html += '</div>';
  }

  listEl.innerHTML = html;
}

// ─── Eval Edit Mode ───

function enterEvalEditMode(itemId) {
  if (appState.editingEvalItemId) {
    saveEvalEditModeChanges(appState.editingEvalItemId);
    var prevId = appState.editingEvalItemId;
    appState.editingEvalItemId = null;
    rerenderEvalItem(prevId);
  }
  appState.editingEvalItemId = itemId;
  rerenderEvalItem(itemId);
  var textInput = document.getElementById('eval-edit-text-' + itemId);
  if (textInput) { textInput.focus(); textInput.select(); }
}

function exitEvalEditMode() {
  var itemId = appState.editingEvalItemId;
  if (!itemId) return;
  saveEvalEditModeChanges(itemId);
  appState.editingEvalItemId = null;
  rerenderEvalItem(itemId);
  updateEvalProgress();
}

function cancelEvalEditMode(itemId) {
  appState.editingEvalItemId = null;
  rerenderEvalItem(itemId);
}

function saveEvalEditModeChanges(itemId) {
  var textInput = document.getElementById('eval-edit-text-' + itemId);
  var dueInput = document.getElementById('eval-edit-due-' + itemId);
  if (!appState.currentEvaluation) return;

  var changed = false;
  appState.currentEvaluation.items.forEach(function(it) {
    if (it.id === itemId) {
      if (textInput) {
        var newText = textInput.value.trim();
        if (newText && newText !== it.text) { it.text = newText; changed = true; }
      }
      if (dueInput) {
        var newDue = dueInput.value || null;
        if (newDue !== it.dueDate) { it.dueDate = newDue; changed = true; }
      }
    }
  });

  if (changed) scheduleEvalAutosave();
}

function rerenderEvalItem(itemId) {
  var el = document.querySelector('.eval-item[data-item-id="' + itemId + '"]');
  if (!el || !appState.currentEvaluation) return;
  var item = null;
  for (var i = 0; i < appState.currentEvaluation.items.length; i++) {
    if (appState.currentEvaluation.items[i].id === itemId) { item = appState.currentEvaluation.items[i]; break; }
  }
  if (!item) { el.remove(); return; }
  el.outerHTML = buildEvalItemRow(appState.currentEvaluation.id, item);
}

// ─── Per-Task File Attachments ───

function toggleEvalItemFiles(itemId) {
  if (_expandedEvalItemFiles[itemId]) {
    delete _expandedEvalItemFiles[itemId];
  } else {
    _expandedEvalItemFiles[itemId] = true;
  }
  rerenderEvalItem(itemId);
}

function showEvalItemAddFileForm(itemId) {
  var btn = document.getElementById('eval-item-add-file-btn-' + itemId);
  var form = document.getElementById('eval-item-add-file-form-' + itemId);
  if (btn) btn.style.display = 'none';
  if (form) form.style.display = '';
  var nameInput = document.getElementById('eval-item-add-file-name-' + itemId);
  if (nameInput) nameInput.focus();
}

function confirmAddEvalItemFile(evalId, itemId) {
  var nameInput = document.getElementById('eval-item-add-file-name-' + itemId);
  var urlInput = document.getElementById('eval-item-add-file-url-' + itemId);
  var name = (nameInput ? nameInput.value : '').trim();
  var url = (urlInput ? urlInput.value : '').trim();

  if (!name) { showToast('Please enter a file name'); if (nameInput) nameInput.focus(); return; }
  if (!url) { showToast('Please enter a URL'); if (urlInput) urlInput.focus(); return; }

  if (!appState.currentEvaluation) return;
  for (var i = 0; i < appState.currentEvaluation.items.length; i++) {
    if (appState.currentEvaluation.items[i].id === itemId) {
      if (!appState.currentEvaluation.items[i].files) appState.currentEvaluation.items[i].files = [];
      appState.currentEvaluation.items[i].files.push({ id: 'file-' + Date.now(), name: name, url: url });
      break;
    }
  }

  _expandedEvalItemFiles[itemId] = true;
  rerenderEvalItem(itemId);
  scheduleEvalAutosave();
  showToast('File added');
}

function removeEvalItemFile(evalId, itemId, fileId) {
  if (!appState.currentEvaluation) return;
  for (var i = 0; i < appState.currentEvaluation.items.length; i++) {
    if (appState.currentEvaluation.items[i].id === itemId) {
      var files = appState.currentEvaluation.items[i].files || [];
      appState.currentEvaluation.items[i].files = files.filter(function(f) { return f.id !== fileId; });
      break;
    }
  }
  rerenderEvalItem(itemId);
  scheduleEvalAutosave();
  showToast('File removed');
}

// ─── Eval Autosave ───

function scheduleEvalAutosave() {
  _evalAutosaveDirty = true;
  updateAutosaveIndicator('unsaved', 'eval-autosave-status');
  if (_evalAutosaveTimer) clearTimeout(_evalAutosaveTimer);
  _evalAutosaveTimer = setTimeout(function() {
    _evalAutosaveTimer = null;
    performEvalAutosave();
  }, 2000);
}

function performEvalAutosave() {
  if (_evalAutosaveInFlight) {
    scheduleEvalAutosave();
    return;
  }
  var eval_ = appState.currentEvaluation;
  if (!eval_ || !eval_.id || !eval_.items) return;

  _evalAutosaveInFlight = true;
  _evalAutosaveDirty = false;
  updateAutosaveIndicator('saving', 'eval-autosave-status');

  google.script.run
    .withSuccessHandler(function(result) {
      _evalAutosaveInFlight = false;
      if (result && result.success) {
        appState.currentEvaluation.items = result.items;
        if (_evalAutosaveDirty) {
          scheduleEvalAutosave();
        } else {
          updateAutosaveIndicator('saved', 'eval-autosave-status');
        }
      } else {
        updateAutosaveIndicator('error', 'eval-autosave-status');
      }
    })
    .withFailureHandler(function() {
      _evalAutosaveInFlight = false;
      updateAutosaveIndicator('error', 'eval-autosave-status');
    })
    .saveEvaluationItems(eval_.id, eval_.items);
}

function resetEvalAutosave() {
  _evalAutosaveDirty = false;
  _evalAutosaveInFlight = false;
  if (_evalAutosaveTimer) { clearTimeout(_evalAutosaveTimer); _evalAutosaveTimer = null; }
}

// ─── Eval Item CRUD (local state + autosave) ───

function deleteEvalItemHandler(evalId, itemId) {
  showConfirmDialog({
    title: 'Delete Task?',
    body: 'This task will be permanently removed from the checklist.',
    confirmLabel: 'Delete',
    onConfirm: "doDeleteEvalItem('" + esc(evalId) + "', '" + esc(itemId) + "')"
  });
}

function doDeleteEvalItem(evalId, itemId) {
  if (appState.editingEvalItemId === itemId) appState.editingEvalItemId = null;

  // Update local state
  if (appState.currentEvaluation) {
    appState.currentEvaluation.items = appState.currentEvaluation.items.filter(function(it) { return it.id !== itemId; });
  }

  // Rebuild items card to update completed divider count
  rebuildEvalItemsCard(evalId);
  updateEvalProgress();
  scheduleEvalAutosave();
}

// ─── Add Task Form ───

function showAddEvalTaskForm(evalId) {
  var row = document.getElementById('eval-add-task-row');
  if (row) row.style.display = 'none';
  var form = document.getElementById('eval-add-task-form');
  if (form) form.style.display = '';
  var input = document.getElementById('eval-add-task-input');
  if (input) { input.value = ''; input.focus(); }
  var due = document.getElementById('eval-add-task-due');
  if (due) due.value = '';
}

function hideAddEvalTaskForm() {
  var form = document.getElementById('eval-add-task-form');
  if (form) form.style.display = 'none';
  var row = document.getElementById('eval-add-task-row');
  if (row) row.style.display = '';
}

function confirmAddEvalTask(evalId) {
  var textInput = document.getElementById('eval-add-task-input');
  var dueInput = document.getElementById('eval-add-task-due');
  var text = (textInput ? textInput.value : '').trim();
  if (!text) { showToast('Please enter a task description'); return; }
  var dueDate = dueInput ? dueInput.value : '';

  var newItem = {
    id: 'item-custom-' + Date.now(),
    text: text,
    checked: false,
    completedAt: null,
    dueDate: dueDate || null
  };

  // Add to local state
  if (appState.currentEvaluation) {
    appState.currentEvaluation.items.push(newItem);
  }

  // Rebuild items card to show new item in correct section
  rebuildEvalItemsCard(evalId);
  updateEvalProgress();
  hideAddEvalTaskForm();
  scheduleEvalAutosave();
  showToast('Task added');
}

// ─── Google Drive File Picker ───

function getFileTypeIcon(mimeType) {
  var iconColor = 'var(--md-on-surface-variant)';
  var iconPath = 'M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z';

  if (!mimeType) {
    // generic file icon
  } else if (mimeType.indexOf('document') !== -1 || mimeType.indexOf('msword') !== -1) {
    iconColor = '#4285F4'; // Google Docs blue
    iconPath = 'M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z';
  } else if (mimeType.indexOf('spreadsheet') !== -1 || mimeType.indexOf('excel') !== -1) {
    iconColor = '#0F9D58'; // Google Sheets green
    iconPath = 'M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm-1 7V3.5L18.5 9H13zM7 13h3v2H7v-2zm0 4h3v2H7v-2zm10 2h-3v-2h3v2zm0-4h-3v-2h3v2z';
  } else if (mimeType.indexOf('presentation') !== -1 || mimeType.indexOf('powerpoint') !== -1) {
    iconColor = '#F4B400'; // Google Slides yellow
    iconPath = 'M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm-1 7V3.5L18.5 9H13zM8 15h8v2H8v-2zm0-4h8v2H8v-2z';
  } else if (mimeType.indexOf('pdf') !== -1) {
    iconColor = '#DB4437'; // PDF red
    iconPath = 'M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm-1 7V3.5L18.5 9H13zM11 19h-1v-2h1c.55 0 1-.45 1-1s-.45-1-1-1h-1v-2h1c1.66 0 3 1.34 3 3s-1.34 3-3 3z';
  } else if (mimeType.indexOf('image') !== -1) {
    iconColor = '#AB47BC'; // Image purple
    iconPath = 'M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z';
  } else if (mimeType.indexOf('folder') !== -1) {
    iconColor = '#5F6368'; // Folder gray
    iconPath = 'M10 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z';
  }

  return '<svg width="20" height="20" viewBox="0 0 24 24" fill="' + iconColor + '"><path d="' + iconPath + '"/></svg>';
}

function renderEvalFilesCard(evaluation) {
  var container = document.getElementById('eval-files-card');
  if (!container) return;

  var files = evaluation.files || [];
  var html = '<div class="eval-files-header">' +
    '<span class="eval-files-title">Files</span>' +
    '<button class="btn btn-ghost btn-sm" onclick="openDrivePicker(\'' + esc(evaluation.id) + '\')" title="Add file from Drive">' +
      '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right:4px"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 14h-3v3h-2v-3H8v-2h3v-3h2v3h3v2zm-3-7V3.5L18.5 9H13z"/></svg>' +
      'Add' +
    '</button>' +
  '</div>';

  if (files.length === 0) {
    html += '<div class="eval-files-empty">' +
      '<svg class="eval-files-empty-icon" width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><path d="M10 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>' +
      '<span>No files attached yet</span>' +
    '</div>';
  } else {
    html += '<div class="eval-files-list">';
    files.forEach(function(file) {
      html += '<div class="eval-file-item">' +
        '<a href="' + esc(file.url) + '" target="_blank" class="eval-file-link" title="Open ' + esc(file.name) + '">' +
          '<span class="eval-file-icon">' + getFileTypeIcon(file.mimeType) + '</span>' +
          '<span class="eval-file-name">' + esc(file.name) + '</span>' +
        '</a>' +
        '<button class="btn-icon btn-sm eval-file-remove" onclick="removeEvalFileHandler(\'' + esc(evaluation.id) + '\', \'' + esc(file.id) + '\')" title="Remove file">' +
          '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>' +
        '</button>' +
      '</div>';
    });
    html += '</div>';
  }

  // Add file by URL fallback section
  html += '<div class="eval-files-url-section">' +
    '<button class="btn btn-ghost btn-sm" onclick="toggleEvalFileUrlForm(\'' + esc(evaluation.id) + '\')" style="width:100%;justify-content:center;">' +
      '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg>' +
      ' Add by URL' +
    '</button>' +
    '<div class="eval-file-url-form" id="eval-file-url-form" style="display:none;">' +
      '<input type="text" class="eval-file-url-input" id="eval-file-url-input" placeholder="Paste Google Drive URL..." onkeydown="if(event.key===\'Enter\'){event.preventDefault();confirmAddEvalFileByUrl(\'' + esc(evaluation.id) + '\');}">' +
      '<input type="text" class="eval-file-name-input" id="eval-file-name-input" placeholder="File name...">' +
      '<button class="btn btn-primary btn-sm" onclick="confirmAddEvalFileByUrl(\'' + esc(evaluation.id) + '\')">Add</button>' +
    '</div>' +
  '</div>';

  // Delete checklist (subtle placement in sidebar)
  html += '<div class="eval-sidebar-delete">' +
    '<button class="btn btn-ghost btn-sm" onclick="confirmDeleteEvaluation(\'' + esc(evaluation.id) + '\')">' +
      '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="margin-right:4px"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>' +
      'Delete Checklist' +
    '</button>' +
  '</div>';

  container.innerHTML = html;
}

function toggleEvalFileUrlForm(evalId) {
  var form = document.getElementById('eval-file-url-form');
  if (!form) return;
  var isHidden = form.style.display === 'none';
  form.style.display = isHidden ? '' : 'none';
  if (isHidden) {
    var urlInput = document.getElementById('eval-file-url-input');
    if (urlInput) { urlInput.value = ''; urlInput.focus(); }
    var nameInput = document.getElementById('eval-file-name-input');
    if (nameInput) nameInput.value = '';
  }
}

function confirmAddEvalFileByUrl(evalId) {
  var urlInput = document.getElementById('eval-file-url-input');
  var nameInput = document.getElementById('eval-file-name-input');
  var url = (urlInput ? urlInput.value : '').trim();
  var name = (nameInput ? nameInput.value : '').trim();

  if (!url) { showToast('Please enter a file URL'); return; }
  if (!name) {
    // Try to extract name from URL
    try {
      var parts = url.split('/');
      name = decodeURIComponent(parts[parts.length - 1] || parts[parts.length - 2] || 'Linked File');
    } catch(e) { name = 'Linked File'; }
  }

  // Try to extract Drive file ID from URL
  var driveFileId = '';
  var match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
  if (match) driveFileId = match[1];

  // Guess MIME type from URL
  var mimeType = '';
  if (url.indexOf('document') !== -1) mimeType = 'application/vnd.google-apps.document';
  else if (url.indexOf('spreadsheets') !== -1) mimeType = 'application/vnd.google-apps.spreadsheet';
  else if (url.indexOf('presentation') !== -1) mimeType = 'application/vnd.google-apps.presentation';
  else if (url.indexOf('.pdf') !== -1) mimeType = 'application/pdf';

  var fileData = {
    driveFileId: driveFileId,
    name: name,
    mimeType: mimeType,
    url: url
  };

  addEvalFileHandler(evalId, fileData);

  // Hide form
  var form = document.getElementById('eval-file-url-form');
  if (form) form.style.display = 'none';
}

function openDrivePicker(evalId) {
  showDriveFileBrowser_(evalId);
}

function showDriveFileBrowser_(evalId) {
  // Remove existing modal if present
  var existing = document.getElementById('drive-browser-overlay');
  if (existing) existing.remove();

  var overlay = document.createElement('div');
  overlay.id = 'drive-browser-overlay';
  overlay.className = 'confirm-overlay';
  overlay.onclick = function(e) { if (e.target === overlay) closeDriveFileBrowser_(); };

  var modal = document.createElement('div');
  modal.className = 'confirm-dialog drive-browser-dialog';
  modal.onclick = function(e) { e.stopPropagation(); };

  modal.innerHTML =
    '<div class="drive-browser-header">' +
      '<h3 class="drive-browser-title">Add file from Drive</h3>' +
      '<button class="btn-icon btn-sm" onclick="closeDriveFileBrowser_()" aria-label="Close">' +
        '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>' +
      '</button>' +
    '</div>' +
    '<div class="drive-browser-search">' +
      '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" class="drive-browser-search-icon"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>' +
      '<input type="text" id="drive-browser-search-input" class="drive-browser-search-input" placeholder="Search your Drive files..." autofocus>' +
    '</div>' +
    '<div id="drive-browser-results" class="drive-browser-results">' +
      '<div class="drive-browser-loading">Searching your Drive...</div>' +
    '</div>';

  overlay.appendChild(modal);
  document.body.appendChild(overlay);

  // Store evalId for selection handler
  overlay.dataset.evalId = evalId;

  // Load initial results (recent files)
  performDriveSearch_('');

  // Wire up search input with debounce
  var searchInput = document.getElementById('drive-browser-search-input');
  var searchTimer = null;
  if (searchInput) {
    searchInput.addEventListener('input', function() {
      clearTimeout(searchTimer);
      var q = searchInput.value;
      searchTimer = setTimeout(function() { performDriveSearch_(q); }, 400);
    });
    searchInput.focus();
  }
}

function performDriveSearch_(query) {
  var resultsEl = document.getElementById('drive-browser-results');
  if (!resultsEl) return;
  resultsEl.innerHTML = '<div class="drive-browser-loading">Searching...</div>';

  google.script.run
    .withSuccessHandler(function(files) {
      renderDriveSearchResults_(files || []);
    })
    .withFailureHandler(function(err) {
      if (resultsEl) {
        resultsEl.innerHTML = '<div class="drive-browser-empty">Error searching Drive: ' + esc(err && err.message ? err.message : String(err)) + '</div>';
      }
    })
    .searchDriveFiles(query);
}

// Holds search results for safe selection by index
var _driveSearchResults = [];

function renderDriveSearchResults_(files) {
  var resultsEl = document.getElementById('drive-browser-results');
  if (!resultsEl) return;

  _driveSearchResults = files;

  if (files.length === 0) {
    resultsEl.innerHTML = '<div class="drive-browser-empty">No files found</div>';
    return;
  }

  var html = '';
  files.forEach(function(file, idx) {
    html += '<button class="drive-browser-item" data-idx="' + idx + '">' +
      '<span class="drive-browser-item-icon">' + getFileTypeIcon(file.mimeType) + '</span>' +
      '<span class="drive-browser-item-name">' + esc(file.name) + '</span>' +
    '</button>';
  });
  resultsEl.innerHTML = html;

  // Delegated click handler — avoids inline onclick escaping issues
  resultsEl.onclick = function(e) {
    var btn = e.target.closest('.drive-browser-item');
    if (!btn) return;
    var idx = parseInt(btn.dataset.idx, 10);
    var file = _driveSearchResults[idx];
    if (!file) return;
    selectDriveFile_(file);
  };
}

function selectDriveFile_(file) {
  var overlay = document.getElementById('drive-browser-overlay');
  var evalId = overlay ? overlay.dataset.evalId : '';
  if (!evalId) return;

  var fileData = {
    driveFileId: file.id,
    name: file.name,
    mimeType: file.mimeType,
    url: file.url
  };

  closeDriveFileBrowser_();
  addEvalFileHandler(evalId, fileData);
}

function closeDriveFileBrowser_() {
  var overlay = document.getElementById('drive-browser-overlay');
  if (overlay) closeConfirmDialog(overlay);
}

function addEvalFileHandler(evalId, fileData) {
  // Optimistic UI: add to local state and re-render files card
  var tempFile = {
    id: 'temp-' + Date.now(),
    driveFileId: fileData.driveFileId || '',
    name: fileData.name,
    mimeType: fileData.mimeType || '',
    url: fileData.url,
    addedAt: new Date().toISOString()
  };

  if (appState.currentEvaluation) {
    if (!appState.currentEvaluation.files) appState.currentEvaluation.files = [];
    appState.currentEvaluation.files.push(tempFile);
    renderEvalFilesCard(appState.currentEvaluation);
  }

  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        appState.currentEvaluation.files = result.files;
        renderEvalFilesCard(appState.currentEvaluation);
        showToast('File added');
      } else {
        showToast('Error adding file: ' + (result.error || 'Unknown'));
        // Rollback optimistic UI
        if (appState.currentEvaluation) {
          appState.currentEvaluation.files = (appState.currentEvaluation.files || []).filter(function(f) {
            return f.id !== tempFile.id;
          });
          renderEvalFilesCard(appState.currentEvaluation);
        }
      }
    })
    .withFailureHandler(function(err) {
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
    })
    .addEvalFile(evalId, fileData);
}

function removeEvalFileHandler(evalId, fileId) {
  showConfirmDialog({
    title: 'Remove File?',
    body: 'This file reference will be removed from the checklist.',
    confirmLabel: 'Remove',
    onConfirm: "doRemoveEvalFile('" + esc(evalId) + "', '" + esc(fileId) + "')"
  });
}

function doRemoveEvalFile(evalId, fileId) {
  // Save original files for rollback
  var originalFiles = appState.currentEvaluation
    ? (appState.currentEvaluation.files || []).slice()
    : [];

  // Optimistic removal
  if (appState.currentEvaluation) {
    appState.currentEvaluation.files = originalFiles.filter(function(f) { return f.id !== fileId; });
    renderEvalFilesCard(appState.currentEvaluation);
  }

  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showToast('File removed');
      } else {
        showToast('Error removing file: ' + (result.error || 'Unknown'));
        if (appState.currentEvaluation) {
          appState.currentEvaluation.files = originalFiles;
          renderEvalFilesCard(appState.currentEvaluation);
        }
      }
    })
    .withFailureHandler(function(err) {
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
      if (appState.currentEvaluation) {
        appState.currentEvaluation.files = originalFiles;
        renderEvalFilesCard(appState.currentEvaluation);
      }
    })
    .removeEvalFile(evalId, fileId);
}

// ─── Button Ripple Effect (delegated) ───
function createRipple(target, clientX, clientY) {
  var rect = target.getBoundingClientRect();
  var ripple = document.createElement('span');
  ripple.className = 'ripple-effect';
  var size = Math.max(rect.width, rect.height);
  ripple.style.width = ripple.style.height = size + 'px';
  ripple.style.left = (clientX - rect.left - size / 2) + 'px';
  ripple.style.top = (clientY - rect.top - size / 2) + 'px';
  target.appendChild(ripple);
  ripple.addEventListener('animationend', function() { ripple.remove(); });
}
document.addEventListener('click', function(e) {
  var btn = e.target.closest('.btn, .btn-icon, .btn-ghost, .action-btn, .rating-btn, .nav-drawer-item, .header-search-result-item, .dp-fab, .ccm-type-chip');
  if (btn) createRipple(btn, e.clientX, e.clientY);
});
</script>
