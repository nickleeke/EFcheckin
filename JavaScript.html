<script>
/* ============================================================
   Caseload Dashboard — Client-Side JavaScript
   v3 — multi-user with onboarding
   ============================================================ */

// ─── Application State ───
var appState = {
  dashboardData: [],
  currentStudentId: null,
  currentCheckIns: [],
  editingCheckIn: null,
  sortField: 'name',
  sortAsc: true,
  missingViewStudentId: null,
  feedbackLinks: null,
  currentUserEmail: '',
  caseManagers: [],
  isSuperuser: false
};
var _persistTimers = {};
var _persistInFlight = 0;
var _ciAutosaveTimer = null;
var _ciAutosaveInFlight = false;
var _ciAutosaveDirty = false;
var _goalsAutosaveTimer = null;
var _goalsAutosaveInFlight = false;
var _goalsAutosaveDirty = false;

var onboardingState = {
  step: 1,
  email: '',
  spreadsheetUrl: null
};

var GPA_MAP = {
  'A':4.0, 'A-':3.7, 'B+':3.3, 'B':3.0, 'B-':2.7,
  'C+':2.3, 'C':2.0, 'C-':1.7, 'D+':1.3, 'D':1.0, 'D-':0.7, 'F':0.0
};

// ─── Preloaded Options ───
var PRELOADED_CLASSES = [
  'Academic Skills', 'Art', 'Band', 'Choir', 'ELA',
  'FACS', 'Global Studies', 'History', 'Lit Lab', 'Math',
  'Numbers Lab', 'PE', 'Photography', 'Reading Tier',
  'Science', 'STEAM', 'Woodshop'
];

// ─── Initialization ───
var _authLoadingTimer = null;

function showAuthError(message) {
  if (_authLoadingTimer) { clearTimeout(_authLoadingTimer); _authLoadingTimer = null; }
  document.getElementById('auth-loading').innerHTML =
    '<div class="empty-state">' +
      '<h3>Unable to Load</h3>' +
      '<p>' + esc(message) + '</p>' +
      '<button class="btn btn-primary" style="margin-top:16px;" onclick="location.reload()">Reload</button>' +
    '</div>';
}

document.addEventListener('DOMContentLoaded', function() {
  // Safety timeout: if auth hasn't resolved after 15s, show a retry prompt
  _authLoadingTimer = setTimeout(function() {
    var authEl = document.getElementById('auth-loading');
    if (authEl && authEl.classList.contains('active')) {
      showAuthError('The app is taking too long to load. Please check your connection and try again.');
    }
  }, 15000);

  // Check user auth status before showing anything
  google.script.run
    .withSuccessHandler(function(status) {
      if (_authLoadingTimer) { clearTimeout(_authLoadingTimer); _authLoadingTimer = null; }
      try {
        appState.currentUserEmail = status.email || '';
        appState.isSuperuser = status.isSuperuser || false;

        // Check for pending co-teacher invite
        if (status.pendingInvite) {
          if (status.isNewUser) {
            // New user with invite — show invite acceptance directly
            showInviteModal(status.pendingInvite, true);
          } else {
            // Existing user with invite — enter app, then show invite modal
            enterApp();
            showInviteModal(status.pendingInvite, false);
          }
        } else if (status.isNewUser) {
          showOnboarding(status);
        } else {
          enterApp();
        }
      } catch(e) {
        showAuthError(e.message || 'Unexpected error during startup.');
      }
    })
    .withFailureHandler(function(err) {
      showAuthError(err && err.message ? err.message : String(err));
    })
    .getUserStatus();
});

/** Enter the main app (for returning users or after onboarding). */
function enterApp() {
  document.getElementById('navbar').style.display = '';
  document.getElementById('tab-bar').style.display = '';
  // Load global case managers list
  google.script.run
    .withSuccessHandler(function(cms) {
      appState.caseManagers = cms || [];
      // Show My Caseload tab if current user is a case manager
      var isCM = cms.some(function(cm) {
        return cm.email === (appState.currentUserEmail || '').toLowerCase();
      });
      if (isCM) {
        var myCaseloadTab = document.getElementById('tab-mycaseload');
        if (myCaseloadTab) myCaseloadTab.style.display = '';
      }
      // Show Admin tab if superuser
      if (appState.isSuperuser) {
        var adminTab = document.getElementById('tab-admin');
        if (adminTab) adminTab.style.display = '';
      }
    })
    .withFailureHandler(function() {})
    .getCaseManagers();
  showView('dashboard-view');
  showDashboardSkeleton();

  google.script.run
    .withSuccessHandler(function(result) {
      try {
        appState.feedbackLinks = (result && result.feedbackLinks) || {};
        loadDashboard();
      } catch(e) {
        document.getElementById('dashboard-table-container').innerHTML =
          renderErrorState(e.message || String(e));
      }
    })
    .withFailureHandler(function(err) {
      document.getElementById('dashboard-table-container').innerHTML =
        renderErrorState(err && err.message ? err.message : String(err));
    })
    .initializeSheets();
}

// Close side panel on Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeSidePanel();
    // Also close any confirmation dialogs
    var overlay = document.querySelector('.confirm-overlay');
    if (overlay) closeConfirmDialog(overlay);
  }
});

function closeConfirmDialog(overlayEl) {
  if (!overlayEl || overlayEl.classList.contains('dialog-closing')) return;
  overlayEl.classList.add('dialog-closing');
  var fallback = setTimeout(function() { overlayEl.remove(); }, 300);
  overlayEl.addEventListener('animationend', function() {
    clearTimeout(fallback);
    overlayEl.remove();
  });
}

// ─── View Management ───
var VIEW_ORDER = {
  'auth-loading': -1, 'onboarding-view': -1,
  'dashboard-view': 0, 'coteacher-view': 1,
  'student-view': 2, 'missing-view': 3, 'checkin-view': 4
};
var _currentViewId = 'auth-loading';

function showView(viewId) {
  var oldId = _currentViewId;
  _currentViewId = viewId;

  document.querySelectorAll('.view').forEach(function(v) {
    v.classList.remove('active', 'view-enter-forward', 'view-enter-backward');
  });

  var el = document.getElementById(viewId);
  el.classList.add('active');

  var oldOrder = VIEW_ORDER[oldId] != null ? VIEW_ORDER[oldId] : 0;
  var newOrder = VIEW_ORDER[viewId] != null ? VIEW_ORDER[viewId] : 0;

  if (oldId !== viewId && oldOrder !== -1 && newOrder !== -1) {
    var cls = newOrder >= oldOrder ? 'view-enter-forward' : 'view-enter-backward';
    el.classList.add(cls);
    el.addEventListener('animationend', function handler() {
      el.classList.remove(cls);
      el.removeEventListener('animationend', handler);
    });
  }

  window.scrollTo(0, 0);
}

// ─── Dashboard ───
function showDashboard() {
  switchDashboardTab('caseload');
}

function loadDashboard() {
  // If academic-data persists are pending or in-flight, render from
  // local optimistic state to avoid overwriting unsaved changes.
  if (Object.keys(_persistTimers).length > 0 || _persistInFlight > 0) {
    renderDashboard(appState.dashboardData);
    return;
  }
  showDashboardSkeleton();
  google.script.run
    .withSuccessHandler(function(data) {
      try {
        appState.dashboardData = data || [];
        renderDashboard(data);
      } catch(e) {
        document.getElementById('dashboard-table-container').innerHTML =
          renderErrorState(e.message || String(e));
      }
    })
    .withFailureHandler(function(err) {
      document.getElementById('dashboard-table-container').innerHTML =
        renderErrorState(err && err.message ? err.message : String(err));
    })
    .getDashboardData();
}

function switchDashboardTab(tabName) {
  // Ensure dashboard view is visible (handles clicks from child pages)
  showView('dashboard-view');
  // Deactivate all tabs and panels
  document.querySelectorAll('.nav-tab').forEach(function(t) { t.classList.remove('active'); });
  document.querySelectorAll('.tab-panel').forEach(function(p) { p.classList.remove('active'); });
  // Activate selected
  var tab = document.getElementById('tab-' + tabName);
  var panel = document.getElementById('tab-panel-' + tabName);
  if (tab) tab.classList.add('active');
  if (panel) panel.classList.add('active');
  // Show/hide refresh button and add student button (not relevant for admin)
  var refreshBtn = document.getElementById('dashboard-refresh-btn');
  if (refreshBtn) refreshBtn.style.display = (tabName === 'admin') ? 'none' : '';
  var addStudentBtn = document.getElementById('add-student-btn');
  if (addStudentBtn) addStudentBtn.style.display = (tabName === 'admin') ? 'none' : '';
  // Render tab content
  if (tabName === 'caseload') {
    loadDashboard();
  } else if (tabName === 'mycaseload') {
    renderMyCaseload();
  } else if (tabName === 'admin') {
    loadAdminView();
  }
}

function toggleSort(field) {
  if (appState.sortField === field) {
    appState.sortAsc = !appState.sortAsc;
  } else {
    appState.sortField = field;
    appState.sortAsc = true;
  }
  renderDashboard(appState.dashboardData);
}

function sortIcon(field) {
  var isActive = appState.sortField === field;
  var arrow;
  if (!isActive) {
    // Inactive: up/down unfold arrow
    arrow = '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 5.83L15.17 9l1.41-1.41L12 3 7.41 7.59 8.83 9 12 5.83zm0 12.34L8.83 15l-1.41 1.41L12 21l4.59-4.59L15.17 15 12 18.17z"/></svg>';
  } else if (appState.sortAsc) {
    arrow = '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M7 14l5-5 5 5z"/></svg>';
  } else {
    arrow = '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>';
  }
  var cls = 'btn-icon btn-sort' + (isActive ? ' btn-sort-active' : '');
  return '<button class="' + cls + '" onclick="event.stopPropagation(); toggleSort(\'' + field + '\')" aria-label="Sort by ' + field + '">' + arrow + '</button>';
}

function renderDashboard(data) {
  var container = document.getElementById('dashboard-table-container');

  if (!data || data.length === 0) {
    container.innerHTML =
      '<div class="empty-state">' +
        '<h3>No Students Yet</h3>' +
        '<p>Click "+ Add Student" to get started.</p>' +
      '</div>';
    return;
  }

  // Sort data
  var sorted = data.slice().sort(function(a, b) {
    var cmp = 0;
    if (appState.sortField === 'name') {
      cmp = String(a.firstName).localeCompare(String(b.firstName));
      if (cmp === 0) cmp = String(a.lastName).localeCompare(String(b.lastName));
    } else if (appState.sortField === 'grade') {
      var ag = a.grade || '', bg = b.grade || '';
      // Push empty grades to the bottom regardless of direction
      if (!ag && !bg) cmp = 0;
      else if (!ag) return 1;
      else if (!bg) return -1;
      else cmp = ag.localeCompare(bg);
      if (cmp === 0) cmp = String(a.firstName).localeCompare(String(b.firstName));
    }
    return appState.sortAsc ? cmp : -cmp;
  });

  var html = '<table class="dashboard-table"><thead><tr>' +
    '<th><span class="th-sortable">' + sortIcon('name') + 'Name</span></th>' +
    '<th><span class="th-sortable">' + sortIcon('grade') + 'Grade</span></th>' +
    '<th>EF Avg</th><th>Trend</th><th>GPA</th>' +
    '<th>Missing</th><th>Last Check-In</th><th>Actions</th>' +
    '</tr></thead><tbody>';

  sorted.forEach(function(s, index) {
    var origIndex = data.indexOf(s);
    var delay = Math.min(index * 50, 400);
    html += '<tr class="stagger-row" style="animation-delay:' + delay + 'ms" onclick="openSidePanel(' + origIndex + ')" title="Click for quick view">';
    html += '<td><strong>' + esc(s.firstName + ' ' + s.lastName) + '</strong></td>';
    html += '<td>' + esc(s.grade || '-') + '</td>';

    // EF Average
    if (s.avgRating != null) {
      var efClass = s.avgRating >= 4 ? 'chip-green' : s.avgRating >= 3 ? 'chip-yellow' : 'chip-red';
      html += '<td><span class="chip ' + efClass + '">' + s.avgRating.toFixed(1) + '</span></td>';
    } else {
      html += '<td><span class="chip chip-gray">--</span></td>';
    }

    // Trend
    var trendMap = { up: '&#9650; Up', down: '&#9660; Down', flat: '&#9654; Flat', none: '--' };
    var trendClass = s.trend === 'up' ? 'trend-up' : s.trend === 'down' ? 'trend-down' : 'trend-flat';
    html += '<td><span class="' + trendClass + '">' + (trendMap[s.trend] || '--') + '</span></td>';

    // GPA
    if (s.gpa != null) {
      var gpaClass = s.gpa >= 3.5 ? 'chip-green' : s.gpa >= 2.5 ? 'chip-yellow' : 'chip-red';
      html += '<td><span class="chip ' + gpaClass + '">' + s.gpa.toFixed(2) + '</span></td>';
    } else {
      html += '<td><span class="chip chip-gray">--</span></td>';
    }

    // Missing assignments (clickable badge)
    if (s.totalMissing > 0) {
      var missingClass = s.totalMissing >= 4 ? 'chip-red' : 'chip-yellow';
      html += '<td><span class="chip chip-clickable ' + missingClass + '" onclick="event.stopPropagation(); showMissingAssignments(\'' + s.id + '\')" title="View missing assignments">' + s.totalMissing + '</span></td>';
    } else {
      html += '<td><span class="chip chip-clickable chip-green" onclick="event.stopPropagation(); showMissingAssignments(\'' + s.id + '\')" title="View missing assignments">0</span></td>';
    }

    // Last check-in date
    html += '<td>' + esc(formatDateDisplay(s.latestWeek)) + '</td>';

    // Action buttons (icon-only)
    html += '<td><div class="action-btns">' +
      '<button class="action-btn primary" onclick="event.stopPropagation(); startCheckIn(\'' + s.id + '\')" title="Check-In">' +
        '<svg class="action-btn-icon" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>' +
      '</button>' +
      '<button class="action-btn" onclick="event.stopPropagation(); showStudentProfile(\'' + s.id + '\')" title="Student Profile">' +
        '<svg class="action-btn-icon" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>' +
      '</button>' +
      '</div></td>';

    html += '</tr>';
  });

  html += '</tbody></table>';
  html += '<p class="hint" style="margin-top:8px;">Click any row for a quick academic overview.</p>';

  container.innerHTML = html;
  animateContentIn(container);
}

// ─── Side Panel (Quick View on Double-Click) ───
function openSidePanel(index) {
  var s = appState.dashboardData[index];
  if (!s) return;

  document.getElementById('side-panel-title').textContent = s.firstName + ' ' + s.lastName;

  var content = '';

  // Student info subtitle
  if (s.grade) {
    content += '<div class="sp-subtitle" style="margin-bottom:16px;">Grade ' + esc(s.grade) + '</div>';
  }

  // Case manager
  var cmEmail = s.caseManagerEmail || '';
  if (cmEmail) {
    var cmName = getCaseManagerName(cmEmail);
    content += '<div class="sp-case-manager">' +
      '<span class="sp-case-manager-name">Case Manager: ' + esc(cmName) + '</span>' +
      '<a href="mailto:' + esc(cmEmail) + '" class="btn-icon" title="Email case manager" onclick="event.stopPropagation();" style="width:28px;height:28px;">' +
        '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>' +
      '</a>' +
    '</div>';
  }

  // GPA
  content += '<div class="sp-section">';
  content += '<div class="sp-section-title">Current GPA</div>';
  if (s.gpa != null) {
    var gpaClass = s.gpa >= 3.5 ? 'high' : s.gpa >= 2.5 ? 'mid' : 'low';
    content += '<div class="sp-gpa ' + gpaClass + '">' + s.gpa.toFixed(2) + '</div>';
  } else {
    content += '<div class="sp-gpa none">No GPA data</div>';
  }
  content += '</div>';

  // Focus Goal (from student profile / onboarding)
  if (s.focusGoal) {
    content += '<div class="sp-section">';
    content += '<div class="sp-section-title">Focus Goal</div>';
    content += '<div class="sp-goal-text">' + esc(s.focusGoal) + '</div>';
    content += '</div>';
  }

  // Current Micro Goal (from latest check-in)
  content += '<div class="sp-section">';
  content += '<div class="sp-section-title">Current Micro Goal</div>';
  if (s.latestMicroGoal) {
    content += '<div class="sp-goal-text">' + esc(s.latestMicroGoal) + '</div>';
  } else {
    content += '<div class="sp-goal-none">No goal set</div>';
  }
  content += '</div>';

  // IEP Goal
  if (s.iepGoal) {
    content += '<div class="sp-section">';
    content += '<div class="sp-section-title">IEP Goal</div>';
    content += '<div class="sp-goal-text">' + esc(s.iepGoal) + '</div>';
    content += '</div>';
  }

  // Classes & Grades
  content += '<div class="sp-section">';
  content += '<div class="sp-section-title">Classes &amp; Grades</div>';
  if (s.academicData && s.academicData.length > 0) {
    content += '<ul class="sp-class-list">';
    s.academicData.forEach(function(c) {
      var missingNum = Number(c.missing) || 0;
      var missingBadgeClass = missingNum > 0 ? '' : ' none';
      var classLabel = c.className || 'Unknown';
      // Find period from student's class list
      var matchedClass = (s.classes || []).find(function(cl) { return cl.name === c.className; });
      if (matchedClass && matchedClass.period) classLabel += ' (P' + matchedClass.period + ')';
      content += '<li class="sp-class-item">' +
        '<span class="sp-class-name">' + esc(classLabel) + '</span>' +
        '<span class="sp-class-meta">' +
          '<span class="sp-class-grade">' + esc(c.grade || '--') + '</span>' +
          '<span class="sp-missing-badge clickable' + missingBadgeClass + '" onclick="event.stopPropagation(); closeSidePanel(); showMissingAssignments(\'' + s.id + '\')" title="View missing assignments">' + missingNum + ' missing</span>' +
        '</span>' +
      '</li>';
    });
    content += '</ul>';
  } else {
    content += '<div class="sp-goal-none">No academic data from latest check-in</div>';
  }
  content += '</div>';

  // Total missing (clickable to open detail view)
  content += '<div class="sp-section">';
  var totalMissing = s.totalMissing || 0;
  if (totalMissing === 0) {
    content += '<div class="sp-total-missing ok sp-no-missing" onclick="closeSidePanel(); showMissingAssignments(\'' + s.id + '\')" style="cursor:pointer;" title="View missing assignments detail">No Missing Assignments! <span class="sp-no-missing-emoji">&#x1F4AF;</span></div>';
  } else {
    content += '<div class="sp-total-missing alert" onclick="closeSidePanel(); showMissingAssignments(\'' + s.id + '\')" style="cursor:pointer;" title="View missing assignments detail">Total Missing Assignments: ' + totalMissing + '</div>';
  }
  content += '</div>';

  // Action buttons
  content += '<div class="sp-actions">' +
    '<button class="btn btn-primary" onclick="closeSidePanel(); startCheckIn(\'' + s.id + '\')">New Check-In</button>' +
    '<button class="btn btn-secondary" onclick="closeSidePanel(); editStudent(\'' + s.id + '\')">View Profile</button>' +
  '</div>';

  document.getElementById('side-panel-content').innerHTML = content;
  document.getElementById('side-panel').classList.add('open');
  document.getElementById('side-panel-overlay').classList.add('open');
}

function closeSidePanel() {
  document.getElementById('side-panel').classList.remove('open');
  document.getElementById('side-panel-overlay').classList.remove('open');
}

// ─── Check-In Form ───
function startCheckIn(studentId, existingCheckIn) {
  appState.currentStudentId = studentId;
  appState.editingCheckIn = existingCheckIn || null;
  document.getElementById('checkin-view-title').innerHTML = '<span class="skeleton skeleton-title-inline"></span>';
  showCheckInSkeleton();
  showView('checkin-view');

  google.script.run
    .withSuccessHandler(function(students) {
      var student = (students || []).find(function(s) { return s.id === studentId; });
      if (!student) { showToast('Student not found'); return; }

      google.script.run
        .withSuccessHandler(function(checkIns) {
          try {
            appState.currentCheckIns = checkIns || [];
            renderCheckInForm(student, checkIns, existingCheckIn);
          } catch(e) { showToast('Render error: ' + e.message); }
        })
        .withFailureHandler(function(err) { showToast('Error: ' + (err && err.message ? err.message : String(err))); })
        .getCheckIns(studentId);
    })
    .withFailureHandler(function(err) { showToast('Error: ' + (err && err.message ? err.message : String(err))); })
    .getStudents();
}

function renderCheckInForm(student, checkIns, existingCheckIn) {
  document.getElementById('checkin-view-breadcrumb').textContent = 'Weekly Check-In';
  document.getElementById('checkin-view-title').textContent = student.firstName + ' ' + student.lastName;

  var container = document.getElementById('checkin-form-container');
  var html = '';

  // ── Previous Goal Banner (top of form) ──
  var lastCheckIn = null;
  if (existingCheckIn) {
    // When editing, show the goal from the check-in before this one
    var others = checkIns.filter(function(ci) { return ci.id !== existingCheckIn.id; });
    lastCheckIn = others.length > 0 ? others[0] : null;
  } else {
    // For new check-in, show the goal from the most recent check-in
    lastCheckIn = checkIns.length > 0 ? checkIns[0] : null;
  }

  if (lastCheckIn && lastCheckIn.microGoal) {
    html += '<div class="prev-goal-banner">' +
      '<div class="banner-label">Previous Goal</div>' +
      '<div class="banner-goal">' + esc(lastCheckIn.microGoal) + '</div>' +
      '<div class="banner-date">Set on check-in: ' + esc(lastCheckIn.weekOf || 'Unknown date') + '</div>' +
    '</div>';
  } else {
    html += '<div class="prev-goal-banner no-goal">' +
      '<div class="banner-label">Previous Goal</div>' +
      '<div class="banner-goal">No previous goal set</div>' +
    '</div>';
  }

  // Pre-fill values from existing check-in (if editing)
  var ci = existingCheckIn || {};
  var today = new Date().toISOString().slice(0, 10);

  html += '<div class="form-card">';

  // Week Of
  html += '<div class="form-section">' +
    '<div class="form-group">' +
      '<label>Week Of</label>' +
      '<input type="date" id="ci-weekOf" value="' + esc(ci.weekOf || today) + '">' +
    '</div>' +
  '</div>';

  // EF Ratings
  html += '<div class="form-section">' +
    '<div class="form-section-title">Executive Function Ratings</div>';

  var efDimensions = [
    { key: 'planningRating', label: 'Planning' },
    { key: 'followThroughRating', label: 'Follow-Through' },
    { key: 'regulationRating', label: 'Regulation' },
    { key: 'focusGoalRating', label: 'Focus Goal' },
    { key: 'effortRating', label: 'Effort' }
  ];

  efDimensions.forEach(function(dim) {
    var currentVal = Number(ci[dim.key]) || 0;
    html += '<div class="form-group">' +
      '<label>' + dim.label + '</label>' +
      '<div class="rating-group" data-field="' + dim.key + '">';
    for (var r = 1; r <= 5; r++) {
      var sel = (r === currentVal) ? ' selected' : '';
      html += '<button type="button" class="rating-btn' + sel + '" data-value="' + r + '" onclick="selectRating(this)">' + r + '</button>';
    }
    html += '</div></div>';
  });

  html += '</div>';

  // Reflection
  html += '<div class="form-section">' +
    '<div class="form-section-title">Reflection</div>' +
    '<div class="form-group"><label>What went well?</label>' +
      '<textarea id="ci-whatWentWell">' + esc(ci.whatWentWell || '') + '</textarea></div>' +
    '<div class="form-group"><label>Barrier / Challenge</label>' +
      '<textarea id="ci-barrier">' + esc(ci.barrier || '') + '</textarea></div>' +
  '</div>';

  // Micro Goal
  html += '<div class="form-section">' +
    '<div class="form-section-title">Micro Goal</div>' +
    '<div class="form-group"><label>Goal for next week</label>' +
      '<input type="text" id="ci-microGoal" value="' + esc(ci.microGoal || '') + '"></div>' +
    '<div class="form-group"><label>Category</label>' +
      '<select id="ci-microGoalCategory">';

  var categories = [
    '', 'Planning & Prioritization', 'Organization', 'Time Management',
    'Task Initiation', 'Sustained Attention', 'Flexibility',
    'Metacognition', 'Working Memory', 'Emotional Regulation', 'Other'
  ];
  categories.forEach(function(cat) {
    var sel = ((ci.microGoalCategory || '') === cat) ? ' selected' : '';
    html += '<option value="' + esc(cat) + '"' + sel + '>' + (cat || '-- Select --') + '</option>';
  });

  html += '</select></div></div>';

  // Academic Snapshot
  html += '<div class="form-section">' +
    '<div class="form-section-title">Academic Snapshot</div>';

  var classes = student.classes || [];

  // Build lookup maps for pre-filling grades
  var prevAcademic = {};
  if (lastCheckIn && lastCheckIn.academicData) {
    lastCheckIn.academicData.forEach(function(ad) { prevAcademic[ad.className] = ad; });
  }
  var editAcademic = {};
  if (existingCheckIn && existingCheckIn.academicData) {
    existingCheckIn.academicData.forEach(function(ad) { editAcademic[ad.className] = ad; });
  }

  if (classes.length > 0) {
    var grades = ['', 'A', 'A-', 'B+', 'B', 'B-', 'C+', 'C', 'C-', 'D+', 'D', 'D-', 'F'];

    html += '<table class="academic-table" id="academic-table">' +
      '<thead><tr><th>Class</th><th>Grade</th><th>Missing</th></tr></thead><tbody>';

    classes.forEach(function(cls, clsIdx) {
      var className = cls.name || cls;
      var classPeriod = cls.period || '';
      var displayName = classPeriod ? className + ' (P' + classPeriod + ')' : className;
      var existing = editAcademic[className] || prevAcademic[className] || {};
      var assignments = existing.missingAssignments || [];
      var missingCount = assignments.length || (Number(existing.missing) || 0);
      var badgeClass = missingCount === 0 ? 'chip-green' : missingCount <= 3 ? 'chip-yellow' : 'chip-red';

      html += '<tr class="acad-row">' +
        '<td class="class-name-col">' + esc(displayName) +
          '<input type="hidden" class="acad-class-name" value="' + esc(className) + '">' +
        '</td>' +
        '<td><select class="acad-grade">';

      grades.forEach(function(g) {
        var sel = ((existing.grade || '') === g) ? ' selected' : '';
        html += '<option value="' + g + '"' + sel + '>' + (g || '--') + '</option>';
      });

      html += '</select></td>' +
        '<td>' +
          '<button type="button" class="missing-toggle chip ' + badgeClass + '" onclick="toggleCheckInMissing(' + clsIdx + ')">' +
            '<span id="ci-missing-count-' + clsIdx + '">' + missingCount + '</span>' +
            ' <svg class="expand-chevron" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>' +
          '</button>' +
        '</td>' +
      '</tr>';

      // Expandable missing assignments detail row
      html += '<tr class="acad-missing-row" id="acad-missing-row-' + clsIdx + '" style="display:none;">' +
        '<td colspan="3">' +
          '<div class="ci-missing-container">' +
            '<div class="ci-missing-list" id="ci-missing-list-' + clsIdx + '">';

      // Render existing individual assignments
      assignments.forEach(function(a) {
        html += renderCheckInMissingItem(clsIdx, a.name || '', a.type || '');
      });

      html += '</div>' +
            '<button type="button" class="btn-ghost btn-sm" onclick="addCheckInMissing(' + clsIdx + ')">+ Add Missing Assignment</button>' +
          '</div>' +
        '</td>' +
      '</tr>';
    });

    html += '</tbody></table>';
  } else {
    html += '<p class="hint">No classes configured for this student.</p>' +
      '<button class="btn-ghost btn-sm" onclick="goBackFromCheckIn(); editStudent(\'' + student.id + '\')">Add Classes</button>';
  }

  html += '</div>';

  // Teacher Notes
  html += '<div class="form-section">' +
    '<div class="form-section-title">Teacher Notes</div>' +
    '<div class="form-group"><label>Notes</label>' +
      '<textarea id="ci-teacherNotes">' + esc(ci.teacherNotes || '') + '</textarea></div>' +
  '</div>';

  // Buttons + autosave indicator
  html += '<div class="checkin-form-footer">' +
    '<div id="ci-autosave-status" class="autosave-status"></div>' +
    '<div style="display:flex;gap:8px;">' +
      '<button class="btn btn-secondary" onclick="goBackFromCheckIn()">Back</button>' +
      '<button class="btn btn-primary" onclick="saveCheckIn()">Save Check-In</button>' +
    '</div>' +
  '</div>';

  html += '</div>'; // form-card

  container.innerHTML = html;
  animateContentIn(container);
  setupCheckInAutosave();
}

function selectRating(btn) {
  var group = btn.parentElement;
  group.querySelectorAll('.rating-btn').forEach(function(b) { b.classList.remove('selected'); });
  btn.classList.add('selected');
  scheduleCheckInAutosave();
}

function getSelectedRating(field) {
  var group = document.querySelector('.rating-group[data-field="' + field + '"]');
  if (!group) return '';
  var selected = group.querySelector('.rating-btn.selected');
  return selected ? selected.getAttribute('data-value') : '';
}

// ─── Check-In Inline Missing Assignment Helpers ───
function renderCheckInMissingItem(clsIdx, name, type) {
  return '<div class="ci-missing-item" data-class-idx="' + clsIdx + '">' +
    '<input type="text" class="ci-ma-name" value="' + esc(name) + '" placeholder="Assignment name">' +
    '<select class="ci-ma-type">' +
      '<option value=""' + (!type ? ' selected' : '') + '>-- Type --</option>' +
      '<option value="Formative"' + (type === 'Formative' ? ' selected' : '') + '>Formative</option>' +
      '<option value="Summative"' + (type === 'Summative' ? ' selected' : '') + '>Summative</option>' +
    '</select>' +
    '<button type="button" class="btn-remove-class" onclick="removeCheckInMissing(this, ' + clsIdx + ')">&times;</button>' +
  '</div>';
}

function toggleCheckInMissing(clsIdx) {
  var row = document.getElementById('acad-missing-row-' + clsIdx);
  if (row.style.display === 'none') {
    row.style.display = '';
  } else {
    row.style.display = 'none';
  }
}

function addCheckInMissing(clsIdx) {
  var list = document.getElementById('ci-missing-list-' + clsIdx);
  var div = document.createElement('div');
  div.innerHTML = renderCheckInMissingItem(clsIdx, '', '');
  list.appendChild(div.firstChild);
  updateCheckInMissingCount(clsIdx);
  scheduleCheckInAutosave();
  // Focus the new name input
  var items = list.querySelectorAll('.ci-missing-item');
  var last = items[items.length - 1];
  if (last) last.querySelector('.ci-ma-name').focus();
}

function removeCheckInMissing(btn, clsIdx) {
  btn.parentElement.remove();
  updateCheckInMissingCount(clsIdx);
  scheduleCheckInAutosave();
}

function updateCheckInMissingCount(clsIdx) {
  var list = document.getElementById('ci-missing-list-' + clsIdx);
  var count = list.querySelectorAll('.ci-missing-item').length;
  var countEl = document.getElementById('ci-missing-count-' + clsIdx);
  countEl.textContent = count;
  // Update badge color
  var btn = countEl.closest('.missing-toggle');
  btn.className = 'missing-toggle chip ' +
    (count === 0 ? 'chip-green' : count <= 3 ? 'chip-yellow' : 'chip-red');
}

function getAcademicData() {
  var table = document.getElementById('academic-table');
  if (!table) return [];
  var rows = table.querySelectorAll('tbody tr.acad-row');
  var result = [];
  rows.forEach(function(row, idx) {
    var missingItems = [];
    var list = document.getElementById('ci-missing-list-' + idx);
    if (list) {
      list.querySelectorAll('.ci-missing-item').forEach(function(item) {
        var name = item.querySelector('.ci-ma-name').value.trim();
        var type = item.querySelector('.ci-ma-type').value;
        if (name) {
          missingItems.push({ name: name, type: type });
        }
      });
    }
    result.push({
      className: row.querySelector('.acad-class-name').value,
      grade: row.querySelector('.acad-grade').value,
      missing: missingItems.length,
      missingAssignments: missingItems
    });
  });
  return result;
}

function collectCheckInData() {
  var weekOfEl = document.getElementById('ci-weekOf');
  if (!weekOfEl) return null;
  return {
    studentId: appState.currentStudentId,
    weekOf: weekOfEl.value,
    planningRating: getSelectedRating('planningRating'),
    followThroughRating: getSelectedRating('followThroughRating'),
    regulationRating: getSelectedRating('regulationRating'),
    focusGoalRating: getSelectedRating('focusGoalRating'),
    effortRating: getSelectedRating('effortRating'),
    whatWentWell: document.getElementById('ci-whatWentWell').value,
    barrier: document.getElementById('ci-barrier').value,
    microGoal: document.getElementById('ci-microGoal').value,
    microGoalCategory: document.getElementById('ci-microGoalCategory').value,
    teacherNotes: document.getElementById('ci-teacherNotes').value,
    academicData: getAcademicData()
  };
}

function saveCheckIn() {
  // Cancel any pending autosave
  if (_ciAutosaveTimer) {
    clearTimeout(_ciAutosaveTimer);
    _ciAutosaveTimer = null;
  }

  var data = collectCheckInData();
  if (!data) return;

  if (appState.editingCheckIn && appState.editingCheckIn.id) {
    data.id = appState.editingCheckIn.id;
  }

  // Reset autosave state
  _ciAutosaveDirty = false;

  // Optimistic UI: navigate immediately
  showView('dashboard-view');
  renderDashboard(appState.dashboardData);
  showToast('Saving check-in\u2026');

  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showToast('Check-in saved');
        loadDashboard();
      } else {
        showToast('Error saving check-in');
      }
    })
    .withFailureHandler(function(err) { showToast('Error: ' + (err && err.message ? err.message : String(err))); })
    .saveCheckIn(data);
}

function goBackFromCheckIn() {
  // Cancel any pending autosave timer
  if (_ciAutosaveTimer) {
    clearTimeout(_ciAutosaveTimer);
    _ciAutosaveTimer = null;
  }
  // If there are unsaved changes, do a final save before leaving
  if (_ciAutosaveDirty && !_ciAutosaveInFlight && appState.editingCheckIn && appState.editingCheckIn.id) {
    var data = collectCheckInData();
    if (data) {
      data.id = appState.editingCheckIn.id;
      _ciAutosaveDirty = false;
      google.script.run
        .withSuccessHandler(function() { loadDashboard(); })
        .withFailureHandler(function() {})
        .saveCheckIn(data);
    }
  }
  showDashboard();
}

// ─── Check-In Autosave ───

function setupCheckInAutosave() {
  var container = document.getElementById('checkin-form-container');
  if (!container) return;

  // Listen for input/change events on all form fields
  container.addEventListener('input', function() { scheduleCheckInAutosave(); });
  container.addEventListener('change', function() { scheduleCheckInAutosave(); });

  // Reset autosave state
  _ciAutosaveDirty = false;
  _ciAutosaveInFlight = false;
  if (_ciAutosaveTimer) { clearTimeout(_ciAutosaveTimer); _ciAutosaveTimer = null; }
  updateAutosaveIndicator('idle');
}

function scheduleCheckInAutosave() {
  _ciAutosaveDirty = true;
  updateAutosaveIndicator('unsaved');
  if (_ciAutosaveTimer) clearTimeout(_ciAutosaveTimer);
  _ciAutosaveTimer = setTimeout(function() {
    _ciAutosaveTimer = null;
    performCheckInAutosave();
  }, 2000);
}

function performCheckInAutosave() {
  if (_ciAutosaveInFlight) {
    // Already saving — re-schedule to pick up latest changes
    scheduleCheckInAutosave();
    return;
  }

  var data = collectCheckInData();
  if (!data) return;

  if (appState.editingCheckIn && appState.editingCheckIn.id) {
    data.id = appState.editingCheckIn.id;
  }

  _ciAutosaveInFlight = true;
  _ciAutosaveDirty = false;
  updateAutosaveIndicator('saving');

  google.script.run
    .withSuccessHandler(function(result) {
      _ciAutosaveInFlight = false;
      if (result && result.success) {
        // Store the ID so future saves update the same record
        if (!appState.editingCheckIn) {
          appState.editingCheckIn = {};
        }
        appState.editingCheckIn.id = result.id;

        if (_ciAutosaveDirty) {
          scheduleCheckInAutosave();
        } else {
          updateAutosaveIndicator('saved');
        }
      } else {
        updateAutosaveIndicator('error');
      }
    })
    .withFailureHandler(function() {
      _ciAutosaveInFlight = false;
      updateAutosaveIndicator('error');
    })
    .saveCheckIn(data);
}

function updateAutosaveIndicator(state, elementId) {
  var el = document.getElementById(elementId || 'ci-autosave-status');
  if (!el) return;
  var html = '';
  switch(state) {
    case 'saving':
      html = '<span class="autosave-saving"><span class="autosave-spinner"></span> Saving\u2026</span>';
      break;
    case 'saved':
      html = '<span class="autosave-saved"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg> All changes saved</span>';
      break;
    case 'unsaved':
      html = '<span class="autosave-unsaved">Unsaved changes</span>';
      break;
    case 'error':
      html = '<span class="autosave-error">Error saving — try again</span>';
      break;
    default:
      html = '';
  }
  el.innerHTML = html;
}

// ─── Goals Autosave ───

function setupGoalsAutosave() {
  var container = document.getElementById('goals-autosave-container');
  if (!container) return;

  container.addEventListener('input', function() { scheduleGoalsAutosave(); });
  container.addEventListener('change', function() { scheduleGoalsAutosave(); });

  _goalsAutosaveDirty = false;
  _goalsAutosaveInFlight = false;
  if (_goalsAutosaveTimer) { clearTimeout(_goalsAutosaveTimer); _goalsAutosaveTimer = null; }
  updateGoalsAutosaveIndicator('idle');
}

function scheduleGoalsAutosave() {
  _goalsAutosaveDirty = true;
  updateGoalsAutosaveIndicator('unsaved');
  if (_goalsAutosaveTimer) clearTimeout(_goalsAutosaveTimer);
  _goalsAutosaveTimer = setTimeout(function() {
    _goalsAutosaveTimer = null;
    performGoalsAutosave();
  }, 2000);
}

function performGoalsAutosave() {
  if (_goalsAutosaveInFlight) {
    scheduleGoalsAutosave();
    return;
  }

  var goalsData = collectGoalsData();
  var goalsJson = JSON.stringify(goalsData);
  var studentId = appState.currentStudentId;
  if (!studentId) return;

  _goalsAutosaveInFlight = true;
  _goalsAutosaveDirty = false;
  updateGoalsAutosaveIndicator('saving');

  google.script.run
    .withSuccessHandler(function(result) {
      _goalsAutosaveInFlight = false;
      if (result && result.success) {
        // Update local state
        var s = appState.dashboardData.find(function(st) { return st.id === studentId; });
        if (s) {
          s.goalsJson = goalsJson;
          s.goals = goalsData;
        }
        if (appState.currentStudent) {
          appState.currentStudent.goalsJson = goalsJson;
          appState.currentStudent.goals = goalsData;
        }

        if (_goalsAutosaveDirty) {
          scheduleGoalsAutosave();
        } else {
          updateGoalsAutosaveIndicator('saved');
        }
      } else {
        updateGoalsAutosaveIndicator('error');
      }
    })
    .withFailureHandler(function() {
      _goalsAutosaveInFlight = false;
      updateGoalsAutosaveIndicator('error');
    })
    .saveStudentGoals(studentId, goalsJson);
}

function collectGoalsData() {
  var container = document.getElementById('goals-autosave-container');
  if (!container) return [];

  var goals = [];
  var goalItems = container.querySelectorAll('.profile-goal-item');
  goalItems.forEach(function(goalEl) {
    var goalId = goalEl.getAttribute('data-goal-id') || '';
    var goalText = goalEl.querySelector('[data-field="goal-text"]');
    var text = goalText ? goalText.value : '';

    var objectives = [];
    var objItems = goalEl.querySelectorAll('.profile-objective-item');
    objItems.forEach(function(objEl) {
      var objId = objEl.getAttribute('data-obj-id') || '';
      var objText = objEl.querySelector('[data-field="obj-text"]');
      objectives.push({
        id: objId,
        text: objText ? objText.value : ''
      });
    });

    goals.push({
      id: goalId,
      text: text,
      objectives: objectives
    });
  });

  return goals;
}

function updateGoalsAutosaveIndicator(state) {
  updateAutosaveIndicator(state, 'goals-autosave-status');
}

function addGoal() {
  var container = document.getElementById('goals-autosave-container');
  if (!container) return;
  var goalId = 'goal-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5);
  var goal = { id: goalId, text: '', objectives: [] };
  var div = document.createElement('div');
  div.innerHTML = renderGoalItem(goal);
  var goalEl = div.firstChild;
  container.appendChild(goalEl);
  // Focus the new goal textarea
  var textarea = goalEl.querySelector('[data-field="goal-text"]');
  if (textarea) textarea.focus();
  scheduleGoalsAutosave();
}

function removeGoal(goalId) {
  var container = document.getElementById('goals-autosave-container');
  if (!container) return;
  var goalEl = container.querySelector('[data-goal-id="' + goalId + '"]');
  if (goalEl) goalEl.remove();
  scheduleGoalsAutosave();
}

function addObjective(goalId) {
  var container = document.getElementById('goals-autosave-container');
  if (!container) return;
  var goalEl = container.querySelector('[data-goal-id="' + goalId + '"]');
  if (!goalEl) return;
  var objList = goalEl.querySelector('.profile-objectives-list');
  if (!objList) return;

  var objId = 'obj-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5);
  var objHtml = '<div class="profile-objective-item" data-obj-id="' + objId + '">' +
    '<textarea data-field="obj-text" placeholder="Enter objective..."></textarea>' +
    '<button class="goal-remove-btn" onclick="removeObjective(\'' + esc(goalId) + '\', \'' + objId + '\')" title="Remove objective">' +
      '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>' +
    '</button>' +
  '</div>';

  // Insert before the "Add Objective" button
  var addBtn = objList.querySelector('.btn-ghost');
  var div = document.createElement('div');
  div.innerHTML = objHtml;
  var objEl = div.firstChild;
  objList.insertBefore(objEl, addBtn);

  // Focus the new objective textarea
  var textarea = objEl.querySelector('[data-field="obj-text"]');
  if (textarea) textarea.focus();
  scheduleGoalsAutosave();
}

function removeObjective(goalId, objId) {
  var container = document.getElementById('goals-autosave-container');
  if (!container) return;
  var goalEl = container.querySelector('[data-goal-id="' + goalId + '"]');
  if (!goalEl) return;
  var objEl = goalEl.querySelector('[data-obj-id="' + objId + '"]');
  if (objEl) objEl.remove();
  scheduleGoalsAutosave();
}

// ─── Missing Assignments View (child page) ───
function showMissingAssignments(studentId) {
  var student = getStudentById(studentId);
  if (!student) { showToast('Student not found'); return; }

  appState.missingViewStudentId = studentId;

  document.getElementById('missing-view-breadcrumb').innerHTML =
    '<button class="breadcrumb-link" onclick="editStudent(appState.missingViewStudentId)">Student Profile</button> <svg class="breadcrumb-chevron" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg> Missing Assignments';
  document.getElementById('missing-view-title').textContent =
    student.firstName + ' ' + student.lastName;

  renderMissingView(student);
  showView('missing-view');
}

function renderMissingView(student) {
  var container = document.getElementById('missing-content-container');
  var academicData = student.academicData || [];
  var totalMissing = student.totalMissing || 0;
  var html = '';

  // Summary card
  if (totalMissing === 0) {
    html += '<div class="missing-summary ok">' +
      '<div class="missing-summary-label" style="font-size:22px;font-weight:600;">No Missing Assignments! &#x1F4AF;</div>' +
    '</div>';
  } else {
    html += '<div class="missing-summary alert">' +
      '<div class="missing-summary-count">' + totalMissing + '</div>' +
      '<div class="missing-summary-label">Total Missing Assignments</div>' +
    '</div>';
  }

  if (academicData.length === 0) {
    html += '<div class="empty-state" style="padding:40px 20px;">' +
      '<p>No academic data from the latest check-in.</p>' +
    '</div>';
  } else {
    html += '<div class="missing-class-cards">';

    academicData.forEach(function(c, idx) {
      var missingNum = Number(c.missing) || 0;
      var assignments = c.missingAssignments || [];
      var badgeClass = missingNum === 0 ? 'badge-green' : missingNum <= 3 ? 'badge-yellow' : 'badge-red';
      var classLabel = c.className || 'Unknown';

      // Find period from student's class list
      var matchedClass = (student.classes || []).find(function(cl) {
        return cl.name === c.className;
      });
      if (matchedClass && matchedClass.period) classLabel += ' (P' + matchedClass.period + ')';

      html += '<div class="missing-class-card" id="missing-card-' + idx + '">' +
        '<div class="missing-class-header" onclick="toggleMissingClass(' + idx + ')">' +
          '<div class="missing-class-info">' +
            '<span class="missing-class-name">' + esc(classLabel) + '</span>' +
            '<span class="missing-class-grade">' + esc(c.grade || '--') + '</span>' +
          '</div>' +
          '<div class="missing-class-right">' +
            '<div class="missing-class-badge ' + badgeClass + '">' + missingNum + '</div>' +
            '<svg class="expand-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>' +
          '</div>' +
        '</div>' +
        '<div class="missing-class-detail" id="missing-class-detail-' + idx + '">';

      if (missingNum === 0) {
        html += '<div class="missing-none-msg">No missing assignments</div>';
      } else if (assignments.length > 0) {
        // Sort by name then type, tracking original indices
        var sorted = assignments.map(function(a, i) {
          return { name: a.name, type: a.type, _origIdx: i };
        }).sort(function(a, b) {
          var nameComp = (a.name || '').localeCompare(b.name || '');
          if (nameComp !== 0) return nameComp;
          return (a.type || '').localeCompare(b.type || '');
        });

        html += '<table class="missing-detail-table">' +
          '<thead><tr><th>Assignment Name</th><th>Type</th><th>Actions</th></tr></thead><tbody>';
        sorted.forEach(function(a) {
          var typeClass = a.type === 'Summative' ? 'type-summative' :
                          a.type === 'Formative' ? 'type-formative' : '';
          html += '<tr>' +
            '<td>' + esc(a.name || 'Untitled') + '</td>' +
            '<td><span class="assignment-type ' + typeClass + '">' +
              esc(a.type || 'Unknown') + '</span></td>' +
            '<td class="missing-actions-cell">' +
              '<button class="missing-action-btn btn-check" onclick="event.stopPropagation(); markMissingDone(\'' + student.id + '\', ' + idx + ', ' + a._origIdx + ')" title="Mark as complete">' +
                '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>' +
              '</button>' +
              '<button class="missing-action-btn btn-delete" onclick="event.stopPropagation(); removeMissingAssignment(\'' + student.id + '\', ' + idx + ', ' + a._origIdx + ')" title="Remove assignment">' +
                '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>' +
              '</button>' +
            '</td>' +
          '</tr>';
        });
        html += '</tbody></table>';
      } else {
        html += '<div class="missing-count-only">' + missingNum +
          ' missing assignment' + (missingNum !== 1 ? 's' : '') +
          ' recorded (no details available)</div>';
      }

      // Add Missing Assignment inline form
      html += '<div class="mv-add-section">' +
        '<button type="button" class="btn-ghost btn-sm mv-add-btn" id="mv-add-btn-' + idx + '" onclick="event.stopPropagation(); showAddMissingForm(\'' + student.id + '\', ' + idx + ')">+ Add Missing Assignment</button>' +
        '<div class="mv-add-form" id="mv-add-form-' + idx + '" style="display:none;">' +
          '<div class="mv-add-form-row">' +
            '<input type="text" class="mv-add-name" id="mv-add-name-' + idx + '" placeholder="Assignment name" onkeydown="if(event.key===\'Enter\'){event.preventDefault();confirmAddMissing(\'' + student.id + '\',' + idx + ');}">' +
            '<select class="mv-add-type" id="mv-add-type-' + idx + '">' +
              '<option value="">-- Type --</option>' +
              '<option value="Formative">Formative</option>' +
              '<option value="Summative">Summative</option>' +
            '</select>' +
            '<button type="button" class="mv-confirm-btn" id="mv-confirm-btn-' + idx + '" onclick="event.stopPropagation(); confirmAddMissing(\'' + student.id + '\', ' + idx + ')" title="Add assignment">' +
              '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>' +
            '</button>' +
          '</div>' +
        '</div>' +
      '</div>';

      html += '</div></div>';
    });

    html += '</div>';
  }

  // Action buttons
  html += '<div class="missing-actions">' +
    '<button class="btn btn-primary" onclick="goBackFromMissing(); startCheckIn(\'' + student.id + '\')">New Check-In</button>' +
    '<button class="btn btn-secondary" onclick="goBackFromMissing()">Back</button>' +
  '</div>';

  container.innerHTML = html;
  animateContentIn(container);
}

function toggleMissingClass(idx) {
  document.getElementById('missing-card-' + idx).classList.toggle('expanded');
}

function launchConfetti(originEl) {
  var rect = originEl ? originEl.getBoundingClientRect() : { left: window.innerWidth / 2, top: window.innerHeight / 2 };
  var colors = ['#4CAF50', '#FFC107', '#2196F3', '#E91E63', '#9C27B0', '#FF5722', '#00BCD4'];
  var shapes = ['circle', 'square'];
  var count = 40;

  for (var i = 0; i < count; i++) {
    (function(index) {
      var piece = document.createElement('div');
      var size = Math.random() * 8 + 5;
      var color = colors[Math.floor(Math.random() * colors.length)];
      var shape = shapes[Math.floor(Math.random() * shapes.length)];
      var angle = (Math.random() * 360) * (Math.PI / 180);
      var velocity = Math.random() * 200 + 100;
      var dx = Math.cos(angle) * velocity;
      var dy = Math.sin(angle) * velocity - 150;
      var rotation = Math.random() * 360;

      piece.style.cssText =
        'position:fixed;z-index:10000;pointer-events:none;' +
        'width:' + size + 'px;height:' + size + 'px;' +
        'background:' + color + ';' +
        'border-radius:' + (shape === 'circle' ? '50%' : '2px') + ';' +
        'left:' + rect.left + 'px;top:' + rect.top + 'px;' +
        'opacity:1;transform:rotate(' + rotation + 'deg);';

      document.body.appendChild(piece);

      var startTime = performance.now();
      var duration = 900 + Math.random() * 400;

      function animate(now) {
        var elapsed = now - startTime;
        var progress = Math.min(elapsed / duration, 1);
        var ease = 1 - Math.pow(1 - progress, 3);

        var x = rect.left + dx * ease;
        var y = rect.top + dy * ease + 300 * progress * progress;
        var opacity = progress < 0.7 ? 1 : 1 - ((progress - 0.7) / 0.3);
        var rot = rotation + 360 * ease;

        piece.style.left = x + 'px';
        piece.style.top = y + 'px';
        piece.style.opacity = opacity;
        piece.style.transform = 'rotate(' + rot + 'deg)';

        if (progress < 1) {
          requestAnimationFrame(animate);
        } else {
          piece.remove();
        }
      }

      requestAnimationFrame(animate);
    })(i);
  }
}

/** Shared logic for removing a missing assignment from a student's academic data. */
function modifyMissingAssignment(studentId, classIdx, assignmentIdx, opts) {
  var student = getStudentById(studentId);
  if (!student) return;
  var classData = student.academicData[classIdx];
  if (!classData || !classData.missingAssignments) return;

  if (opts && opts.confetti) {
    var btn = event && event.currentTarget ? event.currentTarget : null;
    launchConfetti(btn);
  }

  classData.missingAssignments.splice(assignmentIdx, 1);
  classData.missing = classData.missingAssignments.length;
  recalcTotalMissing(student);

  if (opts && opts.renderFn) {
    opts.renderFn(student);
  }
  persistAcademicData_(student);
  showToast(opts && opts.message || 'Assignment updated');
}

function markMissingDone(studentId, classIdx, assignmentIdx) {
  modifyMissingAssignment(studentId, classIdx, assignmentIdx, {
    confetti: true,
    renderFn: renderMissingView,
    message: 'Assignment marked as complete'
  });
}

function removeMissingAssignment(studentId, classIdx, assignmentIdx) {
  modifyMissingAssignment(studentId, classIdx, assignmentIdx, {
    renderFn: renderMissingView,
    message: 'Assignment removed'
  });
}

function persistAcademicData_(student) {
  if (!student.latestCheckInId) {
    showToast('Change not saved — no check-in data found.');
    return;
  }
  // Debounce: if user marks several assignments rapidly, only the last call persists
  if (_persistTimers[student.id]) clearTimeout(_persistTimers[student.id]);
  var checkInId = student.latestCheckInId;
  var dataSnapshot = JSON.parse(JSON.stringify(student.academicData));
  _persistTimers[student.id] = setTimeout(function() {
    delete _persistTimers[student.id];
    _persistInFlight++;
    google.script.run
      .withSuccessHandler(function() {
        _persistInFlight--;
        // Once all persists complete, sync dashboard from backend if visible
        if (_persistInFlight === 0 && Object.keys(_persistTimers).length === 0 &&
            document.getElementById('dashboard-view').classList.contains('active')) {
          loadDashboard();
        }
      })
      .withFailureHandler(function(err) {
        _persistInFlight--;
        showToast('Could not save change: ' + (err && err.message ? err.message : String(err)));
      })
      .updateCheckInAcademicData(checkInId, dataSnapshot);
  }, 600);
}

// ─── Profile Dashboard — Missing Assignment Operations ───

function profileMarkDone(studentId, classIdx, assignmentIdx, btnEl) {
  // For profile view, confetti originates from the passed button element
  var student = getStudentById(studentId);
  if (!student) return;
  launchConfetti(btnEl);
  modifyMissingAssignment(studentId, classIdx, assignmentIdx, {
    renderFn: reRenderProfileAcademics,
    message: 'Assignment marked as complete'
  });
}

function profileRemoveAssignment(studentId, classIdx, assignmentIdx) {
  modifyMissingAssignment(studentId, classIdx, assignmentIdx, {
    renderFn: reRenderProfileAcademics,
    message: 'Assignment removed'
  });
}

function showProfileAddMissing(studentId, classIdx) {
  showAddMissingForm(studentId, classIdx, 'pv');
}

/** Shared logic for adding a missing assignment from an inline form. */
function addMissingFromForm_(studentId, classIdx, prefix, renderFn, opts) {
  var nameInput = document.getElementById(prefix + '-add-name-' + classIdx);
  var typeSelect = document.getElementById(prefix + '-add-type-' + classIdx);
  var name = nameInput.value.trim();
  var type = typeSelect.value;

  if (!name) {
    showToast('Please enter an assignment name');
    nameInput.focus();
    return;
  }

  var student = getStudentById(studentId);
  if (!student) return;
  var classData = student.academicData[classIdx];
  if (!classData) return;

  if (!classData.missingAssignments) classData.missingAssignments = [];
  classData.missingAssignments.push({ name: name, type: type });
  classData.missing = classData.missingAssignments.length;
  recalcTotalMissing(student);

  if (opts && opts.confirmBtn) {
    var confirmBtn = document.getElementById(prefix + '-confirm-btn-' + classIdx);
    if (confirmBtn) confirmBtn.classList.add('saved');
  }

  // Track expanded cards
  var expandedCards = [];
  var cardSelector = opts && opts.cardSelector || '.missing-class-card.expanded';
  document.querySelectorAll(cardSelector).forEach(function(card) {
    expandedCards.push(card.id);
  });

  if (opts && opts.delay) {
    setTimeout(function() {
      renderFn(student);
      expandedCards.forEach(function(cardId) {
        var card = document.getElementById(cardId);
        if (card) card.classList.add('expanded');
      });
      showToast('Assignment added');
    }, opts.delay);
  } else {
    renderFn(student);
    expandedCards.forEach(function(cardId) {
      var card = document.getElementById(cardId);
      if (card) card.classList.add('expanded');
    });
    showToast('Assignment added');
  }

  persistAcademicData_(student);
}

function profileConfirmAddMissing(studentId, classIdx) {
  addMissingFromForm_(studentId, classIdx, 'pv', reRenderProfileAcademics, {
    cardSelector: '.profile-class-card.expanded'
  });
}

function reRenderProfileAcademics(student) {
  // Track which profile class cards are expanded
  var expandedCards = [];
  document.querySelectorAll('.profile-class-card.expanded').forEach(function(card) {
    expandedCards.push(card.id);
  });

  // Save current goals from DOM before re-render so unsaved changes aren't lost
  var goalsData = collectGoalsData();
  if (goalsData.length > 0) {
    student.goalsJson = JSON.stringify(goalsData);
  }

  renderStudentProfileDashboard(student);

  // Re-expand previously expanded cards
  expandedCards.forEach(function(cardId) {
    var card = document.getElementById(cardId);
    if (card) card.classList.add('expanded');
  });
}

function goBackFromMissing() {
  renderDashboard(appState.dashboardData);
  showView('dashboard-view');
}

// ─── Add Missing Assignment (from Missing View) ───

function showAddMissingForm(studentId, classIdx, prefix) {
  prefix = prefix || 'mv';
  var btn = document.getElementById(prefix + '-add-btn-' + classIdx);
  var form = document.getElementById(prefix + '-add-form-' + classIdx);
  if (btn) btn.style.display = 'none';
  if (form) form.style.display = '';
  var nameInput = document.getElementById(prefix + '-add-name-' + classIdx);
  if (nameInput) nameInput.focus();
}

function confirmAddMissing(studentId, classIdx) {
  addMissingFromForm_(studentId, classIdx, 'mv', renderMissingView, {
    confirmBtn: true,
    delay: 400,
    cardSelector: '.missing-class-card.expanded'
  });
}

// ─── Student Profile ───
function showAddStudent() {
  appState.currentStudentId = null;
  renderStudentForm({});
  document.getElementById('student-view-breadcrumb').textContent = 'Students';
  document.getElementById('student-view-title').textContent = 'New Student';
  renderStudentMenu(null);
  showView('student-view');
}

function editStudent(studentId) {
  showStudentProfile(studentId);
}

function showStudentProfile(studentId) {
  appState.currentStudentId = studentId;
  document.getElementById('student-view-breadcrumb').textContent = 'Student Profile';
  document.getElementById('student-view-title').innerHTML = '<span class="skeleton skeleton-title-inline"></span>';
  showStudentProfileSkeleton();
  renderStudentMenu(studentId);
  showView('student-view');

  google.script.run
    .withSuccessHandler(function(students) {
      var student = (students || []).find(function(s) { return s.id === studentId; });
      if (!student) { showToast('Student not found'); return; }

      // Store student reference for edit access
      appState.currentStudent = student;

      try {
        document.getElementById('student-view-title').textContent =
          student.firstName + ' ' + student.lastName;
        renderStudentProfileDashboard(student);
        renderStudentMenu(studentId);
      } catch(e) { showToast('Render error: ' + e.message); return; }

      // Also load check-in history
      google.script.run
        .withSuccessHandler(function(checkIns) {
          try { renderCheckInHistory(checkIns, student); } catch(e) { showToast('History error: ' + e.message); }
        })
        .withFailureHandler(function() {})
        .getCheckIns(studentId);
    })
    .withFailureHandler(function(err) { showToast('Error: ' + (err && err.message ? err.message : String(err))); })
    .getDashboardData();
}

function renderStudentProfileDashboard(student) {
  var container = document.getElementById('student-form-container');
  var html = '';

  // ─── Section 0: Schedule ───
  var classes = student.classes || [];
  if (classes.length > 0) {
    // Sort by period number (classes without a period go to the end)
    var sorted = classes.slice().sort(function(a, b) {
      var pa = parseInt(a.period) || 999;
      var pb = parseInt(b.period) || 999;
      return pa - pb;
    });

    html += '<div class="profile-section-card">';
    html += '<div class="profile-section-header">' +
      '<span class="profile-section-title">Schedule</span>' +
    '</div>';
    html += '<table class="schedule-table"><thead><tr><th>Period</th><th>Class</th></tr></thead><tbody>';
    sorted.forEach(function(cl) {
      html += '<tr><td class="schedule-period">' + esc(cl.period ? String(cl.period) : '--') + '</td>' +
        '<td>' + esc(cl.name || 'Unknown') + '</td></tr>';
    });
    html += '</tbody></table>';
    html += '</div>';
  }

  // ─── Section 1: Academic Snapshot ───
  html += '<div class="profile-section-card">';
  html += '<div class="profile-section-header">' +
    '<span class="profile-section-title">Academics</span>' +
    '<button class="btn btn-sm btn-primary" onclick="startCheckIn(\'' + student.id + '\')">New Check-In</button>' +
  '</div>';

  var academicData = student.academicData || [];
  if (academicData.length === 0) {
    html += '<div class="profile-empty-state"><p>No academic data from the latest check-in.</p></div>';
  } else {
    // GPA summary bar
    var totalMissing = student.totalMissing || 0;
    html += '<div class="profile-gpa-bar">';
    if (student.gpa != null) {
      var gpaClass = student.gpa >= 3.5 ? 'high' : student.gpa >= 2.5 ? 'mid' : 'low';
      html += '<span class="gpa-label">GPA</span><span class="gpa-value ' + gpaClass + '">' + student.gpa.toFixed(2) + '</span>';
    } else {
      html += '<span class="gpa-label">GPA</span><span class="gpa-value">--</span>';
    }
    html += '<span style="margin-left:auto;" class="gpa-label">Missing</span>';
    if (totalMissing === 0) {
      html += '<span class="gpa-value high">0</span>';
    } else {
      html += '<span class="gpa-value low">' + totalMissing + '</span>';
    }
    html += '</div>';

    // Expandable class cards
    html += '<div class="profile-class-cards">';
    academicData.forEach(function(c, idx) {
      var missingNum = Number(c.missing) || 0;
      var assignments = c.missingAssignments || [];
      var badgeClass = missingNum === 0 ? 'badge-green' : missingNum <= 3 ? 'badge-yellow' : 'badge-red';
      var classLabel = c.className || 'Unknown';

      var matchedClass = (student.classes || []).find(function(cl) { return cl.name === c.className; });
      if (matchedClass && matchedClass.period) classLabel += ' (P' + matchedClass.period + ')';

      html += '<div class="profile-class-card" id="profile-card-' + idx + '">' +
        '<div class="profile-class-header" onclick="toggleProfileClass(' + idx + ')">' +
          '<div class="profile-class-info">' +
            '<span class="profile-class-name">' + esc(classLabel) + '</span>' +
            '<span class="profile-class-grade">' + esc(c.grade || '--') + '</span>' +
          '</div>' +
          '<div class="profile-class-right">' +
            '<div class="profile-class-badge ' + badgeClass + '">' + missingNum + '</div>' +
            '<svg class="expand-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>' +
          '</div>' +
        '</div>' +
        '<div class="profile-class-detail">';

      if (missingNum === 0) {
        html += '<div class="missing-none-msg" style="padding:12px 16px;">No missing assignments</div>';
      } else if (assignments.length > 0) {
        var sorted = assignments.map(function(a, i) {
          return { name: a.name, type: a.type, _origIdx: i };
        }).sort(function(a, b) {
          var nameComp = (a.name || '').localeCompare(b.name || '');
          if (nameComp !== 0) return nameComp;
          return (a.type || '').localeCompare(b.type || '');
        });

        html += '<table class="missing-detail-table">' +
          '<thead><tr><th>Assignment Name</th><th>Type</th><th>Actions</th></tr></thead><tbody>';
        sorted.forEach(function(a) {
          var typeClass = a.type === 'Summative' ? 'type-summative' :
                          a.type === 'Formative' ? 'type-formative' : '';
          html += '<tr>' +
            '<td>' + esc(a.name || 'Untitled') + '</td>' +
            '<td><span class="assignment-type ' + typeClass + '">' + esc(a.type || 'Unknown') + '</span></td>' +
            '<td class="missing-actions-cell">' +
              '<button class="missing-action-btn btn-check" onclick="event.stopPropagation(); profileMarkDone(\'' + student.id + '\', ' + idx + ', ' + a._origIdx + ', this)" title="Mark as complete">' +
                '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>' +
              '</button>' +
              '<button class="missing-action-btn btn-delete" onclick="event.stopPropagation(); profileRemoveAssignment(\'' + student.id + '\', ' + idx + ', ' + a._origIdx + ')" title="Remove assignment">' +
                '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>' +
              '</button>' +
            '</td>' +
          '</tr>';
        });
        html += '</tbody></table>';
      } else {
        html += '<div class="missing-count-only" style="padding:12px 16px;">' + missingNum +
          ' missing assignment' + (missingNum !== 1 ? 's' : '') +
          ' recorded (no details available)</div>';
      }

      // Add Missing Assignment inline form
      html += '<div class="mv-add-section">' +
        '<button type="button" class="btn-ghost btn-sm mv-add-btn" id="pv-add-btn-' + idx + '" onclick="event.stopPropagation(); showProfileAddMissing(\'' + student.id + '\', ' + idx + ')">+ Add Missing Assignment</button>' +
        '<div class="mv-add-form" id="pv-add-form-' + idx + '" style="display:none;">' +
          '<div class="mv-add-form-row">' +
            '<input type="text" class="mv-add-name" id="pv-add-name-' + idx + '" placeholder="Assignment name" onkeydown="if(event.key===\'Enter\'){event.preventDefault();profileConfirmAddMissing(\'' + student.id + '\',' + idx + ');}">' +
            '<select class="mv-add-type" id="pv-add-type-' + idx + '">' +
              '<option value="">-- Type --</option>' +
              '<option value="Formative">Formative</option>' +
              '<option value="Summative">Summative</option>' +
            '</select>' +
            '<button type="button" class="mv-confirm-btn" onclick="event.stopPropagation(); profileConfirmAddMissing(\'' + student.id + '\', ' + idx + ')" title="Add assignment">' +
              '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>' +
            '</button>' +
          '</div>' +
        '</div>' +
      '</div>';

      html += '</div></div>';
    });
    html += '</div>';
  }
  html += '</div>';

  // ─── Section 2: Goals & Objectives ───
  html += '<div class="profile-section-card">';
  html += '<div class="profile-section-header">' +
    '<span class="profile-section-title">Goals &amp; Objectives</span>' +
    '<span class="goals-autosave-status" id="goals-autosave-status"></span>' +
  '</div>';
  html += '<div id="goals-autosave-container">';

  // Parse goals — backward compat with old iepGoal field
  var goals = [];
  if (student.goalsJson) {
    try { goals = JSON.parse(student.goalsJson); } catch(e) { goals = []; }
  } else if (student.goals && student.goals.length > 0) {
    goals = student.goals;
  }
  if (goals.length === 0 && student.iepGoal) {
    goals = [{ id: 'migrated-' + Date.now(), text: student.iepGoal, objectives: [] }];
  }

  if (goals.length > 0) {
    goals.forEach(function(goal) {
      html += renderGoalItem(goal);
    });
  }

  html += '</div>';
  html += '<button type="button" class="btn btn-sm btn-secondary" onclick="addGoal()" style="margin-top:8px;">+ Add Goal</button>';
  html += '</div>';

  // ─── Section 3: Check-In History placeholder ───
  html += '<div id="checkin-history-section"></div>';

  container.innerHTML = html;
  animateContentIn(container);

  // Setup goals autosave listeners
  setupGoalsAutosave();
}

function renderGoalItem(goal) {
  var html = '<div class="profile-goal-item" data-goal-id="' + esc(goal.id) + '">';
  html += '<div class="profile-goal-header">' +
    '<span class="profile-goal-label">IEP Goal</span>' +
    '<button class="goal-remove-btn" onclick="removeGoal(\'' + esc(goal.id) + '\')" title="Remove goal">' +
      '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>' +
    '</button>' +
  '</div>';
  html += '<textarea class="profile-goal-textarea" data-field="goal-text" placeholder="Enter IEP goal...">' + esc(goal.text || '') + '</textarea>';

  // Objectives
  html += '<div class="profile-objectives-list">';
  var objectives = goal.objectives || [];
  if (objectives.length > 0) {
    objectives.forEach(function(obj) {
      html += '<div class="profile-objective-item" data-obj-id="' + esc(obj.id) + '">' +
        '<textarea data-field="obj-text" placeholder="Enter objective...">' + esc(obj.text || '') + '</textarea>' +
        '<button class="goal-remove-btn" onclick="removeObjective(\'' + esc(goal.id) + '\', \'' + esc(obj.id) + '\')" title="Remove objective">' +
          '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>' +
        '</button>' +
      '</div>';
    });
  }
  html += '<button type="button" class="btn-ghost btn-sm" onclick="addObjective(\'' + esc(goal.id) + '\')" style="margin-top:4px;">+ Add Objective</button>';
  html += '</div>';

  html += '</div>';
  return html;
}

function toggleProfileClass(idx) {
  document.getElementById('profile-card-' + idx).classList.toggle('expanded');
}

function cancelStudentEdit() {
  if (appState.currentStudentId) {
    showStudentProfile(appState.currentStudentId);
  } else {
    showDashboard();
  }
}

function renderStudentForm(student) {
  var container = document.getElementById('student-form-container');
  var html = '<div class="form-card">';

  // Basic Info
  var gradeOptions = ['', '6', '7', '8'];
  var gradeHtml = '<select id="st-grade">';
  gradeOptions.forEach(function(g) {
    var sel = (String(student.grade || '') === g) ? ' selected' : '';
    gradeHtml += '<option value="' + g + '"' + sel + '>' + (g || '-- Select Grade --') + '</option>';
  });
  gradeHtml += '</select>';

  html += '<div class="form-section">' +
    '<div class="form-section-title">Basic Information</div>' +
    '<div class="form-row">' +
      '<div class="form-group"><label>First Name</label>' +
        '<input type="text" id="st-firstName" value="' + esc(student.firstName || '') + '" placeholder="First name"></div>' +
      '<div class="form-group"><label>Last Name</label>' +
        '<input type="text" id="st-lastName" value="' + esc(student.lastName || '') + '" placeholder="Last name"></div>' +
    '</div>' +
    '<div class="form-group"><label>Grade Level</label>' + gradeHtml + '</div>';

  // Case Manager dropdown
  var cmOptions = '<select id="st-caseManager">';
  cmOptions += '<option value="">-- No Case Manager --</option>';
  (appState.caseManagers || []).forEach(function(cm) {
    var sel = (String(student.caseManagerEmail || '') === cm.email) ? ' selected' : '';
    cmOptions += '<option value="' + esc(cm.email) + '"' + sel + '>' + esc(cm.name) + '</option>';
  });
  cmOptions += '</select>';

  var cmDisplayHtml = '';
  if (student.id && student.caseManagerEmail) {
    var cmName = getCaseManagerName(student.caseManagerEmail);
    cmDisplayHtml = '<div class="case-manager-display" style="margin-top:4px;">' +
      '<span style="font-size:12px;color:var(--md-on-surface-variant);">Assigned: ' + esc(cmName) + '</span>' +
      '<a href="mailto:' + esc(student.caseManagerEmail) + '" class="btn-icon" title="Email case manager" style="width:28px;height:28px;">' +
        '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>' +
      '</a>' +
    '</div>';
  }

  html += '<div class="form-group"><label>Case Manager</label>' + cmOptions + cmDisplayHtml + '</div>' +
  '</div>';

  // Focus & Support
  html += '<div class="form-section">' +
    '<div class="form-section-title">Focus &amp; Support</div>' +
    '<div class="form-group"><label>Focus Goal</label>' +
      '<input type="text" id="st-focusGoal" value="' + esc(student.focusGoal || '') + '" placeholder="Executive function focus area"></div>' +
    '<div class="form-group"><label>Accommodations</label>' +
      '<textarea id="st-accommodations" placeholder="IEP accommodations, 504 plan details, etc.">' + esc(student.accommodations || '') + '</textarea></div>' +
    '<div class="form-group"><label>Notes</label>' +
      '<textarea id="st-notes" placeholder="Additional notes">' + esc(student.notes || '') + '</textarea></div>' +
  '</div>';

  // IEP Goal
  html += '<div class="form-section">' +
    '<div class="form-section-title">IEP Goal</div>' +
    '<div class="form-group"><label>Current IEP Goal</label>' +
      '<textarea id="st-iepGoal" placeholder="Enter the student\'s current IEP goal">' + esc(student.iepGoal || '') + '</textarea></div>' +
  '</div>';

  // Classes
  html += '<div class="form-section">' +
    '<div class="form-section-title">Classes</div>' +
    '<div id="class-list-container">';

  var classes = student.classes || [];
  classes.forEach(function(cls, idx) {
    html += renderClassRow(cls, idx);
  });

  html += '</div>' +
    '<button type="button" class="btn btn-sm btn-secondary" onclick="addClass()" style="margin-top:8px;">+ Add Class</button>' +
  '</div>';

  // Action buttons
  html += '<div style="display:flex;gap:8px;justify-content:space-between;margin-top:24px;">' +
    '<div>';
  if (student.id) {
    html += '<button class="btn btn-danger" onclick="confirmDeleteStudent(\'' + student.id + '\')">Delete Student</button>';
  }
  html += '</div>' +
    '<div style="display:flex;gap:8px;">' +
      '<button class="btn btn-secondary" onclick="cancelStudentEdit()">Cancel</button>' +
      '<button class="btn btn-primary" onclick="saveStudentForm()">Save Student</button>' +
    '</div>' +
  '</div>';

  html += '</div>'; // form-card

  // Placeholder for check-in history (filled later)
  if (student.id) {
    html += '<div id="checkin-history-section"></div>';
  }

  container.innerHTML = html;
}

function renderClassRow(cls, idx) {
  var name = '';
  var period = '';
  if (typeof cls === 'string') {
    name = cls;
  } else if (cls) {
    name = cls.name || '';
    period = cls.period || '';
  }

  var isOther = name !== '' && PRELOADED_CLASSES.indexOf(name) === -1;

  var html = '<div class="class-list-item" data-class-idx="' + idx + '">';

  // Class name select
  html += '<select class="class-select" onchange="handleClassSelect(this)">';
  html += '<option value="">-- Select Class --</option>';
  PRELOADED_CLASSES.forEach(function(c) {
    var sel = (name === c) ? ' selected' : '';
    html += '<option value="' + esc(c) + '"' + sel + '>' + esc(c) + '</option>';
  });
  html += '<option value="__other__"' + (isOther ? ' selected' : '') + '>+ Add Other</option>';
  html += '</select>';

  // Other text input (hidden unless "Other" selected)
  html += '<input type="text" class="class-other-input"' +
    (isOther ? '' : ' style="display:none"') +
    ' value="' + esc(isOther ? name : '') + '" placeholder="Enter class name">';

  // Period select
  html += '<select class="class-period-select">';
  html += '<option value="">Period</option>';
  for (var p = 1; p <= 7; p++) {
    var pSel = (String(period) === String(p)) ? ' selected' : '';
    html += '<option value="' + p + '"' + pSel + '>' + p + '</option>';
  }
  html += '</select>';

  // Remove button
  html += '<button type="button" class="btn-remove-class" onclick="removeClass(this)">&times;</button>';
  html += '</div>';
  return html;
}

function handleClassSelect(select) {
  var otherInput = select.parentElement.querySelector('.class-other-input');
  if (select.value === '__other__') {
    otherInput.style.display = '';
    otherInput.focus();
  } else {
    otherInput.style.display = 'none';
    otherInput.value = '';
  }
}

function addClass() {
  var container = document.getElementById('class-list-container');
  var idx = container.querySelectorAll('.class-list-item').length;
  var div = document.createElement('div');
  div.innerHTML = renderClassRow({ name: '', period: '' }, idx);
  container.appendChild(div.firstChild);
}

function removeClass(btn) {
  btn.parentElement.remove();
}

function saveStudentForm() {
  var classItems = document.querySelectorAll('#class-list-container .class-list-item');
  var classes = [];
  classItems.forEach(function(item) {
    var select = item.querySelector('.class-select');
    var otherInput = item.querySelector('.class-other-input');
    var periodSelect = item.querySelector('.class-period-select');

    var name = select.value === '__other__' ? otherInput.value.trim() : select.value;
    var period = periodSelect.value;

    if (name) classes.push({ name: name, period: period });
  });

  var profile = {
    id: appState.currentStudentId || null,
    firstName: document.getElementById('st-firstName').value.trim(),
    lastName: document.getElementById('st-lastName').value.trim(),
    grade: document.getElementById('st-grade').value,
    period: '',
    focusGoal: document.getElementById('st-focusGoal').value.trim(),
    accommodations: document.getElementById('st-accommodations').value.trim(),
    iepGoal: document.getElementById('st-iepGoal').value.trim(),
    notes: document.getElementById('st-notes').value.trim(),
    caseManagerEmail: document.getElementById('st-caseManager').value,
    classes: classes
  };

  if (!profile.firstName || !profile.lastName) {
    showToast('First and last name are required');
    return;
  }

  // Optimistic UI: update local state and navigate immediately
  if (profile.id) {
    appState.dashboardData.forEach(function(s) {
      if (s.id === profile.id) {
        s.firstName = profile.firstName;
        s.lastName = profile.lastName;
        s.grade = profile.grade;
        s.focusGoal = profile.focusGoal;
        s.iepGoal = profile.iepGoal;
        s.classes = profile.classes;
        s.caseManagerEmail = profile.caseManagerEmail;
      }
    });
  } else {
    appState.dashboardData.push({
      id: '__pending_' + Date.now(),
      firstName: profile.firstName, lastName: profile.lastName,
      grade: profile.grade, period: '',
      focusGoal: profile.focusGoal, iepGoal: profile.iepGoal,
      classes: profile.classes,
      caseManagerEmail: profile.caseManagerEmail,
      totalCheckIns: 0, latestWeek: null, latestMicroGoal: null,
      avgRating: null, trend: 'none', gpa: null,
      totalMissing: 0, academicData: []
    });
  }

  if (appState.currentStudentId) {
    showStudentProfile(appState.currentStudentId);
  } else {
    renderDashboard(appState.dashboardData);
    showView('dashboard-view');
  }
  showToast('Saving\u2026');

  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showToast('Student saved');
        loadDashboard();
      }
    })
    .withFailureHandler(function(err) {
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
      loadDashboard();
    })
    .saveStudent(profile);
}

function confirmDeleteStudent(studentId) {
  showConfirmDialog({
    title: 'Delete Student?',
    body: 'This will permanently delete this student and all their check-in records.',
    confirmLabel: 'Delete',
    onConfirm: "doDeleteStudent('" + studentId + "')"
  });
}

function doDeleteStudent(studentId) {
  // Optimistic UI: remove from local state immediately
  appState.dashboardData = appState.dashboardData.filter(function(s) { return s.id !== studentId; });
  renderDashboard(appState.dashboardData);
  showView('dashboard-view');
  showToast('Deleting\u2026');

  google.script.run
    .withSuccessHandler(function() {
      showToast('Student deleted');
      loadDashboard();
    })
    .withFailureHandler(function(err) {
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
      loadDashboard();
    })
    .deleteStudent(studentId);
}

// ─── Check-In History (inside student profile) ───
function renderCheckInHistory(checkIns, student) {
  var section = document.getElementById('checkin-history-section');
  if (!section) return;

  var html = '<div class="form-card" style="margin-top:20px;">' +
    '<div class="form-section-title" style="display:flex;justify-content:space-between;align-items:center;">' +
      '<span>Check-In History (' + checkIns.length + ')</span>' +
      '<button class="btn btn-sm btn-primary" onclick="startCheckIn(\'' + student.id + '\')">New Check-In</button>' +
    '</div>';

  if (checkIns.length === 0) {
    html += '<p class="hint" style="margin-top:12px;">No check-ins recorded yet.</p>';
  } else {
    checkIns.forEach(function(ci) {
      var ratings = [
        Number(ci.planningRating), Number(ci.followThroughRating),
        Number(ci.regulationRating), Number(ci.focusGoalRating),
        Number(ci.effortRating)
      ].filter(function(r) { return !isNaN(r) && r > 0; });

      var avg = ratings.length > 0
        ? (ratings.reduce(function(a,b){ return a+b; }, 0) / ratings.length).toFixed(1)
        : '--';
      var avgClass = avg !== '--'
        ? (avg >= 4 ? 'chip-green' : avg >= 3 ? 'chip-yellow' : 'chip-red')
        : 'chip-gray';

      html += '<div class="history-card" onclick="editCheckIn(\'' + ci.id + '\', \'' + student.id + '\')">' +
        '<div class="history-card-header">' +
          '<span class="history-card-date">' + esc(formatDateDisplay(ci.weekOf) || 'No date') + '</span>' +
          '<span class="chip ' + avgClass + '">Avg: ' + avg + '</span>' +
        '</div>' +
        '<div class="history-ratings">' +
          '<span class="history-rating-item">Plan: <span>' + (ci.planningRating || '-') + '</span></span>' +
          '<span class="history-rating-item">Follow: <span>' + (ci.followThroughRating || '-') + '</span></span>' +
          '<span class="history-rating-item">Reg: <span>' + (ci.regulationRating || '-') + '</span></span>' +
          '<span class="history-rating-item">Focus: <span>' + (ci.focusGoalRating || '-') + '</span></span>' +
          '<span class="history-rating-item">Effort: <span>' + (ci.effortRating || '-') + '</span></span>' +
        '</div>';

      if (ci.microGoal) {
        html += '<div class="history-goal">Goal: ' + esc(ci.microGoal) + '</div>';
      }

      html += '<div style="margin-top:8px;text-align:right;">' +
        '<button class="action-btn" onclick="event.stopPropagation(); confirmDeleteCheckIn(\'' + ci.id + '\', \'' + student.id + '\')">Delete</button>' +
      '</div>';

      html += '</div>';
    });
  }

  html += '</div>';
  section.innerHTML = html;
}

function editCheckIn(checkInId, studentId) {
  showCheckInSkeleton();
  showView('checkin-view');
  google.script.run
    .withSuccessHandler(function(checkIns) {
      var ci = checkIns.find(function(c) { return c.id === checkInId; });
      if (ci) {
        startCheckIn(studentId, ci);
      } else {
        showToast('Check-in not found');
      }
    })
    .withFailureHandler(function(err) { showToast('Error: ' + (err && err.message ? err.message : String(err))); })
    .getCheckIns(studentId);
}

function confirmDeleteCheckIn(checkInId, studentId) {
  showConfirmDialog({
    title: 'Delete Check-In?',
    body: 'This check-in record will be permanently deleted.',
    confirmLabel: 'Delete',
    onConfirm: "doDeleteCheckIn('" + checkInId + "', '" + studentId + "')"
  });
}

function doDeleteCheckIn(checkInId, studentId) {
  // Optimistic UI: hide the card immediately
  var cards = document.querySelectorAll('.history-card');
  cards.forEach(function(card) {
    if (card.getAttribute('onclick') && card.getAttribute('onclick').indexOf(checkInId) !== -1) {
      card.style.opacity = '0.4';
      card.style.pointerEvents = 'none';
    }
  });
  showToast('Deleting check-in\u2026');

  google.script.run
    .withSuccessHandler(function() {
      showToast('Check-in deleted');
      editStudent(studentId);
    })
    .withFailureHandler(function(err) {
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
      cards.forEach(function(card) {
        card.style.opacity = '';
        card.style.pointerEvents = '';
      });
    })
    .deleteCheckIn(checkInId);
}

// ─── Teacher Feedback Menu ───

function renderStudentMenu(studentId) {
  var container = document.getElementById('student-menu-container');
  if (!container) return;
  if (!studentId) { container.innerHTML = ''; return; }

  var links = appState.feedbackLinks || {};
  var hasSheet = links.sheetUrl ? true : false;

  var items =
    '<button class="dropdown-item" onclick="editStudentInfo()">Edit Student</button>' +
    '<button class="dropdown-item" onclick="printStudentReport()">Print Missing Work &amp; Grades</button>' +
    '<button class="dropdown-item" onclick="handleFeedbackClick()">Request Teacher Feedback</button>';
  if (hasSheet) {
    items += '<button class="dropdown-item" onclick="handleViewFeedbackClick()">View Teacher Feedback</button>';
  }

  container.innerHTML =
    '<div class="menu-anchor">' +
      '<button class="btn-icon" onclick="toggleStudentMenu(event)" aria-label="More options">' +
        '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>' +
      '</button>' +
      '<div class="dropdown-menu" id="student-dropdown">' +
        items +
      '</div>' +
    '</div>';
}

function editStudentInfo() {
  closeStudentMenu();
  var studentId = appState.currentStudentId;
  if (!studentId) return;

  var student = appState.currentStudent;
  if (student) {
    document.getElementById('student-view-breadcrumb').innerHTML =
      '<button class="breadcrumb-link" onclick="showStudentProfile(appState.currentStudentId)">Student Profile</button> ' +
      '<svg class="breadcrumb-chevron" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg> Edit';
    renderStudentForm(student);
    renderStudentMenu(studentId);
    return;
  }

  // Fallback: fetch student data if not cached
  google.script.run
    .withSuccessHandler(function(students) {
      var s = (students || []).find(function(st) { return st.id === studentId; });
      if (!s) { showToast('Student not found'); return; }
      appState.currentStudent = s;
      document.getElementById('student-view-breadcrumb').innerHTML =
        '<button class="breadcrumb-link" onclick="showStudentProfile(appState.currentStudentId)">Student Profile</button> ' +
        '<svg class="breadcrumb-chevron" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg> Edit';
      renderStudentForm(s);
      renderStudentMenu(studentId);
    })
    .withFailureHandler(function(err) { showToast('Error: ' + (err && err.message ? err.message : String(err))); })
    .getStudents();
}

function toggleStudentMenu(e) {
  e.stopPropagation();
  var menu = document.getElementById('student-dropdown');
  if (!menu) return;
  var isOpen = menu.classList.contains('dropdown-open');
  if (isOpen) {
    menu.classList.remove('dropdown-open');
    document.removeEventListener('click', closeStudentMenu);
  } else {
    menu.classList.add('dropdown-open');
    setTimeout(function() {
      document.addEventListener('click', closeStudentMenu);
    }, 0);
  }
}

function closeStudentMenu() {
  var menu = document.getElementById('student-dropdown');
  if (menu) menu.classList.remove('dropdown-open');
  document.removeEventListener('click', closeStudentMenu);
}

function printStudentReport() {
  closeStudentMenu();
  var student = appState.currentStudent;
  if (!student) {
    student = appState.dashboardData.find(function(s) { return s.id === appState.currentStudentId; });
  }
  if (!student) { showToast('Student data not available'); return; }

  var name = (student.firstName || '') + ' ' + (student.lastName || '');
  var grade = student.grade || '--';
  var academicData = student.academicData || [];
  var classes = student.classes || [];

  // Build sorted schedule
  var sortedClasses = classes.slice().sort(function(a, b) {
    return (parseInt(a.period) || 999) - (parseInt(b.period) || 999);
  });

  var html = '<!DOCTYPE html><html><head><title>Report - ' + esc(name) + '</title>' +
    '<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">' +
    '<style>' +
    'body { font-family: "Roboto", Arial, sans-serif; color: #201A1A; margin: 0; padding: 24px 32px; font-size: 13px; -webkit-font-smoothing: antialiased; }' +
    '.report-logo { text-align: center; margin-bottom: 16px; }' +
    '.report-logo img { height: 48px; }' +
    'h1 { font-size: 20px; margin: 0 0 4px; }' +
    '.subtitle { color: #534343; font-size: 13px; margin-bottom: 20px; }' +
    'h2 { font-size: 15px; font-weight: 500; margin: 20px 0 8px; padding-bottom: 4px; border-bottom: 2px solid #C41E3A; }' +
    'table { width: 100%; border-collapse: collapse; margin-bottom: 16px; }' +
    'th, td { padding: 6px 10px; text-align: left; border-bottom: 1px solid #D8C2C2; }' +
    'th { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #534343; background: #F9EAEA; font-weight: 500; }' +
    '.period-col { width: 60px; text-align: center; }' +
    '.grade-col { width: 60px; text-align: center; }' +
    '.missing-col { width: 80px; text-align: center; }' +
    '.grade-good { color: #1B5E20; font-weight: 500; }' +
    '.grade-mid { color: #7A5900; font-weight: 500; }' +
    '.grade-low { color: #BA1A1A; font-weight: 500; }' +
    '.badge { display: inline-block; min-width: 22px; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; text-align: center; }' +
    '.badge-green { background: #D6F5D6; color: #1B5E20; }' +
    '.badge-yellow { background: #FFF3CD; color: #7A5900; }' +
    '.badge-red { background: #FFDAD6; color: #410006; }' +
    '.missing-section { margin-left: 16px; margin-bottom: 12px; }' +
    '.missing-section h3 { font-size: 13px; font-weight: 500; margin: 8px 0 4px; }' +
    '.type-tag { font-size: 11px; padding: 1px 6px; border-radius: 4px; }' +
    '.type-formative { background: #E3F2FD; color: #0D47A1; }' +
    '.type-summative { background: #FCE4EC; color: #880E4F; }' +
    '.gpa-bar { padding: 8px 12px; background: #F9EAEA; border-radius: 8px; margin-bottom: 12px; display: flex; gap: 16px; align-items: center; }' +
    '.gpa-bar .label { font-size: 12px; color: #534343; }' +
    '.gpa-bar .value { font-size: 16px; font-weight: 600; }' +
    '.footer { margin-top: 24px; font-size: 11px; color: #857373; text-align: center; }' +
    '@media print { body { padding: 12px 16px; } }' +
    '</style></head><body>';

  // Logo + Header
  html += '<div class="report-logo"><img src="https://resources.finalsite.net/images/f_auto,q_auto/v1593114034/richfieldschoolsorg/nevtdqxgci8pdkldabzj/MS_Horiz_C.png" alt="Richfield Middle School"></div>';
  html += '<h1>' + esc(name) + '</h1>';
  var subtitleParts = ['Grade ' + esc(grade)];
  var cmEmail = student.caseManagerEmail || '';
  if (cmEmail) {
    var cmName = getCaseManagerName(cmEmail);
    subtitleParts.push('Case Manager: ' + esc(cmName) + ' (' + esc(cmEmail) + ')');
  }
  subtitleParts.push('Printed ' + new Date().toLocaleDateString());
  html += '<div class="subtitle">' + subtitleParts.join(' &bull; ') + '</div>';

  // Schedule section
  if (sortedClasses.length > 0) {
    html += '<h2>Schedule</h2>';
    html += '<table><thead><tr><th class="period-col">Period</th><th>Class</th></tr></thead><tbody>';
    sortedClasses.forEach(function(cl) {
      html += '<tr><td class="period-col">' + esc(cl.period ? String(cl.period) : '--') + '</td>' +
        '<td>' + esc(cl.name || 'Unknown') + '</td></tr>';
    });
    html += '</tbody></table>';
  }

  // Classes with Grades section
  if (academicData.length > 0) {
    var totalMissing = 0;
    academicData.forEach(function(c) { totalMissing += (Number(c.missing) || 0); });

    // GPA bar
    html += '<h2>Classes &amp; Grades</h2>';
    html += '<div class="gpa-bar">';
    if (student.gpa != null) {
      var gpaClass = student.gpa >= 3.5 ? 'grade-good' : student.gpa >= 2.5 ? 'grade-mid' : 'grade-low';
      html += '<span class="label">GPA</span><span class="value ' + gpaClass + '">' + student.gpa.toFixed(2) + '</span>';
    }
    html += '<span class="label" style="margin-left:auto;">Total Missing</span><span class="value ' + (totalMissing === 0 ? 'grade-good' : 'grade-low') + '">' + totalMissing + '</span>';
    html += '</div>';

    // Grades table
    html += '<table><thead><tr><th>Class</th><th class="grade-col">Grade</th><th class="missing-col">Missing</th></tr></thead><tbody>';
    academicData.forEach(function(c) {
      var missingNum = Number(c.missing) || 0;
      var badgeClass = missingNum === 0 ? 'badge-green' : missingNum <= 3 ? 'badge-yellow' : 'badge-red';
      var classLabel = c.className || 'Unknown';
      var matchedClass = (student.classes || []).find(function(cl) { return cl.name === c.className; });
      if (matchedClass && matchedClass.period) classLabel += ' (P' + matchedClass.period + ')';

      var gradeVal = GPA_MAP[c.grade];
      var gradeClass = gradeVal != null ? (gradeVal >= 3.0 ? 'grade-good' : gradeVal >= 2.0 ? 'grade-mid' : 'grade-low') : '';

      html += '<tr><td>' + esc(classLabel) + '</td>' +
        '<td class="grade-col ' + gradeClass + '">' + esc(c.grade || '--') + '</td>' +
        '<td class="missing-col"><span class="badge ' + badgeClass + '">' + missingNum + '</span></td></tr>';
    });
    html += '</tbody></table>';

    // Missing work detail
    var hasMissing = academicData.some(function(c) { return (c.missingAssignments || []).length > 0; });
    if (hasMissing) {
      html += '<h2>Missing Work Detail</h2>';
      academicData.forEach(function(c) {
        var assignments = c.missingAssignments || [];
        if (assignments.length === 0) return;
        var classLabel = c.className || 'Unknown';
        var matchedClass = (student.classes || []).find(function(cl) { return cl.name === c.className; });
        if (matchedClass && matchedClass.period) classLabel += ' (P' + matchedClass.period + ')';

        html += '<div class="missing-section"><h3>' + esc(classLabel) + ' (' + assignments.length + ')</h3>';
        html += '<table><thead><tr><th>Assignment</th><th>Type</th></tr></thead><tbody>';
        assignments.slice().sort(function(a, b) {
          return (a.name || '').localeCompare(b.name || '');
        }).forEach(function(a) {
          var typeClass = a.type === 'Summative' ? 'type-summative' : a.type === 'Formative' ? 'type-formative' : '';
          html += '<tr><td>' + esc(a.name || 'Untitled') + '</td>' +
            '<td><span class="type-tag ' + typeClass + '">' + esc(a.type || 'Unknown') + '</span></td></tr>';
        });
        html += '</tbody></table></div>';
      });
    }
  } else {
    html += '<h2>Classes &amp; Grades</h2>';
    html += '<p style="color:#534343;">No academic data from the latest check-in.</p>';
  }

  html += '<div class="footer">Richfield Public Schools</div>';
  html += '</body></html>';

  var printWindow = window.open('', '_blank');
  if (printWindow) {
    printWindow.document.write(html);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
  } else {
    showToast('Please allow pop-ups to print the report');
  }
}

function handleFeedbackClick() {
  closeStudentMenu();
  var links = appState.feedbackLinks || {};
  if (links.formUrl) {
    window.open(links.formUrl, '_blank');
  } else {
    showFeedbackSetupModal();
  }
}

function handleViewFeedbackClick() {
  closeStudentMenu();
  var links = appState.feedbackLinks || {};
  if (links.sheetUrl) {
    window.open(links.sheetUrl, '_blank');
  }
}

function showFeedbackSetupModal() {
  var existing = appState.feedbackLinks || {};
  var overlay = document.createElement('div');
  overlay.className = 'confirm-overlay';
  overlay.id = 'feedback-modal-overlay';
  overlay.innerHTML =
    '<div class="confirm-dialog" style="max-width:480px;">' +
      '<h3>Teacher Feedback Setup</h3>' +
      '<p>Enter the links for teacher feedback collection.</p>' +
      '<div class="form-group" style="margin-bottom:16px;">' +
        '<label>Teacher Feedback Google Form</label>' +
        '<input type="url" id="fb-form-url" value="' + esc(existing.formUrl || '') + '" placeholder="https://docs.google.com/forms/...">' +
      '</div>' +
      '<div class="form-group" style="margin-bottom:24px;">' +
        '<label>Teacher Feedback Google Sheet</label>' +
        '<input type="url" id="fb-sheet-url" value="' + esc(existing.sheetUrl || '') + '" placeholder="https://docs.google.com/spreadsheets/...">' +
      '</div>' +
      '<div class="confirm-actions">' +
        '<button class="btn btn-secondary" onclick="document.getElementById(\'feedback-modal-overlay\').remove()">Cancel</button>' +
        '<button class="btn btn-primary" onclick="saveFeedbackSetup()">Save &amp; Open Form</button>' +
      '</div>' +
    '</div>';
  document.body.appendChild(overlay);
}

function saveFeedbackSetup() {
  var formUrl = document.getElementById('fb-form-url').value.trim();
  var sheetUrl = document.getElementById('fb-sheet-url').value.trim();

  if (!formUrl) {
    showToast('Please enter a Google Form URL');
    return;
  }

  var links = { formUrl: formUrl, sheetUrl: sheetUrl };

  // Optimistic: update local state
  appState.feedbackLinks = links;
  document.getElementById('feedback-modal-overlay').remove();

  // Re-render menu to show "View Teacher Feedback" if sheet URL was provided
  renderStudentMenu(appState.currentStudentId);

  // Open form immediately
  window.open(formUrl, '_blank');
  showToast('Saving feedback links\u2026');

  google.script.run
    .withSuccessHandler(function() { showToast('Feedback links saved'); })
    .withFailureHandler(function(err) {
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
    })
    .saveFeedbackLinks(links);
}

// ─── Co-Teacher Invite Modal ───

function showInviteModal(invite, isNewUser) {
  document.getElementById('navbar').style.display = '';
  document.getElementById('tab-bar').style.display = '';
  showView('auth-loading'); // keep loading state visible behind the modal
  if (!isNewUser) showView('dashboard-view');

  var overlay = document.createElement('div');
  overlay.className = 'confirm-overlay';
  overlay.id = 'invite-modal-overlay';
  overlay.innerHTML =
    '<div class="confirm-dialog" style="max-width:440px;">' +
      '<h3>Team Invitation</h3>' +
      '<p><strong>' + esc(invite.inviterEmail) + '</strong> has invited you to collaborate on their caseload. You will share the same students and check-in data.</p>' +
      (isNewUser
        ? '<p class="hint">Accepting will set up your account with their shared caseload. You can also decline and create your own.</p>'
        : '<p class="hint">Accepting will switch you to their shared caseload. Your own data will be preserved and can be restored if you leave the team later.</p>') +
      '<div class="confirm-actions">' +
        '<button class="btn btn-secondary" onclick="declineInvite(' + (isNewUser ? 'true' : 'false') + ')">Decline</button>' +
        '<button class="btn btn-primary" onclick="acceptInvite(' + (isNewUser ? 'true' : 'false') + ')">Accept &amp; Join</button>' +
      '</div>' +
    '</div>';
  document.body.appendChild(overlay);
}

function acceptInvite(isNewUser) {
  var modal = document.getElementById('invite-modal-overlay');
  if (modal) modal.innerHTML =
    '<div class="confirm-dialog" style="max-width:440px;text-align:center;">' +
      '<div class="provision-spinner"></div>' +
      '<p>Joining team\u2026</p>' +
    '</div>';

  google.script.run
    .withSuccessHandler(function(result) {
      if (modal) modal.remove();
      if (result.success) {
        showToast('Joined team successfully!');
        enterApp();
      } else {
        showToast(result.error || 'Error joining team');
        if (isNewUser) location.reload();
      }
    })
    .withFailureHandler(function(err) {
      if (modal) modal.remove();
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
      if (isNewUser) location.reload();
    })
    .acceptCoTeacherInvite();
}

function declineInvite(isNewUser) {
  var modal = document.getElementById('invite-modal-overlay');
  if (modal) modal.remove();

  google.script.run
    .withSuccessHandler(function() {
      if (isNewUser) {
        // Show onboarding since they don't have their own spreadsheet yet
        google.script.run
          .withSuccessHandler(function(status) { showOnboarding(status); })
          .withFailureHandler(function() { location.reload(); })
          .getUserStatus();
      }
    })
    .withFailureHandler(function() {})
    .declineCoTeacherInvite();
}

// ─── Co-Teacher Management View ───

function showCoTeachers() {
  document.querySelectorAll('.nav-tab').forEach(function(t) { t.classList.remove('active'); });
  var teamTab = document.getElementById('tab-team');
  if (teamTab) teamTab.classList.add('active');
  showView('coteacher-view');
  document.getElementById('coteacher-content-container').innerHTML =
    '<div class="skeleton-fade-in"><div class="form-card">' +
      '<div class="skeleton skeleton-section-title" style="width:30%;"></div>' +
      '<div class="skeleton skeleton-input" style="margin-bottom:12px;"></div>' +
      '<div class="skeleton skeleton-input" style="margin-bottom:12px;"></div>' +
    '</div></div>';

  google.script.run
    .withSuccessHandler(function(teamInfo) {
      try { renderCoTeacherView(teamInfo); }
      catch(e) { showToast('Render error: ' + e.message); }
    })
    .withFailureHandler(function(err) {
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
    })
    .getTeamInfo();
}

function getRoleDisplayName(role) {
  switch(String(role).toLowerCase()) {
    case 'caseload-manager':
    case 'owner': return 'Caseload Manager';
    case 'service-provider': return 'Service Provider';
    case 'para': return 'Para';
    case 'co-teacher': return 'Co-Teacher';
    default: return role;
  }
}

function renderCoTeacherView(teamInfo) {
  var container = document.getElementById('coteacher-content-container');
  var isCaseloadManager = teamInfo.currentUserRole === 'caseload-manager';
  var html = '';

  // Role banner
  html += '<div class="ct-role-banner ' + (isCaseloadManager ? 'ct-role-caseload-manager' : 'ct-role-coteacher') + '">' +
    '<span class="ct-role-label">Your role:</span> ' +
    '<span class="ct-role-value">' + getRoleDisplayName(teamInfo.currentUserRole) + '</span>' +
  '</div>';

  // Team members
  html += '<div class="form-card">' +
    '<div class="form-section-title">Team Members</div>';

  teamInfo.members.forEach(function(m) {
    var emailStr = String(m.email || '');
    var roleStr = getRoleDisplayName(m.role);
    var isSelf = emailStr.toLowerCase() === (appState.currentUserEmail || '').toLowerCase();

    html += '<div class="ct-member-row">' +
      '<div class="ct-member-info">' +
        '<span class="ct-member-email">' + esc(emailStr) + '</span>' +
        '<span class="ct-member-role">' + roleStr + (isSelf ? ' (you)' : '') + '</span>' +
      '</div>';

    if (isCaseloadManager && m.role !== 'caseload-manager') {
      html += '<button class="btn btn-sm btn-danger" onclick="confirmRemoveTeamMember(\'' + esc(emailStr) + '\')">Remove</button>';
    }

    html += '</div>';
  });

  html += '</div>';

  // Add team member form (caseload manager only)
  if (isCaseloadManager) {
    html += '<div class="form-card">' +
      '<div class="form-section-title">Add Team Member</div>' +
      '<p class="hint">Enter the email address and role of the person you want to invite. They will receive the invite the next time they open the app. All roles have full access to caseload data.</p>' +
      '<div class="ct-add-form">' +
        '<input type="email" id="ct-add-email" placeholder="colleague@school.edu" class="ct-email-input">' +
        '<select id="ct-add-role" class="ct-role-select">' +
          '<option value="service-provider">Service Provider</option>' +
          '<option value="para">Para</option>' +
          '<option value="co-teacher">Co-Teacher</option>' +
        '</select>' +
        '<button class="btn btn-primary" onclick="addTeamMemberFromForm()">Send Invite</button>' +
      '</div>' +
    '</div>';
  }

  // Leave team (non-caseload-manager only)
  if (!isCaseloadManager) {
    html += '<div class="form-card">' +
      '<div class="form-section-title">Leave Team</div>' +
      '<p class="hint">Leaving will disconnect you from this shared caseload. If you previously had your own data, it will be restored.</p>' +
      '<button class="btn btn-danger" style="margin-top:4px;" onclick="confirmLeaveTeam()">Leave Team</button>' +
    '</div>';
  }

  container.innerHTML = html;
  animateContentIn(container);
}

function addTeamMemberFromForm() {
  var input = document.getElementById('ct-add-email');
  var roleSelect = document.getElementById('ct-add-role');
  var email = (input.value || '').trim();
  var role = roleSelect.value;
  if (!email) { showToast('Please enter an email address'); return; }
  if (!role) { showToast('Please select a role'); return; }

  showToast('Sending invite\u2026');

  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showToast('Invite sent to ' + email);
        showCoTeachers(); // refresh
      } else {
        showToast(result.error || 'Error sending invite');
      }
    })
    .withFailureHandler(function(err) {
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
    })
    .addTeamMember(email, role);
}

function confirmRemoveTeamMember(email) {
  showConfirmDialog({
    title: 'Remove Team Member?',
    body: 'This will revoke <strong>' + esc(email) + '</strong>\u2019s access to the shared caseload.',
    confirmLabel: 'Remove',
    onConfirm: "doRemoveTeamMember('" + esc(email) + "')"
  });
}

function doRemoveTeamMember(email) {
  showToast('Removing team member\u2026');
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showToast('Team member removed');
        showCoTeachers();
      } else {
        showToast(result.error || 'Error removing team member');
      }
    })
    .withFailureHandler(function(err) {
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
    })
    .removeTeamMember(email);
}

function confirmLeaveTeam() {
  showConfirmDialog({
    title: 'Leave Team?',
    body: 'You will be disconnected from this shared caseload. If you had your own data before joining, it will be restored.',
    confirmLabel: 'Leave',
    onConfirm: 'doLeaveTeam()'
  });
}

function doLeaveTeam() {
  showToast('Leaving team\u2026');
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showToast('You have left the team');
        location.reload();
      }
    })
    .withFailureHandler(function(err) {
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
    })
    .leaveCoTeacherTeam();
}

// ─── Dashboard Refresh (for co-teacher data freshness) ───
function refreshDashboard() {
  if (Object.keys(_persistTimers).length > 0 || _persistInFlight > 0) {
    renderDashboard(appState.dashboardData);
    showToast('Saving changes\u2026 refresh will complete shortly.');
    return;
  }
  showDashboardSkeleton();
  google.script.run
    .withSuccessHandler(function(data) {
      try {
        appState.dashboardData = data || [];
        renderDashboard(data);
        // Also refresh My Caseload if that tab is active
        var mcTab = document.getElementById('tab-mycaseload');
        if (mcTab && mcTab.classList.contains('active')) {
          renderMyCaseload();
        }
        showToast('Dashboard refreshed');
      } catch(e) { showToast('Render error: ' + e.message); }
    })
    .withFailureHandler(function(err) {
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
    })
    .refreshDashboardData();
}

// ─── Skeleton Loading Functions ───
function showDashboardSkeleton() {
  var container = document.getElementById('dashboard-table-container');
  var html = '<div class="skeleton-fade-in"><table class="skeleton-table"><thead><tr>' +
    '<th><div class="skeleton skeleton-text w-50" style="margin:0;"></div></th>' +
    '<th><div class="skeleton skeleton-text w-40" style="margin:0;"></div></th>' +
    '<th><div class="skeleton skeleton-text w-30" style="margin:0;"></div></th>' +
    '<th><div class="skeleton skeleton-text w-30" style="margin:0;"></div></th>' +
    '<th><div class="skeleton skeleton-text w-25" style="margin:0;"></div></th>' +
    '<th><div class="skeleton skeleton-text w-30" style="margin:0;"></div></th>' +
    '<th><div class="skeleton skeleton-text w-40" style="margin:0;"></div></th>' +
    '<th><div class="skeleton skeleton-text w-30" style="margin:0;"></div></th>' +
  '</tr></thead><tbody>';
  for (var i = 0; i < 6; i++) {
    html += '<tr>' +
      '<td><div class="skeleton skeleton-text w-75" style="margin:0;"></div></td>' +
      '<td><div class="skeleton skeleton-text w-25" style="margin:0;"></div></td>' +
      '<td><div class="skeleton skeleton-chip"></div></td>' +
      '<td><div class="skeleton skeleton-text w-40" style="margin:0;"></div></td>' +
      '<td><div class="skeleton skeleton-chip"></div></td>' +
      '<td><div class="skeleton skeleton-chip"></div></td>' +
      '<td><div class="skeleton skeleton-text w-50" style="margin:0;"></div></td>' +
      '<td><div style="display:flex;gap:8px;"><div class="skeleton skeleton-btn"></div><div class="skeleton skeleton-btn" style="width:56px;"></div></div></td>' +
    '</tr>';
  }
  html += '</tbody></table></div>';
  container.innerHTML = html;
}

function showStudentProfileSkeleton() {
  var container = document.getElementById('student-form-container');
  var html = '<div class="skeleton-fade-in">';
  // Academics card
  html += '<div class="profile-section-card">' +
    '<div class="skeleton skeleton-section-title" style="width:20%;margin-bottom:16px;"></div>' +
    '<div style="display:flex;gap:16px;padding:12px 16px;background:var(--md-surface-container-low);border-radius:var(--md-shape-sm);margin-bottom:12px;">' +
      '<div class="skeleton skeleton-text w-20" style="margin:0;"></div>' +
      '<div class="skeleton skeleton-chip" style="width:64px;height:32px;"></div>' +
      '<div class="skeleton skeleton-text w-20" style="margin:0;margin-left:auto;"></div>' +
      '<div class="skeleton skeleton-chip" style="width:40px;height:32px;"></div>' +
    '</div>';
  for (var i = 0; i < 4; i++) {
    html += '<div style="border:1px solid var(--md-outline-variant);border-radius:var(--md-shape-md);padding:12px 16px;margin-bottom:4px;display:flex;justify-content:space-between;align-items:center;">' +
      '<div style="display:flex;gap:12px;align-items:center;">' +
        '<div class="skeleton skeleton-text w-30" style="margin:0;"></div>' +
        '<div class="skeleton skeleton-text" style="width:24px;margin:0;"></div>' +
      '</div>' +
      '<div class="skeleton skeleton-chip"></div>' +
    '</div>';
  }
  html += '</div>';
  // Goals card
  html += '<div class="profile-section-card">' +
    '<div class="skeleton skeleton-section-title" style="width:30%;margin-bottom:16px;"></div>' +
    '<div class="skeleton skeleton-input" style="height:80px;margin-bottom:16px;"></div>' +
    '<div class="skeleton skeleton-input" style="height:60px;margin-left:20px;"></div>' +
  '</div>';
  // Check-in history
  html += '<div class="profile-section-card">' +
    '<div class="skeleton skeleton-section-title" style="width:25%;margin-bottom:16px;"></div>';
  for (var j = 0; j < 2; j++) {
    html += '<div class="skeleton-card">' +
      '<div style="display:flex;justify-content:space-between;margin-bottom:12px;">' +
        '<div class="skeleton skeleton-text w-25" style="margin:0;"></div>' +
        '<div class="skeleton skeleton-chip"></div>' +
      '</div>' +
      '<div style="display:flex;gap:12px;flex-wrap:wrap;">' +
        '<div class="skeleton skeleton-text w-20" style="margin:0;"></div>' +
        '<div class="skeleton skeleton-text w-20" style="margin:0;"></div>' +
        '<div class="skeleton skeleton-text w-20" style="margin:0;"></div>' +
      '</div>' +
    '</div>';
  }
  html += '</div></div>';
  container.innerHTML = html;
}

function showCheckInSkeleton() {
  var container = document.getElementById('checkin-form-container');
  var html = '<div class="skeleton-fade-in">';
  // Previous goal banner skeleton
  html += '<div style="background:var(--md-surface-container);border-radius:var(--md-shape-md);padding:16px 20px;margin-bottom:24px;border:1px solid var(--md-outline-variant);">' +
    '<div class="skeleton skeleton-text w-20"></div>' +
    '<div class="skeleton skeleton-text w-50"></div>' +
    '<div class="skeleton skeleton-text w-30" style="height:10px;"></div>' +
  '</div>';
  html += '<div class="form-card">';
  // Week Of
  html += '<div class="skeleton-section">' +
    '<div class="skeleton skeleton-input" style="width:200px;"></div>' +
  '</div>';
  // EF Ratings section
  html += '<div class="skeleton-section">' +
    '<div class="skeleton skeleton-section-title" style="width:40%;"></div>';
  for (var i = 0; i < 5; i++) {
    html += '<div style="margin-bottom:16px;">' +
      '<div class="skeleton skeleton-text w-20" style="height:12px;"></div>' +
      '<div style="display:flex;gap:0;">' +
        '<div class="skeleton" style="width:48px;height:40px;border-radius:9999px 0 0 9999px;"></div>' +
        '<div class="skeleton" style="width:48px;height:40px;border-radius:0;"></div>' +
        '<div class="skeleton" style="width:48px;height:40px;border-radius:0;"></div>' +
        '<div class="skeleton" style="width:48px;height:40px;border-radius:0;"></div>' +
        '<div class="skeleton" style="width:48px;height:40px;border-radius:0 9999px 9999px 0;"></div>' +
      '</div>' +
    '</div>';
  }
  html += '</div>';
  // Reflection section
  html += '<div class="skeleton-section">' +
    '<div class="skeleton skeleton-section-title" style="width:20%;"></div>' +
    '<div class="skeleton skeleton-input" style="height:80px;"></div>' +
    '<div class="skeleton skeleton-input" style="height:80px;"></div>' +
  '</div>';
  // Micro Goal section
  html += '<div class="skeleton-section">' +
    '<div class="skeleton skeleton-section-title" style="width:20%;"></div>' +
    '<div class="skeleton skeleton-input"></div>' +
    '<div class="skeleton skeleton-input"></div>' +
  '</div>';
  // Buttons
  html += '<div style="display:flex;gap:8px;justify-content:flex-end;">' +
    '<div class="skeleton skeleton-btn" style="width:72px;height:40px;"></div>' +
    '<div class="skeleton skeleton-btn" style="width:110px;height:40px;"></div>' +
  '</div>';
  html += '</div></div>';
  container.innerHTML = html;
}

var _toastTimer = null;
function showToast(message) {
  var toast = document.getElementById('toast');
  if (_toastTimer) clearTimeout(_toastTimer);
  toast.textContent = message;
  toast.classList.remove('toast-hiding');
  toast.classList.add('show');
  _toastTimer = setTimeout(function() {
    toast.classList.add('toast-hiding');
    toast.classList.remove('show');
    _toastTimer = null;
  }, 3000);
}

function animateContentIn(container) {
  container.classList.add('content-fade-in');
  container.addEventListener('animationend', function handler() {
    container.classList.remove('content-fade-in');
    container.removeEventListener('animationend', handler);
  });
}

function esc(str) {
  if (str === null || str === undefined) return '';
  var div = document.createElement('div');
  div.textContent = String(str);
  return div.innerHTML;
}

function renderErrorState(message) {
  return '<div class="empty-state">' +
    '<h3>Unable to Load</h3>' +
    '<p>' + esc(message) + '</p>' +
    '<button class="btn btn-primary" style="margin-top:16px;" onclick="location.reload()">Reload</button>' +
  '</div>';
}

function showConfirmDialog(opts) {
  var overlay = document.createElement('div');
  overlay.className = 'confirm-overlay';
  if (opts.id) overlay.id = opts.id;
  overlay.innerHTML =
    '<div class="confirm-dialog"' + (opts.style ? ' style="' + opts.style + '"' : '') + '>' +
      '<h3>' + (opts.title || 'Confirm') + '</h3>' +
      '<p>' + (opts.body || '') + '</p>' +
      (opts.hint ? '<p class="hint">' + opts.hint + '</p>' : '') +
      '<div class="confirm-actions">' +
        '<button class="btn btn-secondary" onclick="closeConfirmDialog(this.closest(\'.confirm-overlay\'))">' + (opts.cancelLabel || 'Cancel') + '</button>' +
        '<button class="btn ' + (opts.confirmClass || 'btn-danger') + '" onclick="' + opts.onConfirm + '; closeConfirmDialog(this.closest(\'.confirm-overlay\'))">' + (opts.confirmLabel || 'Confirm') + '</button>' +
      '</div>' +
    '</div>';
  document.body.appendChild(overlay);
  return overlay;
}

function getStudentById(studentId) {
  return appState.dashboardData.find(function(s) { return s.id === studentId; });
}

function recalcTotalMissing(student) {
  student.totalMissing = (student.academicData || []).reduce(function(sum, c) {
    return sum + (Number(c.missing) || 0);
  }, 0);
}

/** Format a YYYY-MM-DD date string as "Mon. DD, YYYY" (e.g. "Feb. 24, 2026") */
function formatDateDisplay(dateStr) {
  if (!dateStr) return 'Never';
  var parts = dateStr.split('-');
  if (parts.length !== 3) return dateStr;
  var months = ['Jan.', 'Feb.', 'Mar.', 'Apr.', 'May', 'Jun.',
                'Jul.', 'Aug.', 'Sep.', 'Oct.', 'Nov.', 'Dec.'];
  var m = parseInt(parts[1], 10);
  var d = parseInt(parts[2], 10);
  if (isNaN(m) || isNaN(d)) return dateStr;
  return months[m - 1] + ' ' + d + ', ' + parts[0];
}

// ─── Onboarding Wizard ───

function showOnboarding(status) {
  onboardingState.email = status.email || '';
  onboardingState.step = 1;
  showView('onboarding-view');
  renderOnboardingStep();
}

function onboardingNext() {
  onboardingState.step++;
  renderOnboardingStep();
}

function renderOnboardingStep() {
  var container = document.getElementById('onboarding-container');
  var html = '';

  // Progress indicator
  html += '<div class="onboarding-progress">';
  for (var i = 1; i <= 3; i++) {
    var stepClass = i === onboardingState.step ? 'active' :
                    i < onboardingState.step ? 'completed' : '';
    html += '<div class="onboarding-step-dot ' + stepClass + '">' + i + '</div>';
    if (i < 3) html += '<div class="onboarding-step-line ' + (i < onboardingState.step ? 'completed' : '') + '"></div>';
  }
  html += '</div>';

  if (onboardingState.step === 1) {
    html += renderOnboardingWelcome();
  } else if (onboardingState.step === 2) {
    html += renderOnboardingProvision();
  } else if (onboardingState.step === 3) {
    html += renderOnboardingFirstStudent();
  }

  container.innerHTML = html;

  // Auto-trigger provisioning when step 2 renders
  if (onboardingState.step === 2) {
    triggerProvisioning();
  }
}

// ── Step 1: Welcome & Feature Highlights ──
function renderOnboardingWelcome() {
  var iconSvgs = {
    dashboard: '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>',
    check_circle: '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>',
    trending_up: '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/></svg>',
    school: '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82zM12 3L1 9l11 6 9-4.91V17h2V9L12 3z"/></svg>',
    insights: '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M21 8c-1.45 0-2.26 1.44-1.93 2.51l-3.55 3.56c-.3-.09-.74-.09-1.04 0l-2.55-2.55C12.27 10.45 11.46 9 10 9c-1.45 0-2.27 1.44-1.93 2.52l-4.56 4.55C2.44 15.74 1 16.55 1 18c0 1.1.9 2 2 2 1.45 0 2.26-1.44 1.93-2.51l4.55-4.56c.3.09.74.09 1.04 0l2.55 2.55C12.73 16.55 13.54 18 15 18c1.45 0 2.27-1.44 1.93-2.52l3.56-3.55C21.56 12.26 23 11.45 23 10c0-1.1-.9-2-2-2z"/></svg>'
  };

  var features = [
    { icon: 'dashboard', title: 'Caseload Dashboard', desc: 'See all your students at a glance with EF ratings, GPA, trends, and missing assignments.' },
    { icon: 'check_circle', title: 'Weekly Check-Ins', desc: 'Rate executive function skills across five dimensions, reflect on progress, and set micro-goals.' },
    { icon: 'trending_up', title: 'EF Tracking', desc: 'Track Planning, Follow-Through, Regulation, Focus Goal, and Effort over time.' },
    { icon: 'school', title: 'Academic Snapshots', desc: 'Log grades and missing assignments per class during each check-in.' },
    { icon: 'insights', title: 'Trends & History', desc: 'Spot trends across check-ins and review a student\u2019s full history.' }
  ];

  var html = '<div class="onboarding-card">' +
    '<h2 class="onboarding-title">Welcome to Caseload Dashboard</h2>' +
    '<p class="onboarding-subtitle">A caseload dashboard for tracking executive function skills and academic progress for your students.</p>';

  html += '<div class="onboarding-features">';
  features.forEach(function(f) {
    html += '<div class="onboarding-feature">' +
      '<div class="onboarding-feature-icon">' + iconSvgs[f.icon] + '</div>' +
      '<div class="onboarding-feature-text">' +
        '<div class="onboarding-feature-title">' + f.title + '</div>' +
        '<div class="onboarding-feature-desc">' + f.desc + '</div>' +
      '</div>' +
    '</div>';
  });
  html += '</div>';

  html += '<div class="onboarding-actions">' +
    '<button class="btn btn-primary" onclick="onboardingNext()">Get Started</button>' +
  '</div>';

  html += '</div>';
  return html;
}

// ── Step 2: Spreadsheet Provisioning ──
function renderOnboardingProvision() {
  var html = '<div class="onboarding-card">' +
    '<h2 class="onboarding-title">Setting Up Your Data</h2>' +
    '<p class="onboarding-subtitle">Creating a private Google Sheet in your Drive to store student data securely.</p>' +
    '<div id="provision-status" class="onboarding-provision-status">' +
      '<div class="provision-spinner"></div>' +
      '<p>Creating your spreadsheet\u2026</p>' +
    '</div>' +
    '<div id="provision-actions" class="onboarding-actions" style="display:none;">' +
      '<button class="btn btn-primary" onclick="onboardingNext()">Continue</button>' +
    '</div>' +
  '</div>';
  return html;
}

function triggerProvisioning() {
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        onboardingState.spreadsheetUrl = result.spreadsheetUrl;
        var statusEl = document.getElementById('provision-status');
        statusEl.innerHTML =
          '<div class="provision-success">' +
            '<svg width="48" height="48" viewBox="0 0 24 24" fill="var(--md-primary)"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>' +
            '<p class="provision-success-text">Your spreadsheet has been created!</p>' +
            '<p class="provision-success-hint">It\u2019s stored in your Google Drive and only accessible to you.</p>' +
          '</div>';
        document.getElementById('provision-actions').style.display = '';
      } else {
        showProvisionError('Unexpected error during setup.');
      }
    })
    .withFailureHandler(function(err) {
      showProvisionError(err && err.message ? err.message : String(err));
    })
    .provisionUserSpreadsheet();
}

function showProvisionError(message) {
  var statusEl = document.getElementById('provision-status');
  statusEl.innerHTML =
    '<div class="provision-error">' +
      '<p>Something went wrong: ' + esc(message) + '</p>' +
      '<button class="btn btn-primary" onclick="renderOnboardingStep()" style="margin-top:12px;">Retry</button>' +
    '</div>';
}

// ── Step 3: First Student Profile ──
function renderOnboardingFirstStudent() {
  var gradeOptions = [
    { value: '', label: '-- Select Grade --' },
    { value: '6', label: '6' },
    { value: '7', label: '7' },
    { value: '8', label: '8' }
  ];

  var gradeHtml = '';
  gradeOptions.forEach(function(g) {
    gradeHtml += '<option value="' + g.value + '">' + g.label + '</option>';
  });

  var html = '<div class="onboarding-card">' +
    '<h2 class="onboarding-title">Add Your First Student</h2>' +
    '<p class="onboarding-subtitle">Set up a student profile to get started. You can always add more students later from the caseload dashboard.</p>' +
    '<div class="form-card" style="box-shadow:none;padding:0;">' +
      '<div class="form-section">' +
        '<div class="form-section-title">Basic Information</div>' +
        '<div class="form-row">' +
          '<div class="form-group"><label>First Name *</label>' +
            '<input type="text" id="ob-firstName" placeholder="First name"></div>' +
          '<div class="form-group"><label>Last Name *</label>' +
            '<input type="text" id="ob-lastName" placeholder="Last name"></div>' +
        '</div>' +
        '<div class="form-group"><label>Grade Level</label>' +
          '<select id="ob-grade">' + gradeHtml + '</select>' +
        '</div>' +
      '</div>' +
      '<div class="form-section">' +
        '<div class="form-section-title">Focus &amp; Support</div>' +
        '<div class="form-group"><label>Focus Goal</label>' +
          '<input type="text" id="ob-focusGoal" placeholder="Executive function focus area"></div>' +
        '<div class="form-group"><label>IEP Goal</label>' +
          '<textarea id="ob-iepGoal" placeholder="Enter the student\u2019s current IEP goal (optional)"></textarea></div>' +
      '</div>' +
    '</div>' +
    '<div class="onboarding-actions">' +
      '<button class="btn btn-secondary" onclick="skipFirstStudent()">Skip for Now</button>' +
      '<button class="btn btn-primary" onclick="saveOnboardingStudent()">Save &amp; Finish</button>' +
    '</div>' +
  '</div>';

  return html;
}

function saveOnboardingStudent() {
  var firstName = document.getElementById('ob-firstName').value.trim();
  var lastName = document.getElementById('ob-lastName').value.trim();

  if (!firstName || !lastName) {
    showToast('First and last name are required');
    return;
  }

  var profile = {
    firstName: firstName,
    lastName: lastName,
    grade: document.getElementById('ob-grade').value,
    focusGoal: document.getElementById('ob-focusGoal').value.trim(),
    iepGoal: document.getElementById('ob-iepGoal').value.trim(),
    period: '',
    accommodations: '',
    notes: '',
    classes: []
  };

  showToast('Saving student\u2026');

  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showToast('Welcome to Caseload Dashboard!');
        completeOnboarding();
      } else {
        showToast('Error saving student');
      }
    })
    .withFailureHandler(function(err) {
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
    })
    .saveStudent(profile);
}

function skipFirstStudent() {
  completeOnboarding();
}

function completeOnboarding() {
  enterApp();
}

// ─── Case Manager Helpers ───

function getCaseManagerName(email) {
  if (!email) return '';
  var match = appState.caseManagers.find(function(cm) {
    return cm.email === email;
  });
  return match ? match.name : email;
}

// ─── My Caseload View ───

function renderMyCaseload() {
  var container = document.getElementById('mycaseload-container');
  if (!container) return;
  var currentEmail = (appState.currentUserEmail || '').toLowerCase();

  var myStudents = appState.dashboardData.filter(function(s) {
    return (s.caseManagerEmail || '').toLowerCase() === currentEmail;
  });

  var html = '';

  // Open SpEdForms button
  html += '<div class="mycaseload-spedforms-btn">' +
    '<a href="https://15.spedforms.org/students2020.php?login=1" target="_blank" class="btn btn-secondary">Open SpEdForms</a>' +
  '</div>';

  if (myStudents.length === 0) {
    html += '<div class="empty-state">' +
      '<h3>No Students Assigned</h3>' +
      '<p>You have no students assigned to you as case manager.</p>' +
    '</div>';
    container.innerHTML = html;
    return;
  }

  myStudents.sort(function(a, b) {
    var cmp = String(a.firstName).localeCompare(String(b.firstName));
    return cmp !== 0 ? cmp : String(a.lastName).localeCompare(String(b.lastName));
  });

  html += '<table class="dashboard-table"><thead><tr>' +
    '<th>Name</th>' +
    '<th>Grade</th>' +
    '<th>GPA</th>' +
    '<th>Missing</th>' +
    '<th>Last Check-In</th>' +
    '<th>Actions</th>' +
  '</tr></thead><tbody>';

  myStudents.forEach(function(s) {
    var origIndex = appState.dashboardData.indexOf(s);
    html += '<tr onclick="openSidePanel(' + origIndex + ')" title="Click for quick view">';
    html += '<td><strong>' + esc(s.firstName + ' ' + s.lastName) + '</strong></td>';
    html += '<td>' + esc(s.grade || '-') + '</td>';

    if (s.gpa != null) {
      var gpaClass = s.gpa >= 3.5 ? 'chip-green' : s.gpa >= 2.5 ? 'chip-yellow' : 'chip-red';
      html += '<td><span class="chip ' + gpaClass + '">' + s.gpa.toFixed(2) + '</span></td>';
    } else {
      html += '<td><span class="chip chip-gray">--</span></td>';
    }

    if (s.totalMissing > 0) {
      var missingClass = s.totalMissing >= 4 ? 'chip-red' : 'chip-yellow';
      html += '<td><span class="chip chip-clickable ' + missingClass + '" onclick="event.stopPropagation(); showMissingAssignments(\'' + s.id + '\')" title="View missing assignments">' + s.totalMissing + '</span></td>';
    } else {
      html += '<td><span class="chip chip-clickable chip-green" onclick="event.stopPropagation(); showMissingAssignments(\'' + s.id + '\')" title="View missing assignments">0</span></td>';
    }

    html += '<td>' + esc(formatDateDisplay(s.latestWeek)) + '</td>';

    html += '<td><div class="action-btns">' +
      '<button class="action-btn" onclick="event.stopPropagation(); editStudent(\'' + s.id + '\')" title="Profile">' +
        '<svg class="action-btn-icon" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>' +
        '<span class="action-btn-label">Profile</span>' +
      '</button>' +
    '</div></td>';

    html += '</tr>';
  });

  html += '</tbody></table>';
  container.innerHTML = html;
  animateContentIn(container);
}

// ─── Admin View (Superuser Only) ───

function loadAdminView() {
  if (!appState.isSuperuser) {
    showToast('Unauthorized');
    return;
  }
  var container = document.getElementById('admin-content-container');
  if (!container) return;
  container.innerHTML =
    '<div class="skeleton-fade-in"><div class="form-card">' +
      '<div class="skeleton skeleton-section-title" style="width:30%;"></div>' +
      '<div class="skeleton skeleton-input" style="margin-bottom:12px;"></div>' +
      '<div class="skeleton skeleton-input" style="margin-bottom:12px;"></div>' +
    '</div></div>';

  var loadedCMs = null;
  var loadedStudents = null;

  function tryRender() {
    if (loadedCMs !== null && loadedStudents !== null) {
      renderAdminView(loadedCMs, loadedStudents);
    }
  }

  google.script.run
    .withSuccessHandler(function(cms) {
      appState.caseManagers = cms || [];
      loadedCMs = cms || [];
      tryRender();
    })
    .withFailureHandler(function() { loadedCMs = []; tryRender(); })
    .getCaseManagers();

  google.script.run
    .withSuccessHandler(function(students) { loadedStudents = students || []; tryRender(); })
    .withFailureHandler(function() { loadedStudents = []; tryRender(); })
    .getAllStudentsForAdmin();
}

function renderAdminView(caseManagers, students) {
  var container = document.getElementById('admin-content-container');
  var html = '';

  // Section 1: Manage Case Managers
  html += '<div class="form-card">' +
    '<div class="form-section-title">Case Managers</div>';

  if (caseManagers.length === 0) {
    html += '<p class="hint">No case managers configured yet.</p>';
  } else {
    caseManagers.forEach(function(cm) {
      html += '<div class="admin-cm-row">' +
        '<div class="admin-cm-info">' +
          '<span class="admin-cm-name">' + esc(cm.name) + '</span>' +
          '<span class="admin-cm-email">' + esc(cm.email) + '</span>' +
        '</div>' +
        '<button class="btn-icon btn-icon-danger" onclick="confirmRemoveCaseManager(\'' + esc(cm.email) + '\')" title="Remove" aria-label="Remove"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>' +
      '</div>';
    });
  }

  html += '<div style="margin-top:16px;">' +
    '<div class="admin-add-form">' +
      '<input type="email" id="admin-cm-email" placeholder="email@school.edu">' +
      '<input type="text" id="admin-cm-name" placeholder="Display Name">' +
      '<button class="btn btn-primary" onclick="addCaseManagerFromForm()">Add</button>' +
    '</div>' +
  '</div></div>';

  // Section 2: Assign Students to Case Managers
  html += '<div class="form-card">' +
    '<div class="form-section-title">Student Case Manager Assignments</div>';

  if (students.length === 0) {
    html += '<p class="hint">No students found.</p>';
  } else {
    html += '<table class="admin-assign-table"><thead><tr>' +
      '<th>Student</th><th>Grade</th><th>Case Manager</th>' +
    '</tr></thead><tbody>';

    students.sort(function(a, b) {
      var cmp = String(a.lastName).localeCompare(String(b.lastName));
      return cmp !== 0 ? cmp : String(a.firstName).localeCompare(String(b.firstName));
    });

    students.forEach(function(s) {
      html += '<tr>';
      html += '<td>' + esc(s.lastName + ', ' + s.firstName) + '</td>';
      html += '<td>' + esc(s.grade || '-') + '</td>';
      html += '<td><select onchange="adminAssignCaseManager(\'' + s.id + '\', this.value)">';
      html += '<option value="">-- None --</option>';
      caseManagers.forEach(function(cm) {
        var sel = (s.caseManagerEmail === cm.email) ? ' selected' : '';
        html += '<option value="' + esc(cm.email) + '"' + sel + '>' + esc(cm.name) + '</option>';
      });
      html += '</select></td></tr>';
    });

    html += '</tbody></table>';
  }

  html += '</div>';
  container.innerHTML = html;
  animateContentIn(container);
}

function addCaseManagerFromForm() {
  var emailInput = document.getElementById('admin-cm-email');
  var nameInput = document.getElementById('admin-cm-name');
  var email = (emailInput.value || '').trim();
  var name = (nameInput.value || '').trim();

  if (!email) { showToast('Please enter an email address'); return; }
  if (!name) { showToast('Please enter a display name'); return; }

  showToast('Adding case manager\u2026');

  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showToast('Case manager added');
        loadAdminView();
      } else {
        showToast(result.error || 'Error adding case manager');
      }
    })
    .withFailureHandler(function(err) {
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
    })
    .addCaseManager(email, name);
}

function confirmRemoveCaseManager(email) {
  showConfirmDialog({
    title: 'Remove Case Manager?',
    body: 'This will remove <strong>' + esc(email) + '</strong> from the case managers list. Students already assigned will keep their assignment.',
    confirmLabel: 'Remove',
    onConfirm: "doRemoveCaseManager('" + esc(email) + "')"
  });
}

function doRemoveCaseManager(email) {
  showToast('Removing case manager\u2026');
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showToast('Case manager removed');
        loadAdminView();
      } else {
        showToast(result.error || 'Error removing case manager');
      }
    })
    .withFailureHandler(function(err) {
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
    })
    .removeCaseManager(email);
}

function adminAssignCaseManager(studentId, caseManagerEmail) {
  showToast('Assigning case manager\u2026');
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showToast('Case manager assigned');
        appState.dashboardData.forEach(function(s) {
          if (s.id === studentId) {
            s.caseManagerEmail = caseManagerEmail;
          }
        });
      } else {
        showToast(result.error || 'Error assigning case manager');
      }
    })
    .withFailureHandler(function(err) {
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
    })
    .assignCaseManager(studentId, caseManagerEmail);
}

// ─── Button Ripple Effect (delegated) ───
function createRipple(target, clientX, clientY) {
  var rect = target.getBoundingClientRect();
  var ripple = document.createElement('span');
  ripple.className = 'ripple-effect';
  var size = Math.max(rect.width, rect.height);
  ripple.style.width = ripple.style.height = size + 'px';
  ripple.style.left = (clientX - rect.left - size / 2) + 'px';
  ripple.style.top = (clientY - rect.top - size / 2) + 'px';
  target.appendChild(ripple);
  ripple.addEventListener('animationend', function() { ripple.remove(); });
}
document.addEventListener('click', function(e) {
  var btn = e.target.closest('.btn, .btn-icon, .btn-ghost, .action-btn, .rating-btn, .nav-tab');
  if (btn) createRipple(btn, e.clientX, e.clientY);
});
</script>
