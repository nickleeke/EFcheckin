<script>
/* ============================================================
   Caseload Dashboard — Client-Side JavaScript
   v3 — multi-user with onboarding
   ============================================================ */

// ─── Application State ───
var appState = {
  dashboardData: [],
  currentStudentId: null,
  currentCheckIns: [],
  editingCheckIn: null,
  sortField: 'name',
  sortAsc: true,
  missingViewStudentId: null,
  feedbackLinks: null,
  currentUserEmail: ''
};
var _persistTimers = {};

var onboardingState = {
  step: 1,
  email: '',
  spreadsheetUrl: null
};

// ─── Preloaded Options ───
var PRELOADED_CLASSES = [
  'Academic Skills', 'Art', 'Band', 'Choir', 'ELA',
  'Lit Lab', 'Math', 'Numbers Lab', 'PE', 'Photography',
  'Reading Tier', 'Science', 'STEAM', 'Woodshop'
];

// ─── Initialization ───
document.addEventListener('DOMContentLoaded', function() {
  // Check user auth status before showing anything
  google.script.run
    .withSuccessHandler(function(status) {
      appState.currentUserEmail = status.email || '';

      // Check for pending co-teacher invite
      if (status.pendingInvite) {
        if (status.isNewUser) {
          // New user with invite — show invite acceptance directly
          showInviteModal(status.pendingInvite, true);
        } else {
          // Existing user with invite — enter app, then show invite modal
          enterApp();
          showInviteModal(status.pendingInvite, false);
        }
      } else if (status.isNewUser) {
        showOnboarding(status);
      } else {
        enterApp();
      }
    })
    .withFailureHandler(function(err) {
      document.getElementById('auth-loading').innerHTML =
        '<div class="empty-state">' +
          '<h3>Unable to Load</h3>' +
          '<p>' + esc(err && err.message ? err.message : String(err)) + '</p>' +
          '<button class="btn btn-primary" style="margin-top:16px;" onclick="location.reload()">Reload</button>' +
        '</div>';
    })
    .getUserStatus();
});

/** Enter the main app (for returning users or after onboarding). */
function enterApp() {
  document.getElementById('navbar').style.display = '';
  showView('dashboard-view');
  showDashboardSkeleton();

  google.script.run
    .withSuccessHandler(function(result) {
      try {
        appState.feedbackLinks = (result && result.feedbackLinks) || {};
        loadDashboard();
      } catch(e) { showToast('Error: ' + e.message); }
    })
    .withFailureHandler(function(err) {
      showToast('Error initializing: ' + (err && err.message ? err.message : String(err)));
    })
    .initializeSheets();
}

// Close side panel on Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeSidePanel();
    // Also close any confirmation dialogs
    var overlay = document.querySelector('.confirm-overlay');
    if (overlay) overlay.remove();
  }
});

// ─── View Management ───
function showView(viewId) {
  document.querySelectorAll('.view').forEach(function(v) {
    v.classList.remove('active');
  });
  document.getElementById(viewId).classList.add('active');
  window.scrollTo(0, 0);
}

// ─── Dashboard ───
function showDashboard() {
  showView('dashboard-view');
  loadDashboard();
}

function loadDashboard() {
  showDashboardSkeleton();
  google.script.run
    .withSuccessHandler(function(data) {
      try {
        appState.dashboardData = data || [];
        renderDashboard(data);
      } catch(e) {
        showToast('Render error: ' + e.message);
      }
    })
    .withFailureHandler(function(err) {
      showToast('Error loading dashboard: ' + (err && err.message ? err.message : String(err)));
    })
    .getDashboardData();
}

function toggleSort(field) {
  if (appState.sortField === field) {
    appState.sortAsc = !appState.sortAsc;
  } else {
    appState.sortField = field;
    appState.sortAsc = true;
  }
  renderDashboard(appState.dashboardData);
}

function sortIcon(field) {
  var isActive = appState.sortField === field;
  var arrow;
  if (!isActive) {
    // Inactive: up/down unfold arrow
    arrow = '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 5.83L15.17 9l1.41-1.41L12 3 7.41 7.59 8.83 9 12 5.83zm0 12.34L8.83 15l-1.41 1.41L12 21l4.59-4.59L15.17 15 12 18.17z"/></svg>';
  } else if (appState.sortAsc) {
    arrow = '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M7 14l5-5 5 5z"/></svg>';
  } else {
    arrow = '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>';
  }
  var cls = 'btn-icon btn-sort' + (isActive ? ' btn-sort-active' : '');
  return '<button class="' + cls + '" onclick="event.stopPropagation(); toggleSort(\'' + field + '\')" aria-label="Sort by ' + field + '">' + arrow + '</button>';
}

function renderDashboard(data) {
  var container = document.getElementById('dashboard-table-container');

  if (!data || data.length === 0) {
    container.innerHTML =
      '<div class="empty-state">' +
        '<h3>No Students Yet</h3>' +
        '<p>Click "+ Add Student" to get started.</p>' +
      '</div>';
    return;
  }

  // Sort data
  var sorted = data.slice().sort(function(a, b) {
    var cmp = 0;
    if (appState.sortField === 'name') {
      cmp = String(a.firstName).localeCompare(String(b.firstName));
      if (cmp === 0) cmp = String(a.lastName).localeCompare(String(b.lastName));
    } else if (appState.sortField === 'grade') {
      var ag = a.grade || '', bg = b.grade || '';
      // Push empty grades to the bottom regardless of direction
      if (!ag && !bg) cmp = 0;
      else if (!ag) return 1;
      else if (!bg) return -1;
      else cmp = ag.localeCompare(bg);
      if (cmp === 0) cmp = String(a.firstName).localeCompare(String(b.firstName));
    }
    return appState.sortAsc ? cmp : -cmp;
  });

  var html = '<table class="dashboard-table"><thead><tr>' +
    '<th><span class="th-sortable">' + sortIcon('name') + 'Name</span></th>' +
    '<th><span class="th-sortable">' + sortIcon('grade') + 'Grade</span></th>' +
    '<th>EF Avg</th><th>Trend</th><th>GPA</th>' +
    '<th>Missing</th><th>Last Check-In</th><th>Actions</th>' +
    '</tr></thead><tbody>';

  sorted.forEach(function(s, index) {
    var origIndex = data.indexOf(s);
    html += '<tr onclick="openSidePanel(' + origIndex + ')" title="Click for quick view">';
    html += '<td><strong>' + esc(s.firstName + ' ' + s.lastName) + '</strong></td>';
    html += '<td>' + esc(s.grade || '-') + '</td>';

    // EF Average
    if (s.avgRating != null) {
      var efClass = s.avgRating >= 4 ? 'chip-green' : s.avgRating >= 3 ? 'chip-yellow' : 'chip-red';
      html += '<td><span class="chip ' + efClass + '">' + s.avgRating.toFixed(1) + '</span></td>';
    } else {
      html += '<td><span class="chip chip-gray">--</span></td>';
    }

    // Trend
    var trendMap = { up: '&#9650; Up', down: '&#9660; Down', flat: '&#9654; Flat', none: '--' };
    var trendClass = s.trend === 'up' ? 'trend-up' : s.trend === 'down' ? 'trend-down' : 'trend-flat';
    html += '<td><span class="' + trendClass + '">' + (trendMap[s.trend] || '--') + '</span></td>';

    // GPA
    if (s.gpa != null) {
      var gpaClass = s.gpa >= 3.5 ? 'chip-green' : s.gpa >= 2.5 ? 'chip-yellow' : 'chip-red';
      html += '<td><span class="chip ' + gpaClass + '">' + s.gpa.toFixed(2) + '</span></td>';
    } else {
      html += '<td><span class="chip chip-gray">--</span></td>';
    }

    // Missing assignments (clickable badge)
    if (s.totalMissing > 0) {
      var missingClass = s.totalMissing >= 4 ? 'chip-red' : 'chip-yellow';
      html += '<td><span class="chip chip-clickable ' + missingClass + '" onclick="event.stopPropagation(); showMissingAssignments(\'' + s.id + '\')" title="View missing assignments">' + s.totalMissing + '</span></td>';
    } else {
      html += '<td><span class="chip chip-clickable chip-green" onclick="event.stopPropagation(); showMissingAssignments(\'' + s.id + '\')" title="View missing assignments">0</span></td>';
    }

    // Last check-in date
    html += '<td>' + esc(s.latestWeek || 'Never') + '</td>';

    // Action buttons
    html += '<td><div class="action-btns">' +
      '<button class="action-btn primary" onclick="event.stopPropagation(); startCheckIn(\'' + s.id + '\')">Check-In</button>' +
      '<button class="action-btn" onclick="event.stopPropagation(); editStudent(\'' + s.id + '\')">Edit</button>' +
      '</div></td>';

    html += '</tr>';
  });

  html += '</tbody></table>';
  html += '<p class="hint" style="margin-top:8px;">Click any row for a quick academic overview.</p>';

  container.innerHTML = html;
}

// ─── Side Panel (Quick View on Double-Click) ───
function openSidePanel(index) {
  var s = appState.dashboardData[index];
  if (!s) return;

  document.getElementById('side-panel-title').textContent = s.firstName + ' ' + s.lastName;

  var content = '';

  // Student info subtitle
  if (s.grade) {
    content += '<div class="sp-subtitle" style="margin-bottom:16px;">Grade ' + esc(s.grade) + '</div>';
  }

  // GPA
  content += '<div class="sp-section">';
  content += '<div class="sp-section-title">Current GPA</div>';
  if (s.gpa != null) {
    var gpaClass = s.gpa >= 3.5 ? 'high' : s.gpa >= 2.5 ? 'mid' : 'low';
    content += '<div class="sp-gpa ' + gpaClass + '">' + s.gpa.toFixed(2) + '</div>';
  } else {
    content += '<div class="sp-gpa none">No GPA data</div>';
  }
  content += '</div>';

  // Focus Goal (from student profile / onboarding)
  if (s.focusGoal) {
    content += '<div class="sp-section">';
    content += '<div class="sp-section-title">Focus Goal</div>';
    content += '<div class="sp-goal-text">' + esc(s.focusGoal) + '</div>';
    content += '</div>';
  }

  // Current Micro Goal (from latest check-in)
  content += '<div class="sp-section">';
  content += '<div class="sp-section-title">Current Micro Goal</div>';
  if (s.latestMicroGoal) {
    content += '<div class="sp-goal-text">' + esc(s.latestMicroGoal) + '</div>';
  } else {
    content += '<div class="sp-goal-none">No goal set</div>';
  }
  content += '</div>';

  // IEP Goal
  if (s.iepGoal) {
    content += '<div class="sp-section">';
    content += '<div class="sp-section-title">IEP Goal</div>';
    content += '<div class="sp-goal-text">' + esc(s.iepGoal) + '</div>';
    content += '</div>';
  }

  // Classes & Grades
  content += '<div class="sp-section">';
  content += '<div class="sp-section-title">Classes &amp; Grades</div>';
  if (s.academicData && s.academicData.length > 0) {
    content += '<ul class="sp-class-list">';
    s.academicData.forEach(function(c) {
      var missingNum = Number(c.missing) || 0;
      var missingBadgeClass = missingNum > 0 ? '' : ' none';
      var classLabel = c.className || 'Unknown';
      // Find period from student's class list
      var matchedClass = (s.classes || []).find(function(cl) { return cl.name === c.className; });
      if (matchedClass && matchedClass.period) classLabel += ' (P' + matchedClass.period + ')';
      content += '<li class="sp-class-item">' +
        '<span class="sp-class-name">' + esc(classLabel) + '</span>' +
        '<span class="sp-class-meta">' +
          '<span class="sp-class-grade">' + esc(c.grade || '--') + '</span>' +
          '<span class="sp-missing-badge clickable' + missingBadgeClass + '" onclick="event.stopPropagation(); closeSidePanel(); showMissingAssignments(\'' + s.id + '\')" title="View missing assignments">' + missingNum + ' missing</span>' +
        '</span>' +
      '</li>';
    });
    content += '</ul>';
  } else {
    content += '<div class="sp-goal-none">No academic data from latest check-in</div>';
  }
  content += '</div>';

  // Total missing (clickable to open detail view)
  content += '<div class="sp-section">';
  var totalMissing = s.totalMissing || 0;
  if (totalMissing === 0) {
    content += '<div class="sp-total-missing ok sp-no-missing" onclick="closeSidePanel(); showMissingAssignments(\'' + s.id + '\')" style="cursor:pointer;" title="View missing assignments detail">No Missing Assignments! <span class="sp-no-missing-emoji">&#x1F4AF;</span></div>';
  } else {
    content += '<div class="sp-total-missing alert" onclick="closeSidePanel(); showMissingAssignments(\'' + s.id + '\')" style="cursor:pointer;" title="View missing assignments detail">Total Missing Assignments: ' + totalMissing + '</div>';
  }
  content += '</div>';

  // Action buttons
  content += '<div class="sp-actions">' +
    '<button class="btn btn-primary" onclick="closeSidePanel(); startCheckIn(\'' + s.id + '\')">New Check-In</button>' +
    '<button class="btn btn-secondary" onclick="closeSidePanel(); editStudent(\'' + s.id + '\')">View Profile</button>' +
  '</div>';

  document.getElementById('side-panel-content').innerHTML = content;
  document.getElementById('side-panel').classList.add('open');
  document.getElementById('side-panel-overlay').classList.add('open');
}

function closeSidePanel() {
  document.getElementById('side-panel').classList.remove('open');
  document.getElementById('side-panel-overlay').classList.remove('open');
}

// ─── Check-In Form ───
function startCheckIn(studentId, existingCheckIn) {
  appState.currentStudentId = studentId;
  appState.editingCheckIn = existingCheckIn || null;
  showCheckInSkeleton();
  showView('checkin-view');

  google.script.run
    .withSuccessHandler(function(students) {
      var student = (students || []).find(function(s) { return s.id === studentId; });
      if (!student) { showToast('Student not found'); return; }

      google.script.run
        .withSuccessHandler(function(checkIns) {
          try {
            appState.currentCheckIns = checkIns || [];
            renderCheckInForm(student, checkIns, existingCheckIn);
          } catch(e) { showToast('Render error: ' + e.message); }
        })
        .withFailureHandler(function(err) { showToast('Error: ' + (err && err.message ? err.message : String(err))); })
        .getCheckIns(studentId);
    })
    .withFailureHandler(function(err) { showToast('Error: ' + (err && err.message ? err.message : String(err))); })
    .getStudents();
}

function renderCheckInForm(student, checkIns, existingCheckIn) {
  document.getElementById('checkin-view-breadcrumb').textContent = 'Weekly Check-In';
  document.getElementById('checkin-view-title').textContent = student.firstName + ' ' + student.lastName;

  var container = document.getElementById('checkin-form-container');
  var html = '';

  // ── Previous Goal Banner (top of form) ──
  var lastCheckIn = null;
  if (existingCheckIn) {
    // When editing, show the goal from the check-in before this one
    var others = checkIns.filter(function(ci) { return ci.id !== existingCheckIn.id; });
    lastCheckIn = others.length > 0 ? others[0] : null;
  } else {
    // For new check-in, show the goal from the most recent check-in
    lastCheckIn = checkIns.length > 0 ? checkIns[0] : null;
  }

  if (lastCheckIn && lastCheckIn.microGoal) {
    html += '<div class="prev-goal-banner">' +
      '<div class="banner-label">Previous Goal</div>' +
      '<div class="banner-goal">' + esc(lastCheckIn.microGoal) + '</div>' +
      '<div class="banner-date">Set on check-in: ' + esc(lastCheckIn.weekOf || 'Unknown date') + '</div>' +
    '</div>';
  } else {
    html += '<div class="prev-goal-banner no-goal">' +
      '<div class="banner-label">Previous Goal</div>' +
      '<div class="banner-goal">No previous goal set</div>' +
    '</div>';
  }

  // Pre-fill values from existing check-in (if editing)
  var ci = existingCheckIn || {};
  var today = new Date().toISOString().slice(0, 10);

  html += '<div class="form-card">';

  // Week Of
  html += '<div class="form-section">' +
    '<div class="form-group">' +
      '<label>Week Of</label>' +
      '<input type="date" id="ci-weekOf" value="' + esc(ci.weekOf || today) + '">' +
    '</div>' +
  '</div>';

  // EF Ratings
  html += '<div class="form-section">' +
    '<div class="form-section-title">Executive Function Ratings</div>';

  var efDimensions = [
    { key: 'planningRating', label: 'Planning' },
    { key: 'followThroughRating', label: 'Follow-Through' },
    { key: 'regulationRating', label: 'Regulation' },
    { key: 'focusGoalRating', label: 'Focus Goal' },
    { key: 'effortRating', label: 'Effort' }
  ];

  efDimensions.forEach(function(dim) {
    var currentVal = Number(ci[dim.key]) || 0;
    html += '<div class="form-group">' +
      '<label>' + dim.label + '</label>' +
      '<div class="rating-group" data-field="' + dim.key + '">';
    for (var r = 1; r <= 5; r++) {
      var sel = (r === currentVal) ? ' selected' : '';
      html += '<button type="button" class="rating-btn' + sel + '" data-value="' + r + '" onclick="selectRating(this)">' + r + '</button>';
    }
    html += '</div></div>';
  });

  html += '</div>';

  // Reflection
  html += '<div class="form-section">' +
    '<div class="form-section-title">Reflection</div>' +
    '<div class="form-group"><label>What went well?</label>' +
      '<textarea id="ci-whatWentWell">' + esc(ci.whatWentWell || '') + '</textarea></div>' +
    '<div class="form-group"><label>Barrier / Challenge</label>' +
      '<textarea id="ci-barrier">' + esc(ci.barrier || '') + '</textarea></div>' +
  '</div>';

  // Micro Goal
  html += '<div class="form-section">' +
    '<div class="form-section-title">Micro Goal</div>' +
    '<div class="form-group"><label>Goal for next week</label>' +
      '<input type="text" id="ci-microGoal" value="' + esc(ci.microGoal || '') + '"></div>' +
    '<div class="form-group"><label>Category</label>' +
      '<select id="ci-microGoalCategory">';

  var categories = [
    '', 'Planning & Prioritization', 'Organization', 'Time Management',
    'Task Initiation', 'Sustained Attention', 'Flexibility',
    'Metacognition', 'Working Memory', 'Emotional Regulation', 'Other'
  ];
  categories.forEach(function(cat) {
    var sel = ((ci.microGoalCategory || '') === cat) ? ' selected' : '';
    html += '<option value="' + esc(cat) + '"' + sel + '>' + (cat || '-- Select --') + '</option>';
  });

  html += '</select></div></div>';

  // Academic Snapshot
  html += '<div class="form-section">' +
    '<div class="form-section-title">Academic Snapshot</div>';

  var classes = student.classes || [];

  // Build lookup maps for pre-filling grades
  var prevAcademic = {};
  if (lastCheckIn && lastCheckIn.academicData) {
    lastCheckIn.academicData.forEach(function(ad) { prevAcademic[ad.className] = ad; });
  }
  var editAcademic = {};
  if (existingCheckIn && existingCheckIn.academicData) {
    existingCheckIn.academicData.forEach(function(ad) { editAcademic[ad.className] = ad; });
  }

  if (classes.length > 0) {
    var grades = ['', 'A', 'A-', 'B+', 'B', 'B-', 'C+', 'C', 'C-', 'D+', 'D', 'D-', 'F'];

    html += '<table class="academic-table" id="academic-table">' +
      '<thead><tr><th>Class</th><th>Grade</th><th>Missing</th></tr></thead><tbody>';

    classes.forEach(function(cls, clsIdx) {
      var className = cls.name || cls;
      var classPeriod = cls.period || '';
      var displayName = classPeriod ? className + ' (P' + classPeriod + ')' : className;
      var existing = editAcademic[className] || prevAcademic[className] || {};
      var assignments = existing.missingAssignments || [];
      var missingCount = assignments.length || (Number(existing.missing) || 0);
      var badgeClass = missingCount === 0 ? 'chip-green' : missingCount <= 3 ? 'chip-yellow' : 'chip-red';

      html += '<tr class="acad-row">' +
        '<td class="class-name-col">' + esc(displayName) +
          '<input type="hidden" class="acad-class-name" value="' + esc(className) + '">' +
        '</td>' +
        '<td><select class="acad-grade">';

      grades.forEach(function(g) {
        var sel = ((existing.grade || '') === g) ? ' selected' : '';
        html += '<option value="' + g + '"' + sel + '>' + (g || '--') + '</option>';
      });

      html += '</select></td>' +
        '<td>' +
          '<button type="button" class="missing-toggle chip ' + badgeClass + '" onclick="toggleCheckInMissing(' + clsIdx + ')">' +
            '<span id="ci-missing-count-' + clsIdx + '">' + missingCount + '</span>' +
            ' <svg class="expand-chevron" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>' +
          '</button>' +
        '</td>' +
      '</tr>';

      // Expandable missing assignments detail row
      html += '<tr class="acad-missing-row" id="acad-missing-row-' + clsIdx + '" style="display:none;">' +
        '<td colspan="3">' +
          '<div class="ci-missing-container">' +
            '<div class="ci-missing-list" id="ci-missing-list-' + clsIdx + '">';

      // Render existing individual assignments
      assignments.forEach(function(a) {
        html += renderCheckInMissingItem(clsIdx, a.name || '', a.type || '');
      });

      html += '</div>' +
            '<button type="button" class="btn-ghost btn-sm" onclick="addCheckInMissing(' + clsIdx + ')">+ Add Missing Assignment</button>' +
          '</div>' +
        '</td>' +
      '</tr>';
    });

    html += '</tbody></table>';
  } else {
    html += '<p class="hint">No classes configured for this student.</p>' +
      '<button class="btn-ghost btn-sm" onclick="goBackFromCheckIn(); editStudent(\'' + student.id + '\')">Add Classes</button>';
  }

  html += '</div>';

  // Teacher Notes
  html += '<div class="form-section">' +
    '<div class="form-section-title">Teacher Notes</div>' +
    '<div class="form-group"><label>Notes</label>' +
      '<textarea id="ci-teacherNotes">' + esc(ci.teacherNotes || '') + '</textarea></div>' +
  '</div>';

  // Buttons
  html += '<div style="display:flex;gap:8px;justify-content:flex-end;">' +
    '<button class="btn btn-secondary" onclick="goBackFromCheckIn()">Cancel</button>' +
    '<button class="btn btn-primary" onclick="saveCheckIn()">Save Check-In</button>' +
  '</div>';

  html += '</div>'; // form-card

  container.innerHTML = html;
}

function selectRating(btn) {
  var group = btn.parentElement;
  group.querySelectorAll('.rating-btn').forEach(function(b) { b.classList.remove('selected'); });
  btn.classList.add('selected');
}

function getSelectedRating(field) {
  var group = document.querySelector('.rating-group[data-field="' + field + '"]');
  if (!group) return '';
  var selected = group.querySelector('.rating-btn.selected');
  return selected ? selected.getAttribute('data-value') : '';
}

// ─── Check-In Inline Missing Assignment Helpers ───
function renderCheckInMissingItem(clsIdx, name, type) {
  return '<div class="ci-missing-item" data-class-idx="' + clsIdx + '">' +
    '<input type="text" class="ci-ma-name" value="' + esc(name) + '" placeholder="Assignment name">' +
    '<select class="ci-ma-type">' +
      '<option value=""' + (!type ? ' selected' : '') + '>-- Type --</option>' +
      '<option value="Formative"' + (type === 'Formative' ? ' selected' : '') + '>Formative</option>' +
      '<option value="Summative"' + (type === 'Summative' ? ' selected' : '') + '>Summative</option>' +
    '</select>' +
    '<button type="button" class="btn-remove-class" onclick="removeCheckInMissing(this, ' + clsIdx + ')">&times;</button>' +
  '</div>';
}

function toggleCheckInMissing(clsIdx) {
  var row = document.getElementById('acad-missing-row-' + clsIdx);
  if (row.style.display === 'none') {
    row.style.display = '';
  } else {
    row.style.display = 'none';
  }
}

function addCheckInMissing(clsIdx) {
  var list = document.getElementById('ci-missing-list-' + clsIdx);
  var div = document.createElement('div');
  div.innerHTML = renderCheckInMissingItem(clsIdx, '', '');
  list.appendChild(div.firstChild);
  updateCheckInMissingCount(clsIdx);
  // Focus the new name input
  var items = list.querySelectorAll('.ci-missing-item');
  var last = items[items.length - 1];
  if (last) last.querySelector('.ci-ma-name').focus();
}

function removeCheckInMissing(btn, clsIdx) {
  btn.parentElement.remove();
  updateCheckInMissingCount(clsIdx);
}

function updateCheckInMissingCount(clsIdx) {
  var list = document.getElementById('ci-missing-list-' + clsIdx);
  var count = list.querySelectorAll('.ci-missing-item').length;
  var countEl = document.getElementById('ci-missing-count-' + clsIdx);
  countEl.textContent = count;
  // Update badge color
  var btn = countEl.closest('.missing-toggle');
  btn.className = 'missing-toggle chip ' +
    (count === 0 ? 'chip-green' : count <= 3 ? 'chip-yellow' : 'chip-red');
}

function getAcademicData() {
  var table = document.getElementById('academic-table');
  if (!table) return [];
  var rows = table.querySelectorAll('tbody tr.acad-row');
  var result = [];
  rows.forEach(function(row, idx) {
    var missingItems = [];
    var list = document.getElementById('ci-missing-list-' + idx);
    if (list) {
      list.querySelectorAll('.ci-missing-item').forEach(function(item) {
        var name = item.querySelector('.ci-ma-name').value.trim();
        var type = item.querySelector('.ci-ma-type').value;
        if (name) {
          missingItems.push({ name: name, type: type });
        }
      });
    }
    result.push({
      className: row.querySelector('.acad-class-name').value,
      grade: row.querySelector('.acad-grade').value,
      missing: missingItems.length,
      missingAssignments: missingItems
    });
  });
  return result;
}

function saveCheckIn() {
  var data = {
    studentId: appState.currentStudentId,
    weekOf: document.getElementById('ci-weekOf').value,
    planningRating: getSelectedRating('planningRating'),
    followThroughRating: getSelectedRating('followThroughRating'),
    regulationRating: getSelectedRating('regulationRating'),
    focusGoalRating: getSelectedRating('focusGoalRating'),
    effortRating: getSelectedRating('effortRating'),
    whatWentWell: document.getElementById('ci-whatWentWell').value,
    barrier: document.getElementById('ci-barrier').value,
    microGoal: document.getElementById('ci-microGoal').value,
    microGoalCategory: document.getElementById('ci-microGoalCategory').value,
    teacherNotes: document.getElementById('ci-teacherNotes').value,
    academicData: getAcademicData()
  };

  if (appState.editingCheckIn) {
    data.id = appState.editingCheckIn.id;
  }

  // Optimistic UI: navigate immediately
  showView('dashboard-view');
  renderDashboard(appState.dashboardData);
  showToast('Saving check-in\u2026');

  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showToast('Check-in saved');
        loadDashboard();
      } else {
        showToast('Error saving check-in');
      }
    })
    .withFailureHandler(function(err) { showToast('Error: ' + (err && err.message ? err.message : String(err))); })
    .saveCheckIn(data);
}

function goBackFromCheckIn() {
  showDashboard();
}

// ─── Missing Assignments View (child page) ───
function showMissingAssignments(studentId) {
  var student = appState.dashboardData.find(function(s) { return s.id === studentId; });
  if (!student) { showToast('Student not found'); return; }

  appState.missingViewStudentId = studentId;

  document.getElementById('missing-view-breadcrumb').innerHTML =
    '<button class="breadcrumb-link" onclick="editStudent(appState.missingViewStudentId)">Student Profile</button> <svg class="breadcrumb-chevron" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg> Missing Assignments';
  document.getElementById('missing-view-title').textContent =
    student.firstName + ' ' + student.lastName;

  renderMissingView(student);
  showView('missing-view');
}

function renderMissingView(student) {
  var container = document.getElementById('missing-content-container');
  var academicData = student.academicData || [];
  var totalMissing = student.totalMissing || 0;
  var html = '';

  // Summary card
  if (totalMissing === 0) {
    html += '<div class="missing-summary-celebrate">' +
      '<div class="missing-celebrate-text">No Missing Assignments!</div>' +
    '</div>';
  } else {
    html += '<div class="missing-summary alert">' +
      '<div class="missing-summary-count">' + totalMissing + '</div>' +
      '<div class="missing-summary-label">Total Missing Assignments</div>' +
    '</div>';
  }

  if (academicData.length === 0) {
    html += '<div class="empty-state" style="padding:40px 20px;">' +
      '<p>No academic data from the latest check-in.</p>' +
    '</div>';
  } else {
    html += '<div class="missing-class-cards">';

    academicData.forEach(function(c, idx) {
      var missingNum = Number(c.missing) || 0;
      var assignments = c.missingAssignments || [];
      var badgeClass = missingNum === 0 ? 'badge-green' : missingNum <= 3 ? 'badge-yellow' : 'badge-red';
      var classLabel = c.className || 'Unknown';

      // Find period from student's class list
      var matchedClass = (student.classes || []).find(function(cl) {
        return cl.name === c.className;
      });
      if (matchedClass && matchedClass.period) classLabel += ' (P' + matchedClass.period + ')';

      html += '<div class="missing-class-card" id="missing-card-' + idx + '">' +
        '<div class="missing-class-header" onclick="toggleMissingClass(' + idx + ')">' +
          '<div class="missing-class-info">' +
            '<span class="missing-class-name">' + esc(classLabel) + '</span>' +
            '<span class="missing-class-grade">' + esc(c.grade || '--') + '</span>' +
          '</div>' +
          '<div class="missing-class-right">' +
            '<div class="missing-class-badge ' + badgeClass + '">' + missingNum + '</div>' +
            '<svg class="expand-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>' +
          '</div>' +
        '</div>' +
        '<div class="missing-class-detail" id="missing-class-detail-' + idx + '">';

      if (missingNum === 0) {
        html += '<div class="missing-none-msg">No missing assignments</div>';
      } else if (assignments.length > 0) {
        // Sort by name then type, tracking original indices
        var sorted = assignments.map(function(a, i) {
          return { name: a.name, type: a.type, _origIdx: i };
        }).sort(function(a, b) {
          var nameComp = (a.name || '').localeCompare(b.name || '');
          if (nameComp !== 0) return nameComp;
          return (a.type || '').localeCompare(b.type || '');
        });

        html += '<table class="missing-detail-table">' +
          '<thead><tr><th>Assignment Name</th><th>Type</th><th>Actions</th></tr></thead><tbody>';
        sorted.forEach(function(a) {
          var typeClass = a.type === 'Summative' ? 'type-summative' :
                          a.type === 'Formative' ? 'type-formative' : '';
          html += '<tr>' +
            '<td>' + esc(a.name || 'Untitled') + '</td>' +
            '<td><span class="assignment-type ' + typeClass + '">' +
              esc(a.type || 'Unknown') + '</span></td>' +
            '<td class="missing-actions-cell">' +
              '<button class="missing-action-btn btn-check" onclick="event.stopPropagation(); markMissingDone(\'' + student.id + '\', ' + idx + ', ' + a._origIdx + ')" title="Mark as complete">' +
                '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>' +
              '</button>' +
              '<button class="missing-action-btn btn-delete" onclick="event.stopPropagation(); removeMissingAssignment(\'' + student.id + '\', ' + idx + ', ' + a._origIdx + ')" title="Remove assignment">' +
                '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>' +
              '</button>' +
            '</td>' +
          '</tr>';
        });
        html += '</tbody></table>';
      } else {
        html += '<div class="missing-count-only">' + missingNum +
          ' missing assignment' + (missingNum !== 1 ? 's' : '') +
          ' recorded (no details available)</div>';
      }

      html += '</div></div>';
    });

    html += '</div>';
  }

  // Action buttons
  html += '<div class="missing-actions">' +
    '<button class="btn btn-primary" onclick="goBackFromMissing(); startCheckIn(\'' + student.id + '\')">New Check-In</button>' +
    '<button class="btn btn-secondary" onclick="goBackFromMissing()">Back</button>' +
  '</div>';

  container.innerHTML = html;
}

function toggleMissingClass(idx) {
  var card = document.getElementById('missing-card-' + idx);
  if (card.classList.contains('expanded')) {
    card.classList.remove('expanded');
  } else {
    card.classList.add('expanded');
  }
}

function launchConfetti(originEl) {
  var rect = originEl ? originEl.getBoundingClientRect() : { left: window.innerWidth / 2, top: window.innerHeight / 2 };
  var colors = ['#4CAF50', '#FFC107', '#2196F3', '#E91E63', '#9C27B0', '#FF5722', '#00BCD4'];
  var shapes = ['circle', 'square'];
  var count = 40;

  for (var i = 0; i < count; i++) {
    (function(index) {
      var piece = document.createElement('div');
      var size = Math.random() * 8 + 5;
      var color = colors[Math.floor(Math.random() * colors.length)];
      var shape = shapes[Math.floor(Math.random() * shapes.length)];
      var angle = (Math.random() * 360) * (Math.PI / 180);
      var velocity = Math.random() * 200 + 100;
      var dx = Math.cos(angle) * velocity;
      var dy = Math.sin(angle) * velocity - 150;
      var rotation = Math.random() * 360;

      piece.style.cssText =
        'position:fixed;z-index:10000;pointer-events:none;' +
        'width:' + size + 'px;height:' + size + 'px;' +
        'background:' + color + ';' +
        'border-radius:' + (shape === 'circle' ? '50%' : '2px') + ';' +
        'left:' + rect.left + 'px;top:' + rect.top + 'px;' +
        'opacity:1;transform:rotate(' + rotation + 'deg);';

      document.body.appendChild(piece);

      var startTime = performance.now();
      var duration = 900 + Math.random() * 400;

      function animate(now) {
        var elapsed = now - startTime;
        var progress = Math.min(elapsed / duration, 1);
        var ease = 1 - Math.pow(1 - progress, 3);

        var x = rect.left + dx * ease;
        var y = rect.top + dy * ease + 300 * progress * progress;
        var opacity = progress < 0.7 ? 1 : 1 - ((progress - 0.7) / 0.3);
        var rot = rotation + 360 * ease;

        piece.style.left = x + 'px';
        piece.style.top = y + 'px';
        piece.style.opacity = opacity;
        piece.style.transform = 'rotate(' + rot + 'deg)';

        if (progress < 1) {
          requestAnimationFrame(animate);
        } else {
          piece.remove();
        }
      }

      requestAnimationFrame(animate);
    })(i);
  }
}

function markMissingDone(studentId, classIdx, assignmentIdx) {
  var student = appState.dashboardData.find(function(s) { return s.id === studentId; });
  if (!student) return;
  var classData = student.academicData[classIdx];
  if (!classData || !classData.missingAssignments) return;

  // Launch confetti from the button that was clicked
  var btn = event && event.currentTarget ? event.currentTarget : null;
  launchConfetti(btn);

  classData.missingAssignments.splice(assignmentIdx, 1);
  classData.missing = classData.missingAssignments.length;

  student.totalMissing = student.academicData.reduce(function(sum, c) {
    return sum + (Number(c.missing) || 0);
  }, 0);

  renderMissingView(student);
  persistAcademicData_(student);
  showToast('Assignment marked as complete');
}

function removeMissingAssignment(studentId, classIdx, assignmentIdx) {
  var student = appState.dashboardData.find(function(s) { return s.id === studentId; });
  if (!student) return;
  var classData = student.academicData[classIdx];
  if (!classData || !classData.missingAssignments) return;

  classData.missingAssignments.splice(assignmentIdx, 1);
  classData.missing = classData.missingAssignments.length;

  student.totalMissing = student.academicData.reduce(function(sum, c) {
    return sum + (Number(c.missing) || 0);
  }, 0);

  renderMissingView(student);
  persistAcademicData_(student);
  showToast('Assignment removed');
}

function persistAcademicData_(student) {
  if (!student.latestCheckInId) {
    showToast('Change not saved — no check-in data found.');
    return;
  }
  // Debounce: if user marks several assignments rapidly, only the last call persists
  if (_persistTimers[student.id]) clearTimeout(_persistTimers[student.id]);
  var checkInId = student.latestCheckInId;
  var dataSnapshot = JSON.parse(JSON.stringify(student.academicData));
  _persistTimers[student.id] = setTimeout(function() {
    delete _persistTimers[student.id];
    google.script.run
      .withSuccessHandler(function() {})
      .withFailureHandler(function(err) {
        showToast('Could not save change: ' + (err && err.message ? err.message : String(err)));
      })
      .updateCheckInAcademicData(checkInId, dataSnapshot);
  }, 600);
}

function goBackFromMissing() {
  renderDashboard(appState.dashboardData);
  showView('dashboard-view');
}

// ─── Student Profile ───
function showAddStudent() {
  appState.currentStudentId = null;
  renderStudentForm({});
  document.getElementById('student-view-breadcrumb').textContent = 'Students';
  document.getElementById('student-view-title').textContent = 'New Student';
  renderStudentMenu(null);
  showView('student-view');
}

function editStudent(studentId) {
  appState.currentStudentId = studentId;
  document.getElementById('student-view-breadcrumb').textContent = 'Student Profile';
  document.getElementById('student-view-title').textContent = 'Loading\u2026';
  showStudentProfileSkeleton();
  renderStudentMenu(studentId);
  showView('student-view');

  google.script.run
    .withSuccessHandler(function(students) {
      var student = (students || []).find(function(s) { return s.id === studentId; });
      if (!student) { showToast('Student not found'); return; }

      try {
        document.getElementById('student-view-title').textContent =
          student.firstName + ' ' + student.lastName;
        renderStudentForm(student);
        renderStudentMenu(studentId);
      } catch(e) { showToast('Render error: ' + e.message); return; }

      // Also load check-in history
      google.script.run
        .withSuccessHandler(function(checkIns) {
          try { renderCheckInHistory(checkIns, student); } catch(e) { showToast('History error: ' + e.message); }
        })
        .withFailureHandler(function() {})
        .getCheckIns(studentId);
    })
    .withFailureHandler(function(err) { showToast('Error: ' + (err && err.message ? err.message : String(err))); })
    .getStudents();
}

function renderStudentForm(student) {
  var container = document.getElementById('student-form-container');
  var html = '<div class="form-card">';

  // Basic Info
  var gradeOptions = ['', '6', '7', '8'];
  var gradeHtml = '<select id="st-grade">';
  gradeOptions.forEach(function(g) {
    var sel = (String(student.grade || '') === g) ? ' selected' : '';
    gradeHtml += '<option value="' + g + '"' + sel + '>' + (g || '-- Select Grade --') + '</option>';
  });
  gradeHtml += '</select>';

  html += '<div class="form-section">' +
    '<div class="form-section-title">Basic Information</div>' +
    '<div class="form-row">' +
      '<div class="form-group"><label>First Name</label>' +
        '<input type="text" id="st-firstName" value="' + esc(student.firstName || '') + '" placeholder="First name"></div>' +
      '<div class="form-group"><label>Last Name</label>' +
        '<input type="text" id="st-lastName" value="' + esc(student.lastName || '') + '" placeholder="Last name"></div>' +
    '</div>' +
    '<div class="form-group"><label>Grade Level</label>' + gradeHtml + '</div>' +
  '</div>';

  // Focus & Support
  html += '<div class="form-section">' +
    '<div class="form-section-title">Focus &amp; Support</div>' +
    '<div class="form-group"><label>Focus Goal</label>' +
      '<input type="text" id="st-focusGoal" value="' + esc(student.focusGoal || '') + '" placeholder="Executive function focus area"></div>' +
    '<div class="form-group"><label>Accommodations</label>' +
      '<textarea id="st-accommodations" placeholder="IEP accommodations, 504 plan details, etc.">' + esc(student.accommodations || '') + '</textarea></div>' +
    '<div class="form-group"><label>Notes</label>' +
      '<textarea id="st-notes" placeholder="Additional notes">' + esc(student.notes || '') + '</textarea></div>' +
  '</div>';

  // IEP Goal
  html += '<div class="form-section">' +
    '<div class="form-section-title">IEP Goal</div>' +
    '<div class="form-group"><label>Current IEP Goal</label>' +
      '<textarea id="st-iepGoal" placeholder="Enter the student\'s current IEP goal">' + esc(student.iepGoal || '') + '</textarea></div>' +
  '</div>';

  // Classes
  html += '<div class="form-section">' +
    '<div class="form-section-title">Classes</div>' +
    '<div id="class-list-container">';

  var classes = student.classes || [];
  classes.forEach(function(cls, idx) {
    html += renderClassRow(cls, idx);
  });

  html += '</div>' +
    '<button type="button" class="btn btn-sm btn-secondary" onclick="addClass()" style="margin-top:8px;">+ Add Class</button>' +
  '</div>';

  // Action buttons
  html += '<div style="display:flex;gap:8px;justify-content:space-between;margin-top:24px;">' +
    '<div>';
  if (student.id) {
    html += '<button class="btn btn-danger" onclick="confirmDeleteStudent(\'' + student.id + '\')">Delete Student</button>';
  }
  html += '</div>' +
    '<div style="display:flex;gap:8px;">' +
      '<button class="btn btn-secondary" onclick="showDashboard()">Cancel</button>' +
      '<button class="btn btn-primary" onclick="saveStudentForm()">Save Student</button>' +
    '</div>' +
  '</div>';

  html += '</div>'; // form-card

  // Placeholder for check-in history (filled later)
  if (student.id) {
    html += '<div id="checkin-history-section"></div>';
  }

  container.innerHTML = html;
}

function renderClassRow(cls, idx) {
  var name = '';
  var period = '';
  if (typeof cls === 'string') {
    name = cls;
  } else if (cls) {
    name = cls.name || '';
    period = cls.period || '';
  }

  var isOther = name !== '' && PRELOADED_CLASSES.indexOf(name) === -1;

  var html = '<div class="class-list-item" data-class-idx="' + idx + '">';

  // Class name select
  html += '<select class="class-select" onchange="handleClassSelect(this)">';
  html += '<option value="">-- Select Class --</option>';
  PRELOADED_CLASSES.forEach(function(c) {
    var sel = (name === c) ? ' selected' : '';
    html += '<option value="' + esc(c) + '"' + sel + '>' + esc(c) + '</option>';
  });
  html += '<option value="__other__"' + (isOther ? ' selected' : '') + '>+ Add Other</option>';
  html += '</select>';

  // Other text input (hidden unless "Other" selected)
  html += '<input type="text" class="class-other-input"' +
    (isOther ? '' : ' style="display:none"') +
    ' value="' + esc(isOther ? name : '') + '" placeholder="Enter class name">';

  // Period select
  html += '<select class="class-period-select">';
  html += '<option value="">Period</option>';
  for (var p = 1; p <= 7; p++) {
    var pSel = (String(period) === String(p)) ? ' selected' : '';
    html += '<option value="' + p + '"' + pSel + '>' + p + '</option>';
  }
  html += '</select>';

  // Remove button
  html += '<button type="button" class="btn-remove-class" onclick="removeClass(this)">&times;</button>';
  html += '</div>';
  return html;
}

function handleClassSelect(select) {
  var otherInput = select.parentElement.querySelector('.class-other-input');
  if (select.value === '__other__') {
    otherInput.style.display = '';
    otherInput.focus();
  } else {
    otherInput.style.display = 'none';
    otherInput.value = '';
  }
}

function addClass() {
  var container = document.getElementById('class-list-container');
  var idx = container.querySelectorAll('.class-list-item').length;
  var div = document.createElement('div');
  div.innerHTML = renderClassRow({ name: '', period: '' }, idx);
  container.appendChild(div.firstChild);
}

function removeClass(btn) {
  btn.parentElement.remove();
}

function saveStudentForm() {
  var classItems = document.querySelectorAll('#class-list-container .class-list-item');
  var classes = [];
  classItems.forEach(function(item) {
    var select = item.querySelector('.class-select');
    var otherInput = item.querySelector('.class-other-input');
    var periodSelect = item.querySelector('.class-period-select');

    var name = select.value === '__other__' ? otherInput.value.trim() : select.value;
    var period = periodSelect.value;

    if (name) classes.push({ name: name, period: period });
  });

  var profile = {
    id: appState.currentStudentId || null,
    firstName: document.getElementById('st-firstName').value.trim(),
    lastName: document.getElementById('st-lastName').value.trim(),
    grade: document.getElementById('st-grade').value,
    period: '',
    focusGoal: document.getElementById('st-focusGoal').value.trim(),
    accommodations: document.getElementById('st-accommodations').value.trim(),
    iepGoal: document.getElementById('st-iepGoal').value.trim(),
    notes: document.getElementById('st-notes').value.trim(),
    classes: classes
  };

  if (!profile.firstName || !profile.lastName) {
    showToast('First and last name are required');
    return;
  }

  // Optimistic UI: update local state and navigate immediately
  if (profile.id) {
    appState.dashboardData.forEach(function(s) {
      if (s.id === profile.id) {
        s.firstName = profile.firstName;
        s.lastName = profile.lastName;
        s.grade = profile.grade;
        s.focusGoal = profile.focusGoal;
        s.iepGoal = profile.iepGoal;
        s.classes = profile.classes;
      }
    });
  } else {
    appState.dashboardData.push({
      id: '__pending_' + Date.now(),
      firstName: profile.firstName, lastName: profile.lastName,
      grade: profile.grade, period: '',
      focusGoal: profile.focusGoal, iepGoal: profile.iepGoal,
      classes: profile.classes,
      totalCheckIns: 0, latestWeek: null, latestMicroGoal: null,
      avgRating: null, trend: 'none', gpa: null,
      totalMissing: 0, academicData: []
    });
  }

  renderDashboard(appState.dashboardData);
  showView('dashboard-view');
  showToast('Saving\u2026');

  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showToast('Student saved');
        loadDashboard();
      }
    })
    .withFailureHandler(function(err) {
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
      loadDashboard();
    })
    .saveStudent(profile);
}

function confirmDeleteStudent(studentId) {
  var overlay = document.createElement('div');
  overlay.className = 'confirm-overlay';
  overlay.innerHTML =
    '<div class="confirm-dialog">' +
      '<h3>Delete Student?</h3>' +
      '<p>This will permanently delete this student and all their check-in records.</p>' +
      '<div class="confirm-actions">' +
        '<button class="btn btn-secondary" onclick="this.closest(\'.confirm-overlay\').remove()">Cancel</button>' +
        '<button class="btn btn-danger" onclick="doDeleteStudent(\'' + studentId + '\'); this.closest(\'.confirm-overlay\').remove()">Delete</button>' +
      '</div>' +
    '</div>';
  document.body.appendChild(overlay);
}

function doDeleteStudent(studentId) {
  // Optimistic UI: remove from local state immediately
  appState.dashboardData = appState.dashboardData.filter(function(s) { return s.id !== studentId; });
  renderDashboard(appState.dashboardData);
  showView('dashboard-view');
  showToast('Deleting\u2026');

  google.script.run
    .withSuccessHandler(function() {
      showToast('Student deleted');
      loadDashboard();
    })
    .withFailureHandler(function(err) {
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
      loadDashboard();
    })
    .deleteStudent(studentId);
}

// ─── Check-In History (inside student profile) ───
function renderCheckInHistory(checkIns, student) {
  var section = document.getElementById('checkin-history-section');
  if (!section) return;

  var html = '<div class="form-card" style="margin-top:20px;">' +
    '<div class="form-section-title" style="display:flex;justify-content:space-between;align-items:center;">' +
      '<span>Check-In History (' + checkIns.length + ')</span>' +
      '<button class="btn btn-sm btn-primary" onclick="startCheckIn(\'' + student.id + '\')">New Check-In</button>' +
    '</div>';

  if (checkIns.length === 0) {
    html += '<p class="hint" style="margin-top:12px;">No check-ins recorded yet.</p>';
  } else {
    checkIns.forEach(function(ci) {
      var ratings = [
        Number(ci.planningRating), Number(ci.followThroughRating),
        Number(ci.regulationRating), Number(ci.focusGoalRating),
        Number(ci.effortRating)
      ].filter(function(r) { return !isNaN(r) && r > 0; });

      var avg = ratings.length > 0
        ? (ratings.reduce(function(a,b){ return a+b; }, 0) / ratings.length).toFixed(1)
        : '--';
      var avgClass = avg !== '--'
        ? (avg >= 4 ? 'chip-green' : avg >= 3 ? 'chip-yellow' : 'chip-red')
        : 'chip-gray';

      html += '<div class="history-card" onclick="editCheckIn(\'' + ci.id + '\', \'' + student.id + '\')">' +
        '<div class="history-card-header">' +
          '<span class="history-card-date">' + esc(ci.weekOf || 'No date') + '</span>' +
          '<span class="chip ' + avgClass + '">Avg: ' + avg + '</span>' +
        '</div>' +
        '<div class="history-ratings">' +
          '<span class="history-rating-item">Plan: <span>' + (ci.planningRating || '-') + '</span></span>' +
          '<span class="history-rating-item">Follow: <span>' + (ci.followThroughRating || '-') + '</span></span>' +
          '<span class="history-rating-item">Reg: <span>' + (ci.regulationRating || '-') + '</span></span>' +
          '<span class="history-rating-item">Focus: <span>' + (ci.focusGoalRating || '-') + '</span></span>' +
          '<span class="history-rating-item">Effort: <span>' + (ci.effortRating || '-') + '</span></span>' +
        '</div>';

      if (ci.microGoal) {
        html += '<div class="history-goal">Goal: ' + esc(ci.microGoal) + '</div>';
      }

      html += '<div style="margin-top:8px;text-align:right;">' +
        '<button class="action-btn" onclick="event.stopPropagation(); confirmDeleteCheckIn(\'' + ci.id + '\', \'' + student.id + '\')">Delete</button>' +
      '</div>';

      html += '</div>';
    });
  }

  html += '</div>';
  section.innerHTML = html;
}

function editCheckIn(checkInId, studentId) {
  showCheckInSkeleton();
  showView('checkin-view');
  google.script.run
    .withSuccessHandler(function(checkIns) {
      var ci = checkIns.find(function(c) { return c.id === checkInId; });
      if (ci) {
        startCheckIn(studentId, ci);
      } else {
        showToast('Check-in not found');
      }
    })
    .withFailureHandler(function(err) { showToast('Error: ' + (err && err.message ? err.message : String(err))); })
    .getCheckIns(studentId);
}

function confirmDeleteCheckIn(checkInId, studentId) {
  var overlay = document.createElement('div');
  overlay.className = 'confirm-overlay';
  overlay.innerHTML =
    '<div class="confirm-dialog">' +
      '<h3>Delete Check-In?</h3>' +
      '<p>This check-in record will be permanently deleted.</p>' +
      '<div class="confirm-actions">' +
        '<button class="btn btn-secondary" onclick="this.closest(\'.confirm-overlay\').remove()">Cancel</button>' +
        '<button class="btn btn-danger" onclick="doDeleteCheckIn(\'' + checkInId + '\', \'' + studentId + '\'); this.closest(\'.confirm-overlay\').remove()">Delete</button>' +
      '</div>' +
    '</div>';
  document.body.appendChild(overlay);
}

function doDeleteCheckIn(checkInId, studentId) {
  // Optimistic UI: hide the card immediately
  var cards = document.querySelectorAll('.history-card');
  cards.forEach(function(card) {
    if (card.getAttribute('onclick') && card.getAttribute('onclick').indexOf(checkInId) !== -1) {
      card.style.opacity = '0.4';
      card.style.pointerEvents = 'none';
    }
  });
  showToast('Deleting check-in\u2026');

  google.script.run
    .withSuccessHandler(function() {
      showToast('Check-in deleted');
      editStudent(studentId);
    })
    .withFailureHandler(function(err) {
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
      cards.forEach(function(card) {
        card.style.opacity = '';
        card.style.pointerEvents = '';
      });
    })
    .deleteCheckIn(checkInId);
}

// ─── Teacher Feedback Menu ───

function renderStudentMenu(studentId) {
  var container = document.getElementById('student-menu-container');
  if (!container) return;
  if (!studentId) { container.innerHTML = ''; return; }

  var links = appState.feedbackLinks || {};
  var hasSheet = links.sheetUrl ? true : false;

  var items =
    '<button class="dropdown-item" onclick="handleFeedbackClick()">Request Teacher Feedback</button>';
  if (hasSheet) {
    items += '<button class="dropdown-item" onclick="handleViewFeedbackClick()">View Teacher Feedback</button>';
  }

  container.innerHTML =
    '<div class="menu-anchor">' +
      '<button class="btn-icon" onclick="toggleStudentMenu(event)" aria-label="More options">' +
        '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>' +
      '</button>' +
      '<div class="dropdown-menu" id="student-dropdown" style="display:none;">' +
        items +
      '</div>' +
    '</div>';
}

function toggleStudentMenu(e) {
  e.stopPropagation();
  var menu = document.getElementById('student-dropdown');
  if (!menu) return;
  var isOpen = menu.style.display !== 'none';
  menu.style.display = isOpen ? 'none' : '';
  if (!isOpen) {
    setTimeout(function() {
      document.addEventListener('click', closeStudentMenu);
    }, 0);
  }
}

function closeStudentMenu() {
  var menu = document.getElementById('student-dropdown');
  if (menu) menu.style.display = 'none';
  document.removeEventListener('click', closeStudentMenu);
}

function handleFeedbackClick() {
  closeStudentMenu();
  var links = appState.feedbackLinks || {};
  if (links.formUrl) {
    window.open(links.formUrl, '_blank');
  } else {
    showFeedbackSetupModal();
  }
}

function handleViewFeedbackClick() {
  closeStudentMenu();
  var links = appState.feedbackLinks || {};
  if (links.sheetUrl) {
    window.open(links.sheetUrl, '_blank');
  }
}

function showFeedbackSetupModal() {
  var existing = appState.feedbackLinks || {};
  var overlay = document.createElement('div');
  overlay.className = 'confirm-overlay';
  overlay.id = 'feedback-modal-overlay';
  overlay.innerHTML =
    '<div class="confirm-dialog" style="max-width:480px;">' +
      '<h3>Teacher Feedback Setup</h3>' +
      '<p>Enter the links for teacher feedback collection.</p>' +
      '<div class="form-group" style="margin-bottom:16px;">' +
        '<label>Teacher Feedback Google Form</label>' +
        '<input type="url" id="fb-form-url" value="' + esc(existing.formUrl || '') + '" placeholder="https://docs.google.com/forms/...">' +
      '</div>' +
      '<div class="form-group" style="margin-bottom:24px;">' +
        '<label>Teacher Feedback Google Sheet</label>' +
        '<input type="url" id="fb-sheet-url" value="' + esc(existing.sheetUrl || '') + '" placeholder="https://docs.google.com/spreadsheets/...">' +
      '</div>' +
      '<div class="confirm-actions">' +
        '<button class="btn btn-secondary" onclick="document.getElementById(\'feedback-modal-overlay\').remove()">Cancel</button>' +
        '<button class="btn btn-primary" onclick="saveFeedbackSetup()">Save &amp; Open Form</button>' +
      '</div>' +
    '</div>';
  document.body.appendChild(overlay);
}

function saveFeedbackSetup() {
  var formUrl = document.getElementById('fb-form-url').value.trim();
  var sheetUrl = document.getElementById('fb-sheet-url').value.trim();

  if (!formUrl) {
    showToast('Please enter a Google Form URL');
    return;
  }

  var links = { formUrl: formUrl, sheetUrl: sheetUrl };

  // Optimistic: update local state
  appState.feedbackLinks = links;
  document.getElementById('feedback-modal-overlay').remove();

  // Re-render menu to show "View Teacher Feedback" if sheet URL was provided
  renderStudentMenu(appState.currentStudentId);

  // Open form immediately
  window.open(formUrl, '_blank');
  showToast('Saving feedback links\u2026');

  google.script.run
    .withSuccessHandler(function() { showToast('Feedback links saved'); })
    .withFailureHandler(function(err) {
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
    })
    .saveFeedbackLinks(links);
}

// ─── Co-Teacher Invite Modal ───

function showInviteModal(invite, isNewUser) {
  document.getElementById('navbar').style.display = '';
  showView('auth-loading'); // keep loading state visible behind the modal
  if (!isNewUser) showView('dashboard-view');

  var overlay = document.createElement('div');
  overlay.className = 'confirm-overlay';
  overlay.id = 'invite-modal-overlay';
  overlay.innerHTML =
    '<div class="confirm-dialog" style="max-width:440px;">' +
      '<h3>Co-Teacher Invitation</h3>' +
      '<p><strong>' + esc(invite.ownerEmail) + '</strong> has invited you to collaborate on their caseload. You will share the same students and check-in data.</p>' +
      (isNewUser
        ? '<p class="hint">Accepting will set up your account with their shared caseload. You can also decline and create your own.</p>'
        : '<p class="hint">Accepting will switch you to their shared caseload. Your own data will be preserved and can be restored if you leave the team later.</p>') +
      '<div class="confirm-actions">' +
        '<button class="btn btn-secondary" onclick="declineInvite(' + (isNewUser ? 'true' : 'false') + ')">Decline</button>' +
        '<button class="btn btn-primary" onclick="acceptInvite(' + (isNewUser ? 'true' : 'false') + ')">Accept &amp; Join</button>' +
      '</div>' +
    '</div>';
  document.body.appendChild(overlay);
}

function acceptInvite(isNewUser) {
  var modal = document.getElementById('invite-modal-overlay');
  if (modal) modal.innerHTML =
    '<div class="confirm-dialog" style="max-width:440px;text-align:center;">' +
      '<div class="provision-spinner"></div>' +
      '<p>Joining team\u2026</p>' +
    '</div>';

  google.script.run
    .withSuccessHandler(function(result) {
      if (modal) modal.remove();
      if (result.success) {
        showToast('Joined team successfully!');
        enterApp();
      } else {
        showToast(result.error || 'Error joining team');
        if (isNewUser) location.reload();
      }
    })
    .withFailureHandler(function(err) {
      if (modal) modal.remove();
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
      if (isNewUser) location.reload();
    })
    .acceptCoTeacherInvite();
}

function declineInvite(isNewUser) {
  var modal = document.getElementById('invite-modal-overlay');
  if (modal) modal.remove();

  google.script.run
    .withSuccessHandler(function() {
      if (isNewUser) {
        // Show onboarding since they don't have their own spreadsheet yet
        google.script.run
          .withSuccessHandler(function(status) { showOnboarding(status); })
          .withFailureHandler(function() { location.reload(); })
          .getUserStatus();
      }
    })
    .withFailureHandler(function() {})
    .declineCoTeacherInvite();
}

// ─── Co-Teacher Management View ───

function showCoTeachers() {
  showView('coteacher-view');
  document.getElementById('coteacher-content-container').innerHTML =
    '<div class="skeleton-fade-in"><div class="form-card">' +
      '<div class="skeleton skeleton-section-title" style="width:30%;"></div>' +
      '<div class="skeleton skeleton-input" style="margin-bottom:12px;"></div>' +
      '<div class="skeleton skeleton-input" style="margin-bottom:12px;"></div>' +
    '</div></div>';

  google.script.run
    .withSuccessHandler(function(teamInfo) {
      try { renderCoTeacherView(teamInfo); }
      catch(e) { showToast('Render error: ' + e.message); }
    })
    .withFailureHandler(function(err) {
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
    })
    .getTeamInfo();
}

function renderCoTeacherView(teamInfo) {
  var container = document.getElementById('coteacher-content-container');
  var isOwner = teamInfo.currentUserRole === 'owner';
  var html = '';

  // Role banner
  html += '<div class="ct-role-banner ' + (isOwner ? 'ct-role-owner' : 'ct-role-coteacher') + '">' +
    '<span class="ct-role-label">Your role:</span> ' +
    '<span class="ct-role-value">' + (isOwner ? 'Owner' : 'Co-Teacher') + '</span>' +
  '</div>';

  // Team members
  html += '<div class="form-card">' +
    '<div class="form-section-title">Team Members</div>';

  teamInfo.members.forEach(function(m) {
    var emailStr = String(m.email || '');
    var roleStr = m.role === 'owner' ? 'Owner' : 'Co-Teacher';
    var isSelf = emailStr.toLowerCase() === (appState.currentUserEmail || '').toLowerCase();

    html += '<div class="ct-member-row">' +
      '<div class="ct-member-info">' +
        '<span class="ct-member-email">' + esc(emailStr) + '</span>' +
        '<span class="ct-member-role">' + roleStr + (isSelf ? ' (you)' : '') + '</span>' +
      '</div>';

    if (isOwner && m.role !== 'owner') {
      html += '<button class="btn btn-sm btn-danger" onclick="confirmRemoveCoTeacher(\'' + esc(emailStr) + '\')">Remove</button>';
    }

    html += '</div>';
  });

  html += '</div>';

  // Add co-teacher form (owner only)
  if (isOwner) {
    html += '<div class="form-card">' +
      '<div class="form-section-title">Add Co-Teacher</div>' +
      '<p class="hint">Enter the email address of the teacher you want to invite. They will receive the invite the next time they open the app.</p>' +
      '<div class="ct-add-form">' +
        '<input type="email" id="ct-add-email" placeholder="colleague@school.edu" class="ct-email-input">' +
        '<button class="btn btn-primary" onclick="addCoTeacherFromForm()">Send Invite</button>' +
      '</div>' +
    '</div>';
  }

  // Leave team (co-teacher only)
  if (!isOwner) {
    html += '<div class="form-card">' +
      '<div class="form-section-title">Leave Team</div>' +
      '<p class="hint">Leaving will disconnect you from this shared caseload. If you previously had your own data, it will be restored.</p>' +
      '<button class="btn btn-danger" onclick="confirmLeaveTeam()">Leave Team</button>' +
    '</div>';
  }

  container.innerHTML = html;
}

function addCoTeacherFromForm() {
  var input = document.getElementById('ct-add-email');
  var email = (input.value || '').trim();
  if (!email) { showToast('Please enter an email address'); return; }

  showToast('Sending invite\u2026');

  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showToast('Invite sent to ' + email);
        showCoTeachers(); // refresh
      } else {
        showToast(result.error || 'Error sending invite');
      }
    })
    .withFailureHandler(function(err) {
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
    })
    .addCoTeacher(email);
}

function confirmRemoveCoTeacher(email) {
  var overlay = document.createElement('div');
  overlay.className = 'confirm-overlay';
  overlay.innerHTML =
    '<div class="confirm-dialog">' +
      '<h3>Remove Co-Teacher?</h3>' +
      '<p>This will revoke <strong>' + esc(email) + '</strong>\u2019s access to the shared caseload.</p>' +
      '<div class="confirm-actions">' +
        '<button class="btn btn-secondary" onclick="this.closest(\'.confirm-overlay\').remove()">Cancel</button>' +
        '<button class="btn btn-danger" onclick="doRemoveCoTeacher(\'' + esc(email) + '\'); this.closest(\'.confirm-overlay\').remove()">Remove</button>' +
      '</div>' +
    '</div>';
  document.body.appendChild(overlay);
}

function doRemoveCoTeacher(email) {
  showToast('Removing co-teacher\u2026');
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showToast('Co-teacher removed');
        showCoTeachers();
      } else {
        showToast(result.error || 'Error removing co-teacher');
      }
    })
    .withFailureHandler(function(err) {
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
    })
    .removeCoTeacher(email);
}

function confirmLeaveTeam() {
  var overlay = document.createElement('div');
  overlay.className = 'confirm-overlay';
  overlay.innerHTML =
    '<div class="confirm-dialog">' +
      '<h3>Leave Team?</h3>' +
      '<p>You will be disconnected from this shared caseload. If you had your own data before joining, it will be restored.</p>' +
      '<div class="confirm-actions">' +
        '<button class="btn btn-secondary" onclick="this.closest(\'.confirm-overlay\').remove()">Cancel</button>' +
        '<button class="btn btn-danger" onclick="doLeaveTeam(); this.closest(\'.confirm-overlay\').remove()">Leave</button>' +
      '</div>' +
    '</div>';
  document.body.appendChild(overlay);
}

function doLeaveTeam() {
  showToast('Leaving team\u2026');
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showToast('You have left the team');
        location.reload();
      }
    })
    .withFailureHandler(function(err) {
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
    })
    .leaveCoTeacherTeam();
}

// ─── Dashboard Refresh (for co-teacher data freshness) ───
function refreshDashboard() {
  showDashboardSkeleton();
  google.script.run
    .withSuccessHandler(function(data) {
      try {
        appState.dashboardData = data || [];
        renderDashboard(data);
        showToast('Dashboard refreshed');
      } catch(e) { showToast('Render error: ' + e.message); }
    })
    .withFailureHandler(function(err) {
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
    })
    .refreshDashboardData();
}

// ─── Skeleton Loading Functions ───
function showDashboardSkeleton() {
  var container = document.getElementById('dashboard-table-container');
  var html = '<div class="skeleton-fade-in"><table class="skeleton-table"><thead><tr>' +
    '<th><div class="skeleton skeleton-text w-50" style="margin:0;"></div></th>' +
    '<th><div class="skeleton skeleton-text w-40" style="margin:0;"></div></th>' +
    '<th><div class="skeleton skeleton-text w-30" style="margin:0;"></div></th>' +
    '<th><div class="skeleton skeleton-text w-30" style="margin:0;"></div></th>' +
    '<th><div class="skeleton skeleton-text w-25" style="margin:0;"></div></th>' +
    '<th><div class="skeleton skeleton-text w-30" style="margin:0;"></div></th>' +
    '<th><div class="skeleton skeleton-text w-40" style="margin:0;"></div></th>' +
    '<th><div class="skeleton skeleton-text w-30" style="margin:0;"></div></th>' +
  '</tr></thead><tbody>';
  for (var i = 0; i < 6; i++) {
    html += '<tr>' +
      '<td><div class="skeleton skeleton-text w-75" style="margin:0;"></div></td>' +
      '<td><div class="skeleton skeleton-text w-25" style="margin:0;"></div></td>' +
      '<td><div class="skeleton skeleton-chip"></div></td>' +
      '<td><div class="skeleton skeleton-text w-40" style="margin:0;"></div></td>' +
      '<td><div class="skeleton skeleton-chip"></div></td>' +
      '<td><div class="skeleton skeleton-chip"></div></td>' +
      '<td><div class="skeleton skeleton-text w-50" style="margin:0;"></div></td>' +
      '<td><div style="display:flex;gap:8px;"><div class="skeleton skeleton-btn"></div><div class="skeleton skeleton-btn" style="width:56px;"></div></div></td>' +
    '</tr>';
  }
  html += '</tbody></table></div>';
  container.innerHTML = html;
}

function showStudentProfileSkeleton() {
  var container = document.getElementById('student-form-container');
  var html = '<div class="skeleton-fade-in"><div class="form-card">';
  // Basic Info section
  html += '<div class="skeleton-section">' +
    '<div class="skeleton skeleton-section-title"></div>' +
    '<div style="display:flex;gap:16px;"><div style="flex:1;"><div class="skeleton skeleton-input"></div></div>' +
    '<div style="flex:1;"><div class="skeleton skeleton-input"></div></div></div>' +
    '<div class="skeleton skeleton-input" style="width:50%;"></div>' +
  '</div>';
  // Focus & Support section
  html += '<div class="skeleton-section">' +
    '<div class="skeleton skeleton-section-title" style="width:25%;"></div>' +
    '<div class="skeleton skeleton-input"></div>' +
    '<div class="skeleton skeleton-input" style="height:80px;"></div>' +
    '<div class="skeleton skeleton-input" style="height:80px;"></div>' +
  '</div>';
  // IEP Goal section
  html += '<div class="skeleton-section">' +
    '<div class="skeleton skeleton-section-title" style="width:20%;"></div>' +
    '<div class="skeleton skeleton-input" style="height:80px;"></div>' +
  '</div>';
  // Classes section
  html += '<div class="skeleton-section">' +
    '<div class="skeleton skeleton-section-title" style="width:15%;"></div>';
  for (var i = 0; i < 3; i++) {
    html += '<div style="display:flex;gap:8px;margin-bottom:10px;">' +
      '<div class="skeleton" style="flex:2;height:44px;border-radius:4px;"></div>' +
      '<div class="skeleton" style="width:100px;height:44px;border-radius:4px;"></div>' +
      '<div class="skeleton" style="width:40px;height:40px;border-radius:50%;"></div>' +
    '</div>';
  }
  html += '</div>';
  // Buttons
  html += '<div style="display:flex;gap:8px;justify-content:flex-end;">' +
    '<div class="skeleton skeleton-btn" style="width:80px;height:40px;"></div>' +
    '<div class="skeleton skeleton-btn" style="width:100px;height:40px;"></div>' +
  '</div>';
  html += '</div>';
  // Check-in history skeleton
  html += '<div class="form-card" style="margin-top:20px;">' +
    '<div class="skeleton skeleton-section-title" style="width:35%;"></div>';
  for (var j = 0; j < 2; j++) {
    html += '<div class="skeleton-card">' +
      '<div style="display:flex;justify-content:space-between;margin-bottom:12px;">' +
        '<div class="skeleton skeleton-text w-25" style="margin:0;"></div>' +
        '<div class="skeleton skeleton-chip"></div>' +
      '</div>' +
      '<div style="display:flex;gap:12px;flex-wrap:wrap;">' +
        '<div class="skeleton skeleton-text w-20" style="margin:0;"></div>' +
        '<div class="skeleton skeleton-text w-20" style="margin:0;"></div>' +
        '<div class="skeleton skeleton-text w-20" style="margin:0;"></div>' +
        '<div class="skeleton skeleton-text w-20" style="margin:0;"></div>' +
      '</div>' +
    '</div>';
  }
  html += '</div></div>';
  container.innerHTML = html;
}

function showCheckInSkeleton() {
  var container = document.getElementById('checkin-form-container');
  var html = '<div class="skeleton-fade-in">';
  // Previous goal banner skeleton
  html += '<div style="background:var(--md-surface-container);border-radius:var(--md-shape-md);padding:16px 20px;margin-bottom:24px;border:1px solid var(--md-outline-variant);">' +
    '<div class="skeleton skeleton-text w-20"></div>' +
    '<div class="skeleton skeleton-text w-50"></div>' +
    '<div class="skeleton skeleton-text w-30" style="height:10px;"></div>' +
  '</div>';
  html += '<div class="form-card">';
  // Week Of
  html += '<div class="skeleton-section">' +
    '<div class="skeleton skeleton-input" style="width:200px;"></div>' +
  '</div>';
  // EF Ratings section
  html += '<div class="skeleton-section">' +
    '<div class="skeleton skeleton-section-title" style="width:40%;"></div>';
  for (var i = 0; i < 5; i++) {
    html += '<div style="margin-bottom:16px;">' +
      '<div class="skeleton skeleton-text w-20" style="height:12px;"></div>' +
      '<div style="display:flex;gap:0;">' +
        '<div class="skeleton" style="width:48px;height:40px;border-radius:9999px 0 0 9999px;"></div>' +
        '<div class="skeleton" style="width:48px;height:40px;border-radius:0;"></div>' +
        '<div class="skeleton" style="width:48px;height:40px;border-radius:0;"></div>' +
        '<div class="skeleton" style="width:48px;height:40px;border-radius:0;"></div>' +
        '<div class="skeleton" style="width:48px;height:40px;border-radius:0 9999px 9999px 0;"></div>' +
      '</div>' +
    '</div>';
  }
  html += '</div>';
  // Reflection section
  html += '<div class="skeleton-section">' +
    '<div class="skeleton skeleton-section-title" style="width:20%;"></div>' +
    '<div class="skeleton skeleton-input" style="height:80px;"></div>' +
    '<div class="skeleton skeleton-input" style="height:80px;"></div>' +
  '</div>';
  // Micro Goal section
  html += '<div class="skeleton-section">' +
    '<div class="skeleton skeleton-section-title" style="width:20%;"></div>' +
    '<div class="skeleton skeleton-input"></div>' +
    '<div class="skeleton skeleton-input"></div>' +
  '</div>';
  // Buttons
  html += '<div style="display:flex;gap:8px;justify-content:flex-end;">' +
    '<div class="skeleton skeleton-btn" style="width:72px;height:40px;"></div>' +
    '<div class="skeleton skeleton-btn" style="width:110px;height:40px;"></div>' +
  '</div>';
  html += '</div></div>';
  container.innerHTML = html;
}

// Legacy wrappers — now no-ops since we use per-view skeletons
function showLoading() {}
function hideLoading() {}

function showToast(message) {
  var toast = document.getElementById('toast');
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(function() { toast.classList.remove('show'); }, 3000);
}

function esc(str) {
  if (str === null || str === undefined) return '';
  var div = document.createElement('div');
  div.textContent = String(str);
  return div.innerHTML;
}

// ─── Onboarding Wizard ───

function showOnboarding(status) {
  onboardingState.email = status.email || '';
  onboardingState.step = 1;
  showView('onboarding-view');
  renderOnboardingStep();
}

function onboardingNext() {
  onboardingState.step++;
  renderOnboardingStep();
}

function renderOnboardingStep() {
  var container = document.getElementById('onboarding-container');
  var html = '';

  // Progress indicator
  html += '<div class="onboarding-progress">';
  for (var i = 1; i <= 3; i++) {
    var stepClass = i === onboardingState.step ? 'active' :
                    i < onboardingState.step ? 'completed' : '';
    html += '<div class="onboarding-step-dot ' + stepClass + '">' + i + '</div>';
    if (i < 3) html += '<div class="onboarding-step-line ' + (i < onboardingState.step ? 'completed' : '') + '"></div>';
  }
  html += '</div>';

  if (onboardingState.step === 1) {
    html += renderOnboardingWelcome();
  } else if (onboardingState.step === 2) {
    html += renderOnboardingProvision();
  } else if (onboardingState.step === 3) {
    html += renderOnboardingFirstStudent();
  }

  container.innerHTML = html;

  // Auto-trigger provisioning when step 2 renders
  if (onboardingState.step === 2) {
    triggerProvisioning();
  }
}

// ── Step 1: Welcome & Feature Highlights ──
function renderOnboardingWelcome() {
  var iconSvgs = {
    dashboard: '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>',
    check_circle: '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>',
    trending_up: '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/></svg>',
    school: '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82zM12 3L1 9l11 6 9-4.91V17h2V9L12 3z"/></svg>',
    insights: '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M21 8c-1.45 0-2.26 1.44-1.93 2.51l-3.55 3.56c-.3-.09-.74-.09-1.04 0l-2.55-2.55C12.27 10.45 11.46 9 10 9c-1.45 0-2.27 1.44-1.93 2.52l-4.56 4.55C2.44 15.74 1 16.55 1 18c0 1.1.9 2 2 2 1.45 0 2.26-1.44 1.93-2.51l4.55-4.56c.3.09.74.09 1.04 0l2.55 2.55C12.73 16.55 13.54 18 15 18c1.45 0 2.27-1.44 1.93-2.52l3.56-3.55C21.56 12.26 23 11.45 23 10c0-1.1-.9-2-2-2z"/></svg>'
  };

  var features = [
    { icon: 'dashboard', title: 'Caseload Dashboard', desc: 'See all your students at a glance with EF ratings, GPA, trends, and missing assignments.' },
    { icon: 'check_circle', title: 'Weekly Check-Ins', desc: 'Rate executive function skills across five dimensions, reflect on progress, and set micro-goals.' },
    { icon: 'trending_up', title: 'EF Tracking', desc: 'Track Planning, Follow-Through, Regulation, Focus Goal, and Effort over time.' },
    { icon: 'school', title: 'Academic Snapshots', desc: 'Log grades and missing assignments per class during each check-in.' },
    { icon: 'insights', title: 'Trends & History', desc: 'Spot trends across check-ins and review a student\u2019s full history.' }
  ];

  var html = '<div class="onboarding-card">' +
    '<h2 class="onboarding-title">Welcome to Caseload Dashboard</h2>' +
    '<p class="onboarding-subtitle">A caseload dashboard for tracking executive function skills and academic progress for your students.</p>';

  html += '<div class="onboarding-features">';
  features.forEach(function(f) {
    html += '<div class="onboarding-feature">' +
      '<div class="onboarding-feature-icon">' + iconSvgs[f.icon] + '</div>' +
      '<div class="onboarding-feature-text">' +
        '<div class="onboarding-feature-title">' + f.title + '</div>' +
        '<div class="onboarding-feature-desc">' + f.desc + '</div>' +
      '</div>' +
    '</div>';
  });
  html += '</div>';

  html += '<div class="onboarding-actions">' +
    '<button class="btn btn-primary" onclick="onboardingNext()">Get Started</button>' +
  '</div>';

  html += '</div>';
  return html;
}

// ── Step 2: Spreadsheet Provisioning ──
function renderOnboardingProvision() {
  var html = '<div class="onboarding-card">' +
    '<h2 class="onboarding-title">Setting Up Your Data</h2>' +
    '<p class="onboarding-subtitle">Creating a private Google Sheet in your Drive to store student data securely.</p>' +
    '<div id="provision-status" class="onboarding-provision-status">' +
      '<div class="provision-spinner"></div>' +
      '<p>Creating your spreadsheet\u2026</p>' +
    '</div>' +
    '<div id="provision-actions" class="onboarding-actions" style="display:none;">' +
      '<button class="btn btn-primary" onclick="onboardingNext()">Continue</button>' +
    '</div>' +
  '</div>';
  return html;
}

function triggerProvisioning() {
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        onboardingState.spreadsheetUrl = result.spreadsheetUrl;
        var statusEl = document.getElementById('provision-status');
        statusEl.innerHTML =
          '<div class="provision-success">' +
            '<svg width="48" height="48" viewBox="0 0 24 24" fill="var(--md-primary)"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>' +
            '<p class="provision-success-text">Your spreadsheet has been created!</p>' +
            '<p class="provision-success-hint">It\u2019s stored in your Google Drive and only accessible to you.</p>' +
          '</div>';
        document.getElementById('provision-actions').style.display = '';
      } else {
        showProvisionError('Unexpected error during setup.');
      }
    })
    .withFailureHandler(function(err) {
      showProvisionError(err && err.message ? err.message : String(err));
    })
    .provisionUserSpreadsheet();
}

function showProvisionError(message) {
  var statusEl = document.getElementById('provision-status');
  statusEl.innerHTML =
    '<div class="provision-error">' +
      '<p>Something went wrong: ' + esc(message) + '</p>' +
      '<button class="btn btn-primary" onclick="renderOnboardingStep()" style="margin-top:12px;">Retry</button>' +
    '</div>';
}

// ── Step 3: First Student Profile ──
function renderOnboardingFirstStudent() {
  var gradeOptions = [
    { value: '', label: '-- Select Grade --' },
    { value: '6', label: '6' },
    { value: '7', label: '7' },
    { value: '8', label: '8' }
  ];

  var gradeHtml = '';
  gradeOptions.forEach(function(g) {
    gradeHtml += '<option value="' + g.value + '">' + g.label + '</option>';
  });

  var html = '<div class="onboarding-card">' +
    '<h2 class="onboarding-title">Add Your First Student</h2>' +
    '<p class="onboarding-subtitle">Set up a student profile to get started. You can always add more students later from the caseload dashboard.</p>' +
    '<div class="form-card" style="box-shadow:none;padding:0;">' +
      '<div class="form-section">' +
        '<div class="form-section-title">Basic Information</div>' +
        '<div class="form-row">' +
          '<div class="form-group"><label>First Name *</label>' +
            '<input type="text" id="ob-firstName" placeholder="First name"></div>' +
          '<div class="form-group"><label>Last Name *</label>' +
            '<input type="text" id="ob-lastName" placeholder="Last name"></div>' +
        '</div>' +
        '<div class="form-group"><label>Grade Level</label>' +
          '<select id="ob-grade">' + gradeHtml + '</select>' +
        '</div>' +
      '</div>' +
      '<div class="form-section">' +
        '<div class="form-section-title">Focus &amp; Support</div>' +
        '<div class="form-group"><label>Focus Goal</label>' +
          '<input type="text" id="ob-focusGoal" placeholder="Executive function focus area"></div>' +
        '<div class="form-group"><label>IEP Goal</label>' +
          '<textarea id="ob-iepGoal" placeholder="Enter the student\u2019s current IEP goal (optional)"></textarea></div>' +
      '</div>' +
    '</div>' +
    '<div class="onboarding-actions">' +
      '<button class="btn btn-secondary" onclick="skipFirstStudent()">Skip for Now</button>' +
      '<button class="btn btn-primary" onclick="saveOnboardingStudent()">Save &amp; Finish</button>' +
    '</div>' +
  '</div>';

  return html;
}

function saveOnboardingStudent() {
  var firstName = document.getElementById('ob-firstName').value.trim();
  var lastName = document.getElementById('ob-lastName').value.trim();

  if (!firstName || !lastName) {
    showToast('First and last name are required');
    return;
  }

  var profile = {
    firstName: firstName,
    lastName: lastName,
    grade: document.getElementById('ob-grade').value,
    focusGoal: document.getElementById('ob-focusGoal').value.trim(),
    iepGoal: document.getElementById('ob-iepGoal').value.trim(),
    period: '',
    accommodations: '',
    notes: '',
    classes: []
  };

  showToast('Saving student\u2026');

  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showToast('Welcome to Caseload Dashboard!');
        completeOnboarding();
      } else {
        showToast('Error saving student');
      }
    })
    .withFailureHandler(function(err) {
      showToast('Error: ' + (err && err.message ? err.message : String(err)));
    })
    .saveStudent(profile);
}

function skipFirstStudent() {
  completeOnboarding();
}

function completeOnboarding() {
  enterApp();
}
</script>
